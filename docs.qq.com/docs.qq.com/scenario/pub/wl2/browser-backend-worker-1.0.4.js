/*! weblog-browser/backend-worker 1.0.4 */
!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){var t,e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};function r(t,r){function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}function o(t,e,r,o){return new(r||(r=Promise))(function(n,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function u(t){try{a(o.throw(t))}catch(t){i(t)}}function a(t){t.done?n(t.value):new r(function(e){e(t.value)}).then(s,u)}a((o=o.apply(t,e||[])).next())})}function n(t,e){var r,o,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function i(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var o,n,i=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return s}!function(t){t[t.Request=0]="Request",t[t.ReplyOK=1]="ReplyOK",t[t.ReplyErr=2]="ReplyErr"}(t||(t={}));var s,u,a,c=function(){function e(){}return e.isRpcMessage=function(t){return t.key===e.rpcKey},e.getMessageType=function(t){return t.type},e.getReq=function(t){return t.req},e.serializeRequest=function(r,o,n,i){return{key:e.rpcKey,type:t.Request,req:r,rpcId:o,method:n,args:i}},e.deserializeRequest=function(t){return{rpcId:t.rpcId,method:t.method,args:t.args}},e.serializeReplyOK=function(r,o){return{key:e.rpcKey,type:t.ReplyOK,req:r,result:o}},e.deserializeReplyOK=function(t){return t.result},e.serializeReplyErr=function(r,o){return{key:e.rpcKey,type:t.ReplyErr,req:r,err:o}},e.deserializeReplyErr=function(t){return t.err},e.rpcKey="weblog-rpc",e}(),l=function(){function t(e,r,o){this.isMain=e,this.sid=r,this.methodNames=o,this.nid=++t.count}return t.identifiers={},t.count=0,t}(),p=(h("MainThreadBackendLogger",["fatal"]),{ExtHostBackend:(s="ExtHostBackend",u=["init","identify","insertLog","queryLog","reportLog","getSessionId"],a=new l(!1,s,u),l.identifiers[a.nid]=a,a)});function h(t,e){var r=new l(!0,t,e);return l.identifiers[r.nid]=r,r}function f(t){return l.identifiers[t].sid}var d,v,y,g=function(){function t(){this.actual=null,this.actualOk=null,this.actualErr=null,this.hasValue=!1,this.value=null,this.hasErr=!1,this.err=null}return Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return this.toString()},enumerable:!1,configurable:!0}),t.prototype.resolveOk=function(t){this.hasValue||this.hasErr||(this.hasValue=!0,this.value=t,this.actual&&this.actualOk(t))},t.prototype.resolveErr=function(t){this.hasValue||this.hasErr||(this.hasErr=!0,this.err=t,this.actual&&this.actualErr(t))},t.prototype.then=function(t,e){return this.ensureActual().then(t,e)},t.prototype.catch=function(t){return this.ensureActual().then(void 0,t)},t.prototype.finally=function(t){return this.ensureActual().finally(t)},t.prototype.ensureActual=function(){var t=this;return this.actual||(this.actual=new Promise(function(e,r){t.actualOk=e,t.actualErr=r,t.hasValue&&t.actualOk(t.value),t.hasErr&&t.actualErr(t.err)})),this.actual},t}(),m=function(){function e(t){var e=this;this.pendingRPCReplies={},this.locals=[],this.proxies={},this.lastMessageId=0,this.protocol=t,this.protocol.onMessage(function(t){return e.receiveOneMessage(t)})}return e.prototype.getProxy=function(t){var e=t.methodNames,r=t.nid;return this.proxies[r]||(this.proxies[r]=this.createProxy(r,e)),this.proxies[r]},e.prototype.set=function(t,e){return this.locals[t.nid]=e,e},e.prototype.createProxy=function(t,e){var r=this,o=Object.create(null);return e.forEach(function(e){o[e]=function(){for(var o=[],n=0;n<arguments.length;n++)o[n]=arguments[n];return r.remoteCall(t,e,o)}}),o},e.prototype.remoteCall=function(t,e,r){var o=++this.lastMessageId,n=String(o),i=new g,s=c.serializeRequest(o,t,e,r);return this.pendingRPCReplies[n]=i,this.protocol.send(s),i},e.prototype.receiveOneMessage=function(e){if(c.isRpcMessage(e)){var r=c.getMessageType(e),o=c.getReq(e);switch(r){case t.Request:var n=c.deserializeRequest(e),i=n.rpcId,s=n.method,u=n.args;this.receiveRequest(o,i,s,u);break;case t.ReplyOK:var a=c.deserializeReplyOK(e);this.receiveReply(o,a,!0);break;case t.ReplyErr:var l=c.deserializeReplyErr(e);this.receiveReply(o,l,!1);break;default:console.error("received unexpected message")}}},e.prototype.receiveRequest=function(t,e,r,o){var n=this;this.invokeHandler(e,r,o).then(function(e){var r=c.serializeReplyOK(t,e);n.protocol.send(r)},function(e){var r=c.serializeReplyErr(t,e);n.protocol.send(r)})},e.prototype.receiveReply=function(t,e,r){var o=String(t);if(Object.prototype.hasOwnProperty.call(this.pendingRPCReplies,o)){var n=this.pendingRPCReplies[o];delete this.pendingRPCReplies[o],n[r?"resolveOk":"resolveErr"](e)}},e.prototype.invokeHandler=function(t,e,r){try{return Promise.resolve(this.doInvokeHandler(t,e,r))}catch(t){return Promise.reject(t)}},e.prototype.doInvokeHandler=function(t,e,r){var o=this.locals[t];if(!o)throw new Error("Unknown actor "+f(t));var n=o[e];if("function"!=typeof n)throw new Error("Unknown method "+e+" on actor "+f(t));return n.apply(o,r)},e}();!function(t){t.INSERT_LOG="insert_log",t.GET_CONFIG="get_config"}(d||(d={})),function(t){t[t.DEBUG=1]="DEBUG",t[t.LOG=1]="LOG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.FATAL=5]="FATAL"}(v||(v={})),function(t){t[t.BeforeInvokeLog=0]="BeforeInvokeLog"}(y||(y={}));var w={};function b(t){return function(t,e){return Object.prototype.toString.call(e)==="[object "+t+"]"}("Object",t)}function I(t){var e=new Set;try{return JSON.stringify(t,function(t,r){if(b(r)||Array.isArray(r)){if(e.has(r))return'["Circular"]';e.add(r)}return r})}catch(e){return console.error(e),b(t)?'{Object:["Circular"]}':Array.isArray(t)?'["Circular"]':"Circular"}}function x(){if("undefined"==typeof crypto&&"undefined"==typeof msCrypto)return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)});var t=new Uint16Array(8);crypto.getRandomValues(t),t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;var e=function(t){for(var e=t.toString(16);e.length<4;)e="0"+e;return e};return e(t[0])+e(t[1])+e(t[2])+e(t[3])+e(t[4])+e(t[5])+e(t[6])+e(t[7])}var T=function(){function t(){this.events=Object.create(null)}return t.prototype.on=function(t,e){var r,o=this;return this.events[t]=null!==(r=this.events[t])&&void 0!==r?r:new Set,this.events[t].add(e),function(){o.events[t].delete(e)}},t.prototype.emit=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=this.events[t];o&&Array.from(o).forEach(function(t){t.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(i(arguments[e]));return t}(e))})},t}();var R="1.0.4",E=function(){function t(t){this.logs=[],this.maxLogsLengthToReport=10,this.reportLogTimerTimestamp=1e3,this.transport=t}return t.prototype.send=function(t){var e=this;this.logs.push(t),this.reportLogTimer&&clearTimeout(this.reportLogTimer),this.logs.length>this.maxLogsLengthToReport?this.realSendLogs():this.reportLogTimer=setTimeout(function(){e.realSendLogs()},this.reportLogTimerTimestamp)},t.prototype.realSendLogs=function(){0!==this.logs.length&&(this.transport.report({logs:this.logs,reserve2:"2",isUserReport:!1}),this.logs=[])},t}(),_=function(){function t(){var t=this;this.version=R,this.repository=this.setupRepository(),this.sessionId=x(),this.reportedSessionLogMaxTs={},this.protocol=this.setupProtocol(),this.rpcProtocol=new m(this.protocol),this.rpcProtocol.set(p.ExtHostBackend,this),this.transport=this.setupTransport({version:this.version,getPID:function(){return t.getPID()},getUID:function(){return t.getUID()}}),this.logSender=new E(this.getTransport())}return t.prototype.init=function(t,e){this.pid=t,this.options=e,this.initRepository(),this.clearExpiredLog()},t.prototype.identify=function(t,e){return o(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return this.uid=t,[4,this.loadConfig(t)];case 1:return[2,e.sent()]}})})},t.prototype.insertLog=function(t){this.firstLogTs||(this.firstLogTs=t.ts),this.lastLogTs=t.ts,t.sessionId=this.sessionId,t.level!==v.FATAL?this.repository.insert(t):this.logSender.send(t)},t.prototype.queryLog=function(t){return o(this,void 0,void 0,function(){var e,r,o,i,s,u,a,c,l;return n(this,function(n){switch(n.label){case 0:return r=(e=t||{}).pid,o=e.startTs,i=e.endTs,s=e.sessionId,u=void 0===s?this.getSessionId():s,a=this.repository,r&&r!==this.getPID()&&((c=this.setupRepository()).init(function(t){return"wl-"+t}(r)),a=c),o&&i?[4,a.queryByTs(o,i)]:[3,2];case 1:return l=n.sent(),[3,5];case 2:return this.firstLogTs?[3,3]:(l=[],[3,5]);case 3:return[4,a.queryBySessionId(u,this.firstLogTs,this.lastLogTs)];case 4:l=n.sent(),n.label=5;case 5:return null==c||c.close(),[2,l]}})})},t.prototype.reportLog=function(t,e,r){var i,s;return void 0===e&&(e={}),void 0===r&&(r={}),o(this,void 0,void 0,function(){var o,u,a,c;return n(this,function(n){switch(n.label){case 0:return o=(null==e?void 0:e.query)?null==e?void 0:e.query:e,0===Object.keys(o).length&&(o.sessionId=this.getSessionId()),o.startTs||o.endTs||o.sessionId?(u=r.reportId||x(),console.log(u),[4,this.getTransport().canReport(t,{query:o,reportId:u,sessionId:this.getSessionId(),release:null===(i=this.options)||void 0===i?void 0:i.release,env:null===(s=this.options)||void 0===s?void 0:s.env})]):[2,""];case 1:return n.sent()?[4,this.queryLog(o)]:(console.warn("[wl]"+t+"超过主动上报次数，忽略本次上报。"),[2,Promise.resolve("")]);case 2:return a=n.sent(),o.sessionId&&(a=this.filterSessionReportedLogs(a,o.sessionId)),c={logs:a,reserve2:u,isUserReport:!1},this.getTransport().report(c),[2,Promise.resolve(u)]}})})},t.prototype.getRepository=function(){return this.repository},t.prototype.getTransport=function(){return this.transport},t.prototype.getSessionId=function(){return this.sessionId},t.prototype.getUID=function(){return this.uid},t.prototype.getPID=function(){return this.pid},t.prototype.loadConfig=function(t,e){return void 0===e&&(e=this.pid),o(this,void 0,void 0,function(){var r,i,s,u,a,c=this;return n(this,function(l){switch(l.label){case 0:return r=this.options.relatedPids||[],[4,this.getTransport().getReportConfig(r.concat(e),t)];case 1:return i=l.sent(),s=i.success,u=i.result,a=i.message,s?u.forEach(function(t){return o(c,void 0,void 0,function(){var e,r,o,i,s,u,a,c,l,p,h;return n(this,function(n){switch(n.label){case 0:e=t.fragmentList||[],r=0,o=e.length,n.label=1;case 1:return r<o?(i=e[r],s=i.startTs,u=i.endTs,a=i.id,c=i.searchType,l=i.pid,[4,this.queryLog({startTs:s,endTs:u,pid:l})]):[3,5];case 2:return p=n.sent(),console.log("[wl]"+l+"-"+s+"-"+u+":",p||[]),h={fragmentId:a,logs:p,searchType:c},[4,this.getTransport().report(h,l)];case 3:n.sent(),n.label=4;case 4:return r++,[3,1];case 5:return[2]}})})}):console.error("[wl]获取上报配置失败",a),[2,u.find(function(t){return(null==t?void 0:t.pid)===e})]}})})},t.prototype.initRepository=function(){var t=this.getRepository(),e=this.options.database;t.init(e)},t.prototype.clearExpiredLog=function(){var t,e;null===(e=(t=this.repository).deleteByTs)||void 0===e||e.call(t,0,Date.now()-864e6)},t.prototype.filterSessionReportedLogs=function(t,e){var r=this,o=t.filter(function(t){return t.ts>=(r.reportedSessionLogMaxTs[e]||0)}),n=o.sort(function(t,e){return((null==e?void 0:e.ts)||0)-((null==t?void 0:t.ts)||0)})[0].ts;return this.reportedSessionLogMaxTs[e]=n,o},t}();var S,L,O=(function(t){var e=function(){var t=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",o={};function n(t,e){if(!o[t]){o[t]={};for(var r=0;r<t.length;r++)o[t][t.charAt(r)]=r}return o[t][e]}var i={compressToBase64:function(t){if(null==t)return"";var r=i._compress(t,6,function(t){return e.charAt(t)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:i._decompress(t.length,32,function(r){return n(e,t.charAt(r))})},compressToUTF16:function(e){return null==e?"":i._compress(e,15,function(e){return t(e+32)})+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:i._decompress(t.length,16384,function(e){return t.charCodeAt(e)-32})},compressToUint8Array:function(t){for(var e=i.compress(t),r=new Uint8Array(2*e.length),o=0,n=e.length;o<n;o++){var s=e.charCodeAt(o);r[2*o]=s>>>8,r[2*o+1]=s%256}return r},decompressFromUint8Array:function(e){if(null==e)return i.decompress(e);for(var r=new Array(e.length/2),o=0,n=r.length;o<n;o++)r[o]=256*e[2*o]+e[2*o+1];var s=[];return r.forEach(function(e){s.push(t(e))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":i._compress(t,6,function(t){return r.charAt(t)})},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),i._decompress(t.length,32,function(e){return n(r,t.charAt(e))}))},compress:function(e){return i._compress(e,16,function(e){return t(e)})},_compress:function(t,e,r){if(null==t)return"";var o,n,i,s={},u={},a="",c="",l="",p=2,h=3,f=2,d=[],v=0,y=0;for(i=0;i<t.length;i+=1)if(a=t.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=h++,u[a]=!0),c=l+a,Object.prototype.hasOwnProperty.call(s,c))l=c;else{if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(o=0;o<f;o++)v<<=1,y==e-1?(y=0,d.push(r(v)),v=0):y++;for(n=l.charCodeAt(0),o=0;o<8;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1}else{for(n=1,o=0;o<f;o++)v=v<<1|n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n=0;for(n=l.charCodeAt(0),o=0;o<16;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1}0==--p&&(p=Math.pow(2,f),f++),delete u[l]}else for(n=s[l],o=0;o<f;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1;0==--p&&(p=Math.pow(2,f),f++),s[c]=h++,l=String(a)}if(""!==l){if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(o=0;o<f;o++)v<<=1,y==e-1?(y=0,d.push(r(v)),v=0):y++;for(n=l.charCodeAt(0),o=0;o<8;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1}else{for(n=1,o=0;o<f;o++)v=v<<1|n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n=0;for(n=l.charCodeAt(0),o=0;o<16;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1}0==--p&&(p=Math.pow(2,f),f++),delete u[l]}else for(n=s[l],o=0;o<f;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1;0==--p&&(p=Math.pow(2,f),f++)}for(n=2,o=0;o<f;o++)v=v<<1|1&n,y==e-1?(y=0,d.push(r(v)),v=0):y++,n>>=1;for(;;){if(v<<=1,y==e-1){d.push(r(v));break}y++}return d.join("")},decompress:function(t){return null==t?"":""==t?null:i._decompress(t.length,32768,function(e){return t.charCodeAt(e)})},_decompress:function(e,r,o){var n,i,s,u,a,c,l,p=[],h=4,f=4,d=3,v="",y=[],g={val:o(0),position:r,index:1};for(n=0;n<3;n+=1)p[n]=n;for(s=0,a=Math.pow(2,2),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;switch(s){case 0:for(s=0,a=Math.pow(2,8),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;l=t(s);break;case 1:for(s=0,a=Math.pow(2,16),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;l=t(s);break;case 2:return""}for(p[3]=l,i=l,y.push(l);;){if(g.index>e)return"";for(s=0,a=Math.pow(2,d),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;switch(l=s){case 0:for(s=0,a=Math.pow(2,8),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;p[f++]=t(s),l=f-1,h--;break;case 1:for(s=0,a=Math.pow(2,16),c=1;c!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=r,g.val=o(g.index++)),s|=(u>0?1:0)*c,c<<=1;p[f++]=t(s),l=f-1,h--;break;case 2:return y.join("")}if(0==h&&(h=Math.pow(2,d),d++),p[l])v=p[l];else{if(l!==f)return null;v=i+i.charAt(0)}y.push(v),p[f++]=i+v.charAt(0),i=v,0==--h&&(h=Math.pow(2,d),d++)}}};return i}();null!=t&&(t.exports=e)}(S={exports:{}},S.exports),S.exports);function A(t,e,r){return t>=e&&t<=r}!function(t){t[t.INITING=0]="INITING",t[t.INITED=1]="INITED",t[t.FAILED=2]="FAILED"}(L||(L={}));var P="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:w,k=function(){try{return!!(P.indexedDB&&P.IDBTransaction&&P.IDBKeyRange)}catch(t){return!1}}(),q=function(){function t(){this.pool=[],this.cacheLogSet=new Set,this.status=L.INITING}return t.prototype.init=function(e){var r=this;if(this.dbName=e,!t.support)return this.throwError("unSupportIndexedDB");this.openDbTimeout=setTimeout(function(){r.throwError("indexeddb_init_blocked_timeout"),r.consumePool(r.pool)},6e4);var o=P.indexedDB.open(e,1);o.onsuccess=function(t){clearTimeout(r.openDbTimeout),r.db=t.target.result;var e=r.db;e.onclose=function(t){return r.throwError("indexeddb_init_success_onclose",t)},e.onabort=function(t){return r.throwError("indexeddb_init_success_onabort",t)},e.onerror=function(t){return r.throwError("indexeddb_init_success_onerror",t)},r.status=L.INITED,r.consumePool(r.pool)},o.onupgradeneeded=function(t){var e;clearTimeout(r.openDbTimeout),r.db=null===(e=null==t?void 0:t.target)||void 0===e?void 0:e.result;var o=r.db;if(!o)return r.throwError("onupgradeneeded_is_null"),void r.consumePool(r.pool);o.objectStoreNames.contains("logs")||o.createObjectStore("logs",{autoIncrement:!0}).createIndex("_s","_s",{unique:!1})},o.onblocked=function(){clearTimeout(r.openDbTimeout),r.throwError("indexeddb_init_blocked"),r.consumePool(r.pool)},o.onerror=function(t){var e,o;clearTimeout(r.openDbTimeout),r.throwError("protocol_indexeddb_is_prevented"),r.consumePool(r.pool);var n=null===(o=null===(e=null==t?void 0:t.target)||void 0===e?void 0:e.error)||void 0===o?void 0:o.name;"VersionError"!==n&&"QuotaExceededError"!==n||r.destroy()}},t.prototype.insert=function(e){var r=this;if(this.cacheLogSet.add(e),this.status===L.INITING)return this.pool.push(function(){return r.insert(e)});this.status!==L.FAILED&&(t.count=t.count+1,t.count>t.maxCount?console.warn("[wl]本次访问到达上限日志数: "+t.maxCount):this.getObjectStore().add(function(t){return{_s:t.sessionId,_t:t.ts,_n:t.type,data:O.compressToEncodedURIComponent(I({level:t.level,msg:t.msg}))}}(e)).onsuccess=function(){return o(r,void 0,void 0,function(){return n(this,function(t){return this.cacheLogSet.delete(e),[2]})})})},t.prototype.queryByTs=function(t,e){var r=this;return new Promise(function(i){if(r.status===L.INITING)return r.pool.push(function(){return o(r,void 0,void 0,function(){var r;return n(this,function(o){switch(o.label){case 0:return[4,this.queryByTs(t,e)];case 1:return r=o.sent(),i(r),[2]}})})});if(r.status===L.FAILED){var s=Array.from(r.cacheLogSet).filter(function(r){return A(r.ts,t,e)});return i(s)}var u=[];r.getObjectStore().openCursor().onsuccess=function(o){var n=o.target.result;if(n){if(!n.value||!A(n.value._t,t,e))return n.continue();u.push(function(t){void 0===t&&(t={});var e={},r=t.data,o=t._t,n=t._s,i=t._n;try{var s=O.decompressFromEncodedURIComponent(r);e=s&&JSON.parse(s)}catch(t){}return e.ts=o,e.sessionId=n,e.type=i,e}(n.value)),n.continue()}else{var s=Array.from(r.cacheLogSet).filter(function(r){return A(r.ts,t,e)});console.log("queryByTs",r.cacheLogSet.size,u.length),i(u.concat(s))}}})},t.prototype.queryBySessionId=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=Date.now()),o(this,void 0,void 0,function(){return n(this,function(o){switch(o.label){case 0:return console.log("[db]queryBySessionId",t,e,r),[4,this.queryByTs(e,r)];case 1:return[2,o.sent().filter(function(e){return e.sessionId===t})]}})})},t.prototype.deleteByTs=function(e,r){var o=this;if(this.status===L.INITING)return this.pool.push(function(){return o.deleteByTs(e,r)});if(this.status!==L.FAILED){var n=this.getObjectStore(),i=n.openCursor(),s=0;i.onsuccess=function(e){var i=e.target.result;if(null==i?void 0:i.value){if(i.value._t<r?n.delete(i.primaryKey):i.value.data&&(s+=i.value.data.length),s<t.maxDbSize)return i.continue();o.destroy()}},i.onerror=function(t){return o.throwError("unable_to_locate_logs_earlier",t.target.error)}}},t.prototype.close=function(){var t;this.status=L.FAILED,null===(t=this.db)||void 0===t||t.close()},t.prototype.destroy=function(){var t,e=this;this.status=L.FAILED,null===(t=this.db)||void 0===t||t.close();var r=P.indexedDB.deleteDatabase(this.dbName);r.onerror=function(t){return e.throwError("destroy_error",t.target.error)},r.onsuccess=function(t){}},t.prototype.getObjectStore=function(){var t=this,e=this.db.transaction(["logs"],"readwrite");return e.onerror=function(e){return e.stopPropagation(),t.throwError("indexeddb_record_transaction",e.target.error)},e.onabort=function(e){var r;e.stopPropagation(),t.throwError("indexeddb_record_transaction_onabort",e.target.error),"QuotaExceededError"===(null===(r=e.target.error)||void 0===r?void 0:r.name)&&t.destroy()},e.objectStore("logs")},t.prototype.consumePool=function(t){void 0===t&&(t=[]);var e=t.shift();try{for(;e;)e.apply(this),e=t.shift()}catch(t){this.throwError("consumePool")}},t.prototype.throwError=function(t,e){this.status=L.FAILED,console.warn("[wl]db throw error",t,e)},t.maxDbSize=104857600,t.maxCount=1e4,t.count=0,t.support=k,t}(),D={BrowserMainThreadNetwork:h("BrowserMainThreadNetwork",["get","post"])},C=function(){function t(t,e){this.reportKeyResult={},this.context=t,this.network=e}return t.prototype.getReportConfig=function(t,e){return this.network.post({url:"https://at.idqqimg.com/api/v1/open/log_report_whitelist",param:{uid:e,pid:t},contentType:"json",timeout:1e5})},t.prototype.canReport=function(t,e){var r,o,n=this,i=null===(r=null==e?void 0:e.query)||void 0===r?void 0:r.pid;if(void 0!==this.reportKeyResult[t]&&"USER_REPORT"!==t&&!i)return Promise.resolve(this.reportKeyResult[t]);var s=(null===(o=null==e?void 0:e.query)||void 0===o?void 0:o.pid)||this.context.getPID();return this.network.post({url:"https://at.idqqimg.com/api/v1/open/report",param:{key:t,type:"log",value:JSON.stringify({options:e,uid:this.context.getUID(),pid:s,v:this.context.version})}}).then(function(e){var r=!!e.result;return n.reportKeyResult[t]=r,r}).catch(function(t){return console.error(t),!1})},t.prototype.report=function(t,e){console.log("report log",t);for(var r=t.logs,o=void 0===r?[]:r,n=t.fragmentId,i=t.searchType,s=t.reserve2,u=t.isUserReport,a=o.length?["ts","sessionId","level","msg","reserve1"]:[],c=function(t){return t.map(function(t){if(t.data){var e=t.data||[];e.unshift(t.msg),t.msg=JSON.stringify(e)}return{ts:t.ts,sessionId:t.sessionId,level:t.level,msg:String(t.msg),type:t.type}})}(o).map(function(t){return[t.ts,t.sessionId,t.level,t.msg,t.type]}),l=[],p=c.length,h=function(t){var r=c.slice(t,t+20),o={uid:f.context.getUID(),pid:e||f.context.getPID(),field:a,from:i,reserve2:s,isUserReport:u,fragmentId:t+20>=p?n:0,log:r},h=f.network.post({url:"https://at.idqqimg.com/api/v1/open/log",param:{lz:O.compressToEncodedURIComponent(JSON.stringify(o))}}).catch(function(t){return console.error(o),t});l.push(h)},f=this,d=0;d<=p;d+=20)h(d);return Promise.all(l)},t}();function N(){var t,e={on:(t=new T).on.bind(t,"message"),fire:t.emit.bind(t,"message")};return self.onmessage=function(t){var r=t.data;e.fire(r)},{onMessage:e.on,send:function(t){self.postMessage(t)}}}new(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.setupProtocol=function(){return N()},e}(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.setupRepository=function(){return new q},e.prototype.setupTransport=function(t){return new C(t,this.rpcProtocol.getProxy(D.BrowserMainThreadNetwork))},e}(_)))});
