self.window=self,window.jsExecStartTimeStamp=Date.now(),(self.webpackChunk_tencent_alloy_builder=self.webpackChunk_tencent_alloy_builder||[]).push([["bundle_messageService"],{"../spread-sheet/src/core/network/message-center/adapter/MessageCenterAdapter.interface.ts":function(e,t,n){n.d(t,{s:function(){return r}});var r=(0,n("../node_modules/@tencent/containerized/build/main/index.js").yh)("IMessageCenterAdapter");t.Z=r},"../spread-sheet/src/core/network/message-center/utils/report.ts":function(e,t,n){n.d(t,{CL:function(){return s},ND:function(){return a},qB:function(){return i}}),n("../node_modules/core-js/modules/es.object.assign.js");var r=n("../packages/report/src/index.ts"),o=n("../spread-sheet/src/base/config/report.ts"),i={101:33612294,102:33612295,103:33612296,104:33612297,105:33612298,106:33612299,1e4:33612314,10001:33612323,4e4:33612311,40001:33612312,40002:33612315,40003:33612316,40004:35508627,40005:33612317,40006:33712774,40020:33612313,40021:33612318,40022:33612319,40023:33612320,40024:33688491,40025:33688492,40026:33688493,40027:33713210,40028:33688494,40029:34872598,40030:34872599,40031:35508628,40032:35508629,40033:35508630,40034:34786084,40035:34642726,40036:34846274,40037:34884339,40100:34872600,40203:35183585,41001:33612321,41002:33612322,40200:35508632,40204:35508633,40205:35508634,60007:33612290,60018:33612308,60019:33612309,60020:33612310,6e4:33712329,60002:33612280,60003:33612286,60004:33612281,60005:33612282,60006:33713563,60008:33612287,60010:33686978,60011:33612283,60013:33612284,60014:33612285,60015:33612291,60016:33612288,60017:33612289,60021:33631110,60022:33631111,60030:35454579,60031:35463395,60032:35463396,60033:35463397},a=Object.assign(Object.assign({},i),{40203:35183586}),s={socketShutdown:function(e){60010!==e&&"INACTIVE"!==e&&r.ZP.zzsStatus({attrid:o.ZZS_REPORT_ATTR.SOCKET_SHUTDOWN,status:1,dimensions:e})}}},"../spread-sheet/src/external/templateinfo/sync-template.ts":function(e,t,n){n.d(t,{D:function(){return d}}),n("../node_modules/regenerator-runtime/runtime.js"),n("../node_modules/core-js/modules/es.object.to-string.js"),n("../node_modules/core-js/modules/es.promise.js");var r=n("./node_modules/axios/index.js"),o=n.n(r),i=n("../spread-sheet/src/core/data/configService/spreadConfig.ts"),a=n("../packages/utils/src/safe.ts"),s=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))};function d(){var e;return s(this,void 0,void 0,regeneratorRuntime.mark((function t(){var r,s;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(12!==i.q.getConfig("docStatus")){t.next=17;break}return i.q.setConfig({docStatus:0}),t.prev=2,(s=new FormData).append("domain_id",i.q.getConfig("domainId")),s.append("pad_id",i.q.getConfig("padId")),s.append("xsrf",(0,a.f)()),t.next=9,o()({method:"post",url:"/cgi-bin/online_docs/doc_humtrans",data:s,headers:{"Content-Type":"multipart/form-data"}});case 9:r=t.sent,t.next=15;break;case 12:t.prev=12,t.t0=t.catch(2),console.error(t.t0);case 15:return 0===(null===r||void 0===r?void 0:r.data.retcode)&&(null===(e=n.g.SLR)||void 0===e||e.dispatch("DOC_HUMTRANS_DONE")),t.abrupt("return",0===(null===r||void 0===r?void 0:r.data.retcode));case 17:return t.abrupt("return",!0);case 18:case"end":return t.stop()}}),t,null,[[2,12]])})))}},"../spread-sheet/src/external/waterMark/config.ts":function(e,t,n){n.d(t,{a:function(){return r}});var r=!0},"../spread-sheet/src/flow/browser/phase/services/messageService.ts":function(e,t,n){n.r(t),n.d(t,{default:function(){return wt}}),n("../node_modules/regenerator-runtime/runtime.js"),n("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),n("../node_modules/core-js/modules/esnext.reflect.metadata.js"),n("../node_modules/core-js/modules/es.object.to-string.js"),n("../node_modules/core-js/modules/es.promise.js"),n("../node_modules/core-js/modules/es.regexp.exec.js"),n("../node_modules/core-js/modules/es.string.replace.js");var r=n("../spread-sheet/src/core/app/SpreadsheetApp.interface.ts"),o=n("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),i=n("../node_modules/@babel/runtime/helpers/esm/inheritsLoose.js"),a=(n("../node_modules/core-js/modules/es.array.iterator.js"),n("../node_modules/core-js/modules/es.map.js"),n("../node_modules/core-js/modules/es.string.iterator.js"),n("../node_modules/core-js/modules/esnext.map.delete-all.js"),n("../node_modules/core-js/modules/esnext.map.every.js"),n("../node_modules/core-js/modules/esnext.map.filter.js"),n("../node_modules/core-js/modules/esnext.map.find.js"),n("../node_modules/core-js/modules/esnext.map.find-key.js"),n("../node_modules/core-js/modules/esnext.map.includes.js"),n("../node_modules/core-js/modules/esnext.map.key-of.js"),n("../node_modules/core-js/modules/esnext.map.map-keys.js"),n("../node_modules/core-js/modules/esnext.map.map-values.js"),n("../node_modules/core-js/modules/esnext.map.merge.js"),n("../node_modules/core-js/modules/esnext.map.reduce.js"),n("../node_modules/core-js/modules/esnext.map.some.js"),n("../node_modules/core-js/modules/esnext.map.update.js"),n("../node_modules/core-js/modules/web.dom-collections.iterator.js"),n("../node_modules/core-js/modules/es.array.map.js"),n("../node_modules/core-js/modules/web.dom-collections.for-each.js"),n("../node_modules/core-js/modules/es.array.concat.js"),n("../node_modules/@tencent/docs-collab/lib/src/messageCenter/index.js")),s=n("../node_modules/@tencent/docs-connection/lib/feature/index.js"),d=n("../spread-sheet/src/base/event/event.ts"),l=n("../spread-sheet/src/core/network/message-center/model/PendingControl.ts"),u=n("../packages/model/src/spreadsheet/SpreadsheetType.ts"),c=(n("../node_modules/core-js/modules/es.object.assign.js"),n("../node_modules/core-js/modules/es.array.find.js"),n("../packages/report/src/index.ts")),h=n("../spread-sheet/src/base/config/report.ts"),p=n("../spread-sheet/src/core/network/message-center/model/UserChange.ts"),f=n("../spread-sheet/src/base/error/errorCodeModalProxy.ts"),g=n("../spread-sheet/src/core/app/lazytool/index.ts"),v=n("../packages/lib/index.ts"),m=n("../spread-sheet/src/core/network/message-center/model/userChange-helper.ts");function C(e,t,n){var r,o=null!==(r=e.changeset)&&void 0!==r?r:"[[]]",i={globalPadId:t,status:n,sheetId:e.subId,baseVersion:e.baseRev,data:{changesetType:e.changesetType,mutations:JSON.parse(o),head:e.head,taskId:e.taskId,keyData:e.keydata},time:e.time,isOfflineMessage:e.offlineMsg};return new p.Z(i)}n("../node_modules/core-js/modules/es.array.filter.js");var b=function(){function e(e,t){var r=this;this.needKeyDataFlagMap=new Map,this._onUserChangeNew=new v.Q5,this.onUserChangeNew=this._onUserChangeNew.event,this._onAfterApplyNewChanges=new v.Q5,this.onAfterApplyNewChanges=this._onAfterApplyNewChanges.event,this._onAcceptCommit=new v.Q5,this.onAcceptCommit=this._onAcceptCommit.event,this._onShutDown=new v.Q5,this.onShutDown=this._onShutDown.event,this._onUserChangeCommit=new v.Q5,this.onUserChangeCommit=this._onUserChangeCommit.event,this._onCommitWithErrorCode=new v.Q5,this.onCommitWithErrorCode=this._onCommitWithErrorCode.event,this.handleAfterApplyNewChanges=function(e){var t=e.changeInfo;r._onAfterApplyNewChanges.fire({changeInfo:t})},this.handleBeforeApplyNewChanges=function(e){var t,o=e.changeInfo,i=e.changes;if(o.isNeedKeyframe&&!r.needKeyDataFlagMap.get(o.sheetId)&&r.app.spreadsheet.activeSheetId===o.sheetId&&r.needKeyDataFlagMap.set(o.sheetId,o.isNeedKeyframe),r.isChangeTitleMessage(i)){r.messageCenter.versionManager.updateVersion(o.newVersion);try{r.app.spreadsheet.setTitle(i[0].d,!0)}catch(a){null===(t=n.g.log)||void 0===t||t.error("应用title失败")}o.isValid=!1}},this.containerID=n.g.containerID,this.app=e,this.messageCenter=t,this._initEventListeners()}var t=e.prototype;return t.addUserChange=function(e){var t,r=e.sheetId,o=e.taskId,i=e.data,a=e.head,s=e.isWorkbook,d=void 0!==s&&s,l=e.oSubId,u=e.withKeyData,f=void 0!==u&&u,v=e.isOfflineMessage,C=void 0!==v&&v,b=e.keyframe,E=void 0===b?null:b,w=e.createTime,O=void 0===w?Date.now():w,S=e.syncToOffline,_=void 0===S||S,k=e.changesetType,y=e.onSuccess;(null===(t=n.g.clientVars)||void 0===t?void 0:t.hotDocs)&&"OPENED"!==this.messageCenter.networkStatusManager.getRoomStatus()&&this.messageCenter.openRoom(),this.messageCenter.networkStatusManager&&"OPENED"===this.messageCenter.networkStatusManager.getRoomStatus()||(console.warn("!isOfflineMessage && this.app.networkStatus.setSocketOnline(false)"),this.app.messageCenterAdapter.socketAdapter.onceOpened&&!C&&this.app.networkStatus.setSocketOnline(!1));var R=null,T={globalPadId:this.app.spreadsheet.getSpreadsheetId(),sheetId:r,baseVersion:this.messageCenter.versionManager.getCurrentVersion(),data:{taskId:o,changesetType:k},isOfflineMessage:C,time:O};if(a&&(T.data.head=!0,T.data.oSubId=l),d&&(T.data.isWorkbook=!0),(R=new p.Z(T)).setOrAppendMutations(i),f||this.needKeyDataFlagMap.get(r)){var I=(0,g.createZipKeyframe)(r);this.needKeyDataFlagMap.delete(r),R.setKeyData(I||null)}else E&&R.setKeyData(E);if(this._onUserChangeNew.fire({userChange:R,syncToOffline:_}),c.ZP.run(h.CONFIG.ADD_USER_CHANGE,[this.containerID,r,R.taskId,f,R.isWithKeyData(),a,l,null===i||void 0===i?void 0:i.length]),function(e){e.mutations=e.mutations.map((function(e){return e.filter((function(e){var t;return!(null===(t=e.isNonPersistedLocalChange)||void 0===t?void 0:t.call(e))}))}))}(R),R.changeData||String(R.mutations)){var D=JSON.parse((0,m.HJ)(R));this.messageCenter.addUserChange(Object.assign(Object.assign({},D),{baseVersion:D.baseRev,onSuccess:y}))}},t.acceptCommit=function(e,t,n){var r=n.offlineMsg?"acceptOfflineCommit":"acceptCommit",o=n.taskId,i=n.isNeedKeyframe;c.ZP.run(h.CONFIG.ACCEPT_COMMIT_2,[this.containerID,e,t,i,o],r),!this.needKeyDataFlagMap.get(e)&&i&&this.needKeyDataFlagMap.set(e,i),this._onAcceptCommit.fire({sheetId:e,newVersion:t,userChange:C(n,this.app.spreadsheet.getSpreadsheetId(),p.t.ACCEPT)}),d.ZP.network.trigger("commitSuccess"),d.ZP.notificationCenter.trigger("localChangeContentExcelEdit")},t.hasUncommittedChanges=function(e){var t=this.messageCenter.localUserChangeManager.getCommitingQueue(),n=this.messageCenter.localUserChangeManager.getWaitingQueue(),r=[].concat((0,o.Z)(t),(0,o.Z)(n));return e?!!r.find((function(t){var n;return(null===(n=null===t||void 0===t?void 0:t.getOtherOptions())||void 0===n?void 0:n.sheetId)===e})):r.length>0},t.commitError=function(e){var t=e.errorCode,n=e.commitingQueue,r=e.cmd,o=e.result;f.Z.client.showUserChangeSaveFailTip();var i=n.length?C(n[0],this.app.spreadsheet.getSpreadsheetId(),p.t.COMMITING):null;switch(c.ZP.run(h.CONFIG.HANDLE_COMMIT_ERROR,[this.containerID,null===i||void 0===i?void 0:i.taskId,r,o],t,null===i||void 0===i?void 0:i.isOfflineMessage),t){case 102:this.app.event.errorCode.trigger("errorCode",{type:"socket",code:"102"});break;case 103:case 105:break;case 52003:this.app.event.errorCode.trigger("errorCode",{type:"socket",code:"52003"}),this._onShutDown.fire(t);break;case 40006:case 40035:case 60018:case 60019:case 60020:case 40203:case 1e4:case 10001:case 4e4:case 40001:case 40002:case 40003:case 40005:case 40020:case 40022:case 40023:case 40024:case 40025:case 40026:case 40028:case 40030:case 40034:case 40036:case 40037:case 40038:case 40039:case 40100:case 41001:case 41002:case 60003:case 60007:case 60008:case 60016:case 60017:case 60015:case 60002:case 60004:case 60005:case 60011:case 60013:case 60014:case 60021:case 60022:default:this._onShutDown.fire(t);break;case 40021:case 40027:this.app.messageCenterAdapter.receiveMessageCenterAdapter.handleCommitVersionBreak()}this._onCommitWithErrorCode.fire({errCode:t})},t.isChangeTitleMessage=function(e){return"ct"===(null===e||void 0===e?void 0:e[0].type)},t._initEventListeners=function(){var e=this;d.ZP.spreadsheetEvent.listen("onShowHowToHandleDataLostModal",(function(){var t=e.messageCenter.localUserChangeManager.getCommitingQueue(),n=e.messageCenter.localUserChangeManager.getWaitingQueue(),r=[].concat((0,o.Z)(t),(0,o.Z)(n)).length;c.ZP.run(h.CONFIG.CLEAR_OFFLINE_DATA_SIZE,r,[e.containerID,!!t.length,n.length])}))},e}(),E=b,w=n("../spread-sheet/src/core/network/message-center/model/MissChange.ts"),O=n("../packages/mutation/src/MutationOperationType.ts"),S=n("../spread-sheet/src/base/error/index.ts"),_=n("../spread-sheet/src/external/view/workbench/service/create-new-doc.ts"),k=n("../spread-sheet/src/core/behavior/multi-type-follow.ts"),y=function(){function e(e,t){this.applyNewChangesError=!1,this._onBeforeApplyNewChanges=new v.Q5,this.onBeforeApplyNewChanges=this._onBeforeApplyNewChanges.event,this._onAfterApplyNewChanges=new v.Q5,this.onAfterApplyNewChanges=this._onAfterApplyNewChanges.event,this._onAfterApplyCollabMutations=new v.Q5,this.onAfterApplyCollabMutations=this._onAfterApplyCollabMutations.event,this._onShutDown=new v.Q5,this.onShutDown=this._onShutDown.event,this.app=e,this.messageCenter=t,this.containerID=n.g.containerID}var t=e.prototype;return t.isSheetNotReady=function(e,t){return!t||!(!t.isFetching&&(t.isLoaded||e===this.app.spreadsheet.activeSheetId))},t.handleCommitVersionBreak=function(){this.messageCenter.sendMessageManager.commitAfterUpdateVersionToLatest(void 0,0)},t.applyNewChanges=function(e,t){void 0===t&&(t={});var n=e.userChangesOrigin;if(!this.applyNewChangesError){var r,o=new w.Z(e);try{r=JSON.parse(o.changeset)}catch(i){console.error("解析 missChanges 失败",o.changeset)}try{this._onBeforeApplyNewChanges.fire({changeInfo:o,changes:r,changesOrigin:n,extra:t})}catch(i){return}o.isValid&&(o.newVersion<=this.messageCenter.versionManager.getCurrentVersion()?c.ZP.run(h.CONFIG.APPLY_NEWCHANGES_VERROR,[this.containerID,n,o],n):(this.app.requestApi.applyCollab({sheetId:o.sheetId,requestId:-1,canUndoRedo:!1,opt:{changeInfo:o,changes:r}}),this._onAfterApplyNewChanges.fire({changeInfo:o})))}},t.onApplyNewChanges=function(e){var t=e.changeInfo,n=e.mutations;try{t.revert||this.applyCollabMutations(n,t),this.messageCenter.versionManager.updateVersion(t.newVersion),c.ZP.run(h.CONFIG.APPLY_NEWCHANGES,[this.containerID,t.newVersion])}catch(r){this.applyError(t,r)}},t.applyCollabMutations=function(e,t){var n=t.sheetId,r=t.newVersion,o=t.head,i=t.isWorkbook,a=t.changesetType,s=this.app.spreadsheet.sheetManager.getSheetBySheetId(n);if(o||i||s&&0!==e.length){var d=(0,k.C6)(a,e),l=[];(d={newVersion:r,requestMutations:d}.requestMutations).forEach((function(e){l=l.concat(e)})),(o||i||!this.isSheetNotReady(n,s))&&(this.applyInUndoRedo(n,l,a),(0,k.fM)(l,a)),this._onAfterApplyCollabMutations.fire({changeInfo:t,mutations:l})}},t.applyError=function(e,t){c.ZP.run(h.CONFIG.APPLY_NEWCHANGES_CATCH_ERROR,[this.containerID,e,t]),this.applyNewChangesError=!0,this._onShutDown.fire(S.B.APPLY_NEW_CHANGE_ERROR)},t.applyInUndoRedo=function(e,t,n){var r=_.Jz[_.$e.sheet];"smartsheet"===n&&(r="smartsheet");var o=this.app.undoredoStack.createUndoRedoMutations({docType:r,sheetId:e,isLocal:!1});o.add(t),this.app.undoredoStack.pushCollab(o)},t.applyInDataAndView=function(e){var t=this;e.forEach((function(e){e.operationType=O.Z.COLLAB,t.app.mutationBehavior.applyMutation(e,{isLocal:!1,isCollab:!0})}))},e}(),R=y,T=n("../spread-sheet/src/core/network/message-center/base/BaseMessageCenterAdapter.ts"),I=(n("../node_modules/core-js/modules/es.string.match.js"),n("../node_modules/core-js/modules/es.array.slice.js"),n("../node_modules/@tencent/dui/lib/components/Snackbar/index.js")),D=(n("../node_modules/@tencent/dui-mobile/lib/components/Snackbar/index.js"),n("../node_modules/@tencent/ark-utils/lib/types/index.js")),x=n("../node_modules/i18next/dist/esm/i18next.js"),A=n("../spread-sheet/src/core/ui/toast/index.ts"),N=n("../node_modules/@tencent/docs-connection/lib/index.js"),P=n("../spread-sheet/src/core/data/configService/spreadConfig.ts"),M=n("../packages/common-utils/src/index.ts"),L=n("../node_modules/@tencent/docs-user-agent/dist/index.js"),F=n.n(L),Z=n("../spread-sheet/src/base/util/timer.ts"),j=n("../node_modules/@tencent/docs_offline/lib/index.js"),U=n("../spread-sheet/src/core/utils/config.ts"),V=n("../spread-sheet/src/external/waterMark/config.ts"),G=n("../spread-sheet/src/core/utils/relate/relate.ts"),B=n("../spread-sheet/src/core/utils/relate/RelateType.ts"),H=n("../spread-sheet/src/external/offline-edit/clear-type.ts"),q=n("../spread-sheet/src/core/utils/offline-env.ts"),W=n("../packages/utils/src/safe.ts"),z=n("./node_modules/axios/index.js"),Y=n.n(z),K=n("../spread-sheet/src/core/network/message-center/utils/report.ts"),Q=n("../spread-sheet/src/external/tencentMeeting/utils.ts"),J=n("../spread-sheet/src/flow/common/utils.ts"),X=n("../spread-sheet/src/base/util/domain-config.ts"),ee=n("../spread-sheet/src/base/log/production-log.ts"),te=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},ne=function(e,t){var n=/^\d+\.\d+/gi,r=e.match(n),o=t.match(n);return!(!r||!o)&&(e=r[0])===(t=o[0])};function re(e,t){var n,r,o;if(!this.hadShowOfflineTip)return(null===(o=null===(r=null===(n=this.app.view)||void 0===n?void 0:n.canvas)||void 0===r?void 0:r.inputManager)||void 0===o?void 0:o.isInputtingState())?(f.Z.client.showNetworkOfflineTip(e,t),void(this.hadShowOfflineTip=!0)):void 0}var oe,ie,ae=[{errorcode:"60000",monitor:K.qB[6e4]},{errorcode:"60001"},{errorcode:"60002",monitor:K.qB[60002]},{errorcode:"60003",monitor:K.qB[60003]},{errorcode:"60004",monitor:K.qB[60004]},{errorcode:"60005"},{errorcode:"60006",monitor:K.qB[60006]},{errorcode:"60007",monitor:K.qB[60007]},{errorcode:"60008",monitor:K.qB[60008]},{errorcode:"60010",monitor:K.qB[60010]},{errorcode:"60011",monitor:K.qB[60011]},{errorcode:"60013",monitor:K.qB[60013]},{errorcode:"60014",monitor:K.qB[60014]},{errorcode:"60015",monitor:K.qB[60015]},{errorcode:"60016"},{errorcode:"60017",monitor:K.qB[60017]},{errorcode:"INACTIVE",monitor:33712576},{errorcode:"60018",monitor:K.qB[60018]},{errorcode:"60019",monitor:K.qB[60019]},{errorcode:"60020",monitor:K.qB[60020]},{errorcode:"60021",monitor:K.qB[60021]},{errorcode:"60022",monitor:K.qB[60022]},{errorcode:"60030",monitor:K.qB[60030]},{errorcode:"60031",monitor:K.qB[60031]},{errorcode:"60032",monitor:K.qB[60032]},{errorcode:"60033",monitor:K.qB[60033]},{errorcode:"40000"},{errorcode:"40001"},{errorcode:"40002"},{errorcode:"40003"},{errorcode:"40005"},{errorcode:"40006",monitor:K.qB[40006]},{errorcode:"40020"},{errorcode:"40022"},{errorcode:"40023"},{errorcode:"40024"},{errorcode:"40025"},{errorcode:"40026"},{errorcode:"40028"},{errorcode:"40029"},{errorcode:"40030"},{errorcode:"40034"},{errorcode:"40035",monitor:K.qB[40035]},{errorcode:"40036"},{errorcode:"40037"},{errorcode:"40038"},{errorcode:"40039"},{errorcode:"40203"},{errorcode:"41001"},{errorcode:"41002"},{errorcode:"10000"},{errorcode:"10001"},{errorcode:"70001"},{errorcode:"64010"}],se=[{errorcode:S.B.SOCKET_NOT_SET_UP},{errorcode:S.B.PERMISSION_CHANGE},{errorcode:S.B.APPLY_NEW_CHANGE_ERROR},{errorcode:S.B.KICK},{errorcode:S.B.MUTATION_SHEET_ID_NOT_MATCH_SHEET},{errorcode:S.B.DATABASE_ERROR},{errorcode:S.B.TASK_RUN_ERROR},{errorcode:S.B.FRONTEND_SOCKET_ERROR_CODE_UNDEFINED},{errorcode:S.B.COMMIT_ERROR_CODE_UNDEFINED},{errorcode:S.B.TASK_DUPLICATE_VERSION_TOO_LOW}],de=function(){function e(e,t){var r,o,i=this;if(this.onceOpened=!1,this.hadShowOfflineTip=!1,this.isOpenRoomTimeout=!1,this.loopTimer=0,this.loopFailCount=0,this.startLoop=function(e){i.loopTimer&&n.g.clearInterval(i.loopTimer);var t=e?1e3*e:void 0;i.loopTimer=n.g.setInterval(i.fetchData,t||5e3)},this.endLoop=function(){i.loopTimer&&(n.g.clearInterval(i.loopTimer),i.loopTimer=0,i.loopFailCount=0)},this.fetchData=function(){if(i.loopFailCount>=3)return i.endLoop(),void I.default.show({type:"info",message:x.ZP.t("文档开小差了，刷新后更新最新内容"),duration:3e3});var e=i.app.spreadsheet.activeSheetId,t="/dop-api/querydata?padid="+P.q.getConfig("globalPadId")+"&type=sheet&subid="+e;t+="&xsrf="+(0,W.f)(),t+="&room=1",c.ZP.monitor(35662116),Y()({method:"get",url:t,responseType:"json"}).then((function(e){var t=null===e||void 0===e?void 0:e.data;(null===t||void 0===t?void 0:t.queryDataInterval)&&i.startLoop(null===t||void 0===t?void 0:t.queryDataInterval),0===(null===t||void 0===t?void 0:t.retcode)?(i.loopFailCount=0,i.app.event.spreadsheetEvent.trigger("syncLatestData",t.rev)):(i.loopFailCount+=1,i.reportFetchDataFail())})).catch((function(e){n.g.log.error("Loop fetchData ERROR: "+JSON.stringify(e)),i.loopFailCount+=1,i.reportFetchDataFail()}))},null===(r=n.g.log)||void 0===r||r.info("flow MessageService new SocketAdapter()"),this.app=e,this.messageCenter=t,this.containerID=n.g.containerID,!n.g.WebSocket||!n.g.WebSocket.prototype||!n.g.WebSocket.prototype.send)return o=F().isIOS?3078272:F().isAndroid?3078271:3078270,void c.ZP.monitor(o);this.loopProbe()}var t=e.prototype;return t.dispose=function(){this.destroy()},t.destroy=function(){var e;null===(e=n.g.log)||void 0===e||e.debug("flow socket destroy()",this.containerID),this.messageCenter.shutDown("LOAD_NEW_DOC"),this.onceOpened=!1,this.hadShowOfflineTip=!1,this.offlineSnackbar=void 0},t.restart=function(){this.init()},t.handleRevert=function(){(0,A.showToast)(x.ZP.t("文档已被还原"),{},{supportMobile:!0,toolToastCloseTime:2e3}),Z.Z.wait(2e3).run((function(){n.g.location.reload()}))},t.hideOfflineTips=function(){var e,t;null===(t=null===(e=this.offlineSnackbar)||void 0===e?void 0:e.close)||void 0===t||t.call(e)},t.init=function(){var e,t;(null===(e=n.g.clientVars)||void 0===e?void 0:e.querydata)&&(this.startLoop(),this.messageCenter.eventManager.onRoomOpen(this.endLoop)),(null===(t=n.g.clientVars)||void 0===t?void 0:t.hotDocs)||this.messageCenter.openRoom()},t.reopenAfterShutdown=function(){this.messageCenter.forceResume(),this.messageCenter.reConnect()},t.handleSocketOpen=function(){this.onceOpened=!0},t.handleRoomStateChange=function(e){var t=e.status,n=e.moreInfo;c.ZP.run(h.CONFIG.ROOM_STATE_CHANGE,[t,n],t);var r=a.RoomState.RECONNECTING_IN_CLOSED,o=a.RoomState.OPENED;switch(t){case r:c.ZP.monitor(33612136),this.handleOffline(n);break;case o:this.handleOnline()}},t.handleShutDown=function(e,t){var r,o;if(K.CL.socketShutdown(null!==t&&void 0!==t?t:e),e!==a.REPORT_MONITOR_TYPE.HANDLE_TASK_DUPLICATE_VERSION_ERROR){if(c.ZP.run(h.CONFIG.HANDLE_SHUTDOWN,t||e),!this.isIgnoreHandleShutDown(e,t)&&(this.app.permissions.activeTempStatus(!1),e!==S.B.LONG_TIME_HIDDEN&&t!==N.IBatchCommitChangesResultRetcode.CONTENT_LENGTH_EXCEED_LIMIT)){c.ZP.monitor(33612127),c.ZP.idkey(291727,53),null===(r=n.g.log)||void 0===r||r.info("SocketshutDownCommitingQueue",this.messageCenter.localUserChangeManager.getCommitingQueue()),null===(o=n.g.log)||void 0===o||o.info("SocketshutDownWaitingQueue",this.messageCenter.localUserChangeManager.getWaitingQueue().slice(0,3));for(var i=0;i<ae.length;i++){var s=ae[i];if(-1!==String(t).indexOf(s.errorcode)||-1!==e.indexOf(s.errorcode))return void this.handleErrorCode(s,"socket")}for(var d=0;d<se.length;d++){var l=se[d];if(-1!==e.indexOf(l.errorcode))return void this.handleErrorCode(l,"front")}this.app.event.errorCode.trigger("errorCode",{type:"socket",code:t})}}else this.handleTaskDuplicateVersionTooLow(e)},t.handleMessageFromServer=function(e){var t,n,r,o,i=e.type,a=e.data;"CODEREV_NEW"!==i&&"LAST_REVERSION"!==i&&"RIGHT_MESSAGE"!==i&&"REVERT_MESSAGE"!==i||c.ZP.run(h.CONFIG.ACCEPT_MESSAGE,[i,a]);var s={USER_NEWINFO:this.handleUserNewInfo.bind(this),USER_NEWINFOS:this.handleUserNewInfos.bind(this),USER_LEAVE:this.handleUserLeave.bind(this),USER_LEAVES:this.handleUserLeaves.bind(this),CURSOR_MESSAGES:this.handleCursorMessages.bind(this),RIGHT_MESSAGE:this.handleRightMessage.bind(this),TITLE_MESSAGE:this.handleTitleMessage.bind(this),HANDLE_DELETE:this.handleDeletePad.bind(this),COMM_NOTICE:this.handleCommonNotice.bind(this),CODEREV_NEW:this.handleCodeRevNew.bind(this),REVERT_MESSAGE:this.handleRevert.bind(this),COMMERCIALIZE_MESSAGE:this.handleCommercializeMessage.bind(this),MARK_MESSAGE:this.handleWatermark.bind(this),PRESENT_INFO:this.handlePresentMessage.bind(this),CHANGE_PRESENTER:this.handleChangePresenterMessage.bind(this),UPDATE_FILE_UPLOAD:this.handleUpdateFileUpload.bind(this)},d={CURSOR_MESSAGE:this.handleCursorMessage.bind(this)};if((0,D.isArray)(a)&&0!==a.length){var l=a[0];null===(t=s[i])||void 0===t||t.call(s,l),null===(n=d[i])||void 0===n||n.call(d,a),"READY_ERROR"===i&&40029===(null===(o=null===(r=l.body)||void 0===r?void 0:r.data)||void 0===o?void 0:o.reason)&&this.handleShutDown("",40029)}},t.handleNetReconnectedFail=function(){var e=this;F().isIOS&&!(0,q.j)()&&(re.call(this,this.app.sheetStatus.canEdit&&!this.app.offlineEdit.isDisabled,(function(t){e.offlineSnackbar=t})),c.ZP.monitor(35623017))},t.isUnavailableTimeout=function(){var e;return this.isOpenRoomTimeout&&(null===(e=this.messageCenter.networkStatusManager)||void 0===e?void 0:e.getRoomStatus())!==a.RoomState.OPENED},t.handleTaskDuplicateVersionTooLow=function(e){this.app.permissions.activeTempStatus(!1),d.ZP.spreadsheetEvent.trigger("clearOfflineStore",{type:H.N.UN_COMMITTED}),this.handleErrorCode({errorcode:S.B.TASK_DUPLICATE_VERSION_TOO_LOW},"front"),c.ZP.run(h.CONFIG.TASK_DUPLICATE_VERSION_TOO_LOW,[e])},t.isIgnoreHandleShutDown=function(e,t){return e===S.B.LOAD_NEW_DOC||e===S.B.SOCKET_NOT_SET_UP||1000001===t},t.handleWatermark=function(e){var t;V.a&&d.ZP.network.trigger("newWatermark",null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice)},t.handlePresentMessage=function(e){var t,n,r,o;(0,Q.isFromTencentMeetingSharing)()&&d.ZP.network.trigger("presentData",null===(n=null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice)||void 0===n?void 0:n.syncData,null===(o=null===(r=null===e||void 0===e?void 0:e.body)||void 0===r?void 0:r.notice)||void 0===o?void 0:o.bizid)},t.handleChangePresenterMessage=function(e){var t,n;(0,Q.isFromTencentMeetingSharing)()&&d.ZP.network.trigger("presentData",null===(n=null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice)||void 0===n?void 0:n.syncData)},t.handleUpdateFileUpload=function(e){var t;d.ZP.network.trigger("updateFileUpload",null===(t=e.body)||void 0===t?void 0:t.notices)},t.handleCommercializeMessage=function(e){n.g.CollaboratorListInit?document.dispatchEvent(new CustomEvent("commercializeMessage",{detail:e})):function t(){n.g.CollaboratorListInit?document.dispatchEvent(new CustomEvent("commercializeMessage",{detail:e})):Z.Z.wait(3e3).run((function(){t()}))}()},t.loopProbe=function(){var e=this;P.q.getConfig("isOverConNum")&&!P.q.getConfig("isCreator")||P.q.getConfig("isSnapshot")||P.q.getConfig("isPreview")||P.q.getConfig("isFormPreview")||(0,U.q)()||"D0000000000000001"===P.q.getConfig("upid")||(this.init(),Z.Z.wait(9e4).run((function(){var t,r;if(!(null===(t=n.g.clientVars)||void 0===t?void 0:t.hotDocs)&&(null===(r=e.messageCenter.networkStatusManager)||void 0===r?void 0:r.getRoomStatus())!==a.RoomState.SHUTDOWN&&(!e.messageCenter.networkStatusManager||!e.onceOpened)){var o={attrid:h.ZZS_REPORT_ATTR.NO_SOCKET_AFTER_90S,status:1};e.app.spreadsheet.isExternalSheet()&&(o.project=e.app.spreadsheet.activeSheet.getSheetType()),c.ZP.zzsStatus(o),ee.$.report("NO_SOCKET_AFTER_90S"),c.ZP.run(h.CONFIG.NETWORK_ERROR),e.isOpenRoomTimeout=!0}})))},t.handleUserNewInfo=function(e){var t,n,r;d.ZP.network.trigger("userNewInfo",[null===(t=e.body)||void 0===t?void 0:t.notice],null===(r=null===(n=e.body)||void 0===n?void 0:n.notice)||void 0===r?void 0:r.mem_count)},t.handleUserNewInfos=function(e){d.ZP.network.trigger("userNewInfo",e.body.notices,e.body.mem_count)},t.handleUserLeave=function(e){var t,n,r;d.ZP.network.trigger("userLeave",[null===(t=e.body)||void 0===t?void 0:t.notice],null===(r=null===(n=e.body)||void 0===n?void 0:n.notice)||void 0===r?void 0:r.mem_count)},t.handleUserLeaves=function(e){var t,n;d.ZP.network.trigger("userLeave",null===(t=e.body)||void 0===t?void 0:t.notices,null===(n=e.body)||void 0===n?void 0:n.mem_count)},t.handleCursorMessage=function(e){var t=d.ZP.network;e.forEach((function(e){var n;t.trigger("cursor",[null===(n=e.body)||void 0===n?void 0:n.notice])}))},t.handleCursorMessages=function(e){var t;d.ZP.network.trigger("cursor",null===(t=e.body)||void 0===t?void 0:t.notices)},t.handleRightMessage=function(e){var t;this.notifyRightChange(null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice),this.comparePrivilege()},t.handleTitleMessage=function(e){var t,n;(null===(n=null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice)||void 0===n?void 0:n.title)&&this.app.spreadsheet.setTitle(e.body.notice.title,!0)},t.handleDeletePad=function(){d.ZP.network.trigger("deletePad")},t.handleCommonNotice=function(e){var t,n,r,o=null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice,i=null===(n=null===e||void 0===e?void 0:e.head)||void 0===n?void 0:n.uid,a=P.q.getConfig("uid");if(o){var s={push_message:this.handlePushMessage.bind(this,o),RELOAD:this.handleReloadMessage.bind(this),RANGE_PRIV_CHANGE:this.handleRangeAuthMessage.bind(this,e),ASSOCIATE_DOC:this.handleRelateMessage.bind(this,o.payload,!0,i===a),DISASSOCIATE_DOC:this.handleRelateMessage.bind(this,o.payload,!1),REMINDER_CHANGE:this.handleReminderChange.bind(this,o),comment_update:this.handleCommentChange.bind(this,o),collab_update:this.handleCollabChange.bind(this,o),discussion_update:this.handleDiscussionChange.bind(this,o),FORM_RELATION_CHANGE:this.handleFormRelationChange.bind(this,o),DOCTOPINFO_CHANGE:this.handleDocTopInfoChange.bind(this,o),todo_status_changed:this.handleTodoChange.bind(this,o)};null===(r=s[o.type])||void 0===r||r.call(s)}},t.handlePushMessage=function(e){var t,r;if(null===e||void 0===e?void 0:e.message){var o=null,i="";try{i=(o=JSON.parse(e.message)).type}catch(a){console.error(a),null===(t=n.g.log)||void 0===t||t.error(e.message,a.stack),c.ZP.run(h.CONFIG.PARSE_PUSH_MESSAGE_ERROR,[null===(r=null===e||void 0===e?void 0:e.message)||void 0===r?void 0:r.substr(0,1e4)])}"unbind"===i&&this.unbindAccount(o),$(window).trigger("notification_message",[e.message])}},t.handleReloadMessage=function(){this.app.event.errorCode.trigger("errorCode",{type:"front",code:S.B.RELOAD}),this.app.permissions.activeShutdownStatus(!1)},t.handleCodeRevNew=function(e){var t,r;return te(this,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a,s,d;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(!(null===(t=null===e||void 0===e?void 0:e.body)||void 0===t?void 0:t.notice)){o.next=15;break}i=e.body.notice,a=i.code_ver,s=i.dver,o.next=5;break;case 5:if(ne(s,n.g._grayVersion)&&a===P.q.getConfig("pver")){o.next=15;break}if(c.ZP.monitor(33624154),d=location.pathname.replace(/\/sheet\/(history\/)?/,""),null===(r=this.app.documentManager)||void 0===r||r.notifyNativeSingleDocVersionMap(d,s,!0),o.t0=n.g.__SUPPORT_FULL_OFFLINE_MODE,!o.t0){o.next=13;break}return o.next=13,j.V0.clearDocumentCache(d,P.q.getConfig("uid"));case 13:this.messageCenter.shutDown(S.B.KICK),this.app.permissions.activeShutdownStatus(!1);case 15:case"end":return o.stop()}}),o,this)})))},t.handleOffline=function(e){var t,n=this;this.onceOpened&&(this.hadShowOfflineTip||($(window).trigger("networkOffline"),this.app.networkStatus.setSocketOnline(!1),F().isIOS&&e&&-1!==e.indexOf("socket io error")?c.ZP.monitor(35623015):this.app.offlineEdit&&!(0,q.j)()&&(re.call(this,this.app.sheetStatus.canEdit&&!this.app.offlineEdit.isDisabled,(function(e){n.offlineSnackbar=e})),c.ZP.monitor(35623016)),null===(t=this.app.getCurrentMainThreadWorker())||void 0===t||t.sheetData.informNetworkChange({type:"networkOffline"})))},t.handleOnline=function(){var e;this.hideOfflineTips(),$(window).trigger("networkOnline"),this.app.networkStatus.setSocketOnline(!0),this.hadShowOfflineTip=!1,null===(e=this.app.getCurrentMainThreadWorker())||void 0===e||e.sheetData.informNetworkChange({type:"networkOnline"})},t.handleRangeAuthMessage=function(e){d.ZP.rangeAuthEvent.trigger("rangeAuthChange",e)},t.handleReminderChange=function(e){d.ZP.dateReminderEvent.trigger("dateReminderChange",e)},t.handleCommentChange=function(e){d.ZP.commentEvent.trigger("commentUpdate",e)},t.handleCollabChange=function(e){d.ZP.collabEvent.trigger("collabUpdate",e)},t.handleDiscussionChange=function(e){d.ZP.discussionEvent.trigger("discussionUpdate",e)},t.handleTodoChange=function(e){d.ZP.todoEvent.trigger("todoChange",e)},t.handleFormRelationChange=function(e){d.ZP.formRelationEvent.trigger("formRelationChange",e)},t.handleDocTopInfoChange=function(e){d.ZP.spreadsheetEvent.trigger("docTopInfoChange",e)},t.handleAuthUpdate=function(e){d.ZP.spreadsheetEvent.trigger("authUpdate",e)},t.notifyRightChange=function(e){var t;try{if(""===e.payload||null===e.payload)return void(null===(t=n.g.SLR)||void 0===t||t.dispatch("TX-AUTH-UPDATED"));var r=JSON.parse(e.payload);if(null===r)return;var o=r.seq;"undefined"===typeof(n.g.clientVars||{}).msgFilterData&&(n.g.clientVars.msgFilterData={}),1===r.action?this.handlePermissionChanged(r,o):2===r.action||this.handleExpDate(r)}catch(i){}},t.handlePermissionChanged=function(e,t){var r;e&&"undefined"===typeof e[t]?4&P.q.getConfig("rightFlag")&&(null===(r=window.SLR)||void 0===r||r.dispatch("TX-AUTH-UPDATED"),$(window).trigger("permissionChanged"),f.Z.changePermission()):delete n.g.clientVars.msgFilterData[t]},t.handleExpDate=function(e){if("undefined"!==e.exptime&&"undefined"!==e.settime&&"undefined"!==e.starttime){var t=e.exptime-e.starttime,n=t;if(t&&t>0){var r={};r.exptime=e.exptime,r.remaintime=n,r.settime=t,r.starttime=e.starttime,this.app.advPermissions.onUpdateAuthExpInfo(r)}else console.error("有效期变更错误")}},t.comparePrivilege=function(){var e=this;4&P.q.getConfig("rightFlag")||this.messageCenter.sendMessage({cmd:"GET_PRIVILEGE",taskId:void 0,data:JSON.stringify({}),onsend:function(t,n,r,o){var i,a;if(0===o.errCode&&0===(null===(a=null===(i=o.response)||void 0===i?void 0:i.onpost)||void 0===a?void 0:a.result)){var s=o.response.onpost.privilege_attribute;if(P.q.getConfig("canEdit")===s.can_edit&&P.q.getConfig("canRead")===s.can_read||(e.messageCenter.shutDown(S.B.PERMISSION_CHANGE),e.app.permissions.activeTempStatus(!1),$("#editor").blur()),P.q.getConfig("canComment")!==s.can_comment&&(e.app.permissions.setWorkbookStatusCanComment(!1),e.messageCenter.shutDown(S.B.PERMISSION_CHANGE)),P.q.getConfig("canCopy")!==s.can_copy&&(e.app.permissions.setWorkbookStatusCanCopy(!1),e.messageCenter.shutDown(S.B.PERMISSION_CHANGE)),null===s||void 0===s?void 0:s.wecom_allow_op){var d=(0,J.dD)(null===s||void 0===s?void 0:s.wecom_allow_op),l=P.q.getConfig("wecomAllowOperations");if((null===d||void 0===d?void 0:d.canClone)!==(null===l||void 0===l?void 0:l.canClone)){var u=(null===d||void 0===d?void 0:d.canClone)?1:0;P.q.setConfig({canCopyDoc:u})}if((null===d||void 0===d?void 0:d.canHistory)!==(null===l||void 0===l?void 0:l.canHistory)){var c=(null===d||void 0===d?void 0:d.canHistory)?1:0;P.q.setConfig({canHistory:c})}if((null===d||void 0===d?void 0:d.canShare)!==(null===l||void 0===l?void 0:l.canShare)){var h=(null===d||void 0===d?void 0:d.canShare)?1:0;P.q.setConfig({canShare:h})}if((null===d||void 0===d?void 0:d.canPrint)!==(null===l||void 0===l?void 0:l.canPrint)){var p=(null===d||void 0===d?void 0:d.canPrint)?1:0;P.q.setConfig({canPrint:p})}P.q.setConfig({wecomAllowOperations:d})}}},onError:function(){}})},t.unbindAccount=function(e){var t=(0,M.ej)("utype");if(t||console.error("handlePushMessage unbind utype is null!"),"wx"===e.unbind&&"wx"===t)return c.ZP.monitor(33612279),void this.messageCenter.shutDown("TX-LOGIN-PSKEY-EXPIRED")},t.handleErrorCode=function(e,t){e.monitor&&c.ZP.monitor(e.monitor),this.app.event.errorCode.trigger("errorCode",{type:t,code:e.code||e.errorcode})},t.handleRelateMessage=function(e,t,r){var o,i,a,s,d,l=e.file,u=e.rel_file;if(l.doc_type===_.$e.sheet)s=l,d=u;else if(u.doc_type===_.$e.sheet)s=u,d=l;else{if(l.doc_type!==_.$e.unknown)return void n.g.log.error("handleDisAssociateDocMessage 处理表格取消关联小应用成功通知失败 -- 不存在表格数据");s=l,d=u}var c,h=s.sub_id,p=d,f=p.doc_type,g=p.doc_id,v=p.doc_url,m=p.sub_id;switch(t&&(c={docId:(0,G.QP)(g),docUrl:v,subId:m}),f){case B.Z.AIO:null===(o=this.app.feature)||void 0===o||o.relateAio.update(h,c,r);break;case _.$e.unknown:case B.Z.FORM:if(t)return void(c&&!X.xc&&(null===(i=this.app.feature)||void 0===i?void 0:i.relateForm).bindRelatedFormToSubSheet(h,c));(null===(a=this.app.feature)||void 0===a?void 0:a.relateForm).unbindSubSheetRelatedForm(h)}},t.reportFetchDataFail=function(){c.ZP.zzsStatus({attrid:h.ZZS_REPORT_ATTR.HOTDOCS_FETCH_DATA_FAIL,status:1})},e}(),le=de,ue=n("../node_modules/@tencent/containerized/build/main/index.js"),ce=n("../spread-sheet/src/core/network/message-center/model/missChange-helper.ts"),he=function(){function e(){var e=this;this.handleReport=function(t){var n=t.type,r=t.remark,o=t.data;e.handleCollabChangeReport({type:n,remark:r,data:o}),e.handleMissChangeReport({type:n,remark:r,data:o}),e.handleReceiveMessageCenterReport({type:n,remark:r,data:o}),e.handleSendMessageCenterReport({type:n,remark:r,data:o}),e.handleVersionReport({type:n,remark:r,data:o})}}var t=e.prototype;return t.handleSendMessageCenterReport=function(e){var t,n,r,o,i,s,d,l=e.type,u=e.data;switch(l){case a.REPORT_MONITOR_TYPE.RETRY_COMMIT:c.ZP.run(h.CONFIG.RETRY_SENDMESSAGE,[null===u||void 0===u?void 0:u.currentTime,null===(n=null===(t=null===u||void 0===u?void 0:u.commitingQueue)||void 0===t?void 0:t[0])||void 0===n?void 0:n.taskId]);break;case a.REPORT_MONITOR_TYPE.COMMITING_BLOCK_ERROR:c.ZP.run(h.CONFIG.COMMITING_QUEUE_BLOCK,[null===u||void 0===u?void 0:u.commitingQueue,null===u||void 0===u?void 0:u.lastRequestTime,null===u||void 0===u?void 0:u.currentTime,null===(r=null===u||void 0===u?void 0:u.waitingQueue)||void 0===r?void 0:r.length]);break;case a.REPORT_MONITOR_TYPE.SEND_USERCHANGE:c.ZP.run(u.isFirstCommit?h.CONFIG.SEND_USERCHANGE:h.CONFIG.SEND_USERCHANGE_1,[null===(o=null===u||void 0===u?void 0:u.userChange)||void 0===o?void 0:o.taskId,null===u||void 0===u?void 0:u.userChange]);break;case a.REPORT_MONITOR_TYPE.HANDLE_TASK_DUPLICATE_VERSION_ERROR:c.ZP.run(h.CONFIG.TASK_DUPLICATE_VERSION_TOO_LOW,[null===(i=null===u||void 0===u?void 0:u.packet)||void 0===i?void 0:i.taskId,null===(s=null===u||void 0===u?void 0:u.packet)||void 0===s?void 0:s.cmd,null===(d=null===u||void 0===u?void 0:u.packet)||void 0===d?void 0:d.result,null===u||void 0===u?void 0:u.currentVersion])}},t.handleReceiveMessageCenterReport=function(e){var t,n,r=e.type,o=e.data;r===a.REPORT_MONITOR_TYPE.HANDLE_NEW_CHANGES&&c.ZP.run(h.CONFIG.HANDLE_NEW_CHANGES,[null===o||void 0===o?void 0:o.newRev,null===(n=null===(t=null===o||void 0===o?void 0:o.body)||void 0===t?void 0:t.data)||void 0===n?void 0:n.commitId,null===o||void 0===o?void 0:o.socketId,null===o||void 0===o?void 0:o.ts])},t.handleVersionReport=function(e){var t=e.type,n=e.data;t===a.REPORT_MONITOR_TYPE.UPDATE_VERSION_ERROR&&c.ZP.run(h.CONFIG.UPDATE_BASEVERSION_ERROR,[null===n||void 0===n?void 0:n.currentVersion,null===n||void 0===n?void 0:n.newVersion])},t.handleMissChangeReport=function(e){var t,n,r=e.type,o=e.data;switch(r){case a.REPORT_MONITOR_TYPE.GET_MISS_CHANGE_ERROR:this.handleGetMissChangeReport(o);break;case a.REPORT_MONITOR_TYPE.MISS_CHANGE_VERSION_ERROR:c.ZP.run(h.CONFIG.FETCH_USERCHANGES_ERROR,[null===(n=null===(t=null===o||void 0===o?void 0:o.userChange)||void 0===t?void 0:t.data)||void 0===n?void 0:n.newRev,null===o||void 0===o?void 0:o.preNewVersion])}},t.handleCollabChangeReport=function(e){var t=e.type,n=e.data;switch(t){case a.REPORT_MONITOR_TYPE.APPLY_COLLAB_CHANGE_VERSION_BREAK:c.ZP.run(h.CONFIG.APPLY_NEWCHANGES_VERROR2,[null===n||void 0===n?void 0:n.newVersion,null===n||void 0===n?void 0:n.currentVersion]);break;case a.REPORT_MONITOR_TYPE.APPLY_COLLAB_CHANGE_VERSION_REPEAT:c.ZP.run(h.CONFIG.APPLY_NEWCHANGES_VERROR5,[null===n||void 0===n?void 0:n.newVersion,null===n||void 0===n?void 0:n.currentVersion]);break;case a.REPORT_MONITOR_TYPE.APPLY_COLLAB_CHANGE_VERSION_BELOW:c.ZP.run(h.CONFIG.APPLY_NEWCHANGES_VERROR6,[null===n||void 0===n?void 0:n.newVersion,null===n||void 0===n?void 0:n.currentVersion])}},t.handleGetMissChangeReport=function(e){var t;void 0===e&&(e={});var n=e,r=n.options,o=n.result;switch(o.errorDescription){case a.MISS_CHANGE_ERROR_TYPE.AJAX_ERROR:c.ZP.monitor(34276670);break;case a.MISS_CHANGE_ERROR_TYPE.RESULT_CHANGES_EMPTY:c.ZP.monitor(33633645);break;case a.MISS_CHANGE_ERROR_TYPE.RESULT_DATA_UNDEFINED:c.ZP.run(h.CONFIG.FETCH_USERCHANGES_3,[null===(t=null===o||void 0===o?void 0:o.data)||void 0===t?void 0:t.status,null===o||void 0===o?void 0:o.data]);break;case a.MISS_CHANGE_ERROR_TYPE.FROM_BELOW_TO_ERROR:c.ZP.run(h.CONFIG.FETCH_USERCHANGE_ARGUMENT,[null===r||void 0===r?void 0:r.form,null===r||void 0===r?void 0:r.to]);break;case a.MISS_CHANGE_ERROR_TYPE.RETCODE_ERROR:!function(e){var t={1e5:33612375,100002:33612376,100003:33612377,200105:33612378,200200:33612379};e&&c.ZP.monitor(t[e])}(null===o||void 0===o?void 0:o.retcode)}},e}(),pe=he,fe=n("../node_modules/@tencent/docs-multi-tools/dist/index.js"),ge=function(e){var t={};return n.g.__globalReleaseVersion&&(t.rel_rev=n.g.__globalReleaseVersion),n.g.__globalCodeVersion&&(t.dver=n.g.__globalCodeVersion),t.right_tag=e.sheetStatus.workbookStatus.canEdit?1:0,t},ve=n("../spread-sheet/src/core/ark-extensions/index.ts"),me=function(e,t,n,r){var o,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},Ce=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},be=function(e,t){return function(n,r){t(n,r,e)}},Ee=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},we=function(e){function t(t,r){var o,i;return(o=e.call(this)||this).app=t,o.userChangeObservers=[],o.handleStartLoadData=function(e){var t,r=e.sheetId;o.pendingControl.startLoadSheet(r)&&1===o.pendingControl.loadingCount&&(o.messageCenter.pause(),console.info("[startLoadData]-暂停messageCenter pause()",r),null===(t=n.g.log)||void 0===t||t.info("[startLoadData]-暂停messageCenter pause()"))},o.handleAfterLoadData=function(e){var t,r=e.sheetId;o.pendingControl.finishLoadSheet(r)&&0===o.pendingControl.loadingCount&&(o.messageCenter.resume(),o.applyFormulaModel(),console.info("[afterLoadData]-打开messageCenter resume()",r),null===(t=n.g.log)||void 0===t||t.info("[afterLoadData]-打开messageCenter resume()"))},o.handleSyncLatestData=function(e){o.messageCenter.forceResume(),o.messageCenter.sendMessageManager.commitAfterUpdateVersionToLatest(e)},null===(i=n.g.log)||void 0===i||i.info("flow MessageService new MessageCenterAdapter()"),o.pendingControl=new l.Z,o.init(r),o}(0,i.Z)(t,e);var r=t.prototype;return r.destroy=function(){var e;null===(e=n.g.log)||void 0===e||e.debug("flow MessageCenterAdapter destroy()"),this.userChangeObservers.length=0,this.messageCenter.dispose()},r.addUserChangeObserver=function(e){this.userChangeObservers.push(e)},r.init=function(e){var t=this;this.reportAdapter=new pe,this.messageCenter=new a.MessageCenter(e.baseVersion),this.messageCenter.setGlobalVars({uid:(0,fe.getUid)(),serverVars:n.g.clientVars.collab_client_vars,userid:n.g.clientVars.userId,uuId:"",module:"Sheet",config:{isUseAllCookie:X.xc,bigDataCommitConfig:{isSupportBigDataCommit:!0,minContentLength:2097152,maxContentLength:20447232},headerGeneralPacket:ge(this.app),messagePriority:new Map([[a.Command.CURSOR_MESSAGE,s.MessagePriority.LOW]])}}),this.sendMessageCenterAdapter=new E(this.app,this.messageCenter),this.receiveMessageCenterAdapter=new R(this.app,this.messageCenter),this.messageCenter.setOptionalFunction({getMissChangesUrl:this.getFetchMissChangesUrl,checkIfNeedFollow:this.checkIfNeedFollow.bind(this),multiTypeFollow:k.hh,applyServerUserChanges:function(){var e;return(e=t.receiveMessageCenterAdapter).applyNewChanges.apply(e,arguments)}}),this.messageCenter.start(),this.socketAdapter=new le(this.app,this.messageCenter),this.initEvent(),this.setConnectionControllerService()},r.initEvent=function(){var e=this;this.initSendMessageCenterEvent(),this.initReceiveMessageCenterEvent(),this.initmessageCenterEvent(),this.initLogAndReportEvent(),d.ZP.default.listen("startLoadData",this.handleStartLoadData),d.ZP.default.listen("afterLoadData",this.handleAfterLoadData),d.ZP.spreadsheetEvent.listen("syncLatestData",this.handleSyncLatestData),this._register((0,ue.OF)((function(){d.ZP.default.remove("startLoadData",e.handleStartLoadData),d.ZP.default.remove("afterLoadData",e.handleAfterLoadData),d.ZP.spreadsheetEvent.remove("syncLatestData",e.handleSyncLatestData)})))},r.initmessageCenterEvent=function(){var e=this;this._register(this.messageCenter.eventManager.onAcceptCommit((function(t){var n=t.newVersion,r=t.data;e.sendMessageCenterAdapter.acceptCommit(e.app.spreadsheet.getSpreadsheetId(),n,r)}))),this._register(this.messageCenter.eventManager.onCommitError((function(){var t;(t=e.sendMessageCenterAdapter).commitError.apply(t,arguments)}))),this._register(this.messageCenter.eventManager.onConnectionStatusChange((function(){var t;(t=e.socketAdapter).handleRoomStateChange.apply(t,arguments)}))),this._register(this.messageCenter.eventManager.onRoomOpen((function(){e.socketAdapter.handleSocketOpen()}))),this._register(this.messageCenter.eventManager.onNetReconnectedFail((function(){e.socketAdapter.handleNetReconnectedFail()}))),this._register(this.messageCenter.eventManager.onReceiveOtherMessage((function(){var t;(t=e.socketAdapter).handleMessageFromServer.apply(t,arguments)}))),this._register(this.messageCenter.eventManager.onShutdown((function(t){var n=t.reason;e.socketAdapter.handleShutDown(n.reason,n.errCode)}))),this._register(this.messageCenter.eventManager.onCommitBlock((function(t){var r;null===(r=n.g.log)||void 0===r||r.info("messageCenter onCommitBlock",t),e.messageCenter.shutDown("onCommitBlock")}))),this._register(this.messageCenter.eventManager.onVersionChange((function(e){var t=e.newVersion,n=e.currentVersion;c.ZP.run(h.CONFIG.UPDATE_BASEVERSION,[n,t])}))),this._register(this.messageCenter.eventManager.onQueueChange((function(t){var n=e.app.spreadsheet.getSpreadsheetId(),r={waitingQueue:t.waitingQueue.map((function(e){return C(e,n,p.t.WATING)})),commitingQueue:t.commitingQueue.map((function(e){return C(e,n,p.t.COMMITING)}))};e.userChangeObservers.forEach((function(e){var t;return null===(t=e.onUserQueueChange)||void 0===t?void 0:t.call(e,r)}))})))},r.initLogAndReportEvent=function(){this._register(this.messageCenter.eventManager.onLog((function(e){var t,r,i,s,d,l,u,c,h=e.type,p=e.data;switch(h){case a.LOG_TYPE.INFO:null===(d=n.g.log)||void 0===d||(t=d).info.apply(t,(0,o.Z)(p));break;case a.LOG_TYPE.DEBUG:null===(l=n.g.log)||void 0===l||(r=l).debug.apply(r,(0,o.Z)(p));break;case a.LOG_TYPE.WARN:null===(u=n.g.log)||void 0===u||(i=u).warn.apply(i,(0,o.Z)(p));break;case a.LOG_TYPE.ERROR:null===(c=n.g.log)||void 0===c||(s=c).error.apply(s,(0,o.Z)(p))}}))),this._register(this.messageCenter.eventManager.onReport(this.reportAdapter.handleReport))},r.initSendMessageCenterEvent=function(){var e=this;this._register(this.sendMessageCenterAdapter.onShutDown((function(t){return e.messageCenter.shutDown(String(t),t)}))),this._register(this.sendMessageCenterAdapter.onAcceptCommit((function(t){e.userChangeObservers.forEach((function(e){var n;return null===(n=e.onAcceptCommit)||void 0===n?void 0:n.call(e,t)}))}))),this._register(this.sendMessageCenterAdapter.onAfterApplyNewChanges((function(t){e.userChangeObservers.forEach((function(e){var n;return null===(n=e.updateMisschange)||void 0===n?void 0:n.call(e,t)}))}))),this._register(this.sendMessageCenterAdapter.onCommitWithErrorCode((function(t){e.userChangeObservers.forEach((function(e){var n;return null===(n=e.handleCommitErrorCode)||void 0===n?void 0:n.call(e,t)}))})))},r.initReceiveMessageCenterEvent=function(){var e=this;this._register(this.receiveMessageCenterAdapter.onShutDown((function(t){return e.messageCenter.shutDown(t)}))),this._register(this.receiveMessageCenterAdapter.onBeforeApplyNewChanges((function(t){return e.sendMessageCenterAdapter.handleBeforeApplyNewChanges(t)}))),this._register(this.receiveMessageCenterAdapter.onAfterApplyNewChanges((function(t){return e.sendMessageCenterAdapter.handleAfterApplyNewChanges(t)})))},r.checkIfNeedFollow=function(e){var t;try{if(e.revert)return!1;if(e.changeset){var n=JSON.parse(e.changeset);if(n&&"ct"===(null===(t=n[0])||void 0===t?void 0:t.type))return!1}return!0}catch(r){return console.error("解析misschange失败",r),!1}},r.applyFormulaModel=function(){var e=this,t=this.messageCenter.localUserChangeManager.getCommitingQueue(),n=this.messageCenter.localUserChangeManager.getWaitingQueue(),r=[].concat((0,o.Z)(t),(0,o.Z)(n)).map((function(e){return JSON.parse(e.getChangeset())})),i=this.pendingControl.sheet;r.forEach((function(t){d.ZP.spreadsheetEvent.trigger(e.app.mutationBehavior.EVENT.AFTER_MUTATION_RUN,{sheetId:i,mutation:t,sType:u.Z.NORMAL,isLocal:!0,isFromFormula:!1,isCollab:!1,isReplay:!1})}))},r.getFetchMissChangesUrl=function(e){return Ee(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,ce.mb)({padId:e.globalPadId,revLower:e.from,revUpper:e.to});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))},r.setConnectionControllerService=function(){this.messageCenter.connectionController&&ve.default.dependentServiceCombinder.connectionControllerService.setConnectionController(this.messageCenter.connectionController)},t}(T.Z),Oe=we=me([be(0,r.m),Ce("design:paramtypes",["function"===typeof(oe="undefined"!==typeof r.m&&r.m)?oe:Object,Object])],we),Se=n("../spread-sheet/src/core/network/message-center/adapter/MessageCenterAdapter.interface.ts"),_e=n("../node_modules/@tencent/netcheck/lib/index.js");!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SOCKET=1]="SOCKET"}(ie||(ie={}));var ke=function(){function e(e){var t=this;this.handleStatusChange=function(e){var r,o=t.isNetworkOnline();e.type===ie.DEFAULT?t.browserNetworkStatus=e.online:e.type===ie.SOCKET&&(t.socketNetworkStatus=e.online);var i=t.isNetworkOnline();o!==i&&(null===(r=n.g.log)||void 0===r||r.warn("flow NetStatus 全局网络状态变化了，isOnline="+i),t.app.permissions.setWorkbookStatusOnline(i),d.ZP.spreadsheetEvent.trigger("NetworkStatusChanged",i))},this.networkChange=function(e){var r;null===(r=n.g.log)||void 0===r||r.warn("flow NetStatus 网络变化了，status=",e),"online"===e?t.handleStatusChange({online:!0,type:ie.DEFAULT}):t.handleStatusChange({online:!1,type:ie.DEFAULT})},this.app=e,this.socketNetworkStatus=!0,this.handleStatusChange({online:_e.network.isOnline,type:ie.DEFAULT}),this.initListeners()}var t=e.prototype;return t.destroy=function(){var e;null===(e=n.g.log)||void 0===e||e.debug("flow NetStatus destroy()"),this.removeListeners()},t.initListeners=function(){_e.network.changeEnd(this.networkChange)},t.removeListeners=function(){_e.network.remove(this.networkChange)},t.setSocketOnline=function(e){var t;null===(t=n.g.log)||void 0===t||t.warn("flow NetStatus Socket变化了，isOnline=",e),this.handleStatusChange({online:e,type:ie.SOCKET})},t.isNetworkOnline=function(){return this.browserNetworkStatus&&this.socketNetworkStatus},e}(),ye=n("../spread-sheet/src/core/app/dataCallCore.ts"),Re=n("../spread-sheet/src/flow/browser/phase/services/sheetLifecyle.interface.ts"),Te=n("../node_modules/@babel/runtime/helpers/esm/createClass.js"),Ie=n("../node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js"),De=(n("../node_modules/core-js/modules/es.array.sort.js"),n("../node_modules/core-js/modules/es.function.name.js"),n("../node_modules/core-js/modules/es.array.from.js"),n("../node_modules/core-js/modules/es.symbol.js"),n("../node_modules/core-js/modules/es.symbol.description.js"),n("../node_modules/core-js/modules/es.symbol.iterator.js"),n("../node_modules/@tencent/ark-model/lib/index.js")),xe=n("../node_modules/@tencent/ark-offline-edit/lib/index.js"),Ae=n("../packages/model/src/sheet/SheetType.ts"),Ne=n("../spread-sheet/src/core/network/message-center/model/changeset-type.ts"),Pe=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},Me=function(){function e(e){this.offlineEdit=e}return e.prototype.isOfflineDataExist=function(){var e;return Pe(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.offlineEdit.getChanges([De.MZ.committing,De.MZ.waiting]);case 2:if(!(n=t.sent).error){t.next=5;break}return t.abrupt("return",new xe.x(n.error));case 5:if(null===(e=n.data)||void 0===e?void 0:e.length){t.next=7;break}return t.abrupt("return",new xe.x(void 0,!1));case 7:return t.abrupt("return",new xe.x(void 0,!0));case 8:case"end":return t.stop()}}),t,this)})))},e}(),Le=35653083,Fe=35684341,Ze="sheet.V1",je=new Map([[p.t.WATING,De.MZ.waiting],[p.t.COMMITING,De.MZ.committing],[p.t.ACCEPT,De.MZ.accepted]]),Ue=function(e){return{modelVersion:Ze,subId:e.sheetId,head:e.head,keydata:e.keyData,offlineMsg:e.isOfflineMessage,isWorkbook:e.isWorkbook,type:je.get(e.status)||De.MZ.waiting,taskId:e.taskId,version:e.baseVersion,createTimestamp:e.time,mutations:Be(e.mutations,e.changesetType),changesetType:e.changesetType,changeData:e.changeData||null}},Ve=function(e){var t,r;try{var o=JSON.parse(e.data);r={modelVersion:Ze,subId:e.subId,head:o.data.head,keydata:o.data.keyData,offlineMsg:o.isOfflineMessage,type:e.type,taskId:e.taskId,version:e.version,createTimestamp:e.createTimestamp,mutations:o.data.mutations,changeData:o.data.changeData||null}}catch(i){null===(t=n.g.log)||void 0===t||t.error("oldChangesToSheetChanges error: "+i)}return r},Ge=function(e){var t,n,r;if(e.changeset){var o=JSON.parse(e.changeset);e.revert||"ct"===(null===(t=o[0])||void 0===t?void 0:t.type)?r=o:n=o}return{subId:e.sheetId,head:e.head,version:e.newVersion,taskId:e.commitId,mutations:n,changesetType:e.changesetType,changeData:r,createTimestamp:(new Date).getTime(),type:De.MZ.missChange}},Be=function(e,t){var n=[];return null===e||void 0===e||e.forEach((function(e){var r=[];e.forEach((function(e){var n=(0,k.t1)(e,t);n&&r.push(n)})),n.push(r)})),n},He=function(e,t){var n=[];return null===e||void 0===e||e.forEach((function(e){var r=[];e.forEach((function(e){var n=(0,k.Xe)(e,t);n&&r.push(n)})),n.push(r)})),n},qe=function(e){return e.filter((function(e){var t=He(e.mutations,e.changesetType);return!(!e.changeData&&t&&1===t.length&&0===t[0].length)}))},We=function(e,t,n){return new Promise((function(r){(0,ce.Tn)({padId:e,revLower:t,revUpper:n,callback:function(e,t,n){r(e?new xe.x(void 0,t):new xe.x(new Error(n)))}})}))},ze=function(){function e(){}var t=e.prototype;return t.show=function(e){var t,r;null===(t=n.g.log)||void 0===t||t.info("OfflineEditToast call showToastTips",e),null===(r=this.toastTips)||void 0===r||r.close(),n.g.SpreadsheetApp.permissions.activeTempStatus(!1),this.toastTips=I.default.show({message:e||x.ZP.t("正在同步离线数据，请稍候..."),type:"info",style:{zIndex:10003},autoClose:!1,onClose:function(){return!1}})},t.hide=function(){var e,t;null===(e=n.g.log)||void 0===e||e.info("OfflineEditToast call hideToastTips"),n.g.SpreadsheetApp.permissions.unactiveTempStatus(),null===(t=this.toastTips)||void 0===t||t.close(),this.toastTips=void 0},e}(),Ye=n("../spread-sheet/src/base/index.ts"),Ke=function(){function e(){}return e.show=function(t){var r;null===(r=n.g.log)||void 0===r||r.info("SyncTips show:",t,!!e.syncOfflineDataToastTips),e.syncOfflineDataToastTips||(e.syncOfflineDataToastTipslastShowTime=Date.now(),e.syncOfflineDataToastTips=I.default.show({message:x.ZP.t("离线数据同步中，请稍候..."),type:"loading",style:{zIndex:10003},autoClose:!1,onClose:function(){return!1}}),e.weblogReportTimer=setTimeout((function(){var t,r,o=Date.now(),i=o-18e4;null===(r=null===(t=n.g.log)||void 0===t?void 0:t.report)||void 0===r||r.call(t,"PAGE_OPEN_OFFLINE_DATA_SYNC_TIMEOUT",{query:{startTs:i,endTs:o}}),clearTimeout(e.weblogReportTimer)}),2e4))},e.hide=function(t){var r,o,i,a;void 0===t&&(t=!1),null===(r=n.g.log)||void 0===r||r.info("SyncTips hide:",t,e.syncOfflineDataToastTipslastShowTime);var s=Date.now()-e.syncOfflineDataToastTipslastShowTime;if(s>1e3||t)try{null===(o=n.g.log)||void 0===o||o.info("SyncTips hide now"),null===(i=e.syncOfflineDataToastTips)||void 0===i||i.close(),e.syncOfflineDataToastTips=null}catch(d){null===(a=n.g.log)||void 0===a||a.error("SyncTips hide error",null===d||void 0===d?void 0:d.stack)}else Ye.Z.util.timer.wait(1e3-s).run((function(){var t,r,o;try{null===(t=n.g.log)||void 0===t||t.info("SyncTips hide sync"),null===(r=e.syncOfflineDataToastTips)||void 0===r||r.close(),e.syncOfflineDataToastTips=null}catch(d){null===(o=n.g.log)||void 0===o||o.error("SyncTips hide error",null===d||void 0===d?void 0:d.stack)}}));clearTimeout(e.weblogReportTimer)},e}();Ke.syncOfflineDataToastTipslastShowTime=0;var Qe=function(e){var t={attrid:h.ZZS_REPORT_ATTR.SYNC_OFFLINE_DATA_ERROR,status:1};e.spreadsheet.isExternalSheet()&&(t.project=e.spreadsheet.activeSheet.getSheetType()),c.ZP.zzsStatus(t)},Je=n("../spread-sheet/src/core/data/converter/tencentdoc/doMutation.ts"),Xe=n("../packages/common-utils/src/client/url.ts");function $e(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"===typeof e)return et(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?et(e,t):void 0}}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function et(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var tt,nt,rt=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},ot="clearOfflineStore",it=function(e){function t(t){var r;return(r=e.call(this)||this).option=t,r.isOfflineDataExistWhenPreCheck=void 0,r.offlineDataCache=[],r.module="OfflineEdit",r.toast=new ze,r.isTempDisabled=!1,r.syncOfflineData=function(){return rt((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function e(){var t,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(t=n.g.log)||void 0===t||t.info(this.module,"syncOfflineData 开始同步离线数据 canWrite:",this.offlineEdit.canWrite()),this.offlineEdit.canWrite()){e.next=3;break}return e.abrupt("return",!0);case 3:if(!1!==this.isOfflineDataExistWhenPreCheck){e.next=5;break}return e.abrupt("return",!0);case 5:return void 0===this.isOfflineDataExistWhenPreCheck&&c.ZP.monitor(35580400),e.next=8,this.syncLocalOfflineData();case 8:return(o=e.sent)||(Qe(this.option.app),null===(r=n.g.log)||void 0===r||r.report("SYNC_OFFLINE_DATA_ERROR")),e.abrupt("return",o);case 11:case"end":return e.stop()}}),e,this)})))},r.applyOfflineDataCache=function(){return rt((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function e(){var t,r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===(t=this.offlineDataCache)||void 0===t||t.forEach((function(e){return rt(r,void 0,void 0,regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.option.app.requestApi.applyOffline({sheetId:e.oSubId||"",requestId:-1,canUndoRedo:!1,opt:e});case 2:null===(r=n.g.log)||void 0===r||r.info("applyLocalOfflineChanges applyOffline end",e.mutations.length);case 3:case"end":return t.stop()}}),t,this)})))}));case 1:case"end":return e.stop()}}),e,this)})))},r.follow=function(e,t){var o;null===(o=n.g.log)||void 0===o||o.info(r.module,"follow source.taskId:"+e.taskId+", newChange.taskId:"+t.taskId);var i=Object.assign({},e);if(t.subId===i.subId&&i.mutations.length&&!i.changeData){var a=t.changesetType,s=t.mutations,d=e.changesetType,l=e.mutations,u=(0,k.Xz)({changesetType:a,mutations:He(s,a)},{changesetType:d,mutations:He(l,d)},!1);i.mutations=Be(u.mutations,u.changesetType)}return i},r.getServerChanges=function(e,t){return new Promise((function(o){return rt((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function r(){var i,a,s,d;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return null===(i=n.g.log)||void 0===i||i.info(this.module,"getServerChanges from:"+e+" to:"+t),r.next=3,We(this.option.globalPadId,e,t);case 3:if(!(s=r.sent).error){r.next=7;break}return o(s),r.abrupt("return");case 7:d=(null===(a=s.data)||void 0===a?void 0:a.length)?s.data.map((function(e){return Ge(e)})):[],o(new xe.x(void 0,d));case 9:case"end":return r.stop()}}),r,this)})))}))},r.clearOfflineChanges=function(e){return rt((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function t(){var r,o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=e.callback,this.canWrite()){t.next=4;break}return null===o||void 0===o||o(!1),t.abrupt("return");case 4:return t.next=6,this.offlineEdit.deleteChanges([De.MZ.waiting,De.MZ.committing]);case 6:if(!(i=t.sent).error){t.next=11;break}return null===(r=n.g.log)||void 0===r||r.error(this.module,"clearOfflineChanges error: "+i.error),null===o||void 0===o||o(!1),t.abrupt("return");case 11:return null===o||void 0===o||o(!0),t.abrupt("return",i);case 13:case"end":return t.stop()}}),t,this)})))},r.dbVersionChanged=function(){var e;null===(e=n.g.log)||void 0===e||e.info("OnTencentDocsDBVersionChanged"),r.offlineEdit.dispose(),r.option.app.permissions.activeTempStatus(!1),f.Z.server.showUpgradeTip("DB_UPGRADE")},r.networkStatusChanged=function(e,t){return rt((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function r(){var o,i,a,s,d,l;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.isOnline!==t.isOnline){r.next=2;break}return r.abrupt("return");case 2:if(null===(o=n.g.log)||void 0===o||o.info(this.module,"NetworkStatusChanged. newStatus="+t.isOnline+" ",this.canWrite()),!t.isOnline){r.next=7;break}this.toast.hide(),r.next=12;break;case 7:if(this.canWrite()){r.next=12;break}return r.next=10,this.offlineEdit.getMutexLockHelper().lockResult;case 10:(s=r.sent).isSuccess||"edit"!==(null===(a=null===(i=s.data)||void 0===i?void 0:i.optional)||void 0===a?void 0:a.source)?(l=F().isMobile?x.ZP.t("网络异常，请检查网络连接。"):x.ZP.t("离线编辑暂无法使用，请尝试重新加载或连接网络后使用。"),this.toast.show(l)):(d=F().isMobile?x.ZP.t("网络异常，请检查网络连接。"):x.ZP.t("文档已在另一个标签页中打开离线编辑，请关闭对应标签页后再重新加载。"),this.toast.show(d));case 12:case"end":return r.stop()}}),r,this)})))},r}(0,i.Z)(t,e);var r=t.prototype;return r.init=function(){var e,t;return rt(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o,i;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o={version:this.option.version,documentInfo:{secretId:this.option.secretId,globalPadId:this.option.globalPadId,dataVersion:n.g.__globalCodeVersion,uid:this.option.uid,docType:De.tE.sheet}},this.offlineEdit=new xe.g(o,{oldChangesTransForm:Ve,follow:this.follow,getServerChanges:this.getServerChanges}),r.next=4,this.offlineEdit.init("edit",1e3);case 4:if(!(i=r.sent).error){r.next=8;break}return null===(e=n.g.log)||void 0===e||e.error(this.module,"init error: "+i.error),r.abrupt("return");case 8:return d.ZP.spreadsheetEvent.listen(ot,this.clearOfflineChanges),this.option.app.sheetStatus.workbookStatus.status.change(this.networkStatusChanged),window.addEventListener("OnTencentDocsDBVersionChanged",this.dbVersionChanged),null===(t=n.g.log)||void 0===t||t.info(this.module,"init success. canWrite:",this.canWrite()),r.next=14,this.preCheckOfflineDataExist();case 14:case"end":return r.stop()}}),r,this)})))},r.dispose=function(){e.prototype.dispose.call(this),this.destroy()},r.destroy=function(){this.toast.hide(),Ke.hide(),this.offlineEdit.dispose(),this.option.app.sheetStatus.workbookStatus.status.offChange(this.networkStatusChanged),d.ZP.spreadsheetEvent.remove(ot,this.clearOfflineChanges),window.removeEventListener("OnTencentDocsDBVersionChanged",this.dbVersionChanged),this.option.app.permissions.unActiveFrozen()},r.shutDown=function(e){var t,r;void 0===e&&(e=!0),null===(t=n.g.log)||void 0===t||t.info(this.module,"shutdown:"+e);try{e?this.offlineEdit.dispose():this.offlineEdit.getMutexLockHelper().dispose()}catch(o){null===(r=n.g.log)||void 0===r||r.error(this.module,"shutdown. error",null===o||void 0===o?void 0:o.stack)}},r.canWrite=function(){return this.offlineEdit.canWrite()},r.lockHelper=function(){return this.offlineEdit.getMutexLockHelper()},r.onUserQueueChange=function(e){var t,r,i;return rt(this,void 0,void 0,regeneratorRuntime.mark((function a(){var s,d;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(this.canWrite()){a.next=2;break}return a.abrupt("return");case 2:return s=[].concat((0,o.Z)(e.waitingQueue.map((function(e){return Ue(e)}))),(0,o.Z)(e.commitingQueue.map((function(e){return Ue(e)})))),null===(t=n.g.log)||void 0===t||t.info(this.module,"onUserQueueChange:",s.map((function(e){return{version:e.version,taskId:e.taskId}}))),a.next=6,this.offlineEdit.deleteAndUpdateChanges(s,[De.MZ.waiting,De.MZ.committing]);case 6:(d=a.sent).error&&(null===(r=n.g.log)||void 0===r||r.error(this.module,"updateChanges error: "+d.error+", "+(null===(i=d.error)||void 0===i?void 0:i.message)));case 8:case"end":return a.stop()}}),a,this)})))},r.handleCommitErrorCode=function(e){var t;return rt(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:r.t0=e.errCode,r.next=60007===r.t0||60015===r.t0||40001===r.t0?3:15;break;case 3:return r.prev=3,r.next=6,this.offlineEdit.deleteChanges([De.MZ.waiting,De.MZ.committing]);case 6:if(!(o=r.sent).error){r.next=9;break}throw o.error;case 9:r.next=14;break;case 11:r.prev=11,r.t1=r.catch(3),null===(t=n.g.log)||void 0===t||t.error(this.module,"数据库操作失败 handleCommitErrorCode",null===r.t1||void 0===r.t1?void 0:r.t1.stack);case 14:return r.abrupt("break",15);case 15:case"end":return r.stop()}}),r,this,[[3,11]])})))},r.syncLocalOfflineData=function(){var e,t,r,o;return rt(this,void 0,void 0,regeneratorRuntime.mark((function i(){var a,s,d;return regeneratorRuntime.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return null===(e=n.g.log)||void 0===e||e.info(this.module,"syncLocalOfflineData version:",this.option.version),this.option.app.permissions.activeFrozen((function(){return Ke.show()})),i.next=4,this.offlineEdit.getChanges([De.MZ.committing,De.MZ.waiting]);case 4:if(!(a=i.sent).error){i.next=10;break}return null===(t=n.g.log)||void 0===t||t.error(this.module,"OfflineEditAdapter getChanges error: "+a.error),Ke.hide(),this.option.app.permissions.unActiveFrozen(),i.abrupt("return",!1);case 10:return i.next=12,this.initSmartSheetSDK(a.data);case 12:if(0!==(s=qe(a.data)).length){i.next=18;break}return null===(r=n.g.log)||void 0===r||r.info(this.module,"没有可用的本地离线数据，不需要同步",a.data.length),Ke.hide(),this.option.app.permissions.unActiveFrozen(),i.abrupt("return",!0);case 18:if(Ke.show(),s.sort((function(e,t){return e.createTimestamp-t.createTimestamp})),d=s[0].version,null===(o=n.g.log)||void 0===o||o.warn("离线数据信息：",s.map((function(e){return{version:e.version,taskId:e.taskId,createTime:e.createTimestamp}}))),d!==this.option.version){i.next=26;break}return i.next=25,this.handleOfflineDataBaseVersionEqualVersion(s);case 25:case 29:case 32:return i.abrupt("return",i.sent);case 26:if(!(d<this.option.version)){i.next=30;break}return i.next=29,this.handleOfflineDataBaseVersionLessThanVersion(s);case 30:return i.next=32,this.handleOfflineDataBaseVersionGreaterVersion(d,s);case 33:case"end":return i.stop()}}),i,this)})))},r.handleOfflineDataBaseVersionEqualVersion=function(e){return rt(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.applyLocalChanges(e);case 2:return n=t.sent,c.ZP.jank.log({moduleValue:"messageOfflineStore",actionValue:"apply",lockJankKey:!0}),t.abrupt("return",n);case 5:case"end":return t.stop()}}),t,this)})))},r.handleOfflineDataBaseVersionGreaterVersion=function(e,t){var r,o;return rt(this,void 0,void 0,regeneratorRuntime.mark((function i(){var a,s,l;return regeneratorRuntime.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return null===(r=n.g.log)||void 0===r||r.warn(this.module,"本地离线数据版本大于服务器版本"),i.next=3,We(this.option.globalPadId,this.option.version+1,e);case 3:if(!(a=i.sent).error){i.next=8;break}return Ke.hide(),f.Z.client.showOfflineSyncError(S.B.OFFLINE_SYNC_ERROR),i.abrupt("return",!1);case 8:if(s=a.data,!((l=s[s.length-1].newVersion)<e)){i.next=16;break}return c.ZP.monitor(Fe),null===(o=n.g.log)||void 0===o||o.warn("真实后台最大版本比本地离线版本还要小，maxMissChangeVersion="+l),d.ZP.spreadsheetEvent.trigger("clearOfflineStore",{type:H.N.ALL,callback:function(){location.reload()}}),i.abrupt("return",!1);case 16:return i.prev=16,i.next=19,this.applyCollabMissChanges(a.data);case 19:i.next=24;break;case 21:return i.prev=21,i.t0=i.catch(16),i.abrupt("return",!1);case 24:return i.next=26,this.applyLocalChanges(t);case 26:return i.abrupt("return",i.sent);case 27:case"end":return i.stop()}}),i,this,[[16,21]])})))},r.handleOfflineDataBaseVersionLessThanVersion=function(e){var t,r,o,i,a;return rt(this,void 0,void 0,regeneratorRuntime.mark((function s(){var d,l;return regeneratorRuntime.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this.offlineEdit.getUpdateChangesHelper().updateChanges(e);case 2:if(!(d=s.sent).error){s.next=8;break}return null===(t=n.g.log)||void 0===t||t.error(this.module,"handleOfflineDataBaseVersionLessThanVersion error: "+(null===(r=d.error)||void 0===r?void 0:r.message)+", "+(null===(o=d.error)||void 0===o?void 0:o.stack)),Ke.hide(),f.Z.client.showOfflineSyncError(S.B.OFFLINE_SYNC_ERROR,!0),s.abrupt("return",!1);case 8:if(null===(i=n.g.log)||void 0===i||i.info(this.module,"offlineDataBaseVersionLessVersion: "+(null===(a=d.data)||void 0===a?void 0:a.length)),!this.offlineEdit.canWrite()){s.next=12;break}return s.next=12,this.offlineEdit.updateChanges(d.data);case 12:return s.next=14,this.applyLocalChanges(d.data);case 14:return l=s.sent,c.ZP.jank.log({moduleValue:"messageOfflineStore",actionValue:"followAndApply",lockJankKey:!0}),s.abrupt("return",l);case 17:case"end":return s.stop()}}),s,this)})))},r.applyLocalChanges=function(e){var t,r;return rt(this,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a,s,d=this;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:c.ZP.jank.stopReport(),null===(t=n.g.log)||void 0===t||t.info(this.module,"applyLocalChanges, localChanges.length:",e.length),i=!1,a=(0,Je.PF)(this.option.app.spreadsheet),s=""!==(0,Xe.IZ)("fv"),(a||s)&&this.option.app.setDidEditable(!1),o.prev=6,e.forEach((function(e){return rt(d,void 0,void 0,regeneratorRuntime.mark((function t(){var r,o,i,a=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.changeData){t.next=4;break}this.option.app.messageCenterAdapter.sendMessageCenterAdapter.addUserChange({sheetId:e.subId,taskId:e.taskId,data:e.changeData,changesetType:e.changesetType,requestId:-1,head:!!e.head,oSubId:e.oSubId||null,withKeyData:!1,isOfflineMessage:!0,allowAutoMerge:!1,keyframe:e.keydata,createTime:e.createTimestamp,syncToOffline:!1}),t.next=14;break;case 4:if((i=He(e.mutations,e.changesetType)).forEach((function(t){a.option.app.messageCenterAdapter.sendMessageCenterAdapter.addUserChange({sheetId:e.subId,taskId:e.taskId,data:t,changesetType:e.changesetType,requestId:-1,head:!!e.head,oSubId:e.oSubId||null,withKeyData:!1,isOfflineMessage:!0,allowAutoMerge:!0,keyframe:e.keydata,createTime:e.createTimestamp,syncToOffline:!1})})),this.option.app.getDidEditable()||e.changesetType===Ne.G.SMARTSHEET){t.next=10;break}this.offlineDataCache.push(e),t.next=14;break;case 10:return null===(r=n.g.log)||void 0===r||r.info(this.module,"applyLocalChanges applyOffline start, mutations.length:",i.length),t.next=13,this.option.app.requestApi.applyOffline({sheetId:e.subId,requestId:-1,canUndoRedo:!1,opt:{mutations:i,changesetType:e.changesetType,sheetId:e.subId}});case 13:null===(o=n.g.log)||void 0===o||o.info(this.module,"applyLocalChanges applyOffline end, mutations.length:",i.length);case 14:case"end":return t.stop()}}),t,this)})))})),i=!0,o.next=15;break;case 11:o.prev=11,o.t0=o.catch(6),i=!1,null===(r=n.g.log)||void 0===r||r.error(this.module,"applyLocalChanges Error",o.t0);case 15:return o.prev=15,Ke.hide(),this.option.app.permissions.unActiveFrozen(),c.ZP.jank.restartReport(),o.abrupt("return",i);case 21:case"end":return o.stop()}}),o,this,[[6,11,15,21]])})))},r.applyCollabMissChanges=function(e){return rt(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r,o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=$e(e);case 1:if((r=n()).done){t.next=11;break}o=r.value,i=void 0;try{i=JSON.parse(o.changeset)}catch(a){console.error("解析 missChanges 失败",o.changeset)}if(o.isValid){t.next=7;break}return t.abrupt("return");case 7:return t.next=9,this.option.app.requestApi.applyCollab({sheetId:o.sheetId,requestId:-1,canUndoRedo:!1,opt:{changeInfo:o,changes:i}});case 9:t.next=1;break;case 11:case 12:case"end":return t.stop()}}),t,this)})))},r.preCheckOfflineDataExist=function(){var e,t,r;return rt(this,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(null===(e=n.g.log)||void 0===e||e.info("call preCheckOfflineDataExist()",this.option.globalPadId,this.option.uid),this.offlineEdit.canRead()){o.next=3;break}return o.abrupt("return");case 3:return i=new Me(this.offlineEdit),o.next=6,i.isOfflineDataExist();case 6:if(a=o.sent,null===(t=n.g.log)||void 0===t||t.info("preCheckOfflineDataExist result",null===(r=a.error)||void 0===r?void 0:r.message,a.data),!a.error){o.next=10;break}return o.abrupt("return");case 10:a.data&&c.ZP.monitor(Le),this.isOfflineDataExistWhenPreCheck=a.data;case 12:case"end":return o.stop()}}),o,this)})))},r.initSmartSheetSDK=function(e){return rt(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=!1,e.forEach((function(e){e.changesetType!==Ne.G.SMARTSHEET||(n=!0)})),!n){t.next=7;break}if((r=this.option.app.sheetAdapterManager.getAdapterBySheetType(Ae.ZP.SMART_SHEET)).isInitialized()){t.next=7;break}return t.next=7,r.init();case 7:case"end":return t.stop()}}),t,this)})))},(0,Te.Z)(t,[{key:"isDisabled",get:function(){return this.isTempDisabled||!this.canWrite()}}]),t}(ue.JT);function at(e){var t=document.createElement("div");return t.innerHTML=e,t.children[0]}n("../node_modules/core-js/modules/es.promise.finally.js"),function(e){e[e.PART=0]="PART",e[e.FULL=1]="FULL"}(tt||(tt={})),function(e){e[e.CLOSE=0]="CLOSE",e[e.INITING=1]="INITING",e[e.OPEN=2]="OPEN",e[e.INIT_FAILED=3]="INIT_FAILED",e[e.NOT_SUPPORT=4]="NOT_SUPPORT",e[e.ERROR=5]="ERROR"}(nt||(nt={}));var st,dt=n("../spread-sheet/src/external/templateinfo/sync-template.ts");function lt(e,t){var n=function(e){if(e===st.CACHE_DOC_FAIL)return{message:x.ZP.t("缓存失败，请稍后重试。"),autoClose:!0,type:"error",duration:2e3,zIndex:100002}}(e);I.default.show(Object.assign(Object.assign({},n),t))}!function(e){e.CACHE_DOC_FAIL="cache_doc_fail"}(st||(st={}));var ut,ct,ht,pt=n("../spread-sheet/src/base/util/appConfig.ts"),ft=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},gt=function(e){function t(t){var r,o;return(r=e.call(this)||this).option=t,r.status=nt.CLOSE,r.toast=new ze,r.isWattingCreateFileResponse=!1,r.registerCallbackOnWindow=function(){n.g.onbeforeclosetab||(n.g.onbeforeclosetab=function(){var e;null===(e=r.option.app.offlineEdit)||void 0===e||e.destroy(),r.offlineDataManager.getDatabase().disConnect()})},r.syncOfflineData=function(){return ft((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(t=n.g.log)||void 0===t||t.info("OfflineOpen syncOfflineData 开始同步离线打开数据。",this.isDBAvaliable()),this.isDBAvaliable()){e.next=3;break}return e.abrupt("return",!0);case 3:if(!P.q.getConfig("isNewDoc")){e.next=10;break}return e.next=6,this.handleLocalCreateDocData();case 6:if(e.sent){e.next=10;break}return null===(r=n.g.log)||void 0===r||r.error("本地新建文档数据写入发生错误。"),e.abrupt("return",!1);case 10:this.isNeedCreateFile()&&this.tryToCreateFile();case 11:case"end":return e.stop()}}),e,this)})))},r.tryToCreateFile=function(){var e,t,o;if(null===(e=n.g.log)||void 0===e||e.info("tryToCreateFile",r.option.globalPadId),r.isWattingCreateFileResponse)null===(t=n.g.log)||void 0===t||t.warn("正在创建中，该创建文件请求直接抛弃");else{if(r.isNeedCreateFile())return r.isWattingCreateFileResponse=!0,r.offlineDataManager.getHelper().createFile(r.option.globalPadId,1,!0).then((function(e){var t,o,i;if(e.error)if(null===(t=n.g.log)||void 0===t||t.error("创建文件失败：",null===(o=e.error)||void 0===o?void 0:o.stack),e.error instanceof HttpError&&10033===e.error.errorCode){var l=e.data.url;!function(e,t,n){var r=at('\n        <div class="offline-modal-mask" style="\n            opacity: 1;\n            visibility: visible;\n            transition: all .3s cubic-bezier(.4,0,.2,1);\n            pointer-events: auto;\n            background-color: hsla(0,0%,100%,.65);\n            position: fixed;\n            z-index: 9998;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            display: flex;\n            -webkit-box-pack: center;\n            justify-content: center;\n            -webkit-box-align: center;\n            align-items: center;\n        ">\n            <div class="offline-model-container" style="\n                user-select: auto;\n                opacity: 1;\n                transform: scale3d(1,1,1);\n                position: relative;\n                width: 386px;\n                box-sizing: border-box;\n                padding: 20px 23px 24px 23px;\n                border-radius: 4px;\n                box-shadow: 0 2px 6px 0 rgba(0,0,0,.12);\n                background-color: #fff;\n                pointer-events: auto;border: 1px solid #eee;\n                box-shadow: 0 2px 6px 0 rgba(0,0,0,.12);\n                background-color: #fff;\n                pointer-events: auto;\n                -webkit-tap-highlight-color: transparent;\n\n            ">\n                <div class="offline-model-close" style="\n                    position: absolute;\n                    z-index: 1;\n                    width: 20px;\n                    height: 20px;\n                    right: 22px;\n                    top: 23px;\n                    background-size: 16px 16px;\n                    background-image: url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216%22%20height%3D%2216%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M8.977%208.047l4.93%204.97-.976.984L8%209.03%203.07%2014l-.977-.984%204.93-4.97L2%202.984%202.977%202%208%207.062%2013.023%202l.977.984-5.023%205.063z%22%20opacity%3D%22.64%22%2F%3E%3C%2Fsvg%3E);\n                    background-position: center;\n                    background-repeat: no-repeat;\n                    cursor: pointer; \n                "></div>\n                <div class="offline-model-title" style="\n                    font-weight: 500;\n                    font-size: 18px;\n                    margin-bottom: 20px;\n                ">'+x.ZP.t("系统消息")+'</div>\n                <div class="offline-model-content" style="\n                    font-size: 14px;\n                    color: rgba(0,0,0,.88);\n                    height: -webkit-max-content;\n                    height: -moz-max-content;\n                    height: max-content;\n                    min-height: 88px;\n                    display: -webkit-box;\n                    display: -webkit-flex;\n                    display: -ms-flexbox;\n                    display: flex;\n                    -webkit-box-orient: vertical;\n                    -webkit-box-direction: normal;\n                    -webkit-flex-flow: column nowrap;\n                    -ms-flex-flow: column nowrap;\n                    flex-flow: column nowrap;\n                    -webkit-box-pack: center;\n                    -webkit-justify-content: center;\n                    -ms-flex-pack: center;\n                    justify-content: center;\n                    -webkit-box-align: start;\n                    -webkit-align-items: flex-start;\n                    -ms-flex-align: start;\n                    align-items: flex-start;\n                ">'+e+'</div>\n                <div class="offline-model-footer" style="\n                    display: -webkit-box;\n                    display: -webkit-flex;\n                    display: -ms-flexbox;\n                    display: flex;\n                    -webkit-box-pack: end;\n                    -webkit-justify-content: flex-end;\n                    -ms-flex-pack: end;\n                    justify-content: flex-end;\n                    margin-top: 24px;\n                    position: relative;\n                ">\n                    <button class="offline-model-ok" style="\n                        margin-left: 16px;\n                        height: 28px;\n                        background: #0188fb;\n                        color: #fff;\n                        outline: 0;\n                        cursor: pointer;\n                        -webkit-user-select: none;\n                        -moz-user-select: none;\n                        -ms-user-select: none;\n                        user-select: none;\n                        -webkit-box-sizing: border-box;\n                        box-sizing: border-box;\n                        display: inline-block;\n                        white-space: nowrap;\n                        border-radius: 2px;\n                        border: 1px solid transparent;\n                        font-size: 14px;\n                        padding: 0 20px;\n                        -webkit-tap-highlight-color: transparent;\n                    ">\n                        <div class="offline-model-button-content" style="\n                            display: -webkit-box;\n                            display: -webkit-flex;\n                            display: -ms-flexbox;\n                            display: flex;\n                            -webkit-box-orient: horizontal;\n                            -webkit-box-direction: normal;\n                            -webkit-flex-flow: row nowrap;\n                            -ms-flex-flow: row nowrap;\n                            flex-flow: row nowrap;\n                            -webkit-box-pack: center;\n                            -webkit-justify-content: center;\n                            -ms-flex-pack: center;\n                            justify-content: center;\n                            -webkit-box-align: center;\n                            -webkit-align-items: center;\n                            -ms-flex-align: center;\n                            align-items: center;\n                        ">'+t+"</div>\n                    </button>\n                </div>\n            </div>\n        </div>\n    ");r.querySelector(".offline-model-close").addEventListener("click",(function(){document.body.removeChild(r)})),r.querySelector(".offline-model-ok").addEventListener("click",n),document.body.appendChild(r)}("与服务器同步完成，请刷新。","重新加载",(function(){location.href=l}))}else r.createFileTimer=Z.Z.wait(5e3).run(r.tryToCreateFile);else{var u=e.data;if(null===(i=n.g.log)||void 0===i||i.error("创建文件成功  retCode=",null===u||void 0===u?void 0:u.retcode),u&&0===u.retcode){n.g.clientVars=u.data,P.q.reloadConfig(n.g.clientVars),r.option.app.spreadsheet.setTitle(P.q.getConfig("title")),d.ZP.spreadsheetEvent.trigger("createFileSuccess");var c=1048576,h={uid:(0,fe.getUid)(),serverVars:n.g.clientVars.collab_client_vars,userid:n.g.clientVars.userId,uuId:"",module:"Sheet",config:{bigDataCommitConfig:{isSupportBigDataCommit:!0,minContentLength:2*c,maxContentLength:19.5*c},headerGeneralPacket:ge(r.option.app),messagePriority:new Map([[a.Command.CURSOR_MESSAGE,s.MessagePriority.LOW]])}};r.option.app.messageCenter.setGlobalVars(h),r.option.app.messageCenter.reConnect(h)}}})).catch((function(e){var t;null===(t=n.g.log)||void 0===t||t.error("调用创建接口异常",null===e||void 0===e?void 0:e.stack),r.createFileTimer=Z.Z.wait(5e3).run(r.tryToCreateFile)})).finally((function(){r.isWattingCreateFileResponse=!1}));null===(o=n.g.log)||void 0===o||o.warn("不符合条件，抛弃创建文件任务",P.q.getConfig("padStatus"),P.q.getConfig("isUserChangeTitle"))}},r.clearOfflineStoreHandleFun=function(e){return ft((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function t(){var r,o,i,a,s;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=e.type,i=e.callback,this.isDBAvaliable()&&o===H.N.ALL){t.next=4;break}return null===i||void 0===i||i(!1),t.abrupt("return");case 4:return t.prev=4,a=j.he.newInstance().addCondition("globalPadId",j.E1.ONLY,this.option.globalPadId).addCondition("uid",j.E1.ONLY,this.option.uid),t.next=8,this.offlineDataManager.getDatabase().delete(j.me.DOCUMENT_DATA,a);case 8:if(!(s=t.sent).error){t.next=11;break}throw s.error;case 11:null===i||void 0===i||i(!0),t.next=19;break;case 14:t.prev=14,t.t0=t.catch(4),null===i||void 0===i||i(!1),null===(r=n.g.log)||void 0===r||r.error("数据库操作失败 clearOfflineStoreHandleFun",null===t.t0||void 0===t.t0?void 0:t.t0.stack),this.switchStatus(nt.ERROR);case 19:case"end":return t.stop()}}),t,this,[[4,14]])})))},r.handleLocalCreateDocData=function(){return ft((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function e(){var t,r,o,i,a,s,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=j.Gk.EXCEL,i=this.getLocalCreateDocOptions(),a=i.folder,s=i.isShareme,d=i.isOnlineBorrowed,e.next=4,this.offlineDataManager.getHelper().storeNewDocData(o,a,this.option.globalPadId,this.option.secretId,n.g.clientVars,s);case 4:if(!e.sent.error){e.next=8;break}return I.default.show({message:x.ZP.t("新建失败，请稍后重试。"),autoClose:!1,type:"error",zIndex:100002}),e.abrupt("return",!1);case 8:return P.q.setConfig({isNewDoc:!1}),null===(r=null===(t=n.g.mqq)||void 0===t?void 0:t.invoke)||void 0===r||r.call(t,"docx","docDBOperation",{isOnlineBorrowed:d,folder:a,globalId:this.option.globalPadId,listTypes:[j.l6.listTypeOffline,j.l6.listTypeCreated,j.l6.listTypeMyDoc,j.l6.listTypeRecent],operation:"addDocToList"}),e.abrupt("return",!0);case 11:case"end":return e.stop()}}),e,this)})))},r.networkStatusChangedFun=function(e,t){return ft((0,Ie.Z)(r),void 0,void 0,regeneratorRuntime.mark((function r(){var o;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.isOnline!==t.isOnline){r.next=2;break}return r.abrupt("return");case 2:null===(o=n.g.log)||void 0===o||o.info("NetworkStatusChanged. newStatus="+t.isOnline+" ",this.isDBAvaliable()),t.isOnline&&(this.toast.hide(),this.isNeedCreateFile()&&this.tryToCreateFile());case 4:case"end":return r.stop()}}),r,this)})))},null===(o=n.g.log)||void 0===o||o.info("flow MessageService new OfflineOpen()"),r}(0,i.Z)(t,e);var r=t.prototype;return r.init=function(){return ft(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initDatabaseConnection();case 2:this.option.app.sheetStatus.workbookStatus.status.change(this.networkStatusChangedFun),d.ZP.spreadsheetEvent.listen("clearOfflineStore",this.clearOfflineStoreHandleFun),this.registerCallbackOnWindow();case 5:case"end":return e.stop()}}),e,this)})))},r.dispose=function(){e.prototype.dispose.call(this),this.destroy()},r.destroy=function(){Z.Z.erase(this.createFileTimer),this.option.app.sheetStatus.workbookStatus.status.offChange(this.networkStatusChangedFun),d.ZP.spreadsheetEvent.remove("clearOfflineStore",this.clearOfflineStoreHandleFun),this.offlineDataManager.getDatabase().disConnect()},r.getDatabase=function(){return this.offlineDataManager.getDatabase()},r.isDBAvaliable=function(){var e;return this.status!==nt.OPEN&&(null===(e=n.g.log)||void 0===e||e.error("数据库不可用")),this.status===nt.OPEN},r.switchStatus=function(e){var t,r,o=this.status;this.status=e,null===(t=n.g.log)||void 0===t||t.info("switchOfflineDatabaseStatus",o,e),o===nt.OPEN&&e!==nt.OPEN&&(null===(r=n.g.log)||void 0===r||r.error("数据库切换状态 oldStatus="+o+"  newStatus="+e),c.ZP.run(h.CONFIG.OFFLINE_DATABASE_ERROR,[o,e]))},r.isNeedCreateFile=function(){return(0,U.q)()},r.userInfoConfig=function(e){return{userId:e.userId,name:e.userInfo.fullName,userPic:e.userInfo.userPic,uin:e.userInfo.uin}},r.handleCacheDocManualOffline=function(){var e,t,r;return ft(this,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.getManualOfflineDocSize();case 2:if(!((i=o.sent)>=100)){o.next=6;break}return I.default.show({message:x.ZP.t("已达到上限，请取消其他缓存的文档后再试。"),autoClose:!0,type:"error",duration:2e3,zIndex:100002}),o.abrupt("return",!1);case 6:if(!(i>=0)){o.next=26;break}return o.next=9,(0,dt.D)();case 9:if(o.sent){o.next=13;break}return lt(st.CACHE_DOC_FAIL),o.abrupt("return",!1);case 13:return null===(e=n.g.mqq)||void 0===e||e.invoke("docx","notifyNative",{status:0,url:location.href,retCode:0,globalPadId:P.q.getConfig("globalPadId")||"",source:"edit"}),o.next=16,this.updateDocumentCache();case 16:if((a=o.sent).resultCode!==j.DW.Success){o.next=22;break}return this.option.app.emitter.emit("updateMoreMenu"),I.default.show({message:x.ZP.t("成功缓存该文档"),autoClose:!0,type:"success",duration:2e3,zIndex:100002}),null===(t=n.g.mqq)||void 0===t||t.invoke("docx","notifyNative",{status:1,url:location.href,retCode:0,globalPadId:P.q.getConfig("globalPadId")||"",source:"edit"}),o.abrupt("return",!0);case 22:if(null===(r=n.g.mqq)||void 0===r||r.invoke("docx","notifyNative",{status:1,url:location.href,retCode:-1,globalPadId:P.q.getConfig("globalPadId")||"",source:"edit"}),a.resultCode!==j.DW.PreFetchDocDataError||200058!==a.subResultCode){o.next=26;break}return I.default.show({message:x.ZP.t("文档过大，无法缓存。"),autoClose:!0,type:"error",duration:2e3,zIndex:100002}),o.abrupt("return",!1);case 26:return lt(st.CACHE_DOC_FAIL),o.abrupt("return",!1);case 28:case"end":return o.stop()}}),o,this)})))},r.updateDocumentCache=function(e){var t,r;return ft(this,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a,s,d,l;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(this.option.app.sheetStatus.workbookStatus.isOnline){o.next=15;break}return o.next=3,this.offlineDataManager.getHelper().getPadInfo(this.option.globalPadId);case 3:if(!o.sent.isOfflineCache){o.next=14;break}return i=j.he.newInstance().addCondition("globalPadId",j.E1.ONLY,this.option.globalPadId).addCondition("uid",j.E1.ONLY,this.option.uid),o.next=8,this.offlineDataManager.getDatabase().updateField(j.me.PAD_INFO,i,{isManualOffline:!0});case 8:if(a=o.sent,!(s=a.error)){o.next=13;break}return null===(t=n.g.log)||void 0===t||t.error("offlineEdit updateDocumentCache updateField error",s.stack,s.message),o.abrupt("return",{resultCode:j.DW.UpdatePreFetchOfflienDataError,subResultCode:-1e3,message:x.ZP.t("updateDocumentCache updateField发生错误。"),error:s});case 13:return o.abrupt("return",{resultCode:j.DW.Success,subResultCode:0,message:""});case 14:return o.abrupt("return",{resultCode:j.DW.UpdatePreFetchOfflienDataError,subResultCode:-1001,message:x.ZP.t("无网络，也没有自动缓存，回包失败。")});case 15:return void 0===(d=e)&&(d=this.option.networkHelper.baseVersion()),o.next=19,this.offlineDataManager.getHelper().fetchAndStoreDocumentCache({padId:P.q.getConfig("globalPadId"),secretId:this.option.secretId,source:"edit",force:!0,padType:j.Gk.EXCEL,deleteOldCache:!1,isManualOffline:!0,rev:d});case 19:return(l=o.sent).error&&(null===(r=n.g.log)||void 0===r||r.error("offlineEdit updateDocumentCache fetchAndStoreDocumentCache error",l.error.stack)),o.abrupt("return",l);case 22:case"end":return o.stop()}}),o,this)})))},r.clearManualCache=function(){var e,t;return ft(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o,i,a;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=j.he.newInstance().addCondition("globalPadId",j.E1.ONLY,this.option.globalPadId).addCondition("uid",j.E1.ONLY,this.option.uid),r.next=3,this.offlineDataManager.getDatabase().updateField(j.me.PAD_INFO,o,{isManualOffline:!1});case 3:if(!(i=r.sent).error){r.next=7;break}return null===(e=n.g.log)||void 0===e||e.error("offlineEdit clearManualCache updateField error",i.error.stack,i.error.message),r.abrupt("return",!1);case 7:return a="https://"+pt.Z.getConfig("runtime.domainName")+"/sheet/"+this.option.secretId,null===(t=n.g.log)||void 0===t||t.info("取消缓存图片",a),j.RR.invokeNative("docx","removeManualSaveDoc",{docUrl:a},(function(){})),r.abrupt("return",!0);case 11:case"end":return r.stop()}}),r,this)})))},r.getDocCacheStatus=function(){return ft(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.offlineDataManager.getHelper().getPadInfo(this.option.globalPadId);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",-1);case 5:if(!t.isManualOffline){e.next=7;break}return e.abrupt("return",1);case 7:if(!t.isOfflineCache){e.next=9;break}return e.abrupt("return",2);case 9:return e.abrupt("return",-1);case 10:case"end":return e.stop()}}),e,this)})))},r.getManualOfflineDocSize=function(){var e;return ft(this,void 0,void 0,regeneratorRuntime.mark((function t(){var r,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=j.he.newInstance().addCondition("uid",j.E1.ONLY,this.option.uid).addCondition("isManualOffline",j.E1.ONLY,!0),this.isDBAvaliable()){t.next=3;break}return t.abrupt("return",-1);case 3:return t.next=5,this.offlineDataManager.getDatabase().getAll(j.me.PAD_INFO,r);case 5:if(!(o=t.sent).error){t.next=9;break}return null===(e=n.g.log)||void 0===e||e.error("offlineEdit getManualOfflineDocSize error",o.error.stack,o.error.message),t.abrupt("return",-1);case 9:return t.abrupt("return",o.data.length);case 10:case"end":return t.stop()}}),t,this)})))},r.handleClearDocManualOffline=function(){var e;return ft(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.clearManualCache();case 2:if(!t.sent){t.next=10;break}return this.option.app.emitter.emit("updateMoreMenu"),I.default.show({message:x.ZP.t("已取消缓存该文档"),autoClose:!0,type:"success",duration:2e3,zIndex:100002}),null===(e=n.g.mqq)||void 0===e||e.invoke("docx","notifyNative",{status:2,url:location.href,retCode:0,globalPadId:P.q.getConfig("globalPadId")||"",source:"edit"}),t.abrupt("return",!0);case 10:return I.default.show({message:x.ZP.t("取消缓存失败，请稍后重试。"),autoClose:!0,type:"error",duration:2e3,zIndex:100002}),t.abrupt("return",!1);case 12:case"end":return t.stop()}}),t,this)})))},r.userChange2OfflineData=function(e){return new j.TU({uid:this.option.uid,globalPadId:this.option.globalPadId,secretId:this.option.secretId,subSheetId:e.sheetId,type:this.userChangeStatus2OfflineType(e.status),docType:j.Gk.EXCEL,taskId:e.taskId,version:e.baseVersion,data:(0,m.Jv)(e),createTime:e.time,dver:n.g.__globalCodeVersion})},r.missChange2OfflineData=function(e){return new j.TU({uid:this.option.uid,globalPadId:this.option.globalPadId,secretId:this.option.secretId,subSheetId:e.sheetId,type:j.Nt.NEW_CHANGE,docType:j.Gk.EXCEL,taskId:e.commitId,version:e.newVersion,data:e,createTime:Date.now(),dver:n.g.__globalCodeVersion})},r.userChangeStatus2OfflineType=function(e){var t=j.Nt.WATTING;switch(e){case p.t.WATING:t=j.Nt.WATTING;break;case p.t.COMMITING:t=j.Nt.COMMITING;break;case p.t.ACCEPT:t=j.Nt.ACCEPTED}return t},r.onAcceptCommit=function(e){var t;return ft(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o,i;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(this.isDBAvaliable()){r.next=2;break}return r.abrupt("return");case 2:return r.prev=2,o=this.userChange2OfflineData(e.userChange),r.next=6,this.offlineDataManager.getDatabase().update(j.me.DOCUMENT_DATA,o);case 6:if(!(i=r.sent).error){r.next=9;break}throw i.error;case 9:r.next=15;break;case 11:r.prev=11,r.t0=r.catch(2),null===(t=n.g.log)||void 0===t||t.error("数据库操作失败 onUserChangeAccept",null===r.t0||void 0===r.t0?void 0:r.t0.stack,null===r.t0||void 0===r.t0?void 0:r.t0.message),this.switchStatus(nt.ERROR);case 15:case"end":return r.stop()}}),r,this,[[2,11]])})))},r.updateMisschange=function(e){var t;return ft(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o,i;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(this.isDBAvaliable()){r.next=2;break}return r.abrupt("return");case 2:return r.prev=2,o=this.missChange2OfflineData(e.changeInfo),r.next=6,this.offlineDataManager.getDatabase().update(j.me.DOCUMENT_DATA,o);case 6:if(!(i=r.sent).error){r.next=9;break}throw i.error;case 9:r.next=15;break;case 11:r.prev=11,r.t0=r.catch(2),null===(t=n.g.log)||void 0===t||t.error("数据库操作失败 updateMisschange",null===r.t0||void 0===r.t0?void 0:r.t0.stack),this.switchStatus(nt.ERROR);case 15:case"end":return r.stop()}}),r,this,[[2,11]])})))},r.getLocalCreateDocOptions=function(){var e=(0,M.ol)(n.g.__originUrl);return{folder:decodeURIComponent(e.folder||"/"),isShareme:"true"===e.isShareme,isOnlineBorrowed:"true"===e.isOnlineBorrowed}},r.initDatabaseConnection=function(){var e;return ft(this,void 0,void 0,regeneratorRuntime.mark((function t(){var r,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.checkDocTabLock();case 2:if(r=t.sent,o=r.isLockedByOtherTab,!r.isDBAvaliable){t.next=20;break}return this.switchStatus(nt.INITING),t.prev=7,t.next=10,this.initOfflineDataManager();case 10:this.offlineDataManager.getHelper().setDefaultCodeVersion("sheet",n.g.__globalCodeVersion),this.switchStatus(o?nt.CLOSE:nt.OPEN),t.next=18;break;case 14:t.prev=14,t.t0=t.catch(7),null===(e=n.g.log)||void 0===e||e.error("init OfflineDatamanager error",null===t.t0||void 0===t.t0?void 0:t.t0.name,null===t.t0||void 0===t.t0?void 0:t.t0.stack),t.t0&&t.t0.name===j.Iv.NOT_SUPPORT_INDEXEDDB?(this.switchStatus(nt.NOT_SUPPORT),c.ZP.run(h.CONFIG.NOT_SUPPORT_INDEXEDDB)):(this.switchStatus(nt.INIT_FAILED),c.ZP.run(h.CONFIG.OPEN_INDEXED_DB_FAIL,"1",t.t0||{}));case 18:t.next=21;break;case 20:this.switchStatus(nt.CLOSE);case 21:case"end":return t.stop()}}),t,this,[[7,14]])})))},r.initOfflineDataManager=function(){return ft(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){if(j.V0.offlineDataManager)return t.offlineDataManager=j.V0.offlineDataManager,void e(!0);t.offlineDataManager=new j.Sg({businessType:j.Gk.EXCEL,user:new j.ao({uid:t.option.uid})});var r=Ye.Z.util.timer.wait(2e3).run((function(){n(new Error("InitDatabaseTimeoutError"))}));setTimeout((function(){return ft(t,void 0,void 0,regeneratorRuntime.mark((function t(){var o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.offlineDataManager.init();case 2:o=t.sent,Ye.Z.util.timer.erase(r),o.error&&n(o.error),e(o);case 6:case"end":return t.stop()}}),t,this)})))}),0)})));case 1:case"end":return e.stop()}}),e)})))},r.checkDocTabLock=function(){var e;return ft(this,void 0,void 0,regeneratorRuntime.mark((function t(){var n,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.option.app.offlineEdit.lockHelper().lockResult;case 2:if(n=t.sent,r=null===(e=n.data)||void 0===e?void 0:e.optional,n.isSuccess){t.next=11;break}if("list"!==(null===r||void 0===r?void 0:r.source)){t.next=9;break}return this.toast.show(),this.option.app.offlineEdit.lockHelper().deteckLock((function(){location.reload()}),200),t.abrupt("return",{isLockedByOtherTab:!n.isSuccess,isDBAvaliable:!1});case 9:if("edit"!==(null===r||void 0===r?void 0:r.source)){t.next=11;break}return t.abrupt("return",{isLockedByOtherTab:!n.isSuccess,isDBAvaliable:!0});case 11:return t.abrupt("return",{isLockedByOtherTab:!n.isSuccess,isDBAvaliable:!0});case 12:case"end":return t.stop()}}),t,this)})))},t}(ue.JT),vt=function(e,t,n,r){var o,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},mt=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Ct=function(e,t){return function(n,r){t(n,r,e)}},bt=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{d(r.next(e))}catch(t){i(t)}}function s(e){try{d(r.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}d((r=r.apply(e,t||[])).next())}))},Et=function(){function e(e,t,n){this.app=e,this.instantiationService=t,this.sheetLifeService=n}var t=e.prototype;return t.initMessageCenter=function(){var e;return bt(this,void 0,void 0,regeneratorRuntime.mark((function t(){var r,o,i,a,s,d;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return null===(e=n.g.log)||void 0===e||e.info("flow MessageService initMessage()"),this.app.emitter.emit(this.app.EVENT.SPREAD_SHEET_MESSAGE_START),this.sheetLifeService.phase=Re.P.SPREAD_SHEET_MESSAGE_START,this.initNetworkStatus(),r=new Oe(this.app,{baseVersion:P.q.getConfig("rev")}),(o=r.messageCenter).pause(),this.instantiationService.addService(Se.s,r),this.app.initMessageCenter(o,r),i=r.messageCenter.versionManager,a=r.sendMessageCenterAdapter,s=new it({app:this.app,secretId:P.q.getConfig("upid")||location.pathname.replace(/\/sheet\/(history\/)?/,""),globalPadId:P.q.getConfig("globalPadId"),uid:P.q.getConfig("uid"),version:i.getCurrentVersion()}),t.next=14,s.init();case 14:if(r.addUserChangeObserver(s),this.app.initOfflineEdit(s),!(0,q.j)()){t.next=24;break}return d=new gt({app:this.app,secretId:P.q.getConfig("upid")||location.pathname.replace("/sheet/",""),globalPadId:P.q.getConfig("globalPadId"),uid:P.q.getConfig("uid"),networkHelper:{baseVersion:i.getCurrentVersion.bind(i),addUserChange:a.addUserChange.bind(a)}}),t.next=20,d.init();case 20:return r.addUserChangeObserver(d),t.next=23,(0,ye.I8)();case 23:this.app.initOfflineOpen(d);case 24:this.app.emitter.emit(this.app.EVENT.SPREAD_SHEET_MESSAGE_END),this.sheetLifeService.phase=Re.P.SPREAD_SHEET_MESSAGE_END;case 26:case"end":return t.stop()}}),t,this)})))},t.initNetworkStatus=function(){var e;null===(e=n.g.log)||void 0===e||e.info("flow","MessageService initNetworkStatus()");var t=new ke(this.app);this.app.initNetworkStatus(t)},e}(),wt=Et=vt([Ct(0,r.m),Ct(1,ue.TG),Ct(2,Re.n),mt("design:paramtypes",["function"===typeof(ut="undefined"!==typeof r.m&&r.m)?ut:Object,"function"===typeof(ct="undefined"!==typeof ue.TG&&ue.TG)?ct:Object,"function"===typeof(ht="undefined"!==typeof Re.n&&Re.n)?ht:Object])],Et)}}]),window.jsExecEndTimeStamp=Date.now(),window.cachedPerformanceEntries||(window.cachedPerformanceEntries=[]),window.cachedPerformanceEntries.push({name:"jsExec: js/bundle_messageService.7654ee7ea7bdbe697f72.js",entryType:"jsExec",startTime:window.jsExecStartTimeStamp,endTime:window.jsExecEndTimeStamp});
//# sourceMappingURL=bundle_messageService.7654ee7ea7bdbe697f72.js.map