self.window=self,window.jsExecStartTimeStamp=Date.now(),(self.webpackChunk_tencent_alloy_builder=self.webpackChunk_tencent_alloy_builder||[]).push([["vendors-node_modules_tencent_ark-offline-edit_lib_index_js"],{"../node_modules/@tencent/ark-model/lib/index.js":function(e,t,n){n.d(t,{H4:function(){return f},MZ:function(){return p},TU:function(){return _},tE:function(){return o}});var r,i,o,a,s,u,c,l,p,h=n("../node_modules/@tencent/memoire-structured-storage/esm/index.js");!function(e){e[e.unknown=-1]="unknown",e[e.doc=0]="doc",e[e.sheet=1]="sheet",e[e.slide=4]="slide"}(o||(o={})),function(e){e.doc="doc",e.sheet="sheet",e.form="form",e.slide="slide"}(a||(a={})),(r={})[a.doc]=o.doc,r[a.sheet]=o.sheet,r[a.slide]=o.slide,(i={})[o.doc]=a.doc,i[o.sheet]=a.sheet,i[o.slide]=a.slide,function(e){e[e.private=0]="private",e[e.partialShare=1]="partialShare",e[e.canRead=2]="canRead",e[e.canEdit=3]="canEdit"}(s||(s={})),function(e){e.new="new",e.local="local",e.deleted="deleted",e.normal="normal"}(u||(u={})),function(e){e[e.file=1]="file",e[e.folder=2]="folder"}(c||(c={})),function(e){e[e.trash=3]="trash",e[e.share=4]="share",e[e.myDoc=5]="myDoc",e[e.recent=6]="recent",e[e.start=7]="start"}(l||(l={})),function(e){e.init="init",e.document="document",e.workbook="workbook",e.chunk="chunk",e.accepted="accepted",e.missChange="misschange",e.newChange="newchange",e.committing="commiting",e.waiting="watting",e.queue="queue"}(p||(p={}));var d,f="TencentDocs";!function(e){e.documentStatus="DocumentStatus",e.documentEntities="DocumentEntities",e.newDocumentIds="NewDocumentIds",e.padinfo="PadInfo",e.offlineData="OfflineData",e.documentData="DocumentData"}(d||(d={}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var v=function(e,t){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},v(e,t)};function y(e,t){function n(){this.constructor=e}v(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function g(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a}function m(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)}var b=function(e){function t(t){var n,r,i,o,a,s,c=e.call(this)||this;return c.isDefaultChunk=!1,c.uid=t.uid,c.type=t.type,c.data=t.data,c.dataVersion=t.dataVersion,c.docType=t.docType,c.subId=t.subId,c.secretId=t.secretId,c.version=t.version,c.globalPadId=t.globalPadId,c.taskId=null!==(n=t.taskId)&&void 0!==n?n:c.getTaskId(),c.isDefaultChunk=null!==(r=t.isDefaultChunk)&&void 0!==r&&r,c.chunkId=null!==(i=t.chunkId)&&void 0!==i?i:0,c.docStatus=null!==(o=t.docStatus)&&void 0!==o?o:u.normal,c.createTimestamp=null!==(a=t.createTimestamp)&&void 0!==a?a:Date.now(),c.lastModifyTimestamp=null!==(s=t.lastModifyTimestamp)&&void 0!==s?s:Date.now(),c.key=c.getKey(),c}return y(t,e),t.prototype.getTaskId=function(){return Math.ceil(2147483648*Math.random())},t.prototype.getKey=function(){return this.type===p.init?this.globalPadId+"_"+this.subId+"_"+this.uid:this.type===p.document?this.globalPadId+"_"+this.uid+"_version_"+this.version:this.type===p.workbook?this.globalPadId+"_"+this.subId+"_"+this.uid+"_version_"+this.version:this.type===p.chunk?this.globalPadId+"_"+this.subId+"_"+this.chunkId+"_"+this.uid+"_version_"+this.version:this.globalPadId+"_"+this.subId+"_"+this.uid+"_taskId_"+this.taskId},g([(0,h.T$)(),m("design:type",String)],t.prototype,"key",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"secretId",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"globalPadId",void 0),g([(0,h.Kz)(),m("design:type",Number)],t.prototype,"version",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"type",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"uid",void 0),g([(0,h.Kz)(),(0,h.EP)("subSheetId"),m("design:type",String)],t.prototype,"subId",void 0),g([(0,h.Kz)(),m("design:type",Number)],t.prototype,"chunkId",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"taskId",void 0),g([(0,h.EP)("_data"),m("design:type",String)],t.prototype,"data",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"docType",void 0),g([(0,h.EP)("padStatus"),m("design:type",String)],t.prototype,"docStatus",void 0),g([(0,h.EP)("createTime"),m("design:type",Number)],t.prototype,"createTimestamp",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"lastModifyTimestamp",void 0),g([(0,h.EP)("dver"),m("design:type",String)],t.prototype,"dataVersion",void 0),g([(0,h.EP)("default"),m("design:type",Object)],t.prototype,"isDefaultChunk",void 0),t}(h.Hn),_=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.addListTimestamp=0,t.attribute=null,t.docPolicy=s.private,t.docPrivilege=null,t.folderPolicy=0,t.folderPrivilege=null,t.isManualOffline=!1,t.isOfflineCache=!1,t.hasSnapShot=!1,t.isAddedToMy=0,t.isCollected=0,t.isOwner=1,t.isPinned=0,t.isShortcut=0,t.isUserChangeTitle=!1,t.lastCollectTimestamp=0,t.lastDeleteTimestamp=0,t.parents=[],t}y(t,e),g([(0,h.T$)(),m("design:type",String)],t.prototype,"key",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"secretId",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"globalPadId",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"uid",void 0),g([(0,h.EP)("add_list_ts"),m("design:type",Object)],t.prototype,"addListTimestamp",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"attribute",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"childrenLength",void 0),g([(0,h.EP)("client_version"),m("design:type",String)],t.prototype,"clientVersion",void 0),g([(0,h.EP)("create_ts"),m("design:type",Number)],t.prototype,"createTimestamp",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"creator",void 0),g([(0,h.EP)("creator_domain"),m("design:type",String)],t.prototype,"creatorDomain",void 0),g([(0,h.EP)("doc_icon"),m("design:type",String)],t.prototype,"icon",void 0),g([(0,h.EP)("doc_policy"),m("design:type",Number)],t.prototype,"docPolicy",void 0),g([(0,h.EP)("doc_privilege"),m("design:type",Object)],t.prototype,"docPrivilege",void 0),g([(0,h.EP)("doc_thumbnail"),m("design:type",String)],t.prototype,"thumbnail",void 0),g([(0,h.EP)("doc_type"),m("design:type",Number)],t.prototype,"docType",void 0),g([(0,h.EP)("doc_type_desc"),m("design:type",String)],t.prototype,"docTypeDesc",void 0),g([(0,h.EP)("doc_url"),m("design:type",String)],t.prototype,"url",void 0),g([(0,h.EP)("domain_id"),m("design:type",String)],t.prototype,"domainId",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"dver",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"folder",void 0),g([(0,h.EP)("folder_id"),m("design:type",String)],t.prototype,"folderId",void 0),g([(0,h.EP)("folder_policy"),m("design:type",Object)],t.prototype,"folderPolicy",void 0),g([(0,h.EP)("folder_privilege"),m("design:type",Object)],t.prototype,"folderPrivilege",void 0),g([(0,h.EP)("isDelete"),m("design:type",Boolean)],t.prototype,"isDeleted",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"isManualOffline",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"isMyCreated",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"isMydoc",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"isOfflineCache",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"isRencent",void 0),g([(0,h.EP)("isShareme"),m("design:type",Boolean)],t.prototype,"isShareToMe",void 0),g([(0,h.EP)("isSnapShot"),m("design:type",Object)],t.prototype,"hasSnapShot",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"isStar",void 0),g([(0,h.EP)("is_added_my"),m("design:type",Object)],t.prototype,"isAddedToMy",void 0),g([(0,h.EP)("is_collected"),m("design:type",Object)],t.prototype,"isCollected",void 0),g([(0,h.EP)("is_owner"),m("design:type",Object)],t.prototype,"isOwner",void 0),g([(0,h.EP)("is_pinned"),m("design:type",Object)],t.prototype,"isPinned",void 0),g([(0,h.EP)("is_shortcut"),m("design:type",Object)],t.prototype,"isShortcut",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"isUserChangeTitle",void 0),g([(0,h.EP)("lastSyncTime"),m("design:type",Number)],t.prototype,"lastSyncTimestamp",void 0),g([(0,h.EP)("last_browse_ts"),m("design:type",Number)],t.prototype,"lastBrowseTimestamp",void 0),g([(0,h.EP)("last_collect_ts"),m("design:type",Object)],t.prototype,"lastCollectTimestamp",void 0),g([(0,h.EP)("last_delete_ts"),m("design:type",Object)],t.prototype,"lastDeleteTimestamp",void 0),g([(0,h.EP)("last_modify_ts"),m("design:type",Number)],t.prototype,"lastModifyTimestamp",void 0),g([(0,h.EP)("last_modify_nick"),m("design:type",String)],t.prototype,"lastModifyNick",void 0),g([(0,h.EP)("last_modify_uid"),m("design:type",String)],t.prototype,"lastModifyUid",void 0),g([(0,h.EP)("last_pinned_ts"),m("design:type",Number)],t.prototype,"lastPinnedTimestamp",void 0),g([(0,h.EP)("list_info_type"),m("design:type",Number)],t.prototype,"listInfoType",void 0),g([(0,h.EP)("list_type"),m("design:type",Number)],t.prototype,"listType",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"offlineCommiting",void 0),g([(0,h.EP)(),m("design:type",Boolean)],t.prototype,"offlineCommitSuccessd",void 0),g([(0,h.EP)("origin_folder_id"),m("design:type",String)],t.prototype,"originFolderId",void 0),g([(0,h.EP)("owner_nick"),m("design:type",String)],t.prototype,"ownerNick",void 0),g([(0,h.EP)("owner_uid"),m("design:type",String)],t.prototype,"ownerUid",void 0),g([(0,h.EP)("pad_id"),m("design:type",String)],t.prototype,"padId",void 0),g([(0,h.EP)("parent_folder_id"),m("design:type",String)],t.prototype,"parentFolderId",void 0),g([(0,h.EP)(),m("design:type",Array)],t.prototype,"parents",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"privilege",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"status",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"title",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"type",void 0),g([(0,h.EP)("uncommit"),m("design:type",Boolean)],t.prototype,"hasLocalChanges",void 0),t=g([(0,h.yD)(d.padinfo)],t)}(h.Hn),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isCreated=!1,t}y(t,e),g([(0,h.T$)(),m("design:type",String)],t.prototype,"globalPadId",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"secretId",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"documentType",void 0),g([(0,h.EP)(),m("design:type",String)],t.prototype,"localPadId",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"isCreated",void 0),t=g([(0,h.yD)(d.newDocumentIds)],t)}(h.Hn),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lastSyncTimestamp=0,t}y(t,e),g([(0,h.T$)(),m("design:type",String)],t.prototype,"globalPadId",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"secretId",void 0),g([(0,h.Kz)(),m("design:type",String)],t.prototype,"uid",void 0),g([(0,h.EP)("lastSyncTime"),m("design:type",Object)],t.prototype,"lastSyncTimestamp",void 0),g([(0,h.EP)(),m("design:type",Number)],t.prototype,"lastErrorTimestamp",void 0),t=g([(0,h.yD)(d.documentStatus)],t)}(h.Hn),function(e){function t(){return null!==e&&e.apply(this,arguments)||this}y(t,e),g([(0,h.T$)(),m("design:type",String)],t.prototype,"key",void 0),g([(0,h.EP)(),m("design:type",Object)],t.prototype,"data",void 0),t=g([(0,h.yD)(d.documentEntities)],t)}(h.Hn),function(e){function t(){return null!==e&&e.apply(this,arguments)||this}y(t,e),t=g([(0,h.yD)(d.documentData)],t)}(b),function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return y(t,e),t=g([(0,h.yD)(d.offlineData)],t)}(b))},"../node_modules/@tencent/ark-offline-edit/lib/index.js":function(e,t,n){n.d(t,{g:function(){return jn},x:function(){return wn}});var r,i,o=n("../node_modules/@tencent/memoire-structured-storage/esm/index.js"),a=n("./node_modules/tslib/tslib.es6.js"),s=n("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),u=n("../node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),c=n("../node_modules/@babel/runtime/regenerator/index.js"),l=n.n(c),p=new WeakMap,h=new WeakMap,d=new WeakMap,f=new WeakMap,v=new WeakMap,y={get:function(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return h.get(e);if("objectStoreNames"===t)return e.objectStoreNames||d.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return b(e[t])},set:function(e,t,n){return e[t]=n,!0},has:function(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function g(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.apply(_(this),n),b(p.get(this))}:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return b(e.apply(_(this),n))}:function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=e.call.apply(e,[_(this),t].concat(r));return d.set(o,t.sort?t.sort():[t]),b(o)}}function m(e){return"function"===typeof e?g(e):(e instanceof IDBTransaction&&function(e){if(!h.has(e)){var t=new Promise((function(t,n){var r=function(){e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=function(){t(),r()},o=function(){n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)}));h.set(e,t)}}(e),t=e,(r||(r=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((function(e){return t instanceof e}))?new Proxy(e,y):e);var t}function b(e){if(e instanceof IDBRequest)return function(e){var t=new Promise((function(t,n){var r=function(){e.removeEventListener("success",i),e.removeEventListener("error",o)},i=function(){t(b(e.result)),r()},o=function(){n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)}));return t.then((function(t){t instanceof IDBCursor&&p.set(t,e)})).catch((function(){})),v.set(t,e),t}(e);if(f.has(e))return f.get(e);var t=m(e);return t!==e&&(f.set(e,t),v.set(t,e)),t}var _=function(e){return v.get(e)};function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function E(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.blocked,i=n.upgrade,o=n.blocking,a=n.terminated,s=indexedDB.open(e,t),u=b(s);return i&&s.addEventListener("upgradeneeded",(function(e){i(b(s.result),e.oldVersion,e.newVersion,b(s.transaction))})),r&&s.addEventListener("blocked",(function(){return r()})),u.then((function(e){a&&e.addEventListener("close",(function(){return a()})),o&&e.addEventListener("versionchange",(function(){return o()}))})).catch((function(){})),u}function A(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.blocked,r=indexedDB.deleteDatabase(e);return n&&r.addEventListener("blocked",(function(){return n()})),b(r).then((function(){}))}var C,S=["get","getKey","getAll","getAllKeys","count"],I=["put","add","delete","clear"],k=new Map;function T(e,t){if(e instanceof IDBDatabase&&!(t in e)&&"string"===typeof t){if(k.get(t))return k.get(t);var n=t.replace(/FromIndex$/,""),r=t!==n,i=I.includes(n);if(n in(r?IDBIndex:IDBObjectStore).prototype&&(i||S.includes(n))){var o=function(){var e=(0,u.Z)(l().mark((function e(t){var o,a,s,u,c,p,h=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a=this.transaction(t,i?"readwrite":"readonly"),s=a.store,u=h.length,c=new Array(u>1?u-1:0),p=1;p<u;p++)c[p-1]=h[p];return r&&(s=s.index(c.shift())),e.next=6,Promise.all([(o=s)[n].apply(o,c),i&&a.done]);case 6:return e.abrupt("return",e.sent[0]);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}();return k.set(t,o),o}}}y=x(x({},C=y),{},{get:function(e,t,n){return T(e,t)||C.get(e,t,n)},has:function(e,t){return!!T(e,t)||C.has(e,t)}});var D,N,P,O=n("../node_modules/@tencent/memoire-core/esm/index.js"),M=function(){function e(e,t,n,r){var i,o=this;this.mode=e,this.proxyCursor=t,this.direction=n,this.engineAspects=r,this.delete=void 0,this.update=void 0,e!==O.pF.READ_ONLY&&(this.delete=function(){return o.getProxyCursorWithMode().delete()},this.update=function(e){return o.getProxyCursorWithMode().update(e)}),(null===(i=this.engineAspects)||void 0===i?void 0:i.cursor)&&this.applyAspectPatch()}return e.prototype[Symbol.asyncIterator]=function(){return new R(this)},e.prototype.next=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e;return(0,a.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.proxyCursor.continue()];case 1:return(e=t.sent())?(this.proxyCursor=e,[2,this]):[2,null]}}))}))},e.prototype.value=function(){return this.proxyCursor.value},e.prototype.getProxyCursorWithMode=function(){return this.proxyCursor},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.cursor;this.mode!==O.pF.READ_ONLY&&(null===t||void 0===t||t.delete.patch(this,"delete"),null===t||void 0===t||t.update.patch(this,"update")),null===t||void 0===t||t.next.patch(this,"next"),null===t||void 0===t||t.value.patch(this,"value")},e}(),R=function(){function e(e){this.currentCursor=e}return e.prototype[Symbol.asyncIterator]=function(){return this},e.prototype.next=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,a.__generator)(this,(function(n){switch(n.label){case 0:return this.currentCursor?(e=this.currentCursor.value(),t=this,[4,this.currentCursor.next()]):[2,{value:void 0,done:!0}];case 1:return t.currentCursor=n.sent(),[2,{value:e,done:!1}]}}))}))},e}(),B=function(){function e(e,t,n,r){this.table=e,this.proxyIndex=t,this.mode=n,this.engineAspects=r,this.name=t.name,this.keyPath=t.keyPath,this.unique=t.unique,(null===r||void 0===r?void 0:r.index)&&this.applyAspectPatch()}return e.prototype.getAll=function(e){return this.proxyIndex.getAll(e)},e.prototype.getAllKeys=function(e,t){return this.proxyIndex.getAllKeys(e,t)},e.prototype.get=function(e){return this.proxyIndex.get(e)},e.prototype.openCursor=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.proxyIndex.openCursor(e,t)];case 1:return(n=r.sent())?[2,new M(this.mode,n,null!==t&&void 0!==t?t:"next")]:[2,null]}}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.index,n=this;null===t||void 0===t||t.get.patch(n,"get"),null===t||void 0===t||t.getAll.patch(n,"getAll"),null===t||void 0===t||t.getAllKeys.patch(n,"getAllKeys"),null===t||void 0===t||t.openCursor.patch(n,"openCursor")},e}(),q=function(){function e(e,t,n,r){this.mode=e,this.objectStore=t,this.engineAspects=n,this.transaction=r,this.createIndex=void 0,this.delete=void 0,this.bulkDelete=void 0,this.clear=void 0,this.insert=void 0,this.upsert=void 0,this.deleteIndex=void 0,this.bulkUpsert=void 0,this.keyPath=t.keyPath,this.autoIncrement=t.autoIncrement,this.tableName=t.name,this.indexNames=(0,a.__spreadArray)([],(0,a.__read)(t.indexNames)),this.initWriteFun(e),(null===n||void 0===n?void 0:n.table)&&this.applyAspectPatch()}return e.prototype.query=function(){throw new Error("query Method is not support for IDB.")},e.prototype.supports=function(e){return!["query","bulkDelete"].includes(e)},e.prototype.index=function(e){var t=this.objectStore.index(e);return new B(this,t,this.mode,this.engineAspects)},e.prototype.getAll=function(e){return this.objectStore.getAll(e)},e.prototype.getAllKeys=function(e,t){return this.objectStore.getAllKeys(e,t)},e.prototype.get=function(e){var t;return null!==(t=this.objectStore.get(e))&&void 0!==t?t:null},e.prototype.openCursor=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.objectStore.openCursor(e,t)];case 1:return(n=r.sent())?[2,new M(this.mode,n,null!==t&&void 0!==t?t:"next")]:[2,null]}}))}))},e.prototype.initWriteFun=function(e){var t=this;e===O.pF.VERSION_CHANGE&&(this.createIndex=this.createIndexFun,this.deleteIndex=function(e){return t.getProxyObjectStoreWithMode().deleteIndex(e)}),e!==O.pF.READ_ONLY&&(this.delete=function(e){return t.getProxyObjectStoreWithMode().delete(e)},this.bulkDelete=function(e){throw new Error("bulkDelete Method is not support for IDB.")},this.clear=function(){return t.getProxyObjectStoreWithMode().clear()},this.insert=function(e){return t.getProxyObjectStoreWithMode().add(e)},this.upsert=function(e){return t.getProxyObjectStoreWithMode().put(e)},this.bulkUpsert=function(e){var n=t.getProxyObjectStoreWithMode(),r=e.reduce((function(e,t){return e.push(n.put(t)),e}),[]);return Promise.all(r)})},e.prototype.createIndexFun=function(e,t,n){var r=this.getProxyObjectStoreWithMode();return new B(this,r.createIndex(e,t,n),this.mode)},e.prototype.getProxyObjectStoreWithMode=function(){return this.objectStore},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.table;if(this.mode===O.pF.READ_ONLY)return null===t||void 0===t||t.get.patch(this,"get"),null===t||void 0===t||t.getAll.patch(this,"getAll"),null===t||void 0===t||t.getAllKeys.patch(this,"getAllKeys"),null===t||void 0===t||t.index.patch(this,"index"),void(null===t||void 0===t||t.openCursor.patch(this,"openCursor"));this.mode===O.pF.VERSION_CHANGE&&(null===t||void 0===t||t.createIndex.patch(this,"createIndex"),null===t||void 0===t||t.deleteIndex.patch(this,"deleteIndex")),null===t||void 0===t||t.delete.patch(this,"delete"),null===t||void 0===t||t.insert.patch(this,"insert"),null===t||void 0===t||t.upsert.patch(this,"upsert"),null===t||void 0===t||t.bulkUpsert.patch(this,"bulkUpsert"),null===t||void 0===t||t.clear.patch(this,"clear")},e}(),L=function(){function e(e,t){this.proxyTransaction=e,this.engineAspects=t,this.tables=e.objectStoreNames,this.mode=e.mode,(null===t||void 0===t?void 0:t.transaction)&&this.applyAspectPatch()}return e.prototype.table=function(e){var t=this.proxyTransaction.objectStore(e);return new q(this.mode,t,this.engineAspects,this)},e.prototype.commit=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){return(0,a.__generator)(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.proxyTransaction.done];case 1:return e.sent(),[3,3];case 2:return e.sent(),[2,!1];case 3:return[2,!0]}}))}))},e.prototype.rollback=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){return(0,a.__generator)(this,(function(e){switch(e.label){case 0:return e.trys.push([0,1,,6]),this.proxyTransaction.abort(),[3,6];case 1:e.sent(),e.label=2;case 2:return e.trys.push([2,4,,5]),[4,this.proxyTransaction.done];case 3:return e.sent(),[3,5];case 4:return e.sent(),[2,!0];case 5:return[2,!1];case 6:return[2,!0]}}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.transaction,n=this;null===t||void 0===t||t.commit.patch(n,"commit"),null===t||void 0===t||t.rollback.patch(n,"rollback"),null===t||void 0===t||t.table.patch(n,"table")},e}(),j=function(){function e(e,t){this.idbDatabase=e,this.engineAspect=t,this.name=e.name,this.version=e.version,this.tableNames=(0,a.__spreadArray)([],(0,a.__read)(e.objectStoreNames)),this.engineAspect&&this.applyAspectPatch()}return e.prototype.setVersionChangeListener=function(e){this.idbDatabase.addEventListener("versionchange",(function(t){e(t.oldVersion,t.newVersion)}))},e.prototype.close=function(){this.idbDatabase.close()},e.prototype.createTable=function(e,t){var n=this.idbDatabase.createObjectStore(e,t);return new q(O.pF.VERSION_CHANGE,n)},e.prototype.deleteTable=function(e){this.idbDatabase.deleteObjectStore(e)},e.prototype.transaction=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n;return(0,a.__generator)(this,(function(r){return n=this.idbDatabase.transaction(e,t),[2,new L(n,this.engineAspect)]}))}))},e.prototype.table=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r,i;return(0,a.__generator)(this,(function(o){return n=this.idbDatabase.transaction([e],t),r=new L(n),i=n.objectStore(e),[2,new q(t,i,this.engineAspect,r)]}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspect)||void 0===e?void 0:e.database;null===t||void 0===t||t.deleteTable.patch(this,"deleteTable"),null===t||void 0===t||t.createTable.patch(this,"createTable"),null===t||void 0===t||t.transaction.patch(this,"transaction"),null===t||void 0===t||t.table.patch(this,"table"),null===t||void 0===t||t.close.patch(this,"close")},e}(),K=function(e,t){var n=typeof e,r=typeof t;if(isNaN(e)||isNaN(t))return indexedDB.cmp(e,t);if(n===r){if("number"===n||"bigint"===n)return e-t;if("string"===n)return function(e,t){return e<t?-1:+(e>t)}(e,t)}return e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():indexedDB.cmp(e,t)},F=n("../node_modules/@tencent/memoire-error-utils/esm/index.js"),U=F.sH.withDefaultMessage("IndexedDB is missing in global context. Consider using `indexeddbshim` for better compatibility or `fake-indexeddb` in your test environment."),V=function(){function e(){if("undefined"===typeof indexedDB)throw new U;this.cmp=K}return e.prototype.deleteDB=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){return(0,a.__generator)(this,(function(t){return[2,A(e)]}))}))},e.prototype.setAspects=function(e){this.engineAspects=e,this.engineAspects.openDB.patch(this,"openDB"),this.engineAspects.deleteDB.patch(this,"deleteDB")},e.prototype.openDB=function(e,t,n,r){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t,i=this;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return[4,E(e,n,{upgrade:function(e,t,n,o){var a;null===(a=null===r||void 0===r?void 0:r.upgrade)||void 0===a||a.call(r,new j(e,i.engineAspects),t,n,new L(o))},blocked:function(){var e;return null===(e=null===r||void 0===r?void 0:r.blocked)||void 0===e?void 0:e.call(r)},blocking:function(){var e;return null===(e=null===r||void 0===r?void 0:r.blocking)||void 0===e?void 0:e.call(r)},terminated:function(){var e;return null===(e=null===r||void 0===r?void 0:r.terminated)||void 0===e?void 0:e.call(r)}})];case 1:return t=o.sent(),[2,new j(t,this.engineAspects)]}}))}))},e}();!function(e){e.INIT="init",e.GET="get",e.GET_ALL="getAll",e.DELETE="delete",e.INSERT="set",e.UPDATE="update",e.UPDATE_MUTIL_TABLE_DATA="updateMultiTableData",e.BEGIN_TRANSACTION="beginTransaction",e.COMMIT_TRANSACTION="commitTransaction",e.ROLLBACK_TRANSACTION="rollbackTransaction"}(D||(D={})),function(e){e[e.IN=0]="IN",e[e.LOWER_BOUND=1]="LOWER_BOUND",e[e.UPPER_BOUND=2]="UPPER_BOUND",e[e.BOUND=3]="BOUND",e[e.ONLY=4]="ONLY",e[e.NOT_IN=5]="NOT_IN"}(N||(N={})),function(e){e[e.INCREASE=0]="INCREASE",e[e.DECREASE=1]="DECREASE",e[e.INCREASE_BY_TEXT=2]="INCREASE_BY_TEXT",e[e.DECREASE_BY_TEXT=3]="DECREASE_BY_TEXT"}(P||(P={}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var W=function(e,t){return W=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},W(e,t)};function G(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}W(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var H,Q=function(){return Q=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Q.apply(this,arguments)};function z(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function Y(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function X(e,t){var n="function"===typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function J(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(X(arguments[t]));return e}function $(e){return{data:e,status:H.success,statusText:"Success"}}function Z(e){return{data:[],status:H.unknown,statusText:e}}!function(e){e[e.unknown=-1]="unknown",e[e.success=200]="success"}(H||(H={}));var ee=function(){function e(){this.interceptors=[]}return e.prototype.add=function(e){this.interceptors.push(e)},e.prototype.proceed=function(e){return z(this,void 0,void 0,(function(){var t;return Y(this,(function(n){return t=Array.from(this.interceptors),this.fillBuildInInterceptors(t,e),[2,this.dispatch(e,t)]}))}))},e.prototype.dispatch=function(e,t){var n=this;if(0===t.length){var r=$([]);return Promise.resolve(r)}return t.shift().intercept((function(){return n.dispatch(e,t)}),e)},e}(),te=function(){function e(){var e,t;this.canUseNativeAndroid=(null===(e=n.g.mqq)||void 0===e?void 0:e.android)&&(null===(t=n.g._mqqWebViewJSInterface)||void 0===t?void 0:t.invoke),this.currentSeqId=0,this.reqCallbacks=new Map}return e.prototype.JSApiCallback=function(e){var t=this.reqCallbacks.get(e.callbackId);if(!t)throw new Error("TypeError:[ark-reqeust] the reqCallback of response["+e.callbackId+"] can't found!");t.callback(e)},e.prototype.invokeNative=function(e,t,r,i){var o,a=null!==r&&void 0!==r?r:{},s=a.command;if(i){var u=this.createReqSeq();this.reqCallbacks.set(u,{callback:i,command:s,startTime:Date.now()}),a.callbackId=u}this.canUseNativeAndroid?this.invokeNativeAndroid(e,t,a):null===(o=n.g.mqq)||void 0===o||o.invoke(e,t,a)},e.prototype.invokeNativeAndroid=function(e,t,r){var i,o="jsbridge://"+encodeURIComponent(e)+"/"+encodeURIComponent(t);r&&(o+="?p="+encodeURIComponent(JSON.stringify(r))),null===(i=n.g._mqqWebViewJSInterface)||void 0===i||i.invoke(o)},e.prototype.createReqSeq=function(){return this.currentSeqId+=1},e}();n.g.jsApi||(n.g.jsApi=new te,n.g.JSApiCallback||(n.g.JSApiCallback=n.g.jsApi.JSApiCallback.bind(n.g.jsApi)));var ne=n.g.jsApi,re=function(){function e(){}return e.prototype.invoke=function(e){return new Promise((function(t,n){if(!e.namespace)throw new Error("jsapi, namespace is null.");var r=e.params||{},i=e.callback?function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t($(e))}:void 0;try{ne.invokeNative(e.namespace,e.method,r,i),i||t($([]))}catch(o){n(Z("Error:[ark-request] Jsapi invokeNative fail."))}}))},e}();function ie(e){return function(e,t){return Object.prototype.toString.call(t)==="[object "+e+"]"}("Function",e)}var oe,ae,se=function(){function e(){}return e.prototype.invoke=function(e){return z(this,void 0,void 0,(function(){var t,r;return Y(this,(function(i){switch(i.label){case 0:if(!n.g.mqq)throw new Error("UnknownError:[ark-request] mqq channel is undefined.");if(!e.namespace)throw new Error("TypeError:[ark-request] mqq invoke has no namespace!");return t=n.g.mqq[e.namespace],(r=null===t||void 0===t?void 0:t[e.method])&&ie(r)?[4,this.innerModuleInvoke(r,e.params,e.callback)]:[3,2];case 1:case 3:return[2,i.sent()];case 2:return[4,this.innerCoreInvoke(n.g.mqq.invoke,e)]}}))}))},e.prototype.innerModuleInvoke=function(e,t,n){return new Promise((function(r,i){var o=[];t&&o.push(t),n&&o.push((function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];r($(e))}));try{e.apply(void 0,J(o)),n||r($([]))}catch(a){i(Z("Error:[ark-request] Mqq invoke module fail."))}}))},e.prototype.innerCoreInvoke=function(e,t){return new Promise((function(n,r){try{e(t.namespace,t.method,t.params,(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n($(e))}))}catch(i){r(Z("Error:[ark-request] Mqq invoke core["+t.namespace+"."+t.method+"] fail."))}}))},e}();!function(e){e.mqq="mqq",e.jsapi="jsapi"}(ae||(ae={}));var ue={schema:"mqq",channels:(oe={},oe[ae.mqq]=se,oe[ae.jsapi]=re,oe)},ce=function(){function e(){}return e.prototype.intercept=function(e,t){return z(this,void 0,void 0,(function(){var e;return Y(this,(function(n){switch(n.label){case 0:if(!t.schema)throw Error("TypeError[ark-request]: the schema of request("+t.namespace+"."+t.method+") is undefined.");if(!(e=ue.channels[t.schema]))throw Error("TypeError[ark-request]: can't match strategy to handle request("+t.schema+"."+t.namespace+"."+t.method+").");return[4,(new e).invoke(t)];case 1:return[2,n.sent()]}}))}))},e}(),le=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return G(t,e),t.prototype.fillBuildInInterceptors=function(e){return e.push(new ce),e},t}(ee),pe=function(){function e(e){this.interceptors=e}return e.prototype.invoke=function(e){this.interceptors.proceed(Q({schema:ue.schema},e)).then((function(t){var n,r=t.data;null===(n=e.callback)||void 0===n||n.call.apply(n,J([e],r))}))},e.prototype.register=function(e,t){if(!ie(t))throw new Error("TypeError:[ark-request] The handler["+e+"] to register is not function.");this.getNativeChannel()[this.generateCallbackName(e)]=t},e.prototype.unregister=function(e){this.getNativeChannel()[this.generateCallbackName(e)]=void 0},e.prototype.notify=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=this.getNativeChannel(),i=this.generateCallbackName(e),o=r[i];if(!ie(o))throw new Error("TypeError:[ark-request] The handler["+e+"] is not function!");o.apply(void 0,J(t))},e.prototype.generateCallbackName=function(e){return e},e.prototype.getNativeChannel=function(){return window},e}(),he=function(){var e=new le;return new pe(e)}(),de={maxRetry:3},fe=function(e,t){return function(){for(var n=new Array(arguments.length),r=0;r<n.length;r++)n[r]=arguments[r];return e.apply(t,n)}},ve=Object.prototype.toString;function ye(e){return"[object Array]"===ve.call(e)}function ge(e){return"undefined"===typeof e}function me(e){return null!==e&&"object"===typeof e}function be(e){if("[object Object]"!==ve.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function _e(e){return"[object Function]"===ve.call(e)}function we(e,t){if(null!==e&&"undefined"!==typeof e)if("object"!==typeof e&&(e=[e]),ye(e))for(var n=0,r=e.length;n<r;n++)t.call(null,e[n],n,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}var xe={isArray:ye,isArrayBuffer:function(e){return"[object ArrayBuffer]"===ve.call(e)},isBuffer:function(e){return null!==e&&!ge(e)&&null!==e.constructor&&!ge(e.constructor)&&"function"===typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!==typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!==typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"===typeof e},isNumber:function(e){return"number"===typeof e},isObject:me,isPlainObject:be,isUndefined:ge,isDate:function(e){return"[object Date]"===ve.call(e)},isFile:function(e){return"[object File]"===ve.call(e)},isBlob:function(e){return"[object Blob]"===ve.call(e)},isFunction:_e,isStream:function(e){return me(e)&&_e(e.pipe)},isURLSearchParams:function(e){return"undefined"!==typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"===typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!==typeof window&&"undefined"!==typeof document},forEach:we,merge:function e(){var t={};function n(n,r){be(t[r])&&be(n)?t[r]=e(t[r],n):be(n)?t[r]=e({},n):ye(n)?t[r]=n.slice():t[r]=n}for(var r=0,i=arguments.length;r<i;r++)we(arguments[r],n);return t},extend:function(e,t,n){return we(t,(function(t,r){e[r]=n&&"function"===typeof t?fe(t,n):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}};function Ee(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Ae=function(e,t,n){if(!t)return e;var r;if(n)r=n(t);else if(xe.isURLSearchParams(t))r=t.toString();else{var i=[];xe.forEach(t,(function(e,t){null!==e&&"undefined"!==typeof e&&(xe.isArray(e)?t+="[]":e=[e],xe.forEach(e,(function(e){xe.isDate(e)?e=e.toISOString():xe.isObject(e)&&(e=JSON.stringify(e)),i.push(Ee(t)+"="+Ee(e))})))})),r=i.join("&")}if(r){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e};function Ce(){this.handlers=[]}Ce.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},Ce.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},Ce.prototype.forEach=function(e){xe.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var Se=Ce,Ie=function(e,t,n){return xe.forEach(n,(function(n){e=n(e,t)})),e},ke=function(e){return!(!e||!e.__CANCEL__)},Te=function(e,t){xe.forEach(e,(function(n,r){r!==t&&r.toUpperCase()===t.toUpperCase()&&(e[t]=n,delete e[r])}))},De=function(e,t,n,r,i){return function(e,t,n,r,i){return e.config=t,n&&(e.code=n),e.request=r,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,n,r,i)},Ne=xe.isStandardBrowserEnv()?{write:function(e,t,n,r,i,o){var a=[];a.push(e+"="+encodeURIComponent(t)),xe.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),xe.isString(r)&&a.push("path="+r),xe.isString(i)&&a.push("domain="+i),!0===o&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},Pe=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],Oe=xe.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function r(e){var r=e;return t&&(n.setAttribute("href",r),r=n.href),n.setAttribute("href",r),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}return e=r(window.location.href),function(t){var n=xe.isString(t)?r(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0},Me=function(e){return new Promise((function(t,n){var r=e.data,i=e.headers;xe.isFormData(r)&&delete i["Content-Type"];var o=new XMLHttpRequest;if(e.auth){var a=e.auth.username||"",s=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";i.Authorization="Basic "+btoa(a+":"+s)}var u,c,l=(u=e.baseURL,c=e.url,u&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(c)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(u,c):c);if(o.open(e.method.toUpperCase(),Ae(l,e.params,e.paramsSerializer),!0),o.timeout=e.timeout,o.onreadystatechange=function(){if(o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))){var r="getAllResponseHeaders"in o?function(e){var t,n,r,i={};return e?(xe.forEach(e.split("\n"),(function(e){if(r=e.indexOf(":"),t=xe.trim(e.substr(0,r)).toLowerCase(),n=xe.trim(e.substr(r+1)),t){if(i[t]&&Pe.indexOf(t)>=0)return;i[t]="set-cookie"===t?(i[t]?i[t]:[]).concat([n]):i[t]?i[t]+", "+n:n}})),i):i}(o.getAllResponseHeaders()):null,i={data:e.responseType&&"text"!==e.responseType?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:r,config:e,request:o};!function(e,t,n){var r=n.config.validateStatus;n.status&&r&&!r(n.status)?t(De("Request failed with status code "+n.status,n.config,null,n.request,n)):e(n)}(t,n,i),o=null}},o.onabort=function(){o&&(n(De("Request aborted",e,"ECONNABORTED",o)),o=null)},o.onerror=function(){n(De("Network Error",e,null,o)),o=null},o.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(De(t,e,"ECONNABORTED",o)),o=null},xe.isStandardBrowserEnv()){var p=(e.withCredentials||Oe(l))&&e.xsrfCookieName?Ne.read(e.xsrfCookieName):void 0;p&&(i[e.xsrfHeaderName]=p)}if("setRequestHeader"in o&&xe.forEach(i,(function(e,t){"undefined"===typeof r&&"content-type"===t.toLowerCase()?delete i[t]:o.setRequestHeader(t,e)})),xe.isUndefined(e.withCredentials)||(o.withCredentials=!!e.withCredentials),e.responseType)try{o.responseType=e.responseType}catch(h){if("json"!==e.responseType)throw h}"function"===typeof e.onDownloadProgress&&o.addEventListener("progress",e.onDownloadProgress),"function"===typeof e.onUploadProgress&&o.upload&&o.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){o&&(o.abort(),n(e),o=null)})),r||(r=null),o.send(r)}))},Re={"Content-Type":"application/x-www-form-urlencoded"};function Be(e,t){!xe.isUndefined(e)&&xe.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var qe={adapter:function(){var e;return("undefined"!==typeof XMLHttpRequest||"undefined"!==typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(e=Me),e}(),transformRequest:[function(e,t){return Te(t,"Accept"),Te(t,"Content-Type"),xe.isFormData(e)||xe.isArrayBuffer(e)||xe.isBuffer(e)||xe.isStream(e)||xe.isFile(e)||xe.isBlob(e)?e:xe.isArrayBufferView(e)?e.buffer:xe.isURLSearchParams(e)?(Be(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):xe.isObject(e)?(Be(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"===typeof e)try{e=JSON.parse(e)}catch(t){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};xe.forEach(["delete","get","head"],(function(e){qe.headers[e]={}})),xe.forEach(["post","put","patch"],(function(e){qe.headers[e]=xe.merge(Re)}));var Le=qe;function je(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var Ke=function(e){return je(e),e.headers=e.headers||{},e.data=Ie(e.data,e.headers,e.transformRequest),e.headers=xe.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),xe.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||Le.adapter)(e).then((function(t){return je(e),t.data=Ie(t.data,t.headers,e.transformResponse),t}),(function(t){return ke(t)||(je(e),t&&t.response&&(t.response.data=Ie(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},Fe=function(e,t){t=t||{};var n={},r=["url","method","data"],i=["headers","auth","proxy","params"],o=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],a=["validateStatus"];function s(e,t){return xe.isPlainObject(e)&&xe.isPlainObject(t)?xe.merge(e,t):xe.isPlainObject(t)?xe.merge({},t):xe.isArray(t)?t.slice():t}function u(r){xe.isUndefined(t[r])?xe.isUndefined(e[r])||(n[r]=s(void 0,e[r])):n[r]=s(e[r],t[r])}xe.forEach(r,(function(e){xe.isUndefined(t[e])||(n[e]=s(void 0,t[e]))})),xe.forEach(i,u),xe.forEach(o,(function(r){xe.isUndefined(t[r])?xe.isUndefined(e[r])||(n[r]=s(void 0,e[r])):n[r]=s(void 0,t[r])})),xe.forEach(a,(function(r){r in t?n[r]=s(e[r],t[r]):r in e&&(n[r]=s(void 0,e[r]))}));var c=r.concat(i).concat(o).concat(a),l=Object.keys(e).concat(Object.keys(t)).filter((function(e){return-1===c.indexOf(e)}));return xe.forEach(l,u),n};function Ue(e){this.defaults=e,this.interceptors={request:new Se,response:new Se}}Ue.prototype.request=function(e){"string"===typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=Fe(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[Ke,void 0],n=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)n=n.then(t.shift(),t.shift());return n},Ue.prototype.getUri=function(e){return e=Fe(this.defaults,e),Ae(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},xe.forEach(["delete","get","head","options"],(function(e){Ue.prototype[e]=function(t,n){return this.request(Fe(n||{},{method:e,url:t,data:(n||{}).data}))}})),xe.forEach(["post","put","patch"],(function(e){Ue.prototype[e]=function(t,n,r){return this.request(Fe(r||{},{method:e,url:t,data:n}))}}));var Ve=Ue;function We(e){this.message=e}We.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},We.prototype.__CANCEL__=!0;var Ge=We;function He(e){if("function"!==typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var n=this;e((function(e){n.reason||(n.reason=new Ge(e),t(n.reason))}))}He.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},He.source=function(){var e;return{token:new He((function(t){e=t})),cancel:e}};var Qe=He;function ze(e){var t=new Ve(e),n=fe(Ve.prototype.request,t);return xe.extend(n,Ve.prototype,t),xe.extend(n,t),n}var Ye=ze(Le);Ye.Axios=Ve,Ye.create=function(e){return ze(Fe(Ye.defaults,e))},Ye.Cancel=Ge,Ye.CancelToken=Qe,Ye.isCancel=ke,Ye.all=function(e){return Promise.all(e)},Ye.spread=function(e){return function(t){return e.apply(null,t)}},Ye.isAxiosError=function(e){return"object"===typeof e&&!0===e.isAxiosError};var Xe=Ye,Je=Ye;Xe.default=Je;var $e=Xe,Ze=function(){function e(){}return e.prototype.intercept=function(e,t){return z(this,void 0,void 0,(function(){return Y(this,(function(e){switch(e.label){case 0:return[4,$e.request(t)];case 1:return[2,e.sent()]}}))}))},e}(),et=function(){function e(e){this.maxRetry=e}return e.prototype.intercept=function(e,t){return z(this,void 0,void 0,(function(){var n;return Y(this,(function(r){switch(r.label){case 0:n=this.maxRetry,r.label=1;case 1:if(!(n>0))return[3,6];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,e()];case 3:return[2,r.sent()];case 4:return r.sent(),n-=1,[3,5];case 5:return[3,1];case 6:throw new Error("Error:[ark-request] request["+t.url+"] reach max retry count.")}}))}))},e}(),tt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return G(t,e),t.prototype.fillBuildInInterceptors=function(e,t){return(void 0===t.maxRetry||t.maxRetry>0)&&e.push(new et(t.maxRetry||de.maxRetry)),e.push(new Ze),e},t}(ee),nt=function(){function e(e,t){this.defaults=e,this.interceptors=t}return e.prototype.get=function(e,t){return this.dispatchRequest("get",e,void 0,t)},e.prototype.post=function(e,t,n){return this.dispatchRequest("post",e,t,n)},e.prototype.request=function(e){return this.interceptors.proceed(Q(Q({},this.defaults),e))},e.prototype.dispatchRequest=function(e,t,n,r){var i=r||{},o=Q(Q({},i.headers),{"Content-Type":i.contentType});return this.interceptors.proceed(Q(Q(Q({},this.defaults),i),{url:t,method:e,headers:o,data:n||i.data}))},e}();!function(e){var t=new tt;new nt(e||de,t)}();var rt=function(){function e(){}return e.send=function(t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,a.__generator)(this,(function(i){return n=new Promise((function(e){he.invoke({schema:"jsapi",namespace:"docx",method:"clientDatabaseRequest",params:t,callback:function(t){e(t)}})})),r=new Promise((function(t){setTimeout((function(){t({err_msg:"req timeout",err_code:e.timeoutErrorCode})}),e.timeout)})),[2,Promise.race([n,r])]}))}))},e.timeout=1e4,e.timeoutErrorCode="100002",e}(),it=function(){function e(){}return e.getDBKeyFromKeyPath=function(e){return"string"===typeof e?e:e.join("_")},e.normalizeUnionKeyValue=function(e){return Array.isArray(e)?JSON.stringify(e):e},e.getKeyFromValue=function(e,t){if("object"!==typeof e)return e;var n=e;if("string"===typeof t)return n[t];var r=[];return t.forEach((function(e){r.push(n[e])})),r},e.addUnionKeyIfNeed=function(t,n){if("string"===typeof n)return t;var r=(0,a.__assign)({},t),i=e.getDBKeyFromKeyPath(n),o=[];return n.forEach((function(e){return o.push(r[e])})),r[i]=e.normalizeUnionKeyValue(o),r},e.deleteUnionKeyIfNeed=function(t,n){if("string"===typeof n)return t;var r=(0,a.__assign)({},t);return r[e.getDBKeyFromKeyPath(n)]=void 0,r},e}(),ot=function(){function e(e,t,n,r,i){var o;this.direction=n,this.mode=r,this.engineAspects=i,this.delete=void 0,this.update=void 0,this.cursor=0,this.engineTable=t,this.values=this.preProcessedData(e),this.isPositiveDirection()||(this.cursor=this.values.length-1),r!==O.pF.READ_ONLY&&(this.delete=this.deleteData,this.update=this.updateData),(null===(o=this.engineAspects)||void 0===o?void 0:o.cursor)&&this.applyAspectPatch()}return e.prototype.next=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e;return(0,a.__generator)(this,(function(t){return(e=this.cursor+(this.isPositiveDirection()?1:-1))<0||e>this.values.length-1?[2,null]:(this.cursor=e,[2,this])}))}))},e.prototype.value=function(){return this.values[this.cursor]},e.prototype[Symbol.asyncIterator]=function(){return new at(this)},e.prototype.deleteData=function(){var e=it.getKeyFromValue(this.value(),this.engineTable.keyPath);return this.engineTable.delete(e)},e.prototype.updateData=function(e){return this.engineTable.upsert(e)},e.prototype.isPositiveDirection=function(){return"next"===this.direction||"nextunique"===this.direction},e.prototype.isUniqueDirection=function(){return"nextunique"===this.direction||"prevunique"===this.direction},e.prototype.preProcessedData=function(e){return this.isUniqueDirection()?(0,a.__spreadArray)([],(0,a.__read)(new Set(e))):e},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.cursor;this.mode!==O.pF.READ_ONLY&&(null===t||void 0===t||t.delete.patch(this,"delete"),null===t||void 0===t||t.update.patch(this,"update")),null===t||void 0===t||t.next.patch(this,"next"),null===t||void 0===t||t.value.patch(this,"value")},e}(),at=function(){function e(e){this.currentCursor=e}return e.prototype[Symbol.asyncIterator]=function(){return this},e.prototype.next=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,a.__generator)(this,(function(n){switch(n.label){case 0:return this.currentCursor?(e=this.currentCursor.value(),t=this,[4,this.currentCursor.next()]):[2,{value:void 0,done:!0}];case 1:return t.currentCursor=n.sent(),[2,{value:e,done:!1}]}}))}))},e}(),st=F.sH.withMessageCreator("UnSupportError Error",(function(e){return"client db does not support "+e})),ut=F.sH.withMessageCreator("openDBError",(function(e){return"open db error in database , msg: "+e})),ct=F.sH.withMessageCreator("tableNotExist",(function(e){return e+" is not exist in the database"})),lt=F.sH.withMessageCreator("indexNotExist",(function(e){return e+" is not exist in the table"})),pt=F.sH.withDefaultMessage("WhereOrUnsupportedError","multiple where clause is not supported in native engine"),ht=F.sH.withMessageCreator("DBOperationError",(function(e){return"query or write db has error, msg: "+e}));function dt(e,t){var n=t.collections.filter((function(t){return t.name===e}));if(!n.length)throw new ct(e);return n[0]}function ft(e,t,n){if(e.err_code||e.err_msg){var r=new ht("has error in "+t+" opt, code: "+e.err_code+" msg: "+e.err_msg);throw null===n||void 0===n||n(r),r}}var vt,yt=function(){function e(){this.conditions=[],this.limitCount=Number.MAX_VALUE,this.offsetCount=0,this.orders=[]}return e.prototype.addKeyQueryCondition=function(e,t){var n=this;if("string"===typeof e)return this.addCondition(e,t);if(t instanceof Array)return this.addCondition(it.getDBKeyFromKeyPath(e),it.normalizeUnionKeyValue(t));if(!(t instanceof IDBKeyRange))throw new Error("unsupported key: "+t);var r=t.upper,i=t.upperOpen,o=t.lower,a=t.lowerOpen;return e.forEach((function(t,s){var u=null===o||void 0===o?void 0:o[s],c=null===r||void 0===r?void 0:r[s];if(void 0===u&&void 0===c)throw new Error("key range query param has error, keyPath: "+e+" lower: "+o+", upper: "+r);void 0!==u&&void 0!==c?n.addCondition(t,IDBKeyRange.bound(u,c,a,i)):void 0!==u?n.addCondition(t,IDBKeyRange.lowerBound(u,a)):n.addCondition(t,IDBKeyRange.upperBound(c,i))})),this},e.prototype.addCondition=function(e,t,n){void 0===n&&(n=N.ONLY);var r,i=n;return t instanceof IDBKeyRange?void 0!==t.lower&&void 0!==t.upper?(i=N.BOUND,r={lower:t.lower,upper:t.upper,lowerOpen:t.lowerOpen,upperOpen:t.upperOpen}):void 0!==t.lower?(i=N.LOWER_BOUND,r={lower:t.lower,open:t.lowerOpen}):(i=N.UPPER_BOUND,r={upper:t.upper,open:t.upperOpen}):r=t,this.conditions.push({type:i,column:e,value:r}),this},e.prototype.setLimit=function(e){return this.limitCount=e,this},e.prototype.setOffset=function(e){return this.offsetCount=e,this},e.prototype.addOrder=function(e,t){var n=P.INCREASE;t===O.As.DESCENDING&&(n=P.DECREASE),this.orders.push({key:e,type:n})},e.prototype.build=function(){return{_conditions:this.conditions,_limitCount:this.limitCount,_offsetCount:this.offsetCount,_orders:this.orders}},e}(),gt=function(){function e(e,t,n,r,i){var o,a=this;this.dbName=e,this.table=t,this.mode=r,this.engineAspects=i,this.name=n.name,this.keyPath=n.path,this.unique=null!==(o=n.unique)&&void 0!==o&&o,this.transaction=t.transaction,this.reqErrorObserver=function(e){var t;return null===(t=a.transaction)||void 0===t?void 0:t.notifyTransactionFail(e)},(null===i||void 0===i?void 0:i.index)&&this.applyAspectPatch()}return e.prototype.getAll=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r,i=this;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return n={command:D.GET_ALL,dbName:this.dbName,tableName:this.table.tableName,where:e?(new yt).addKeyQueryCondition(this.keyPath,e).setLimit(null!==t&&void 0!==t?t:Number.MAX_VALUE).build():void 0},[4,this.sendRequest(n)];case 1:return ft(r=o.sent(),"getAll",this.reqErrorObserver),r.result?[2,r.result.map((function(e){return it.deleteUnionKeyIfNeed(e,i.table.keyPath)}))]:[2,[]]}}))}))},e.prototype.getAllKeys=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r=this;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return[4,this.getAll(null!==e&&void 0!==e?e:void 0,t)];case 1:return(n=i.sent())?[2,n.map((function(e){return it.getKeyFromValue(e,r.table.keyPath)}))]:[2,[]]}}))}))},e.prototype.get=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t,n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return t={command:D.GET,dbName:this.dbName,tableName:this.table.tableName,where:(new yt).addKeyQueryCondition(this.keyPath,e).build()},[4,this.sendRequest(t)];case 1:return ft(n=r.sent(),"get",this.reqErrorObserver),n.result?[2,it.deleteUnionKeyIfNeed(n.result,this.table.keyPath)]:[2,null]}}))}))},e.prototype.openCursor=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.getAll(e)];case 1:return(n=r.sent())?[2,new ot(n,this.table,null!==t&&void 0!==t?t:"next",this.mode)]:[2,null]}}))}))},e.prototype.sendRequest=function(e){var t,n;(null===(t=this.transaction)||void 0===t?void 0:t.transactionID)&&(e.transaction=this.transaction.transactionID);var r=rt.send(e);return null===(n=this.transaction)||void 0===n||n.addResponsePromise(r),r},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.index,n=this;null===t||void 0===t||t.get.patch(n,"get"),null===t||void 0===t||t.getAll.patch(n,"getAll"),null===t||void 0===t||t.getAllKeys.patch(n,"getAllKeys"),null===t||void 0===t||t.openCursor.patch(n,"openCursor")},e}(),mt=function(){function e(e,t,n,r,i){var o,a,s,u=this;this.dbName=e,this.collectionSchema=t,this.mode=n,this.engineAspects=r,this.transaction=i,this.createIndex=void 0,this.delete=void 0,this.bulkDelete=void 0,this.clear=void 0,this.insert=void 0,this.upsert=void 0,this.deleteIndex=void 0,this.bulkUpsert=void 0,this.keyPath=null!==(a=null===(o=t.key)||void 0===o?void 0:o.path)&&void 0!==a?a:[],this.autoIncrement=!!(null===(s=t.key)||void 0===s?void 0:s.generator),this.tableName=t.name,this.indexNames=t.indices.map((function(e){return it.getDBKeyFromKeyPath(e.path)})),this.initWriteFun(n),this.reqErrorObserver=function(e){var t;return null===(t=u.transaction)||void 0===t?void 0:t.notifyTransactionFail(e)},(null===r||void 0===r?void 0:r.table)&&this.applyAspectPatch()}return e.prototype.query=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r,i,o=this;return(0,a.__generator)(this,(function(s){switch(s.label){case 0:return n={command:D.GET_ALL,dbName:this.dbName,tableName:this.tableName,where:this.getClientQueryCondition(e)},[4,this.sendRequest(n)];case 1:return ft(r=s.sent(),"query",this.reqErrorObserver),r.result&&r.result.length?(i=r.result.map((function(e){return[it.getKeyFromValue(e,o.keyPath),it.deleteUnionKeyIfNeed(e,o.keyPath)]})),t===O.yE.COUNT?[2,i.length]:t===O.yE.KEYS?[2,i.map((function(e){return(0,a.__read)(e,1)[0]}))]:t===O.yE.VALUES?[2,i.map((function(e){return(0,a.__read)(e,2)[1]}))]:[2,i]):[2,[]]}}))}))},e.prototype.supports=function(){return!0},e.prototype.index=function(e){var t=this.collectionSchema.indices.filter((function(t){return t.name===e}));if(!t.length)throw new lt(e);return new gt(this.dbName,this,t[0],this.mode,this.engineAspects)},e.prototype.getAll=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r,i=this;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return n={command:D.GET_ALL,dbName:this.dbName,tableName:this.tableName,where:e?(new yt).addKeyQueryCondition(this.keyPath,e).setLimit(null!==t&&void 0!==t?t:Number.MAX_VALUE).build():void 0},[4,this.sendRequest(n)];case 1:return ft(r=o.sent(),"getAll",this.reqErrorObserver),r.result&&r.result.length?[2,r.result.map((function(e){return it.deleteUnionKeyIfNeed(e,i.keyPath)}))]:[2,[]]}}))}))},e.prototype.getAllKeys=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r=this;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return[4,this.getAll(null!==e&&void 0!==e?e:void 0,t)];case 1:return(n=i.sent())?[2,n.map((function(e){return it.getKeyFromValue(e,r.keyPath)}))]:[2,[]]}}))}))},e.prototype.get=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t,n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return t={command:D.GET,dbName:this.dbName,tableName:this.tableName,where:(new yt).addKeyQueryCondition(this.keyPath,e).build()},[4,this.sendRequest(t)];case 1:return ft(n=r.sent(),"get",this.reqErrorObserver),n.result?[2,it.deleteUnionKeyIfNeed(n.result,this.keyPath)]:[2,null]}}))}))},e.prototype.openCursor=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.getAll(e)];case 1:return(n=r.sent())?[2,new ot(n,this,null!==t&&void 0!==t?t:"next",this.mode,this.engineAspects)]:[2,null]}}))}))},e.prototype.initWriteFun=function(e){var t=this;e===O.pF.VERSION_CHANGE&&(this.createIndex=this.createIndexFun,this.deleteIndex=function(e){}),e!==O.pF.READ_ONLY&&(this.delete=this.deleteData,this.bulkDelete=this.bulkDeleteData,this.clear=this.deleteData,this.insert=this.insertAndUpdate,this.upsert=function(e){return t.insertAndUpdate(e,!0)},this.bulkUpsert=this.bulkUpsertData)},e.prototype.createIndexFun=function(e,t){var n=this.collectionSchema.indices.filter((function(t){return t.name===e}));if(!n.length)throw new lt(e);return new gt(this.dbName,this,n[0],this.mode)},e.prototype.bulkDeleteData=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t,n;return(0,a.__generator)(this,(function(r){switch(r.label){case 0:return t=e.map((function(e){return it.normalizeUnionKeyValue(e)})),n={command:D.DELETE,dbName:this.dbName,tableName:this.tableName,where:e?(new yt).addCondition(it.getDBKeyFromKeyPath(this.keyPath),t,N.IN).build():void 0},[4,this.sendRequest(n)];case 1:return ft(r.sent(),"bulkDelete",this.reqErrorObserver),[2]}}))}))},e.prototype.bulkUpsertData=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t,n,r=this;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return t=e.map((function(e){return it.addUnionKeyIfNeed(e,r.keyPath)})).map((function(e){return{tableName:r.tableName,data:e}})),n={command:D.UPDATE_MUTIL_TABLE_DATA,dbName:this.dbName,multiData:t},[4,this.sendRequest(n)];case 1:return ft(i.sent(),"bulkUpsert",this.reqErrorObserver),[2,e.map((function(e){return it.getKeyFromValue(e,r.keyPath)}))]}}))}))},e.prototype.insertAndUpdate=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return n=it.addUnionKeyIfNeed(e,this.keyPath),r={command:t?D.UPDATE:D.INSERT,dbName:this.dbName,tableName:this.tableName,data:n},[4,this.sendRequest(r)];case 1:return ft(i.sent(),t?"upsert":"insert",this.reqErrorObserver),[2,it.getKeyFromValue(e,this.keyPath)]}}))}))},e.prototype.deleteData=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){var t;return(0,a.__generator)(this,(function(n){switch(n.label){case 0:return t={command:D.DELETE,dbName:this.dbName,tableName:this.tableName,where:e?(new yt).addKeyQueryCondition(this.keyPath,e).build():void 0},[4,this.sendRequest(t)];case 1:return ft(n.sent(),e?"delete":"clear",this.reqErrorObserver),[2]}}))}))},e.prototype.sendRequest=function(e){var t,n;(null===(t=this.transaction)||void 0===t?void 0:t.transactionID)&&(e.transaction=this.transaction.transactionID);var r=rt.send(e);return null===(n=this.transaction)||void 0===n||n.addResponsePromise(r),r},e.prototype.getClientQueryCondition=function(e){var t,n,r,i,o,s=new yt;if(e.whereClauses.length>1)throw new pt;if(!e.whereClauses.length)return s.build();var u=(0,a.__read)(e.whereClauses,1)[0];try{for(var c=(0,a.__values)(Object.entries(u)),l=c.next();!l.done;l=c.next()){var p=(0,a.__read)(l.value,2),h=p[0],d=p[1];if((0,O.ot)(d))s.addKeyQueryCondition(h,d);else if(!this.isEmptyPredicate(d)){var f=d[O.qW.In];Array.isArray(f)&&s.addCondition(it.getDBKeyFromKeyPath(h),f.map(it.normalizeUnionKeyValue),N.IN);var v=d[O.qW.NotIn];Array.isArray(v)&&s.addCondition(it.getDBKeyFromKeyPath(h),v.map(it.normalizeUnionKeyValue),N.NOT_IN);try{for(var y=(r=void 0,(0,a.__values)(Object.entries(d))),g=y.next();!g.done;g=y.next()){var m=(0,a.__read)(g.value,2),b=m[0],_=m[1];if(void 0!==_)if(b!==O.qW.NotEquals){var w=(o={},o[O.qW.Equals]=IDBKeyRange.only(_),o[O.qW.GreaterThan]=IDBKeyRange.lowerBound(_,!0),o[O.qW.GreaterOrEqualThan]=IDBKeyRange.lowerBound(_,!1),o[O.qW.LessThan]=IDBKeyRange.upperBound(_,!0),o[O.qW.LessOrEqualThan]=IDBKeyRange.upperBound(_,!1),o)[b];void 0!==w&&s.addKeyQueryCondition(h,w)}else s.addCondition(it.getDBKeyFromKeyPath(h),[it.normalizeUnionKeyValue(_)],N.NOT_IN)}}catch(x){r={error:x}}finally{try{g&&!g.done&&(i=y.return)&&i.call(y)}finally{if(r)throw r.error}}}}}catch(E){t={error:E}}finally{try{l&&!l.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return void 0!==e.limit&&s.setLimit(e.limit),s.setOffset(e.offset),void 0!==e.order&&s.addOrder(it.getDBKeyFromKeyPath(e.order.path),e.order.type),s.build()},e.prototype.isEmptyPredicate=function(e){return!e||Object.values(e).every((function(e){return void 0===e}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.table;null===t||void 0===t||t.get.patch(this,"get"),null===t||void 0===t||t.getAll.patch(this,"getAll"),null===t||void 0===t||t.getAllKeys.patch(this,"getAllKeys"),null===t||void 0===t||t.index.patch(this,"index"),null===t||void 0===t||t.openCursor.patch(this,"openCursor"),this.mode===O.pF.VERSION_CHANGE&&(null===t||void 0===t||t.createIndex.patch(this,"createIndex"),null===t||void 0===t||t.deleteIndex.patch(this,"deleteIndex")),this.mode!==O.pF.READ_WRITE&&this.mode!==O.pF.VERSION_CHANGE||(null===t||void 0===t||t.delete.patch(this,"delete"),null===t||void 0===t||t.insert.patch(this,"insert"),null===t||void 0===t||t.upsert.patch(this,"upsert"),null===t||void 0===t||t.clear.patch(this,"clear"),null===t||void 0===t||t.query.patch(this,"query"),null===t||void 0===t||t.bulkDelete.patch(this,"bulkDelete"),null===t||void 0===t||t.bulkUpsert.patch(this,"bulkUpsert"))},e}();!function(e){e.ACTIVE="active",e.COMMITTING="committing",e.COMPLETED="completed"}(vt||(vt={}));var bt,_t=function(){function e(e,t,n,r,i,o){var a=this;this.tables=e,this.dbName=t,this.dbSchema=n,this.transactionID=r,this.mode=i,this.engineAspects=o,this.reqSeqFactory=function(){var e=0;return function(){return e+=1}}(),this.dbRequestSeqAndResponseMap=new Map,this.transactionStatus="active",this.autoCommitTimerId=null,this.onTransactionDonePromiseResolve=function(){},this.onTransactionDonePromiseReject=function(){},this.waitingTransactionDonePromise=new Promise((function(e,t){a.onTransactionDonePromiseResolve=e,a.onTransactionDonePromiseReject=t})),(null===o||void 0===o?void 0:o.transaction)&&this.applyAspectPatch(),this.tryToAutoCommit()}return e.prototype.notifyTransactionFail=function(e){this.onTransactionDonePromiseReject(e),this.clearAutoCommitTimer()},e.prototype.waitForTransactionDone=function(){return this.waitingTransactionDonePromise},e.prototype.addResponsePromise=function(e){var t=this,n=this.reqSeqFactory();this.clearAutoCommitTimer(),this.dbRequestSeqAndResponseMap.set(n,e),e.then((function(){t.dbRequestSeqAndResponseMap.delete(n),t.tryToAutoCommit()}))},e.prototype.table=function(e){return new mt(this.dbName,dt(e,this.dbSchema),this.mode,this.engineAspects,this)},e.prototype.commit=function(e){var t,n,r,i;return(0,a.__awaiter)(this,void 0,void 0,(function(){var o,s;return(0,a.__generator)(this,(function(a){switch(a.label){case 0:return this.clearAutoCommitTimer(),"active"!==this.transactionStatus?(e||null===(n=null===(t=window.log)||void 0===t?void 0:t.report)||void 0===n||n.call(t,"transaction_repeat_error",{query:{sessionId:null===(i=null===(r=window.log)||void 0===r?void 0:r.var)||void 0===i?void 0:i.sessionId}}),[2,!0]):this.transactionID?(o={command:D.COMMIT_TRANSACTION,dbName:this.dbName,transaction:this.transactionID},this.transactionStatus="committing",[4,rt.send(o)]):(this.onTransactionDonePromiseResolve(),[2,!0]);case 1:return s=a.sent(),this.transactionStatus="completed",s.err_code||s.err_msg?(this.onTransactionDonePromiseReject(),[2,!1]):(this.onTransactionDonePromiseResolve(),[2,!0])}}))}))},e.prototype.rollback=function(){return(0,a.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,a.__generator)(this,(function(n){switch(n.label){case 0:return this.transactionID?(e={command:D.ROLLBACK_TRANSACTION,dbName:this.dbName,transaction:this.transactionID},[4,rt.send(e)]):(this.onTransactionDonePromiseResolve(),[2,!0]);case 1:return(t=n.sent()).err_code||t.err_msg?(this.onTransactionDonePromiseReject(),[2,!1]):(this.onTransactionDonePromiseResolve(),[2,!0])}}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.transaction,n=this;null===t||void 0===t||t.commit.patch(n,"commit"),null===t||void 0===t||t.rollback.patch(n,"rollback"),null===t||void 0===t||t.table.patch(n,"table")},e.prototype.tryToAutoCommit=function(){var e=this;0===this.dbRequestSeqAndResponseMap.size&&null===this.autoCommitTimerId&&(this.autoCommitTimerId=setTimeout((function(){0===e.dbRequestSeqAndResponseMap.size&&"active"===e.transactionStatus&&e.commit(!0)})))},e.prototype.clearAutoCommitTimer=function(){null!==this.autoCommitTimerId&&(clearTimeout(this.autoCommitTimerId),this.autoCommitTimerId=null)},e}(),wt=function(){function e(e,t,n,r,i,o){this.isSupportTransactions=i,this.engineAspects=o,this.schema=e,this.name=t,this.version=n,this.tableNames=r,(null===o||void 0===o?void 0:o.database)&&this.applyAspectPatch()}return e.prototype.setVersionChangeListener=function(){},e.prototype.close=function(){},e.prototype.createTable=function(e){return new mt(this.name,dt(e,this.schema),O.pF.VERSION_CHANGE,this.engineAspects)},e.prototype.deleteTable=function(){},e.prototype.transaction=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return this.isSupportTransactions&&t!==O.pF.READ_ONLY?(n={command:D.BEGIN_TRANSACTION,dbName:this.name},[4,rt.send(n)]):[2,new _t(e,this.name,this.schema,void 0,null!==t&&void 0!==t?t:O.pF.READ_ONLY,this.engineAspects)];case 1:return ft(r=i.sent(),"startTransaction"),[2,new _t(e,this.name,this.schema,r.result,null!==t&&void 0!==t?t:O.pF.READ_ONLY,this.engineAspects)]}}))}))},e.prototype.table=function(e,t){return(0,a.__awaiter)(this,void 0,void 0,(function(){return(0,a.__generator)(this,(function(n){return[2,new mt(this.name,dt(e,this.schema),t,this.engineAspects)]}))}))},e.prototype.applyAspectPatch=function(){var e,t=null===(e=this.engineAspects)||void 0===e?void 0:e.database;null===t||void 0===t||t.deleteTable.patch(this,"deleteTable"),null===t||void 0===t||t.createTable.patch(this,"createTable"),null===t||void 0===t||t.transaction.patch(this,"transaction"),null===t||void 0===t||t.table.patch(this,"table"),null===t||void 0===t||t.close.patch(this,"close")},e}(),xt=function(e,t){return e===t?0:e>t?1:-1},Et=function(){function e(){this.cmp=xt}return e.prototype.deleteDB=function(e){return(0,a.__awaiter)(this,void 0,void 0,(function(){return(0,a.__generator)(this,(function(e){return[2]}))}))},e.prototype.setAspects=function(e){this.engineAspects=e,e.openDB.patch(this,"openDB"),e.deleteDB.patch(this,"deleteDB")},e.prototype.openDB=function(e,t,n,r){var i,o,s,u;return(0,a.__awaiter)(this,void 0,void 0,(function(){var c,l,p,h;return(0,a.__generator)(this,(function(a){switch(a.label){case 0:return[4,rt.send({command:D.INIT,dbName:e,table:this.getTableInfo(t)})];case 1:if((c=a.sent()).err_msg||c.err_code)throw new ut(e+" errCode: "+c.err_code+", errMsg: "+c.err_msg);return[4,this.getDBExistTableNames(e)];case 2:return l=a.sent(),p=new wt(t,e,null!==n&&void 0!==n?n:0,l,null!==(o=null===(i=c.result)||void 0===i?void 0:i.supportTransaction)&&void 0!==o&&o,this.engineAspects),(null===(s=c.result)||void 0===s?void 0:s.dbSchemaChange)&&(null===r||void 0===r?void 0:r.upgrade)?[4,p.transaction(l,O.pF.VERSION_CHANGE)]:[2,p];case 3:return h=a.sent(),null===(u=null===r||void 0===r?void 0:r.upgrade)||void 0===u||u.call(r,p,0,null!==n&&void 0!==n?n:null,h),[4,h.waitForTransactionDone()];case 4:return a.sent(),[2,p]}}))}))},e.prototype.getDBExistTableNames=function(e){var t;return(0,a.__awaiter)(this,void 0,void 0,(function(){var n,r;return(0,a.__generator)(this,(function(i){switch(i.label){case 0:return[4,rt.send({dbName:e,command:D.GET_ALL,tableName:O.O3.name})];case 1:return(n=i.sent()).err_code||n.err_msg||!(null===(t=n.result)||void 0===t?void 0:t.length)?[2,[]]:(r=n.result,[2,(0,a.__spreadArray)((0,a.__spreadArray)([],(0,a.__read)(r)),[O.O3]).map((function(e){return e.name}))])}}))}))},e.prototype.getTableInfo=function(e){return e?e.collections.map((function(e){var t;if(!(null===(t=e.key)||void 0===t?void 0:t.path))throw new st("key autoIncrement");var n=e.indices.map((function(e){if(e.path instanceof Array)throw new st("union index");return it.getDBKeyFromKeyPath(e.path)}));return e.key.path instanceof Array&&e.key.path.forEach((function(e){n.push(e)})),{tableName:e.name,keyName:it.getDBKeyFromKeyPath(e.key.path),indexs:(0,a.__spreadArray)([],(0,a.__read)(new Set(n)))}})):[]},e}(),At=Et;!function(e){e.pending="[PENDING]",e.success="[SUCCESS]",e.failure="[FAILURE]",e.slow="[SLOW]"}(bt||(bt={}));var Ct,St,It,kt=Symbol("begin"),Tt=function(e,t){return e+"/"+t},Dt=function(e,t){return"["+e+"."+t+"]"},Nt=function(e){var t=Array.isArray(e)?e:Object.keys(e).filter((function(t){return void 0!==e[t]})).map((function(t){return t+"="+e[t]}));return t.length?(0,a.__spreadArray)(["args:"],(0,a.__read)(t)):[]},Pt=function(e){return"[-* "+e+"]"},Ot=function(){function e(e){var t=this,n=void 0===e?{logger:console,verbose:!1,disabled:!1,prefix:""}:e,r=n.logger,i=void 0===r?console:r,o=n.disabled,s=void 0!==o&&o,u=n.verbose,c=void 0!==u&&u,l=n.prefix,p=void 0===l?"":l;this.name="LoggerPlugin",this.formatQueryConditionsExp=function(e){if(e.type===O.Kl.AND||e.type===O.Kl.OR){if(!e.exps.length)return;return e.exps.map(t.formatQueryConditionsExp).filter(Boolean).map((function(t){return e.type===O.Kl.OR&&e.exps.length>1?"("+t+")":t})).join(e.type===O.Kl.AND?" AND ":" OR ")}return e.type===O.Kl.FILTER?t.formatPredicate(e.path,e.predicate):e.type},this.formatPredicate=function(e,t){return Object.keys(t).filter((function(e){return void 0!==t[e]})).map((function(n){return e+" "+n+" "+JSON.stringify(t[n])})).join(" AND ")},this.logMethodBegin=function(e,n,r,i){var o;e.timings.set(kt,new Date),(o=t.logger).info.apply(o,(0,a.__spreadArray)([t.prefix,bt.pending,Dt(n,r)],(0,a.__read)(Nt(i))))},this.logMethodEnd=function(e,n,r,i,o){var s,u,c,l,p=e.timings.get(kt)||new Date,h=Dt(n,r),d=Date.now()-p.getTime(),f="cost="+d+"ms",v=d>=500;o.error?(s=t.logger).error.apply(s,(0,a.__spreadArray)([t.prefix,bt.failure,Dt(n,r),f,null===(c=o.error)||void 0===c?void 0:c.message,null===(l=o.error)||void 0===l?void 0:l.stack],(0,a.__read)(Nt(i)))):(u=t.logger)[v?"warn":"info"].apply(u,(0,a.__spreadArray)((0,a.__spreadArray)((0,a.__spreadArray)((0,a.__spreadArray)([t.prefix,bt.success],(0,a.__read)(v?[bt.slow]:[])),[h,f]),(0,a.__read)(Nt(i))),["result:",o.data]))},this.logger=i,this.disabled=s,this.verbose=c,this.prefix=p}return e.prototype.register=function(e){this.disabled||(this.prefix=this.prefix||"["+e.name+"]",this.hookPrimaryKeyQueries(e),this.hookConditionQueries(e),this.hookDataManipulationQueries(e),this.hookEvents(e),this.hookMigration(e),this.verbose&&this.hookEngine(e))},e.prototype.dispose=function(e){throw new F.zF({storage:e})},e.prototype.hookMigration=function(e){var t=this,n=function(e,n,r){void 0===r&&(r="migration"),e.before((function(e){t.logMethodBegin(e,r,n,e.args)})).after((function(e){t.logMethodEnd(e,r,n,e.args,{data:e.return,error:e.error})}))};n(e.aspects.migration.buildMigration,"buildMigration"),n(e.aspects.migration.executeDataMigration,"executeDataMigration"),n(e.aspects.migration.executeSchemaMigration,"executeSchemaMigration"),n(e.aspects.migration.updateMigrationChangeInfo,"updateMigrationChangeInfo"),n(e.aspects.migration.prepareAutoUpgradeHandler,"prepareAutoUpgradeHandler"),n(e.aspects.migration.log,"innerLog"),n(e.aspects.migration.actionExecutor.executeSchemaAction,"executeSchemaAction"),n(e.aspects.migration.actionExecutor.executeDataAction,"executeDataAction")},e.prototype.hookEngine=function(e){var t=this,n=function(e,n,r){e.before((function(e){t.logMethodBegin(e,n,r,e.args)})).after((function(e){t.logMethodEnd(e,n,r,e.args,{data:e.return,error:e.error})}))},r=e.aspects.engine;n(r.openDB,"engine","openDB"),n(r.deleteDB,"engine","deleteDB"),this.hookEngineDatabase(r.database,n),this.hookEngineTable(r.table,n),this.hookEngineTransaction(r.transaction,n),this.hookEngineIndex(r.index,n),this.hookEngineCursor(r.cursor,n)},e.prototype.hookEngineDatabase=function(e,t){var n=Tt("engine","database");t(e.close,n,"close"),t(e.table,n,"table"),t(e.transaction,n,"transaction"),t(e.createTable,n,"createTable"),t(e.deleteTable,n,"deleteTable")},e.prototype.hookEngineTransaction=function(e,t){var n=Tt("engine","transaction");t(e.commit,n,"commit"),t(e.rollback,n,"rollback"),t(e.table,n,"table")},e.prototype.hookEngineIndex=function(e,t){var n=Tt("engine","index");t(e.get,n,"get"),t(e.getAll,n,"getAll"),t(e.getAllKeys,n,"getAllKeys"),t(e.openCursor,n,"openCursor")},e.prototype.hookEngineCursor=function(e,t){var n=Tt("engine","cursor");t(e.delete,n,"delete"),t(e.update,n,"update"),t(e.next,n,"next"),t(e.value,n,"value")},e.prototype.hookEngineTable=function(e,t){var n=Tt("engine","table");t(e.clear,n,"clear"),t(e.get,n,"get"),t(e.delete,n,"delete"),t(e.getAll,n,"getAll"),t(e.getAllKeys,n,"getAllKeys"),t(e.index,n,"index"),t(e.insert,n,"insert"),t(e.upsert,n,"upsert"),t(e.createIndex,n,"createIndex"),t(e.deleteIndex,n,"deleteIndex"),t(e.openCursor,n,"openCursor"),t(e.query,n,"query"),t(e.bulkDelete,n,"bulkDelete"),t(e.bulkUpsert,n,"bulkUpsert")},e.prototype.hookPrimaryKeyQueries=function(e){var t=this,n=function(e,n){e.before((function(e){t.logMethodBegin(e,e.this.name,n,{key:e.args[0]})})).after((function(e){t.logMethodEnd(e,e.this.name,n,{key:e.args[0]},{data:e.return,error:e.error})}))};n(e.aspects.collection.get,"get"),n(e.aspects.collection.has,"has"),n(e.aspects.collection.delete,"delete")},e.prototype.hookConditionQueries=function(e){var t=this,n=function(e,n){e.before((function(e){t.logMethodBegin(e,e.this.name,n,t.formatQueryConditions(e.this.conditions()))})).after((function(e){t.logMethodEnd(e,e.this.name,n,t.formatQueryConditions(e.this.conditions()),{data:e.return,error:e.error})}))};n(e.aspects.collection.count,"count"),n(e.aspects.collection.entries,"entries"),n(e.aspects.collection.keys,"keys"),n(e.aspects.collection.values,"values"),n(e.aspects.collection.first,"first"),n(e.aspects.collection.last,"last"),n(e.aspects.collection.clear,"clear"),n(e.aspects.collection.update,"update")},e.prototype.hookDataManipulationQueries=function(e){var t=this,n=function(e,n){e.before((function(e){t.logMethodBegin(e,e.this.name,n,e.args)})).after((function(e){t.logMethodEnd(e,e.this.name,n,e.args,{data:e.return,error:e.error})}))};n(e.aspects.collection.insert,"insert"),n(e.aspects.collection.upsert,"upsert"),n(e.aspects.collection.bulkInsert,"bulkInsert"),n(e.aspects.collection.bulkUpsert,"bulkUpsert")},e.prototype.hookEvents=function(e){var t=this,n=function(){var e=Date.now();return function(){var t=Date.now(),n="+"+(t-e)+"ms";return e=t,n}}();e.events.onBootstrapStart((function(){t.logger.info(t.prefix,Pt(o.uW.BootstrapStart),n())})),e.events.onBootstrapEnd((function(){t.logger.info(t.prefix,Pt(o.uW.BootstrapEnd),n())})),e.events.onSchemaMigrationStart((function(){t.logger.info(t.prefix,Pt(o.uW.SchemaMigrationStart),n())})),e.events.onSchemaMigrationEnd((function(){t.logger.info(t.prefix,Pt(o.uW.SchemaMigrationEnd),n())})),e.events.onRegisterModel((function(e){var r,i=e.schema;return(r=t.logger).info.apply(r,(0,a.__spreadArray)((0,a.__spreadArray)([t.prefix,Pt(o.uW.RegisterModel)],(0,a.__read)(Nt({schema:JSON.stringify(i)}))),[n()]))})),e.events.onRegisterPlugin((function(e){var r,i=e.name;return(r=t.logger).info.apply(r,(0,a.__spreadArray)((0,a.__spreadArray)([t.prefix,Pt(o.uW.RegisterPlugin)],(0,a.__read)(Nt({name:i}))),[n()]))})),e.events.onReady((function(e){var r,i=e.version,s=e.tableNames;return(r=t.logger).info.apply(r,(0,a.__spreadArray)((0,a.__spreadArray)([t.prefix,Pt(o.uW.Ready)],(0,a.__read)(Nt({version:i,collections:Array.from(s)}))),[n()]))}))},e.prototype.formatQueryConditions=function(e){var t=e.offset,n=e.limit,r=e.order,i=e.exp;return{OFFSET:t||void 0,LIMIT:n,ORDER_BY:r&&"("+r.path+" "+r.type+")",WHERE:"("+this.formatQueryConditionsExp(i)+")"}},e}(),Mt=Ot,Rt=n("../node_modules/@tencent/ark-model/lib/index.js");!function(e){e.storage="storage",e.collection="collection",e.query="query",e.migration="migration",e.engine="engine"}(Ct||(Ct={})),function(e){e.tableGetAll="table#getAll",e.tableGetAllKeys="table#getAllKeys",e.tableGet="table#get",e.tableInsert="table#insert",e.tableUpsert="table#upsert",e.tableDelete="table#delete",e.tableClear="table#clear",e.tableBulkUpsert="table#bulkUpsert",e.tableBulkDelete="table#bulkDelete",e.tableQuery="table#query",e.tableCreateIndex="table#createIndex",e.tableDeleteIndex="table#deleteIndex",e.indexGet="index#get",e.indexGetAll="index#getAll",e.indexGetAllKeys="index#getAllKeys",e.cursorNext="cursor#next",e.cursorValue="cursor#value",e.cursorUpdate="cursor#update",e.cursorDelete="cursor#delete",e.transactionCommit="transaction#commit",e.transactionRollback="transaction#rollback",e.databaseClose="database#close",e.databaseCreateTable="database#createTable",e.databaseDeleteTable="database#deleteTable",e.engineOpenDB="engine#openDB",e.engineDeleteDB="engine#deleteDB"}(St||(St={})),function(e){e[e.success=0]="success",e[e.fail=1]="fail"}(It||(It={}));var Bt=function(){function e(e,t){this.module=Ct.engine,this.actionExecuteState=0,this.status=0,this.time=new Date,this.action=e,this.cost=t}return e.prototype.markError=function(e){this.errorMsg=e.message,this.actionExecuteState=1,this.status=1},e}(),qt=function(){function e(e,t){this.module=Ct.collection,this.status=0,this.actionExecuteState=0,this.write={count:0},this.read={count:0},this.delete={count:0},this.fail={count:0,reasons:[]},this.time=new Date,this.action=e,this.cost=t}return e.prototype.increment=function(e,t){void 0===t&&(t=1),this[e].count+=t},e.prototype.error=function(e){this.actionExecuteState=1,this.status=1,this.increment("fail"),this.fail.reasons.push(e.name)},e}(),Lt=Symbol("begin");function jt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e}var Kt,Ft,Ut=function(){function e(e){var t=this,n=void 0===e?{}:e,r=n.disabled,i=void 0!==r&&r,o=n.onEvent,s=n.onCollectionEvent,u=n.onEngineEvent;this.name="MonitorPlugin",this.begin=function(e){e.timings.set(Lt,new Date)},this.reportReadEvent=function(e,n){t.reportCollectionEvent(e,n,(function(r){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?[4,e.return]:[3,2];case 1:t=o.sent(),i="has"===n?!t:null===t,r.increment("read",i?0:1),o.label=2;case 2:return[2]}}))}))}))},this.reportBatchReadEvent=function(e,n){t.reportCollectionEvent(e,n,(function(n){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,r,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?(r=(t=n).increment,i=["read"],[4,e.return]):[3,2];case 1:r.apply(t,i.concat([o.sent().length])),o.label=2;case 2:return[2]}}))}))}))},this.reportWriteEvent=function(e,n){t.reportCollectionEvent(e,n,(function(n){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,r,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?(r=(t=n).increment,i=["write"],[4,e.return]):[3,2];case 1:r.apply(t,i.concat([null===o.sent()?0:1])),o.label=2;case 2:return[2]}}))}))}))},this.reportBatchWriteEvent=function(e,n){t.reportCollectionEvent(e,n,(function(n){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,r,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?(r=(t=n).increment,i=["write"],[4,e.return]):[3,2];case 1:r.apply(t,i.concat([o.sent().length])),o.label=2;case 2:return[2]}}))}))}))},this.reportDeleteEvent=function(e,n){t.reportCollectionEvent(e,n,(function(n){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,r,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?(r=(t=n).increment,i=["delete"],[4,e.return]):[3,2];case 1:r.apply(t,i.concat([null===o.sent()?0:1])),o.label=2;case 2:return[2]}}))}))}))},this.reportBatchDeleteEvent=function(e,n){t.reportCollectionEvent(e,n,(function(n){return(0,a.__awaiter)(t,void 0,void 0,(function(){var t,r,i;return(0,a.__generator)(this,(function(o){switch(o.label){case 0:return e.return?(r=(t=n).increment,i=["delete"],[4,e.return]):[3,2];case 1:r.apply(t,i.concat([o.sent().length])),o.label=2;case 2:return[2]}}))}))}))},this.disabled=i,this.onEvent=o,this.onCollectionEvent=s,this.onEngineEvent=u}return e.prototype.register=function(e){var t,n,r,i,o,s,u,c,l=this;if(!this.disabled){var p=e.aspects,h=p.collection,d=p.engine,f=function(e){h[e].before(v.begin).after((function(t){return l.reportReadEvent(t,e)}))},v=this;try{for(var y=(0,a.__values)(jt("get","has","first","last")),g=y.next();!g.done;g=y.next())f(g.value)}catch(R){t={error:R}}finally{try{g&&!g.done&&(n=y.return)&&n.call(y)}finally{if(t)throw t.error}}var m=function(e){h[e].before(b.begin).after((function(t){return l.reportBatchReadEvent(t,e)}))},b=this;try{for(var _=(0,a.__values)(jt("entries","keys","values","update")),w=_.next();!w.done;w=_.next())m(w.value)}catch(B){r={error:B}}finally{try{w&&!w.done&&(i=_.return)&&i.call(_)}finally{if(r)throw r.error}}var x=function(e){h[e].before(E.begin).after((function(t){return l.reportWriteEvent(t,e)}))},E=this;try{for(var A=(0,a.__values)(jt("upsert","insert")),C=A.next();!C.done;C=A.next())x(C.value)}catch(q){o={error:q}}finally{try{C&&!C.done&&(s=A.return)&&s.call(A)}finally{if(o)throw o.error}}var S=function(e){h[e].before(I.begin).after((function(t){return l.reportBatchWriteEvent(t,e)}))},I=this;try{for(var k=(0,a.__values)(jt("bulkUpsert","bulkInsert","update")),T=k.next();!T.done;T=k.next())S(T.value)}catch(L){u={error:L}}finally{try{T&&!T.done&&(c=k.return)&&c.call(k)}finally{if(u)throw u.error}}h.delete.before(this.begin).after((function(e){return l.reportDeleteEvent(e,"delete")})),h.clear.before(this.begin).after((function(e){return l.reportBatchDeleteEvent(e,"clear")})),d.openDB.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.engineOpenDB)})),d.deleteDB.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.engineDeleteDB)}));var D=d.database,N=d.table,P=d.transaction,O=d.index,M=d.cursor;D.close.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.databaseClose)})),D.createTable.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.databaseCreateTable)})),D.deleteTable.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.databaseDeleteTable)})),N.get.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableGet)})),N.getAll.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableGetAll)})),N.getAllKeys.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableGetAllKeys)})),N.insert.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableInsert)})),N.upsert.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableUpsert)})),N.delete.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableDelete)})),N.clear.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableClear)})),N.bulkDelete.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableBulkDelete)})),N.bulkUpsert.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableBulkUpsert)})),N.query.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableQuery)})),N.createIndex.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableCreateIndex)})),N.deleteIndex.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.tableDeleteIndex)})),P.commit.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.transactionCommit)})),P.rollback.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.transactionRollback)})),O.get.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.indexGet)})),O.getAll.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.indexGetAll)})),O.getAllKeys.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.indexGetAllKeys)})),M.delete.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.cursorDelete)})),M.update.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.cursorUpdate)})),M.next.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.cursorNext)})),M.value.before(this.begin).after((function(e){return l.reportEngineEvent(e,St.cursorValue)}))}},e.prototype.dispose=function(e){throw new F.zF({storage:e})},e.prototype.reportEngineEvent=function(e,t){var n,r,i=e.timings.get(Lt)||new Date,o=Date.now()-i.getTime(),a=new Bt(t,o);e.error&&a.markError(e.error),null===(n=this.onEvent)||void 0===n||n.call(this,a),null===(r=this.onEngineEvent)||void 0===r||r.call(this,a)},e.prototype.reportCollectionEvent=function(e,t,n){var r,i;return(0,a.__awaiter)(this,void 0,void 0,(function(){var o,s,u;return(0,a.__generator)(this,(function(a){switch(a.label){case 0:return o=e.timings.get(Lt)||new Date,s=Date.now()-o.getTime(),u=new qt(t,s),e.error?(u.error(e.error),[3,3]):[3,1];case 1:return[4,n(u,e)];case 2:a.sent(),a.label=3;case 3:return null===(r=this.onEvent)||void 0===r||r.call(this,u),null===(i=this.onCollectionEvent)||void 0===i||i.call(this,u),[2]}}))}))},e}(),Vt=Ut,Wt=function(e,t){return Wt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},Wt(e,t)};function Gt(e,t){function n(){this.constructor=e}Wt(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function Ht(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function Qt(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}!function(e){e[e.indexDB=1]="indexDB",e[e.nativeDB=2]="nativeDB"}(Ft||(Ft={}));var zt=((Kt={})[Ft.indexDB]=V,Kt[Ft.nativeDB]=At,Kt),Yt=function(){function e(e){void 0===e&&(e={type:Ft.indexDB}),this.config=e;var t=zt[e.type];this.storage=new o.ZP({name:Rt.H4,version:3,engine:new t,databaseSchema:'{"name":"unknown","collections":[{"name":"DocumentData","key":{"path":"key"},"indices":[{"name":"secretId","path":"secretId","unique":false},{"name":"globalPadId","path":"globalPadId","unique":false},{"name":"version","path":"version","unique":false},{"name":"type","path":"type","unique":false},{"name":"uid","path":"uid","unique":false},{"name":"subId","path":"subSheetId","unique":false},{"name":"chunkId","path":"chunkId","unique":false}],"properties":["key","secretId","globalPadId","version","type","uid","subId","chunkId","taskId","data","docType","docStatus","createTimestamp","lastModifyTimestamp","dataVersion","isDefaultChunk"]},{"name":"DocumentEntities","key":{"path":"key"},"indices":[],"properties":["key","data"]},{"name":"NewDocumentIds","key":{"path":"globalPadId"},"indices":[],"properties":["globalPadId","secretId","docType","localPadId","isCreated"]},{"name":"DocumentStatus","key":{"path":"globalPadId"},"indices":[{"name":"secretId","path":"secretId","unique":false},{"name":"uid","path":"uid","unique":false}],"properties":["globalPadId","secretId","uid","lastSyncTimestamp","lastErrorTimestamp"]},{"name":"OfflineData","key":{"path":"key"},"indices":[{"name":"secretId","path":"secretId","unique":false},{"name":"globalPadId","path":"globalPadId","unique":false},{"name":"version","path":"version","unique":false},{"name":"type","path":"type","unique":false},{"name":"uid","path":"uid","unique":false},{"name":"subId","path":"subSheetId","unique":false},{"name":"chunkId","path":"chunkId","unique":false}],"properties":["key","secretId","globalPadId","version","type","uid","subId","chunkId","taskId","data","docType","docStatus","createTimestamp","lastModifyTimestamp","dataVersion","isDefaultChunk"]},{"name":"PadInfo","key":{"path":"key"},"indices":[{"name":"secretId","path":"secretId","unique":false},{"name":"globalPadId","path":"globalPadId","unique":false},{"name":"uid","path":"uid","unique":false}],"properties":["key","secretId","globalPadId","uid","addListTimestamp","attribute","childrenLength","clientVersion","createTimestamp","creator","creatorDomain","icon","docPolicy","docPrivilege","thumbnail","docType","docTypeDesc","url","domainId","dver","folder","folderId","folderPolicy","folderPrivilege","isDeleted","isManualOffline","isMyCreated","isMydoc","isOfflineCache","isRencent","isShareToMe","hasSnapShot","isStar","isAddedToMy","isCollected","isOwner","isPinned","isShortcut","isUserChangeTitle","lastSyncTimestamp","lastBrowseTimestamp","lastCollectTimestamp","lastDeleteTimestamp","lastModifyTimestamp","lastModifyNick","lastModifyUid","lastPinnedTimestamp","listInfoType","listType","offlineCommiting","offlineCommitSuccessd","originFolderId","ownerNick","ownerUid","padId","parentFolderId","parents","privilege","status","title","type","hasLocalChanges"]}]}',disableAutoOpen:!0,plugins:this.getPlugins(e)})}return e.prototype.dispose=function(){this.storage.close()},e.prototype.init=function(){return Ht(this,void 0,void 0,(function(){var e=this;return Qt(this,(function(t){return[2,new Promise((function(t,n){var r,i=setTimeout((function(){var n,r;null===(r=null===(n=e.config.logger)||void 0===n?void 0:n.error)||void 0===r||r.call(n,"dababase init timeout."),t(!1)}),null!==(r=e.config.timeout)&&void 0!==r?r:15e3);e.storage.open().then((function(){t(!0),clearTimeout(i)})).catch((function(){t(!1),clearTimeout(i)}))}))]}))}))},e.prototype.getPlugins=function(e){var t,n=[],r=new Mt({logger:e.logger,disabled:!!e.disabled,verbose:!!e.verbose});return n.push(r),e.monitorReporter&&n.push((t=e.monitorReporter,new Vt({onEvent:function(e){t.report("storageActionResultAndCost",{action:e.action,module:e.module,retCode:e.actionExecuteState,cost:e.cost,time:e.time.getTime(),errorMsg:e.errorMsg})}}))),n},e}(),Xt=function(){function e(e){this.collection=e}return e.prototype.getChanges=function(e,t){return Ht(this,void 0,void 0,(function(){var n;return Qt(this,(function(r){return n=this.collection.where({uid:e.uid,secretId:e.secretId,type:{in:e.types},docType:e.docType,dataVersion:e.dataVersion,subId:{in:e.subId?(new Array).concat(e.subId):void 0},chunkId:{in:e.chunkId?(new Array).concat(e.chunkId):void 0},version:{">=":null===t||void 0===t?void 0:t.startVersion,"<=":null===t||void 0===t?void 0:t.endVersion}}),(null===t||void 0===t?void 0:t.orderPath)&&n.orderBy(t.orderPath,t.sortOrder),(null===t||void 0===t?void 0:t.limit)&&n.take(t.limit),[2,n.values()]}))}))},e.prototype.upsertChanges=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.bulkUpsert(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.deleteChanges=function(e){return Ht(this,void 0,void 0,(function(){var t,n,r,i,o;return Qt(this,(function(a){switch(a.label){case 0:return t=e.uid,n=e.secretId,r=e.globalPadId,i=e.types,o=e.taskIds,[4,this.collection.where({uid:t,secretId:n,globalPadId:r,type:{in:i},taskId:{in:o},version:{">":e.startVersion||Number.MIN_SAFE_INTEGER,"<":e.endVersion||Number.MAX_SAFE_INTEGER}}).clear()];case 1:return a.sent(),[2]}}))}))},e}(),Jt=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}Gt(t,e)}(Xt),function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Gt(t,e),t}(Xt)),$t=(function(){function e(e){this.collection=e}e.prototype.popDocumentId=function(e){return Ht(this,void 0,void 0,(function(){var t,n,r;return Qt(this,(function(i){switch(i.label){case 0:return[4,this.collection.where({documentType:e}).first()];case 1:return(t=i.sent())?(n=t.globalPadId,[4,this.collection.delete(n)]):[2,null];case 2:return r=i.sent(),n!==r?[2,null]:[2,t]}}))}))},e.prototype.upsertDocumentIds=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.bulkUpsert(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.countDocumentIds=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){return[2,this.collection.where({documentType:e}).count()]}))}))},e.prototype.deleteDocumentIds=function(){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(e){switch(e.label){case 0:return[4,this.collection.clear()];case 1:return e.sent(),[2]}}))}))}}(),function(){function e(e){this.collection=e}e.prototype.getStatus=function(e,t){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(n){switch(n.label){case 0:return[4,this.collection.where({secretId:t,uid:e}).first()];case 1:return[2,n.sent()]}}))}))},e.prototype.upsertStatus=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.upsert(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.deleteStatus=function(e,t){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(n){switch(n.label){case 0:return[4,this.collection.where({secretId:t,uid:e}).clear()];case 1:return n.sent(),[2]}}))}))}}(),function(){function e(e){this.collection=e}e.prototype.getEntity=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.get(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.upsertEntities=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.bulkUpsert(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.deleteEntity=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.delete(e)];case 1:return t.sent(),[2]}}))}))}}(),function(){function e(e){this.collection=e}e.prototype.getPadInfo=function(e,t){return Ht(this,void 0,void 0,(function(){var n;return Qt(this,(function(r){switch(r.label){case 0:return[4,this.getPadInfos({uid:e,secretId:t})];case 1:return 0===(n=r.sent()).length?[2,null]:[2,n.shift()]}}))}))},e.prototype.getPadInfos=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){return[2,this.collection.where({uid:e.uid,secretId:{in:e.secretId?(new Array).concat(e.secretId):void 0}}).values()]}))}))},e.prototype.upsertPadInfo=function(e){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(t){switch(t.label){case 0:return[4,this.collection.upsert(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.updateField=function(e,t,n){return Ht(this,void 0,void 0,(function(){var r;return Qt(this,(function(i){switch(i.label){case 0:return[4,this.collection.where({uid:e,secretId:t}).first()];case 1:return(r=i.sent())?(Object.assign(r,n),[4,this.collection.upsert(r)]):[2];case 2:return i.sent(),[2]}}))}))},e.prototype.deletePadInfo=function(e,t){return Ht(this,void 0,void 0,(function(){return Qt(this,(function(n){switch(n.label){case 0:return[4,this.collection.where({uid:e,secretId:t}).clear()];case 1:return n.sent(),[2]}}))}))}}(),n("../node_modules/@tencent/ark-request/lib/index.js")),Zt=function(e,t){return Zt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},Zt(e,t)};function en(e,t){function n(){this.constructor=e}Zt(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var tn=function(){return tn=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},tn.apply(this,arguments)};function nn(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function rn(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var on=function(){function e(e,t){void 0===t&&(t="exclusive"),this.id=this.getId();var n=tn(tn({},this.getDefaultConfig()),e);this.mode=t,this.strategy=n.strategy,this.period=n.period,this.autoRenewal=n.autoRenewal}return e.prototype.getId=function(){var e=new Date;return e.toLocaleDateString()+"-"+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+":"+e.getMilliseconds()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)},e}(),an=function(e,t){void 0!==e&&(this.error=e),void 0!==t&&(this.data=t)},sn=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.renewalHandler=new Map,t}return en(t,e),t.prototype.getDefaultConfig=function(){return{strategy:0,period:3e5,autoRenewal:!0}},t.prototype.lock=function(e,t){return nn(this,void 0,void 0,(function(){return rn(this,(function(n){switch(n.label){case 0:return"exclusive"!==this.mode?[3,2]:[4,this.lockExclusive(e,t)];case 1:case 3:return[2,n.sent()];case 2:return[4,this.lockShared(e,t)]}}))}))},t.prototype.detectKey=function(e){return nn(this,void 0,void 0,(function(){var t,n,r,i;return rn(this,(function(o){return t=this.getYKey(e),n=new an(void 0,void 0),(r=localStorage.getItem(t))&&(i=JSON.parse(r)).expire>Date.now()&&(n.data=i),[2,n]}))}))},t.prototype.release=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){switch(t.label){case 0:return"exclusive"!==this.mode?[3,2]:[4,this.releaseExclusiveLock(e)];case 1:case 3:return[2,t.sent()];case 2:return[4,this.releaseSharedLock(e)]}}))}))},t.prototype.lockExclusive=function(e,t){return nn(this,void 0,void 0,(function(){var n=this;return rn(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r,i){n.tryToLockKey(e,t,r,i)})).then((function(t){return n.autoRenewal&&n.renewal(e,n.period),{isSuccess:!0,data:t}}),(function(t){var r=n.getXKey(e);return localStorage.getItem(r)===n.id&&localStorage.removeItem(r),{isSuccess:!1,data:t}}))];case 1:return[2,r.sent()]}}))}))},t.prototype.lockShared=function(e,t){return nn(this,void 0,void 0,(function(){return rn(this,(function(n){throw new Error("method not implemented with "+e+" "+t+" ")}))}))},t.prototype.releaseExclusiveLock=function(e){return nn(this,void 0,void 0,(function(){var t,n,r,i;return rn(this,(function(o){return t=this.getXKey(e),n=this.getYKey(e),(r=localStorage.getItem(n))&&JSON.parse(r).id===this.id?(localStorage.removeItem(n),localStorage.getItem(t)===this.id&&localStorage.removeItem(t),(i=this.renewalHandler.get(e))&&(clearTimeout(i),this.renewalHandler.delete(e)),[2,!0]):[2,!1]}))}))},t.prototype.releaseSharedLock=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){throw new Error("method not implemented with "+e)}))}))},t.prototype.renewal=function(e,t){var n=this,r=this.renewalHandler.get(e);r&&clearTimeout(r);var i=setTimeout((function(){var r=n.getYKey(e),i=localStorage.getItem(r);if(i){var o=JSON.parse(i);if(o.id===n.id){var a=tn(tn({},o),{expire:Date.now()+n.period});localStorage.setItem(n.getYKey(e),JSON.stringify(a)),n.renewal(e,t)}}}),.85*t);return this.renewalHandler.set(e,i),i},t.prototype.getXKey=function(e){return t.PREFIX_LOCK_X+"_"+e},t.prototype.getYKey=function(e){return t.PREFIX_LOCK_Y+"_"+e},t.prototype.tryToLockKey=function(e,t,n,r){var i=this.getXKey(e),o=this.getYKey(e);localStorage.setItem(i,this.id);var a=localStorage.getItem(o);if(a&&JSON.parse(a).expire>Date.now())this.handleDetectLockFail(e,t,n,r);else{var s={id:this.id,expire:Date.now()+this.period,optional:t};localStorage.setItem(o,JSON.stringify(s)),localStorage.getItem(i)===this.id?n(s):this.delayDetect(e,t,n,r)}},t.prototype.delayDetect=function(e,t,n,r){var i=this,o=this.getYKey(e),a=localStorage.getItem(o),s=JSON.parse(a||"{}");setTimeout((function(){a&&s.id===i.id&&s.expire>Date.now()?n(s):i.handleDetectLockFail(e,t,n,r)}))},t.prototype.handleDetectLockFail=function(e,t,n,r){var i=this,o=this.getYKey(e),a=localStorage.getItem(o),s=JSON.parse(a||"{}");0!==this.strategy?setTimeout((function(){return i.tryToLockKey(e,t,n,r)}),200):r(s)},t.PREFIX_LOCK_X="prefix_lock_x",t.PREFIX_LOCK_Y="prefix_lock_y",t}(on);function un(){return!!window.localStorage}function cn(){return!!navigator.locks}var ln,pn,hn=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.releaseLockHandlerMap=new Map,t.lockManager=navigator.locks,t}return en(t,e),t.prototype.lock=function(e,t){var n=this;return new Promise((function(r){var i={isSuccess:!1,data:{id:n.id,expire:-1,optional:t}};n.lockManager.request(e,{ifAvailable:!0,mode:n.mode},(function(t){return t?(un()&&localStorage.setItem(e,JSON.stringify(i)),i.isSuccess=!0,r(i),n.keepLock(e)):(r(i),Promise.resolve())}))}))},t.prototype.release=function(e){return this.releaseLockHandlerMap.has(e)?(this.releaseLockHandlerMap.get(e)(),this.releaseLockHandlerMap.delete(e),localStorage.removeItem(e),Promise.resolve(!0)):Promise.resolve(!1)},t.prototype.detectKey=function(e){return nn(this,void 0,void 0,(function(){var t,n,r,i,o,a;return rn(this,(function(s){switch(s.label){case 0:return[4,this.lockManager.query()];case 1:return t=s.sent(),n=t.held.some((function(t){return t.name===e})),r=!!this.releaseLockHandlerMap.has(e),i=new an(void 0,void 0),!n||r||(un()?(a=localStorage.getItem(e),o=JSON.parse(a)):o={id:"",expire:-1,optional:{}},i.data=o),[2,i]}}))}))},t.prototype.getDefaultConfig=function(){return{strategy:0,period:-1,autoRenewal:!1}},t.prototype.keepLock=function(e){var t=this;return new Promise((function(n){var r;null===(r=t.releaseLockHandlerMap.get(e))||void 0===r||r(),t.releaseLockHandlerMap.set(e,n)}))},t}(on),dn=function(){function e(e,t){if(void 0===t&&(t="exclusive"),!un()&&!cn())throw new Error("当前环境不支持使用锁机制");this.resourceLock=cn()?new hn(e,t):new sn(e,t)}return e.prototype.lock=function(e,t){return nn(this,void 0,void 0,(function(){return rn(this,(function(n){switch(n.label){case 0:return[4,this.resourceLock.lock(e,t)];case 1:return[2,n.sent()]}}))}))},e.prototype.release=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){switch(t.label){case 0:return[4,this.resourceLock.release(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.detectKey=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){switch(t.label){case 0:return[4,this.resourceLock.detectKey(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getDefaultConfig=function(){return this.resourceLock.getDefaultConfig()},e}(),fn=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return en(t,e),t.prototype.lock=function(e,t){return nn(this,void 0,void 0,(function(){return rn(this,(function(n){switch(n.label){case 0:return"exclusive"!==this.mode?[3,2]:[4,this.lockExclusive(e,t)];case 1:case 3:return[2,n.sent()];case 2:return[4,this.lockShared(e,t)]}}))}))},t.prototype.detectKey=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){switch(t.label){case 0:return"exclusive"!==this.mode?[3,2]:[4,this.detectExclusiveKey(e)];case 1:case 3:return[2,t.sent()];case 2:return[4,this.detectSharedKey(e)]}}))}))},t.prototype.release=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){switch(t.label){case 0:return"exclusive"!==this.mode?[3,2]:[4,this.releaseExclusiveKey(e)];case 1:case 3:return[2,t.sent()];case 2:return[4,this.releaseSharedKey(e)]}}))}))},t.prototype.getDefaultConfig=function(){return{strategy:0,period:-1,autoRenewal:!0}},t.prototype.lockExclusive=function(e,t){return nn(this,void 0,void 0,(function(){var n,r,i,o=this;return rn(this,(function(a){switch(a.label){case 0:return n={tabId:this.id,expire:-1===this.period?-1:Date.now()+this.period,optional:t},r={command:"lock",key:e,item:n},[4,new Promise((function(e){$t.nativeRequest.invoke({schema:"jsapi",namespace:"docx",method:"clientMutexLock",params:r,callback:function(t){e(o.wrapResult(t))}})}))];case 1:return(i=a.sent()).error?[2,{isSuccess:!1,data:i.data}]:i.data.id===this.id?[2,{isSuccess:!0,data:i.data}]:[2,{isSuccess:!1,data:i.data}]}}))}))},t.prototype.lockShared=function(e,t){return nn(this,void 0,void 0,(function(){return rn(this,(function(n){throw new Error("method not implemented with "+e+" "+t)}))}))},t.prototype.detectExclusiveKey=function(e){return nn(this,void 0,void 0,(function(){var t,n,r;return rn(this,(function(i){switch(i.label){case 0:return t={command:"detectKey",key:e},[4,new Promise((function(e){$t.nativeRequest.invoke({schema:"jsapi",namespace:"docx",method:"clientMutexLock",params:t,callback:function(t){e(t)}})}))];case 1:return n=i.sent(),r=new an(void 0,n.result),n.err_code?(r.error=new Error(""+n.err_code),[2,r]):[2,r]}}))}))},t.prototype.detectSharedKey=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){throw new Error("method not implemented with "+e)}))}))},t.prototype.releaseExclusiveKey=function(e){return nn(this,void 0,void 0,(function(){var t,n=this;return rn(this,(function(r){switch(r.label){case 0:return t={command:"release",key:e},[4,new Promise((function(e){$t.nativeRequest.invoke({schema:"jsapi",namespace:"docx",method:"clientMutexLock",params:t,callback:function(t){e(n.wrapResult(t))}})}))];case 1:return r.sent().error?[2,!1]:[2,!0]}}))}))},t.prototype.releaseSharedKey=function(e){return nn(this,void 0,void 0,(function(){return rn(this,(function(t){throw new Error("method not implemented with "+e)}))}))},t.prototype.wrapResult=function(e){var t;if((null===(t=e.result)||void 0===t?void 0:t.tabId)&&(e.result.id=e.result.tabId,delete e.result.tabId),e.err_msg||e.err_code){var n=new Error(e.err_msg||e.err_code);return new an(n,e.result)}return new an(void 0,e.result)},t}(on);!function(e){e[e.ONCE=0]="ONCE",e[e.RETRY=1]="RETRY"}(ln||(ln={})),function(e){e.EXCLUSIVE="exclusive",e.SHARED="shared"}(pn||(pn={}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var vn=function(){return vn=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},vn.apply(this,arguments)};function yn(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function gn(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function mn(e){var t="function"===typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"===typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function bn(e,t){var n="function"===typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function _n(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(bn(arguments[t]));return e}var wn=function(e,t){void 0!==e&&(this.error=e),void 0!==t&&(this.data=t)},xn=function(){function e(){}return e.prototype.debug=function(){for(var e,t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];null===(t=null===(e=n.g.log)||void 0===e?void 0:e.debug)||void 0===t||t.call.apply(t,_n([e],r))},e.prototype.info=function(){for(var e,t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];null===(t=null===(e=n.g.log)||void 0===e?void 0:e.info)||void 0===t||t.call.apply(t,_n([e],r))},e.prototype.warn=function(){for(var e,t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];null===(t=null===(e=n.g.log)||void 0===e?void 0:e.warn)||void 0===t||t.call.apply(t,_n([e],r))},e.prototype.error=function(){for(var e,t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];null===(t=null===(e=n.g.log)||void 0===e?void 0:e.error)||void 0===t||t.call.apply(t,_n([e],r))},e}(),En=[Rt.MZ.committing,Rt.MZ.queue,Rt.MZ.waiting],An=new xn,Cn=function(){function e(e,t){this.version=e,this.denpendency=t,this.TAG="UpdateChangesHelper"}return e.prototype.updateChanges=function(e,t,n){return yn(this,void 0,void 0,(function(){var r;return gn(this,(function(i){switch(i.label){case 0:return An.info(this.TAG,"updateChanges localChanges.length:"+e.length),this.beginUpdateChanges=t,this.endUpdateChanges=n,(null===e||void 0===e?void 0:e.length)?-1===(r=this.getBaseVersion(e))?[2,new wn(new Error("INVALID_BASE_REV."))]:[4,this.readyUpdateChanges(e,r,this.version)]:[2,new wn(void 0,[])];case 1:return[2,i.sent()]}}))}))},e.prototype.readyUpdateChanges=function(e,t,n){return yn(this,void 0,void 0,(function(){return gn(this,(function(r){switch(r.label){case 0:return t===n?(An.info(this.TAG,"fromVersion === toVersion."),[2,new wn(void 0,e)]):[4,this.getMissToFollow(e,t+1,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.getMissToFollow=function(e,t,n){var r,i;return yn(this,void 0,void 0,(function(){var o,a,s,u=this;return gn(this,(function(c){switch(c.label){case 0:return null===(r=this.beginUpdateChanges)||void 0===r||r.call(this),An.info(this.TAG,"getMissToFollow fromVersion:"+t+", toVersion"+n+" "),[4,this.denpendency.getServerChanges(t,n)];case 1:return(o=c.sent()).error?(null===(i=this.endUpdateChanges)||void 0===i||i.call(this),[2,o]):(a=e,null===(s=o.data)||void 0===s||s.forEach((function(e){(null===a||void 0===a?void 0:a.length)&&a[0].taskId===e.taskId?(a.forEach((function(t){t.version=e.version})),a.shift()):a=a.map((function(t){var n=u.denpendency.follow(t,e);return n.version=e.version,n}))})),An.info(this.TAG,"getMissToFollow end, followChanges.length"+a.length),[2,new wn(void 0,a)])}}))}))},e.prototype.getBaseVersion=function(e){var t,n,r,i,o=new Set,a=-1;try{for(var s=mn(e),u=s.next();!u.done;u=s.next())a=u.value.version,o.add(a)}catch(h){t={error:h}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}if(o.size>1){var c="";try{for(var l=mn(o),p=l.next();!p.done;p=l.next())c=""+c+p.value+", "}catch(d){r={error:d}}finally{try{p&&!p.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}return An.error(this.TAG,"getBaseRev:"+c+" "),-1}return a},e}(),Sn=function(){function e(e,t){this.storage=e,this.info=t,this.TAG="OfflineDataHelper",this.changeStorage=new Jt(this.storage.collection(Rt.TU))}return e.prototype.setUpOldChangesTransForm=function(e){this.transform=e},e.prototype.getChanges=function(e,t,n){return yn(this,void 0,void 0,(function(){var r,i,a,s;return gn(this,(function(u){switch(u.label){case 0:return r={uid:this.info.uid,secretId:this.info.secretId,types:e},i={startVersion:t,endVersion:n,orderPath:"version",sortOrder:o.As.ASCENDING},[4,this.changeStorage.getChanges(r,i)];case 1:return a=u.sent(),s=this.offlineDataTransFormToBaseChanges(a),[2,new wn(void 0,s)]}}))}))},e.prototype.updateChanges=function(e){return yn(this,void 0,void 0,(function(){return gn(this,(function(t){switch(t.label){case 0:return(null===e||void 0===e?void 0:e.length)?[4,this.changeStorage.upsertChanges(this.storageChanges(e))]:[2,new wn({name:this.TAG,message:"updateChanges changes is null"})];case 1:return t.sent(),[2,new wn(void 0,!0)]}}))}))},e.prototype.deleteChanges=function(e,t,n){return yn(this,void 0,void 0,(function(){var r;return gn(this,(function(i){switch(i.label){case 0:return r={uid:this.info.uid,secretId:this.info.secretId,types:e,startVersion:t,endVersion:n},[4,this.changeStorage.deleteChanges(r)];case 1:return i.sent(),[2,new wn(void 0,!0)]}}))}))},e.prototype.deleteAndUpdateChanges=function(e,t){return yn(this,void 0,void 0,(function(){var n,r=this;return gn(this,(function(i){switch(i.label){case 0:return n={uid:this.info.uid,secretId:this.info.secretId,types:t},[4,this.storage.transaction([Rt.TU],o.pF.READ_WRITE,(function(t){return yn(r,void 0,void 0,(function(){var r;return gn(this,(function(i){switch(i.label){case 0:return[4,(r=t.collection(Rt.TU)).where({uid:n.uid,secretId:n.secretId,type:{in:n.types}}).clear()];case 1:return i.sent(),(null===e||void 0===e?void 0:e.length)?[4,r.bulkUpsert(this.storageChanges(e))]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}))];case 1:return i.sent(),[2,new wn(void 0,!0)]}}))}))},e.prototype.storageChanges=function(e){var t=this,n=[];return e.forEach((function(e){var r=e.version,i=e.taskId,o=e.subId,a=e.type,s=e.createTimestamp,u=e.chunkId,c=vn(vn({},t.info),{version:r,taskId:i,subId:o,type:a,createTimestamp:s,chunkId:u,isDefaultChunk:e.default,data:JSON.stringify(e)}),l=new Rt.TU(c);n.push(l)})),n},e.prototype.offlineDataTransFormToBaseChanges=function(e){var t=this;return e.filter((function(e){return e.data})).map((function(e){var n=e.data;try{var r=JSON.parse(n);return!r.modelVersion&&t.transform&&(r=t.transform(e)),r}catch(i){An.warn(t.TAG,"offlineDataTransFormToBaseChanges fail."+e.key)}return n}))},e}(),In={};function kn(){return"undefined"!==typeof window}function Tn(){return"undefined"!==typeof n.g}var Dn=kn()?window:Tn()?n.g:kn||"undefined"===typeof self?(Tn()&&n.g.describe,In):self;function Nn(e,t){return null!==e&&Object.prototype.hasOwnProperty.call(e,t)}var Pn="location";function On(e){if(!Nn(Dn,Pn))return"";var t=new RegExp("(\\?|&)"+e+"=([^&]*)(#|&|$)"),n=(Nn(Dn,Pn)?decodeURIComponent(location.search):"").match(t);return n?decodeURIComponent(n[2]):""}"undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof n.g?n.g:"undefined"!==typeof self&&self;var Mn=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){"undefined"!=typeof window&&window,e.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=73)}([function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){e.exports=!n(3)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t,n){var r=n(5);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var r=n(18)("wks"),i=n(17),o=n(0).Symbol,a="function"==typeof o;(e.exports=function(e){return r[e]||(r[e]=a&&o[e]||(a?o:i)("Symbol."+e))}).store=r},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){var r=n(0),i=n(15),o=n(11),a=n(12),s=n(19),u=function(e,t,n){var c,l,p,h,d=e&u.F,f=e&u.G,v=e&u.S,y=e&u.P,g=e&u.B,m=f?r:v?r[t]||(r[t]={}):(r[t]||{}).prototype,b=f?i:i[t]||(i[t]={}),_=b.prototype||(b.prototype={});for(c in f&&(n=t),n)p=((l=!d&&m&&void 0!==m[c])?m:n)[c],h=g&&l?s(p,r):y&&"function"==typeof p?s(Function.call,p):p,m&&a(m,c,p,e&u.U),b[c]!=p&&o(b,c,h),y&&_[c]!=p&&(_[c]=p)};r.core=i,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},function(e,t,n){var r=n(2),i=n(24),o=n(16),a=Object.defineProperty;t.f=n(1)?Object.defineProperty:function(e,t,n){if(r(e),t=o(t,!0),r(n),i)try{return a(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(14),i=Math.min;e.exports=function(e){return e>0?i(r(e),9007199254740991):0}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var r=n(7),i=n(26);e.exports=n(1)?function(e,t,n){return r.f(e,t,i(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var r=n(0),i=n(11),o=n(13),a=n(17)("src"),s=n(45),u=(""+s).split("toString");n(15).inspectSource=function(e){return s.call(e)},(e.exports=function(e,t,n,s){var c="function"==typeof n;c&&(o(n,"name")||i(n,"name",t)),e[t]!==n&&(c&&(o(n,a)||i(n,a,e[t]?""+e[t]:u.join(String(t)))),e===r?e[t]=n:s?e[t]?e[t]=n:i(e,t,n):(delete e[t],i(e,t,n)))})(Function.prototype,"toString",(function(){return"function"==typeof this&&this[a]||s.call(this)}))},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:n)(e)}},function(e,t){var n=e.exports={version:"2.6.11"};"number"==typeof __e&&(__e=n)},function(e,t,n){var r=n(5);e.exports=function(e,t){if(!r(e))return e;var n,i;if(t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;if("function"==typeof(n=e.valueOf)&&!r(i=n.call(e)))return i;if(!t&&"function"==typeof(n=e.toString)&&!r(i=n.call(e)))return i;throw TypeError("Can't convert object to primitive value")}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(15),i=n(0),o=i["__core-js_shared__"]||(i["__core-js_shared__"]={});(e.exports=function(e,t){return o[e]||(o[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:n(46)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(e,t,n){var r=n(27);e.exports=function(e,t,n){if(r(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var r=n(8);e.exports=function(e){return Object(r(e))}},function(e,t,n){var r=n(31),i=n(8);e.exports=function(e){return r(i(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){var r,i,o=n(40),a=RegExp.prototype.exec,s=String.prototype.replace,u=a,c=(r=/a/,i=/b*/g,a.call(r,"a"),a.call(i,"a"),0!==r.lastIndex||0!==i.lastIndex),l=void 0!==/()??/.exec("")[1];(c||l)&&(u=function(e){var t,n,r,i,u=this;return l&&(n=new RegExp("^"+u.source+"$(?!\\s)",o.call(u))),c&&(t=u.lastIndex),r=a.call(u,e),c&&r&&(u.lastIndex=u.global?r.index+r[0].length:t),l&&r&&r.length>1&&s.call(r[0],n,(function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(r[i]=void 0)})),r}),e.exports=u},function(e,t,n){e.exports=!n(1)&&!n(3)((function(){return 7!=Object.defineProperty(n(25)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,n){var r=n(5),i=n(0).document,o=r(i)&&r(i.createElement);e.exports=function(e){return o?i.createElement(e):{}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var r=n(14),i=Math.max,o=Math.min;e.exports=function(e,t){return(e=r(e))<0?i(e+t,0):o(e,t)}},function(e,t,n){var r=n(4)("unscopables"),i=Array.prototype;null==i[r]&&n(11)(i,r,{}),e.exports=function(e){i[r][e]=!0}},function(e,t,n){var r=n(19),i=n(31),o=n(20),a=n(9),s=n(50);e.exports=function(e,t){var n=1==e,u=2==e,c=3==e,l=4==e,p=6==e,h=5==e||p,d=t||s;return function(t,s,f){for(var v,y,g=o(t),m=i(g),b=r(s,f,3),_=a(m.length),w=0,x=n?d(t,_):u?d(t,0):void 0;_>w;w++)if((h||w in m)&&(y=b(v=m[w],w,g),e))if(n)x[w]=y;else if(y)switch(e){case 3:return!0;case 5:return v;case 6:return w;case 2:x.push(v)}else if(l)return!1;return p?-1:c||l?l:x}}},function(e,t,n){var r=n(10);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,n){var r=n(5),i=n(54).set;e.exports=function(e,t,n){var o,a=t.constructor;return a!==n&&"function"==typeof a&&(o=a.prototype)!==n.prototype&&r(o)&&i&&i(e,o),e}},function(e,t,n){var r=n(55),i=n(26),o=n(21),a=n(16),s=n(13),u=n(24),c=Object.getOwnPropertyDescriptor;t.f=n(1)?c:function(e,t){if(e=o(e),t=a(t,!0),u)try{return c(e,t)}catch(e){}if(s(e,t))return i(!r.f.call(e,t),e[t])}},function(e,t,n){var r=n(35),i=n(22).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,i)}},function(e,t,n){var r=n(13),i=n(21),o=n(56)(!1),a=n(36)("IE_PROTO");e.exports=function(e,t){var n,s=i(e),u=0,c=[];for(n in s)n!=a&&r(s,n)&&c.push(n);for(;t.length>u;)r(s,n=t[u++])&&(~o(c,n)||c.push(n));return c}},function(e,t,n){var r=n(18)("keys"),i=n(17);e.exports=function(e){return r[e]||(r[e]=i(e))}},function(e,t,n){var r=n(5),i=n(10),o=n(4)("match");e.exports=function(e){var t;return r(e)&&(void 0!==(t=e[o])?!!t:"RegExp"==i(e))}},function(e,t,n){var r=n(65)(!0);e.exports=function(e,t,n){return t+(n?r(e,t).length:1)}},function(e,t,n){var r=n(66),i=RegExp.prototype.exec;e.exports=function(e,t){var n=e.exec;if("function"==typeof n){var o=n.call(e,t);if("object"!=typeof o)throw new TypeError("RegExp exec method returned something other than an Object or null");return o}if("RegExp"!==r(e))throw new TypeError("RegExp#exec called on incompatible receiver");return i.call(e,t)}},function(e,t,n){var r=n(2);e.exports=function(){var e=r(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,n){n(67);var r=n(12),i=n(11),o=n(3),a=n(8),s=n(4),u=n(23),c=s("species"),l=!o((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")})),p=function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var n="ab".split(e);return 2===n.length&&"a"===n[0]&&"b"===n[1]}();e.exports=function(e,t,n){var h=s(e),d=!o((function(){var t={};return t[h]=function(){return 7},7!=""[e](t)})),f=d?!o((function(){var t=!1,n=/a/;return n.exec=function(){return t=!0,null},"split"===e&&(n.constructor={},n.constructor[c]=function(){return n}),n[h](""),!t})):void 0;if(!d||!f||"replace"===e&&!l||"split"===e&&!p){var v=/./[h],y=n(a,h,""[e],(function(e,t,n,r,i){return t.exec===u?d&&!i?{done:!0,value:v.call(t,n,r)}:{done:!0,value:e.call(n,t,r)}:{done:!1}})),g=y[0],m=y[1];r(String.prototype,e,g),i(RegExp.prototype,h,2==t?function(e,t){return m.call(e,this,t)}:function(e){return m.call(e,this)})}}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},function(e,t,n){var r=n(6);r(r.S+r.F*!n(1),"Object",{defineProperty:n(7).f})},function(e,t,n){e.exports=n(18)("native-function-to-string",Function.toString)},function(e,t){e.exports=!1},function(e,t,n){var r=n(6);r(r.P,"Array",{fill:n(48)}),n(29)("fill")},function(e,t,n){var r=n(20),i=n(28),o=n(9);e.exports=function(e){for(var t=r(this),n=o(t.length),a=arguments.length,s=i(a>1?arguments[1]:void 0,n),u=a>2?arguments[2]:void 0,c=void 0===u?n:i(u,n);c>s;)t[s++]=e;return t}},function(e,t,n){var r=n(6),i=n(30)(5),o=!0;"find"in[]&&Array(1).find((function(){o=!1})),r(r.P+r.F*o,"Array",{find:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0)}}),n(29)("find")},function(e,t,n){var r=n(51);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,n){var r=n(5),i=n(52),o=n(4)("species");e.exports=function(e){var t;return i(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!i(t.prototype)||(t=void 0),r(t)&&null===(t=t[o])&&(t=void 0)),void 0===t?Array:t}},function(e,t,n){var r=n(10);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){var r=n(0),i=n(13),o=n(10),a=n(32),s=n(16),u=n(3),c=n(34).f,l=n(33).f,p=n(7).f,h=n(57).trim,d=r.Number,f=d,v=d.prototype,y="Number"==o(n(59)(v)),g="trim"in String.prototype,m=function(e){var t=s(e,!1);if("string"==typeof t&&t.length>2){var n,r,i,o=(t=g?t.trim():h(t,3)).charCodeAt(0);if(43===o||45===o){if(88===(n=t.charCodeAt(2))||120===n)return NaN}else if(48===o){switch(t.charCodeAt(1)){case 66:case 98:r=2,i=49;break;case 79:case 111:r=8,i=55;break;default:return+t}for(var a,u=t.slice(2),c=0,l=u.length;c<l;c++)if((a=u.charCodeAt(c))<48||a>i)return NaN;return parseInt(u,r)}}return+t};if(!d(" 0o1")||!d("0b1")||d("+0x1")){d=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof d&&(y?u((function(){v.valueOf.call(n)})):"Number"!=o(n))?a(new f(m(t)),n,d):m(t)};for(var b,_=n(1)?c(f):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),w=0;_.length>w;w++)i(f,b=_[w])&&!i(d,b)&&p(d,b,l(f,b));d.prototype=v,v.constructor=d,n(12)(r,"Number",d)}},function(e,t,n){var r=n(5),i=n(2),o=function(e,t){if(i(e),!r(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,r){try{(r=n(19)(Function.call,n(33).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return o(e,n),t?e.__proto__=n:r(e,n),e}}({},!1):void 0),check:o}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var r=n(21),i=n(9),o=n(28);e.exports=function(e){return function(t,n,a){var s,u=r(t),c=i(u.length),l=o(a,c);if(e&&n!=n){for(;c>l;)if((s=u[l++])!=s)return!0}else for(;c>l;l++)if((e||l in u)&&u[l]===n)return e||l||0;return!e&&-1}}},function(e,t,n){var r=n(6),i=n(8),o=n(3),a=n(58),s="["+a+"]",u=RegExp("^"+s+s+"*"),c=RegExp(s+s+"*$"),l=function(e,t,n){var i={},s=o((function(){return!!a[e]()||"​"!="​"[e]()})),u=i[e]=s?t(p):a[e];n&&(i[n]=u),r(r.P+r.F*s,"String",i)},p=l.trim=function(e,t){return e=String(i(e)),1&t&&(e=e.replace(u,"")),2&t&&(e=e.replace(c,"")),e};e.exports=l},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,n){var r=n(2),i=n(60),o=n(22),a=n(36)("IE_PROTO"),s=function(){},u=function(){var e,t=n(25)("iframe"),r=o.length;for(t.style.display="none",n(62).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),u=e.F;r--;)delete u.prototype[o[r]];return u()};e.exports=Object.create||function(e,t){var n;return null!==e?(s.prototype=r(e),n=new s,s.prototype=null,n[a]=e):n=u(),void 0===t?n:i(n,t)}},function(e,t,n){var r=n(7),i=n(2),o=n(61);e.exports=n(1)?Object.defineProperties:function(e,t){i(e);for(var n,a=o(t),s=a.length,u=0;s>u;)r.f(e,n=a[u++],t[n]);return e}},function(e,t,n){var r=n(35),i=n(22);e.exports=Object.keys||function(e){return r(e,i)}},function(e,t,n){var r=n(0).document;e.exports=r&&r.documentElement},function(e,t,n){var r=n(37),i=n(2),o=n(64),a=n(38),s=n(9),u=n(39),c=n(23),l=n(3),p=Math.min,h=[].push,d="length",f=!l((function(){}));n(41)("split",2,(function(e,t,n,l){var v;return v="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1)[d]||2!="ab".split(/(?:ab)*/)[d]||4!=".".split(/(.?)(.?)/)[d]||".".split(/()()/)[d]>1||"".split(/.?/)[d]?function(e,t){var i=String(this);if(void 0===e&&0===t)return[];if(!r(e))return n.call(i,e,t);for(var o,a,s,u=[],l=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),p=0,f=void 0===t?4294967295:t>>>0,v=new RegExp(e.source,l+"g");(o=c.call(v,i))&&!((a=v.lastIndex)>p&&(u.push(i.slice(p,o.index)),o[d]>1&&o.index<i[d]&&h.apply(u,o.slice(1)),s=o[0][d],p=a,u[d]>=f));)v.lastIndex===o.index&&v.lastIndex++;return p===i[d]?!s&&v.test("")||u.push(""):u.push(i.slice(p)),u[d]>f?u.slice(0,f):u}:"0".split(void 0,0)[d]?function(e,t){return void 0===e&&0===t?[]:n.call(this,e,t)}:n,[function(n,r){var i=e(this),o=null==n?void 0:n[t];return void 0!==o?o.call(n,i,r):v.call(String(i),n,r)},function(e,t){var r=l(v,e,this,t,v!==n);if(r.done)return r.value;var c=i(e),h=String(this),d=o(c,RegExp),y=c.unicode,g=(c.ignoreCase?"i":"")+(c.multiline?"m":"")+(c.unicode?"u":"")+(f?"y":"g"),m=new d(f?c:"^(?:"+c.source+")",g),b=void 0===t?4294967295:t>>>0;if(0===b)return[];if(0===h.length)return null===u(m,h)?[h]:[];for(var _=0,w=0,x=[];w<h.length;){m.lastIndex=f?w:0;var E,A=u(m,f?h:h.slice(w));if(null===A||(E=p(s(m.lastIndex+(f?0:w)),h.length))===_)w=a(h,w,y);else{if(x.push(h.slice(_,w)),x.length===b)return x;for(var C=1;C<=A.length-1;C++)if(x.push(A[C]),x.length===b)return x;w=_=E}}return x.push(h.slice(_)),x}]}))},function(e,t,n){var r=n(2),i=n(27),o=n(4)("species");e.exports=function(e,t){var n,a=r(e).constructor;return void 0===a||null==(n=r(a)[o])?t:i(n)}},function(e,t,n){var r=n(14),i=n(8);e.exports=function(e){return function(t,n){var o,a,s=String(i(t)),u=r(n),c=s.length;return u<0||u>=c?e?"":void 0:(o=s.charCodeAt(u))<55296||o>56319||u+1===c||(a=s.charCodeAt(u+1))<56320||a>57343?e?s.charAt(u):o:e?s.slice(u,u+2):a-56320+(o-55296<<10)+65536}}},function(e,t,n){var r=n(10),i=n(4)("toStringTag"),o="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,n,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),i))?n:o?r(t):"Object"==(a=r(t))&&"function"==typeof t.callee?"Arguments":a}},function(e,t,n){var r=n(23);n(6)({target:"RegExp",proto:!0,forced:r!==/./.exec},{exec:r})},function(e,t,n){var r=n(6),i=n(30)(1);r(r.P+r.F*!n(69)([].map,!0),"Array",{map:function(e){return i(this,e,arguments[1])}})},function(e,t,n){var r=n(3);e.exports=function(e,t){return!!e&&r((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},function(e,t,n){var r=n(2),i=n(20),o=n(9),a=n(14),s=n(38),u=n(39),c=Math.max,l=Math.min,p=Math.floor,h=/\$([$&`']|\d\d?|<[^>]*>)/g,d=/\$([$&`']|\d\d?)/g;n(41)("replace",2,(function(e,t,n,f){return[function(r,i){var o=e(this),a=null==r?void 0:r[t];return void 0!==a?a.call(r,o,i):n.call(String(o),r,i)},function(e,t){var i=f(n,e,this,t);if(i.done)return i.value;var p=r(e),h=String(this),d="function"==typeof t;d||(t=String(t));var y=p.global;if(y){var g=p.unicode;p.lastIndex=0}for(var m=[];;){var b=u(p,h);if(null===b)break;if(m.push(b),!y)break;""===String(b[0])&&(p.lastIndex=s(h,o(p.lastIndex),g))}for(var _,w="",x=0,E=0;E<m.length;E++){b=m[E];for(var A=String(b[0]),C=c(l(a(b.index),h.length),0),S=[],I=1;I<b.length;I++)S.push(void 0===(_=b[I])?_:String(_));var k=b.groups;if(d){var T=[A].concat(S,C,h);void 0!==k&&T.push(k);var D=String(t.apply(void 0,T))}else D=v(A,h,C,S,k,t);C>=x&&(w+=h.slice(x,C)+D,x=C+A.length)}return w+h.slice(x)}];function v(e,t,r,o,a,s){var u=r+e.length,c=o.length,l=d;return void 0!==a&&(a=i(a),l=h),n.call(s,l,(function(n,i){var s;switch(i.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,r);case"'":return t.slice(u);case"<":s=a[i.slice(1,-1)];break;default:var l=+i;if(0===l)return n;if(l>c){var h=p(l/10);return 0===h?n:h<=c?void 0===o[h-1]?i.charAt(1):o[h-1]+i.charAt(1):n}s=o[l-1]}return void 0===s?"":s}))}}))},function(e,t,n){var r=n(0),i=n(32),o=n(7).f,a=n(34).f,s=n(37),u=n(40),c=r.RegExp,l=c,p=c.prototype,h=/a/g,d=/a/g,f=new c(h)!==h;if(n(1)&&(!f||n(3)((function(){return d[n(4)("match")]=!1,c(h)!=h||c(d)==d||"/a/i"!=c(h,"i")})))){c=function(e,t){var n=this instanceof c,r=s(e),o=void 0===t;return!n&&r&&e.constructor===c&&o?e:i(f?new l(r&&!o?e.source:e,t):l((r=e instanceof c)?e.source:e,r&&o?u.call(e):t),n?this:p,c)};for(var v=function(e){e in c||o(c,e,{configurable:!0,get:function(){return l[e]},set:function(t){l[e]=t}})},y=a(l),g=0;y.length>g;)v(y[g++]);p.constructor=c,c.prototype=p,n(12)(r,"RegExp",c)}n(72)("RegExp")},function(e,t,n){var r=n(0),i=n(7),o=n(1),a=n(4)("species");e.exports=function(e){var t=r[e];o&&t&&!t[a]&&i.f(t,a,{configurable:!0,get:function(){return this}})}},function(e,t,n){n.r(t),n.d(t,"UserAgent",(function(){return h})),n.d(t,"getVersionFromUA",(function(){return p})),n.d(t,"compareVersion",(function(){return l})),n(44);var r=n(42),i=n.n(r),o=n(43),a=n.n(o),s=(n(47),n(49),n(53),n(63),n(68),n(70),n(71),/\d+([._]\d+)*/);function u(e){var t,n=s.exec(e);return null!==(t=null==n?void 0:n[0].replace(/_/g,"."))&&void 0!==t?t:null}function c(e){var t=u(e);return(null==t?void 0:t.split(".").map(Number))||[]}function l(e,t){return n=c(e),r=c(t),(i=Array(Math.max(n.length,r.length)).fill(0).map((function(e,t){return(n[t]||0)-(r[t]||0)})).find((function(e){return 0!==e}))||0)<0?-1:i>0?1:0;var n,r,i}function p(e,t){var n;try{n=new RegExp("\\b".concat(e,"\\W+\\d+([\\._]\\d+)*"),"i")}catch(e){return null}var r=n.exec(t);return r?u(r[0].substring(e.length)):null}var h=function(){function e(t){var n=this;i()(this,e),this.userAgent="",this.getAndroidVersion=function(){return n.isAndroid?p("Android",n.userAgent):null},this.isAndroidVersionAboveOrEqual=function(e){return l(n.getAndroidVersion()||"",e)>=0},this.getIOSVersion=function(){return n.isIOS?p("OS",n.userAgent):null},this.isIOSVersionAboveOrEqual=function(e){return l(n.getIOSVersion()||"",e)>=0},this.getPCQQBrowserVersion=function(){return n.isPCQQBrowser?p("QQBrowser",n.userAgent):null},this.isPCQQBrowserVersionAboveOrEqual=function(e){return l(n.getPCQQBrowserVersion()||"",e)>=0},this.getMobileQQBrowserVersion=function(){return n.isMobileQQBrowser?p("MQQBrowser",n.userAgent):null},this.isMobileQQBrowserVersionAboveOrEqual=function(e){return l(n.getMobileQQBrowserVersion()||"",e)>=0},this.getChromeVersion=function(){return p("Chrome",n.userAgent)},this.isChromeVersionAboveOrEqual=function(e){return l(n.getChromeVersion()||"",e)>=0},this.getWeChatVersion=function(){return n.isWeChat||n.isWxMiniProgram?p("MicroMessenger",n.userAgent):null},this.isWeChatVersionAboveOrEqual=function(e){return l(n.getWeChatVersion()||"",e)>=0},this.getWxDriveVersion=function(){return n.isWxDrive?p("WXDrive",n.userAgent):null},this.isWxDriveVersionAboveOrEqual=function(e){return l(n.getWxDriveVersion()||"",e)>=0},this.getWxWorkVersion=function(){return n.isWxWork?p("wxwork",n.userAgent):null},this.isWxWorkVersionAboveOrEqual=function(e){return l(n.getWxWorkVersion()||"",e)>=0},this.getQQVersion=function(){return n.isQQ||n.isQQMiniProgram?p("QQ",n.userAgent):null},this.isQQVersionAboveOrEqual=function(e){return l(n.getQQVersion()||"",e)>=0},this.getTimVersion=function(){return n.isTim?p("TIM",n.userAgent):null},this.isTimVersionAboveOrEqual=function(e){return l(n.getTimVersion()||"",e)>=0},this.getTencentDocsAppVersion=function(){return p("TencentDocs",n.userAgent)},this.isTencentDocsAppVersionAboveOrEqual=function(e){return l(n.getTencentDocsAppVersion()||"",e)>=0},this.getPCTencentDocsClientVersion=function(){return p("TxDocsPC",n.userAgent)},this.isPCTencentDocsClientVersionAboveOrEqual=function(e){return l(n.getPCTencentDocsClientVersion()||"",e)>=0},this.getElectronTencentDocsClientVersion=function(){return p("TDAppDesktop",n.userAgent)},this.isElectronTencentDocsClientVersionAboveOrEqual=function(e){return l(n.getElectronTencentDocsClientVersion()||"",e)>=0},void 0===t&&(t="undefined"!=typeof navigator?navigator.userAgent:""),Object.defineProperty(this,"userAgent",{value:t,writable:!1})}return a()(e,[{key:"isMobile",get:function(){return/(mobile)/i.test(this.userAgent)||this.isAndroidPad}},{key:"isMobilePhone",get:function(){return/(mobile)/i.test(this.userAgent)&&!this.isIPad}},{key:"isIPhone",get:function(){return/(iphone)/i.test(this.userAgent)}},{key:"isIPad",get:function(){return/(ipad)/i.test(this.userAgent)}},{key:"isAndroidPhone",get:function(){return/(mobile)/i.test(this.userAgent)&&this.isAndroid}},{key:"isAndroidPad",get:function(){return!/(mobile)/i.test(this.userAgent)&&this.isAndroid}},{key:"isPC",get:function(){return!this.isMobile}},{key:"isMac",get:function(){return!this.isMobile&&/Mac OS X/i.test(this.userAgent)}},{key:"isIPadEmulatedMac",get:function(){return this.isMac&&navigator.maxTouchPoints>1}},{key:"isAndroid",get:function(){return/android|adr/i.test(this.userAgent)}},{key:"isIOS",get:function(){return/(iphone|ipad|ipod)/i.test(this.userAgent)}},{key:"isWindows",get:function(){return/(win64|wow64|win32|wow32|windows nt)/i.test(this.userAgent)}},{key:"isWindowsUWP",get:function(){return/MSAppHost/i.test(this.userAgent)}},{key:"isLinux",get:function(){return/linux/i.test(this.userAgent)&&!this.isAndroid}},{key:"isLinuxKylin",get:function(){return/linux-kylin/i.test(this.userAgent)}},{key:"isLinuxUOS",get:function(){return/linux-uos/i.test(this.userAgent)}},{key:"isPCQQBrowser",get:function(){return!this.isMobile&&/QQBrowser/i.test(this.userAgent)&&!/QBCore/i.test(this.userAgent)}},{key:"isMobileQQBrowser",get:function(){return this.isMobile&&/MQQBrowser/i.test(this.userAgent)&&!this.isTimOrQQ&&!this.isWeChat&&!this.isWxWork&&!this.isTencentDocsApp&&!this.isWeiYunApp&&!this.isMiniProgram}},{key:"isQQBrowser",get:function(){return this.isMobile?this.isMobileQQBrowser:this.isPCQQBrowser}},{key:"isChrome",get:function(){return/(Chrome|CriOS)\/\S+( Mobile\S*)? Safari\/\S+$/i.test(this.userAgent)}},{key:"isSafari",get:function(){return/Version\/\S+( Mobile\S*)? Safari\/\S+$/i.test(this.userAgent)}},{key:"isIE",get:function(){return/MSIE/i.test(this.userAgent)&&!/opera/i.test(this.userAgent)||/Trident/i.test(this.userAgent)}},{key:"isOldEdge",get:function(){return/Edge/i.test(this.userAgent)}},{key:"isChromiumEdge",get:function(){return/Edg\//i.test(this.userAgent)}},{key:"isFirefox",get:function(){return/(Firefox|Focus|FxiOS)\//i.test(this.userAgent)}},{key:"isWeChat",get:function(){return/MicroMessenger/i.test(this.userAgent)&&!this.isWxWork&&!this.isWxMiniProgram}},{key:"isWxWork",get:function(){return/(wxwork)/i.test(this.userAgent)}},{key:"isWxDrive",get:function(){return/WXDrive/i.test(this.userAgent)}},{key:"isQQ",get:function(){return/QQ\//i.test(this.userAgent)&&!this.isTencentDocsApp&&!this.isQQMiniProgram&&!this.isTim}},{key:"isQQForGooglePlay",get:function(){return/QQ\//i.test(this.userAgent)&&/_GM/i.test(this.userAgent)}},{key:"isTim",get:function(){return/TIM/i.test(this.userAgent)}},{key:"isPCTim",get:function(){return/QBCore/i.test(this.userAgent)&&/TIM2.0/i.test(this.userAgent)}},{key:"isTimOrQQ",get:function(){return this.isTim||this.isQQ}},{key:"isTimOrQQFamily",get:function(){return this.isTim||/QQ/i.test(this.userAgent)}},{key:"isMiniProgram",get:function(){return/miniprogram|miniapp(?!enable)/i.test(this.userAgent)||"undefined"!=typeof __wxjs_environment&&"miniprogram"===__wxjs_environment}},{key:"isWxMiniProgram",get:function(){return/MicroMessenger/i.test(this.userAgent)&&this.isMiniProgram}},{key:"isQQMiniProgram",get:function(){return/QQ\/|TIM/i.test(this.userAgent)&&this.isMiniProgram}},{key:"isTencentDocsApp",get:function(){return/TencentDocs/i.test(this.userAgent)}},{key:"isPCTencentDocsClient",get:function(){return/TxDocsPC/i.test(this.userAgent)}},{key:"isPCTencentDocsApp",get:function(){return this.isPCTencentDocsClient}},{key:"isElectronTencentDocsClient",get:function(){return/TDAppDesktop/i.test(this.userAgent)}},{key:"isWeiYunApp",get:function(){return/weiyun/i.test(this.userAgent)}},{key:"isSouGou",get:function(){return/SE 2\.X MetaSr 1\.0/i.test(this.userAgent)}},{key:"isTencentMeeting",get:function(){return/tencent_wemeet/i.test(this.userAgent)}},{key:"isTencentMeetingRooms",get:function(){return/TencentMeetingRooms/i.test(this.userAgent)}}]),e}();t.default=new h}])})),Rn=function(){if("0"===localStorage.getItem("OFFLINE_DB_SWITCH"))return!1;var e=navigator.userAgent.match(/_tdocFlag\/(\d+)/);return!!(null===e||void 0===e?void 0:e[1])&&2&parseInt(e[1],10)},Bn=function(e){return Rn()&&"1"!==On("offline-debug")?new fn(e):new dn(e)},qn={strategy:0,period:5e3,autoRenewal:!0},Ln=function(){function e(e,t,n){void 0===n&&(n=5e3),this.info=e,this.source=t,this.TAG="MutexLockHelper",qn.period=n,this.mutexLock=Bn(qn),this.lockKey="offline_edit_"+this.info.secretId}return e.prototype.dispose=function(){return yn(this,void 0,void 0,(function(){return gn(this,(function(e){switch(e.label){case 0:return[4,this.releaseLock()];case 1:return e.sent(),clearInterval(this.timer),[2,!0]}}))}))},e.prototype.lock=function(){return yn(this,void 0,void 0,(function(){var e;return gn(this,(function(t){switch(t.label){case 0:return e=this,[4,this.doLock(this.source)];case 1:return e.lockResult=t.sent(),[2,this.lockResult]}}))}))},e.prototype.deteckLock=function(e,t){var n=this;void 0===t&&(t=200),An.info("deteckLock, interval="+t),this.timer=setInterval((function(){return yn(n,void 0,void 0,(function(){var t;return gn(this,(function(n){switch(n.label){case 0:return[4,this.mutexLock.detectKey(this.lockKey)];case 1:return(t=n.sent()).error||void 0!==t.data||null===e||void 0===e||e(),[2]}}))}))}),t)},e.prototype.releaseLock=function(){return yn(this,void 0,void 0,(function(){var e;return gn(this,(function(t){switch(t.label){case 0:return[4,this.mutexLock.release(this.lockKey)];case 1:return e=t.sent(),An.info(this.TAG,"释放锁结果："+e),[2,!0]}}))}))},e.prototype.doLock=function(e){var t=this;return new Promise((function(n){t.mutexLock.lock(t.lockKey,{source:e}).then((function(e){var r;An.info(t.TAG,"竞争锁结果："+(null===e||void 0===e?void 0:e.isSuccess)+" "+(null===(r=null===e||void 0===e?void 0:e.data)||void 0===r?void 0:r.id)),n(e)}))}))},e}(),jn=function(){function e(e,t){this.option=e,this.denpendency=t,this.TAG="OfflineEdit",this.isStorageAvailable=!1}return e.prototype.init=function(e,t){return yn(this,void 0,void 0,(function(){var n,r,i;return gn(this,(function(o){switch(o.label){case 0:return n={disabled:!0,type:Rn()?Ft.nativeDB:Ft.indexDB},this.storageManager=new Yt(n),this.mutexLockHelper=new Ln(this.option.documentInfo,e,t),r=this,[4,this.mutexLockHelper.lock()];case 1:return[4,o.sent().isSuccess];case 2:return r.isLockSuccess=o.sent(),this.offlineDataHelper=new Sn(this.storageManager.storage,this.option.documentInfo),this.offlineDataHelper.setUpOldChangesTransForm(this.denpendency.oldChangesTransForm),function(){var e=new Mn.UserAgent;return!(e.isElectronTencentDocsClient&&!e.isElectronTencentDocsClientVersionAboveOrEqual("2.2.29"))}()?[4,this.storageManager.init()]:[3,4];case 3:if(i=o.sent(),this.isStorageAvailable=i,!i)return[2,new wn(new Error("StorageManager init fail."))];o.label=4;case 4:return An.info(this.TAG,"OfflineEdit init finish, isStorageAvailable: "+this.isStorageAvailable),[2,new wn(void 0,!0)]}}))}))},e.prototype.dispose=function(){var e;return yn(this,void 0,void 0,(function(){return gn(this,(function(t){switch(t.label){case 0:return[4,null===(e=this.mutexLockHelper)||void 0===e?void 0:e.dispose()];case 1:return t.sent(),this.storageManager.dispose(),[2,!0]}}))}))},e.prototype.canWrite=function(){return this.isLockSuccess&&this.isStorageAvailable},e.prototype.canRead=function(){return this.isStorageAvailable},e.prototype.getChanges=function(e,t,n){return void 0===e&&(e=En),void 0===t&&(t=Number.MIN_SAFE_INTEGER),void 0===n&&(n=Number.MAX_SAFE_INTEGER),yn(this,void 0,void 0,(function(){var r;return gn(this,(function(i){switch(i.label){case 0:if(!this.canRead())return[2,this.canNotRead()];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.offlineDataHelper.getChanges(e,t,n)];case 2:return[2,i.sent()];case 3:return r=i.sent(),this.isStorageAvailable=!1,[2,new wn(r)];case 4:return[2]}}))}))},e.prototype.updateChanges=function(e){return yn(this,void 0,void 0,(function(){var t;return gn(this,(function(n){switch(n.label){case 0:if(!this.canWrite())return An.warn(this.TAG,"updateChanges can not write."),[2,this.canNotWrite()];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.offlineDataHelper.updateChanges(e)];case 2:return[2,n.sent()];case 3:return t=n.sent(),this.isStorageAvailable=!1,[2,new wn(t)];case 4:return[2]}}))}))},e.prototype.deleteChanges=function(e,t,n){return void 0===e&&(e=En),void 0===t&&(t=Number.MIN_SAFE_INTEGER),void 0===n&&(n=Number.MAX_SAFE_INTEGER),yn(this,void 0,void 0,(function(){var r;return gn(this,(function(i){switch(i.label){case 0:if(!this.canWrite())return An.warn(this.TAG,"deleteChanges can not write."),[2,this.canNotWrite()];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.offlineDataHelper.deleteChanges(e,t,n)];case 2:return[2,i.sent()];case 3:return r=i.sent(),this.isStorageAvailable=!1,[2,new wn(r)];case 4:return[2]}}))}))},e.prototype.deleteAndUpdateChanges=function(e,t){return yn(this,void 0,void 0,(function(){var n;return gn(this,(function(r){switch(r.label){case 0:if(!this.canWrite())return An.warn(this.TAG,"deleteAndUpdate can not write."),[2,this.canNotWrite()];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.offlineDataHelper.deleteAndUpdateChanges(e,t)];case 2:return[2,r.sent()];case 3:return n=r.sent(),this.isStorageAvailable=!1,[2,new wn(n)];case 4:return[2]}}))}))},e.prototype.getMutexLockHelper=function(){return this.mutexLockHelper},e.prototype.getUpdateChangesHelper=function(){return new Cn(this.option.version,this.denpendency)},e.prototype.canNotWrite=function(e){return new wn(new Error("can’t write by "+e))},e.prototype.canNotRead=function(){return new wn(new Error("read fail，db can’t use."))},e}()},"../node_modules/@tencent/memoire-core/esm/index.js":function(e,t,n){var r,i;n.d(t,{cg:function(){return i},uZ:function(){return l},O3:function(){return a},yE:function(){return u},Kl:function(){return s},g6:function(){return r},Ze:function(){return m},As:function(){return c},pF:function(){return y},q9:function(){return h},qW:function(){return o},IA:function(){return v},zV:function(){return f},ot:function(){return d}}),function(e){e.CreateCollection="create-collection",e.DropCollection="drop-collection",e.CreateIndex="create-index",e.DropIndex="drop-index"}(r||(r={})),function(e){e.MoveProperty="move-property",e.DropProperty="drop-property",e.ReplaceProperty="replace-property",e.ClearData="clear-data",e.ReplaceData="replace-data"}(i||(i={}));var o,a={name:"alloy_db_schema_table",indices:[],key:{path:"name"},properties:[]};!function(e){e.Equals="=",e.NotEquals="!=",e.GreaterThan=">",e.GreaterOrEqualThan=">=",e.LessThan="<",e.LessOrEqualThan="<=",e.In="in",e.NotIn="nin"}(o||(o={}));var s,u,c,l,p,h=void 0;function d(e){return"number"===typeof e&&!Number.isNaN(e)||"string"===typeof e||e instanceof Date&&!Number.isNaN(e.getTime())||e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Array.isArray(e)&&e.every(d)}function f(e,t){var n=e;return Array.isArray(t)?t.map((function(e){return n[e]})):n[t]}function v(e,t){return Array.isArray(e)?Array.isArray(t)&&e.length===t.length&&e.every((function(e,n){return v(e,t[n])})):e===t}!function(e){e.OR="or",e.AND="and",e.FILTER="filter",e.NONE="none",e.ALL="all"}(s||(s={})),function(e){e.ENTRIES="entries",e.VALUES="values",e.KEYS="keys",e.COUNT="count"}(u||(u={})),function(e){e.DESCENDING="desc",e.ASCENDING="asc"}(c||(c={})),function(e){e.AutoIncrement="auto-increment"}(l||(l={})),function(e){e.Equals="=",e.GreaterThan=">",e.GreaterOrEqualThan=">=",e.LessThan="<",e.LessOrEqualThan="<="}(p||(p={}));var y,g=n("./node_modules/tslib/tslib.es6.js"),m=function(){function e(){}return e.collectionDiff=function(e,t){if(e.name!==t.name)throw new Error("can not compare collection schema with different name");var n={collection:e.name},r=t.indices.filter((function(t){return!e.indices.some((function(e){return e.name===t.name}))})),i=e.indices.filter((function(e){return!t.indices.some((function(t){return t.name===e.name}))}));return(r.length||i.length)&&(n.index={added:(0,g.__spreadArray)([],(0,g.__read)(r)),deleted:(0,g.__spreadArray)([],(0,g.__read)(i))}),n},e.databaseDiff=function(e,t){var n,r,i=this.getCompareMap(e,t),o={added:[],deleted:[],different:[]};try{for(var a=(0,g.__values)(i.values()),s=a.next();!s.done;s=a.next()){var u=s.value;if(!u.oldValue||u.newValue)if(u.oldValue||!u.newValue){if(u.oldValue&&u.newValue){var c=this.collectionDiff(u.oldValue,u.newValue);if(!c.index)continue;o.different.push(c)}}else o.added.push(u.newValue);else o.deleted.push(u.oldValue)}}catch(l){n={error:l}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return o},e.getCompareMap=function(e,t){var n,r,i,o,a=new Map;try{for(var s=(0,g.__values)(t.collections),u=s.next();!u.done;u=s.next()){var c=u.value;(h=a.get(c.name)||{}).newValue=c,a.set(c.name,h)}}catch(d){n={error:d}}finally{try{u&&!u.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}try{for(var l=(0,g.__values)(e.collections),p=l.next();!p.done;p=l.next()){var h;c=p.value,(h=a.get(c.name)||{}).oldValue=c,a.set(c.name,h)}}catch(f){i={error:f}}finally{try{p&&!p.done&&(o=l.return)&&o.call(l)}finally{if(i)throw i.error}}return a},e}();!function(e){e.READ_ONLY="readonly",e.READ_WRITE="readwrite",e.VERSION_CHANGE="versionchange"}(y||(y={}))},"../node_modules/@tencent/memoire-error-utils/esm/index.js":function(e,t,n){n.d(t,{sH:function(){return o},zF:function(){return a},ZK:function(){return s}});var r=n("./node_modules/tslib/tslib.es6.js"),i=function(e){function t(t,n){for(var r=this,i=t,o={cause:n};o.cause&&o.cause instanceof Error;)i=t+"\n\t→ "+n,o=o.cause;return(r=e.call(this,i)||this).cause=n,r.name=r.constructor.name,"function"===typeof Error.captureStackTrace?Error.captureStackTrace(r,r.constructor):r.stack=(new Error).stack,Object.setPrototypeOf(r,r.constructor.prototype),r}return(0,r.__extends)(t,e),t}(Error),o={withDefaultMessage:function(e,t){return function(n){function i(r,i){var o=n.call(this,r||t||"",i)||this;return o.name=e,Object.setPrototypeOf(o,o.constructor.prototype),o}return(0,r.__extends)(i,n),i}(i)},withMessageCreator:function(e,t){return function(n){function i(r,i){var o=n.call(this,t(r),i)||this;return o.name=e,Object.setPrototypeOf(o,o.constructor.prototype),o}return(0,r.__extends)(i,n),i}(i)}},a=(o.withDefaultMessage("AssertionError","the asserted condition is invalid"),o.withMessageCreator("UnimplementedError",(function(e){return e?"called with arguments: "+JSON.stringify(e):"called with nothing"}))),s=function(e){}},"../node_modules/@tencent/memoire-structured-storage/esm/index.js":function(e,t,n){n.d(t,{Hn:function(){return P},As:function(){return i.As},uW:function(){return k},pF:function(){return i.pF},ZP:function(){return Et},EP:function(){return E},Kz:function(){return C},T$:function(){return S},yD:function(){return A}});var r=n("./node_modules/tslib/tslib.es6.js"),i=n("../node_modules/@tencent/memoire-core/esm/index.js"),o=n("../node_modules/@tencent/memoire-error-utils/esm/index.js"),a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,r.__extends)(t,e),t.prototype.isQuotaExceeded=function(){return this.message.includes("QuotaExceededError")},t}(o.sH.withMessageCreator("DatabaseConnectError",(function(e){return"failed to connect to database '"+e+"'."}))),s=o.sH.withMessageCreator("CollectionNotFoundError",(function(e){return"model '"+e+"' is not registered, please register it before use it."})),u=o.sH.withMessageCreator("DataMigrationError",(function(e){return"failed to perform data migration, versionChange: "+e.oldVersion+" -> "+e.newVersion+"."})),c=o.sH.withMessageCreator("IncorrectTransactionModeError",(function(e){return"use error transaction type["+e+"]."})),l=o.sH.withMessageCreator("NoTableInfoError",(function(e){return"'"+e+"' is not a valid model with table info injected, please ensure the model class is decorated by @table(), @field() etc."})),p=o.sH.withDefaultMessage("EmptyTableInfoError","table without any field declare, please define model use [field] decorator."),h=o.sH.withMessageCreator("InvalidWhereInValueError",(function(e){return"there is an error in your where clause of field '"+e.path+"'."+e.op+", the value must be an array."})),d=o.sH.withMessageCreator("UnsupportedWhereOperatorError",(function(e){return"unsupported where operator '"+e+"', current supported operators are >, >=, <, <=, =, !=, in, nin."})),f=o.sH.withDefaultMessage("OrderByKeyError","can not order value that is not Key: 'Key = number | string | Date | BufferSource | Key[]'."),v=o.sH.withMessageCreator("DatabaseInternalError",(function(e){return"there is an internal error of database, reason: "+e+"."})),y=(o.sH.withMessageCreator("QueryJobError",(function(e){return"failed to execute query job, reason: "+e+"."})),o.sH.withMessageCreator("PluginError",(function(e){return'an error has occurred on plugin "'+e.name+'"": '+e.message+"."})),o.sH.withDefaultMessage("TransactionCommitError","failed to commit transaction.")),g=o.sH.withDefaultMessage("UpdateMigrationChangeInfoError","failed to update migration change info"),m=o.sH.withMessageCreator("ExecuteDataUpgradeError",(function(e){return"failed to execute data upgrade on collection '"+e+"'."})),b=o.sH.withMessageCreator("UnexpectedClosedError",(function(e){return"database "+e+" is unexpectedly closed by browser, this could happen when disk is unavailable or the page is shutdown."})),_=Symbol.for("TABLE_KEY"),w=function(){function e(){}return e.saveTableInfo=function(e,t){Object.defineProperty(t,_,{configurable:!0,value:(0,r.__assign)({},e)})},e.getTableInfo=function(e){return e[_]},e.getFirstTableInfoAlongPrototypeChain=function(e){var t=this.getTableInfo(e),n=Object.assign({},t);return n.properties=new Map(n.properties),n},e.getTableName=function(e){var t=this.getTableInfo(e.prototype);if(!(null===t||void 0===t?void 0:t.tableName))throw new l(e.name);return t.tableName},e.addTablePropertyInfo=function(t,n){var r=e.getOrCreateTableInfo(t);if(r.properties.has(n.name)){var i=r.properties.get(n.name);Object.assign(n,i)}r.properties.set(n.name,n),this.saveTableInfo(r,t)},e.createPropertyInfo=function(e,t){return{name:e,alias:t,isUnionKey:!1}},e.convertTableInfoToSchema=function(e){if(!e.tableName)return null;var t,n=(0,r.__spreadArray)([],(0,r.__read)(e.properties.values())),o=n.filter((function(e){return e.isIndex})).map((function(e){var t,n;return{name:null!==(t=e.alias)&&void 0!==t?t:e.name,path:null!==(n=e.alias)&&void 0!==n?n:e.name,unique:e.isUnique}}));return t=!e.autoIncrement&&e.keyPath?{path:1===e.keyPath.length?e.keyPath[0]:e.keyPath}:{generator:i.uZ.AutoIncrement},{properties:n.map((function(e){var t;return null!==(t=e.alias)&&void 0!==t?t:e.name})),indices:o,key:t,name:e.tableName}},e.createDefaultTableInfo=function(){return{tableName:null,autoIncrement:!0,properties:new Map}},e.getOrCreateTableInfo=function(t){if(Object.prototype.hasOwnProperty.call(t,_))return t[_];var n=e.createDefaultTableInfo(),i=t[_];return i&&(n.properties=new Map((0,r.__spreadArray)((0,r.__spreadArray)([],(0,r.__read)(i.properties)),(0,r.__read)(n.properties)))),e.saveTableInfo(n,t),n},e}(),x=w,E=function(e){return function(t,n){var r=x.createPropertyInfo(n,e);x.addTablePropertyInfo(t,r)}},A=function(e,t){return function(n){var i=x.getFirstTableInfoAlongPrototypeChain(n.prototype);if(!i)throw new p;i.tableName=e;var o=(0,r.__spreadArray)([],(0,r.__read)(i.properties.values())),a=function(e,t){if(null===e||void 0===e?void 0:e.key)return"string"===typeof e.key?[e.key]:e.key;var n=t.filter((function(e){return e.isPrimaryKey})).map((function(e){var t;return null!==(t=e.alias)&&void 0!==t?t:e.name}));return n.length>0?n:void 0}(t,o);i.keyPath=a,i.autoIncrement=void 0===i.keyPath,x.saveTableInfo(i,n.prototype)}},C=function(e){return function(t,n){var r=x.createPropertyInfo(n);r.isIndex=!0,r.isUnique=!!(null===e||void 0===e?void 0:e.unique),x.addTablePropertyInfo(t,r)}},S=function(){return function(e,t){var n=x.createPropertyInfo(t);n.isPrimaryKey=!0,x.addTablePropertyInfo(e,n)}};let I=()=>({events:{},emit(e,...t){(this.events[e]||[]).forEach((e=>e(...t)))},on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=(this.events[e]||[]).filter((e=>e!==t))}});var k,T;!function(e){e.Ready="Ready",e.Fetal="Fetal",e.Closed="Closed",e.Destroyed="Destroyed",e.Error="Error",e.RegisterModel="RegisterModel",e.RegisterPlugin="RegisterPlugin",e.BootstrapStart="BootstrapStart",e.BootstrapEnd="BootstrapEnd",e.SchemaMigrationStart="SchemaMigrationStart",e.SchemaMigrationEnd="SchemaMigrationEnd",e.VersionChange="VersionChange"}(k||(k={})),function(e){e.CollectionCreated="CollectionCreated",e.ModelLazyMigrationEnd="ModelLazyMigrationEnd",e.PrepareAutoUpgradeEnd="PrepareAutoUpgradeEnd",e.UpdateMigrationChangeInfo="UpdateMigrationChangeInfoEnd",e.StartTransaction="StartTransaction"}(T||(T={}));var D,N=function(){function e(e){var t=this;this.onClosed=function(e){t.eventBus.on(k.Closed,e)},this.eventBus=e}return e.prototype.onReady=function(e){this.eventBus.on(k.Ready,e)},e.prototype.onFetal=function(e){this.eventBus.on(k.Fetal,e)},e.prototype.onError=function(e){this.eventBus.on(k.Error,e)},e.prototype.onRegisterModel=function(e){this.eventBus.on(k.RegisterModel,e)},e.prototype.onRegisterPlugin=function(e){this.eventBus.on(k.RegisterPlugin,e)},e.prototype.onBootstrapStart=function(e){this.eventBus.on(k.BootstrapStart,e)},e.prototype.onBootstrapEnd=function(e){this.eventBus.on(k.BootstrapEnd,e)},e.prototype.onSchemaMigrationStart=function(e){this.eventBus.on(k.SchemaMigrationStart,e)},e.prototype.onSchemaMigrationEnd=function(e){this.eventBus.on(k.SchemaMigrationEnd,e)},e.prototype.onVersionChange=function(e){this.eventBus.on(k.VersionChange,e)},e.prototype.emitError=function(e){this.eventBus.emit(k.Error,e)},e}(),P=function(){function e(){}return e.revealSchema=function(e){var t=x.getTableInfo(e.prototype);return t?x.convertTableInfoToSchema(t):null},e}(),O=function(){function e(e){this.models=[],this.eventBus=e}return e.prototype.register=function(e){if(!this.models.includes(e)){var t=this.getSchema(e);this.models.push(e),this.eventBus.emit(k.RegisterModel,{class:e,schema:t})}},e.prototype.getSchema=function(e){var t=P.revealSchema(e);if(!t){var n=new l(e.name);throw this.eventBus.emit(k.Error,n),new l(e.name)}return t},e.prototype.getSchemaAndRegisterModelIfNeed=function(e){return this.register(e),this.getSchema(e)},e}();function M(e){var t,n,i,o=x.getTableInfo(Object.getPrototypeOf(e));if(!o)return e;var a={};try{for(var s=(0,r.__values)(o.properties.values()),u=s.next();!u.done;u=s.next()){var c=u.value;a[null!==(i=c.alias)&&void 0!==i?i:c.name]=e[c.name]}}catch(l){t={error:l}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return a}function R(e,t){var n,i;if(void 0===e||null===e)return null;var o=x.getTableInfo(t.prototype);if(!o)return e;var a=function(e,t){var n,i,o,a={};try{for(var s=(0,r.__values)(t.properties.values()),u=s.next();!u.done;u=s.next()){var c=u.value,l=null!==(o=c.alias)&&void 0!==o?o:c.name;a[c.name]=e[l]}}catch(p){n={error:p}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return a}(e,o),s=new t(a);try{for(var u=(0,r.__values)(Object.keys(a)),c=u.next();!c.done;c=u.next()){var l=c.value;void 0!==a[l]&&void 0===s[l]&&(s[l]=a[l])}}catch(p){n={error:p}}finally{try{c&&!c.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}return s}!function(e){e.FILL="fill",e.HYDRATE="hydrate",e.PAGINATE="paginate",e.FILTER="filter",e.SORT="sort",e.SCAN="scan",e.SCAN_ALL="scan-all",e.INDEX_SCAN="index-scan",e.UNION="union",e.DISTINCT="distinct",e.INTERSECT="intersect"}(D||(D={}));var B=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a;return(0,r.__generator)(this,(function(s){try{for(t=(0,r.__values)(this.node.inputs),n=t.next();!n.done;n=t.next())i=n.value,e.push(i)}catch(u){o={error:u}}finally{try{n&&!n.done&&(a=t.return)&&a.call(t)}finally{if(o)throw o.error}}return[2]}))}))},e}(),q=function(){function e(e){this.comparer=e}return e.prototype.has=function(e,t){return-1!==this.getOrder(e,t)},e.prototype.getOrder=function(e,t){for(var n=0,r=e.length;n<r;){var i=n+Math.floor((r-n)/2),o=e[i],a=this.comparer.cmp(t,o);if(0===a)return i;a>0?n=i+1:r=i}return-1},e}(),L=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a,s,u,c,l,p,h,d,f,v,y,g,m;return(0,r.__generator)(this,(function(b){t=new q(this.node.comparer);try{for(n=(0,r.__values)(this.context.inputs),i=n.next();!i.done;i=n.next()){o=i.value,a=new Map,s=o.map((function(e){return(0,r.__read)(e,1)[0]})).sort(this.node.comparer.cmp),u=[];try{for(g=void 0,c=(0,r.__values)(o),l=c.next();!l.done;l=c.next())p=l.value,h=(0,r.__read)(p,1),d=h[0],f=t.getOrder(s,d),a.has(f)||(a.set(f,!0),u.push(p))}catch(_){g={error:_}}finally{try{l&&!l.done&&(m=c.return)&&m.call(c)}finally{if(g)throw g.error}}e.push(u)}}catch(w){v={error:w}}finally{try{i&&!i.done&&(y=n.return)&&y.call(n)}finally{if(v)throw v.error}}return[2]}))}))},e}(),j=L,K=Symbol("-∞"),F=Symbol("+∞"),U=function(){function e(e){var t=this;this.contains=function(e,n){var r=t,i=r.cmp,o=r.lowerOf,a=r.upperOf;if(!t.isValid(e))return!1;var s=e.lowerOpen,u=e.upperOpen,c=i(o(e),n),l=i(a(e),n);return 0===c&&!s||c<0&&l>0||0===l&&!u},this.union=function(e){if(e.length<=1)return e;t.sort(e);for(var n=[],r=e[0],i=1;i<e.length;i++){var o=e[i];t.isOverlapped(r,o)?r=t.wrap(r,o):(n.push(r),r=o)}return n.push(r),n},this.intersect=function(e){var n,i;if(e.length<=1)return e;t.sort(e);var o=e[0];try{for(var a=(0,r.__values)(e),s=a.next();!s.done;s=a.next()){var u=s.value;if(!t.isOverlapped(o,u))return[];o=t.overlap(o,u)}}catch(c){n={error:c}}finally{try{s&&!s.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return[o]},this.isValid=function(e){var n=t,r=n.cmp,i=n.lowerOf,o=n.upperOf,a=r(i(e),o(e));return a<0||0===a&&!e.lowerOpen&&!e.upperOpen},this.cmp=function(e,n){return e!==K&&e!==F&&n!==K&&n!==F?t.comparer.cmp(e,n):e===n?0:e===K||n===F?-1:1},this.lowerOf=function(e){return void 0===e.lower?K:e.lower},this.upperOf=function(e){return void 0===e.upper?F:e.upper},this.comparer=e}return e.prototype.isOverlapped=function(e,t){var n,i=this,o=i.cmp,a=i.lowerOf,s=i.upperOf,u=(0,r.__read)([e,t],2),c=u[0],l=u[1],p=o(a(c),a(l));(p>0||0===p&&!c.lowerOpen&&l.lowerOpen)&&(c=(n=(0,r.__read)([l,c],2))[0],l=n[1]);var h=o(s(c),a(l));return h>0||0===h&&!c.upperOpen&&!l.lowerOpen},e.prototype.sort=function(e){var t=this.cmp,n=this.lowerOf;return e.sort((function(e,r){var i=t(n(e),n(r));return 0!==i||e.lowerOpen===r.lowerOpen?i:e.lowerOpen?-1:1}))},e.prototype.wrap=function(e,t){var n=this,i=n.cmp,o=n.lowerOf,a=n.upperOf,s=(0,r.__assign)({},e),u=i(o(e),o(t)),c=i(a(e),a(t));return(u>0||0===u&&!t.lowerOpen)&&(s.lower=t.lower,s.lowerOpen=t.lowerOpen),(c<0||0===c&&!t.upperOpen)&&(s.upper=t.upper,s.upperOpen=t.upperOpen),s},e.prototype.overlap=function(e,t){var n=this,i=n.cmp,o=n.lowerOf,a=n.upperOf,s=(0,r.__assign)({},e),u=i(o(e),o(t)),c=i(a(e),a(t));return(u<0||0===u&&!e.lowerOpen)&&(s.lower=t.lower,s.lowerOpen=t.lowerOpen),(c>0||0===c&&!e.upperOpen)&&(s.upper=t.upper,s.upperOpen=t.upperOpen),s},e}(),V=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a,s,u,c,l;return(0,r.__generator)(this,(function(p){for(t=[],n=this.node,i=[t];n;)n.regroup&&(t=[],i.push(t)),t.push(this.createFilter(n)),n=n.nextFilter;o=function(e){var t=(0,r.__read)(e,2)[1];return i.some((function(e){return e.every((function(e){return e(t)}))}))};try{for(a=(0,r.__values)(this.context.inputs),s=a.next();!s.done;s=a.next())u=s.value,e.push(u.filter(o))}catch(h){c={error:h}}finally{try{s&&!s.done&&(l=a.return)&&l.call(a)}finally{if(c)throw c.error}}return[2]}))}))},e.prototype.createFilter=function(e){var t=new U(e.comparer);return function(n){return e.intervals.some((function(r){if(void 0===n)throw new v("can not do filter on non-hydrated data");var o=(0,i.zV)(n,e.path);return(0,i.ot)(o)&&t.contains(r,o)}))}},e}(),W=function(){function e(e,t,n){this.node=e,this.parent=t,this.transaction=n,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a,s,u,c,l=this;return(0,r.__generator)(this,(function(p){switch(p.label){case 0:t=this.transaction.table(this.node.collectionSchema.name),n=function(n){var i;return(0,r.__generator)(this,(function(o){switch(o.label){case 0:return i=n.filter((function(e){return!function(e){return!!(0,r.__read)(e,2)[1]}(e)})),[4,Promise.all(i.map((function(e,n){var o=(0,r.__read)(e,1)[0];return(0,r.__awaiter)(l,void 0,void 0,(function(){var e;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.get(o)];case 1:return e=r.sent(),i[n][1]=e,[2]}}))}))})))];case 1:return o.sent(),e.push(n),[2]}}))},p.label=1;case 1:p.trys.push([1,6,7,8]),i=(0,r.__values)(this.context.inputs),o=i.next(),p.label=2;case 2:return o.done?[3,5]:(a=o.value,[5,n(a)]);case 3:p.sent(),p.label=4;case 4:return o=i.next(),[3,2];case 5:return[3,8];case 6:return s=p.sent(),u={error:s},[3,8];case 7:try{o&&!o.done&&(c=i.return)&&c.call(i)}finally{if(u)throw u.error}return[7];case 8:return[2]}}))}))},e}(),G=function(){function e(e,t,n,r){this.lower=e,this.upper=t,this.lowerOpen=n,this.upperOpen=r}return e.getKeyRange=function(e,t){if(void 0!==t){if(!e.isValid(t))throw new Error("invalid key interval");var n=t.lower,r=t.upper,i=t.lowerOpen,o=t.upperOpen;return n===r?n:void 0!==n&&void 0!==r?IDBKeyRange.bound(n,r,i,o):void 0!==n?IDBKeyRange.lowerBound(n,i):IDBKeyRange.upperBound(r,o)}},e}(),H=function(){function e(e,t){var n=this;this.comparer=t,this.math=new U(t),this.intervals=e.filter((function(e){return n.math.isValid(e)}))}return e.fromWherePredicate=function(t,n){var i,o,a;try{for(var s=(0,r.__values)(Object.keys(t)),u=s.next();!u.done;u=s.next()){var c=u.value,l=t[c];if(void 0!==l){var p=e.fromWhereExp(c,l,n);a=a?a.intersect(p):p}}}catch(h){i={error:h}}finally{try{u&&!u.done&&(o=s.return)&&o.call(s)}finally{if(i)throw i.error}}return a||this.createFullGroup(n)},e.fromWhereExp=function(t,n,r){var o;if(t===i.qW.In||t===i.qW.NotIn){if(!Array.isArray(n))throw new h({op:t});var a=n;return t===i.qW.In?a.reduce((function(t,n){return t.union(e.fromWhereExp(i.qW.Equals,n,r))}),this.createEmptyGroup(r)):a.reduce((function(t,n,o){var a=e.fromWhereExp(i.qW.NotEquals,n,r);return o?t.intersect(a):a}),this.createFullGroup(r))}switch(t){case i.qW.Equals:o=[new G(n,n,!1,!1)];break;case i.qW.NotEquals:o=[new G(void 0,n,!0,!0),new G(n,void 0,!0,!0)];break;case i.qW.GreaterThan:o=[new G(n,void 0,!0,!0)];break;case i.qW.GreaterOrEqualThan:o=[new G(n,void 0,!1,!0)];break;case i.qW.LessThan:o=[new G(void 0,n,!0,!0)];break;case i.qW.LessOrEqualThan:o=[new G(void 0,n,!0,!1)];break;default:throw new d(t)}return new e(o,r)},e.prototype.union=function(t){return new e(this.math.union((0,r.__spreadArray)((0,r.__spreadArray)([],(0,r.__read)(this.intervals)),(0,r.__read)(t.intervals))),this.comparer)},e.prototype.intersect=function(t){for(var n=this.math,i=n.cmp,o=n.upperOf,a=n.lowerOf,s=n.intersect,u=(0,r.__read)([this.intervals,t.intervals],2),c=u[0],l=u[1],p=(0,r.__read)([0,0],2),h=p[0],d=p[1],f=[];h<c.length;){for(;d<l.length&&i(o(c[h]),a(l[d]))>=0;){var v=s([c[h],l[d]]);f.push.apply(f,(0,r.__spreadArray)([],(0,r.__read)(v))),d+=1}d-=1,h+=1}return new e(f,this.comparer)},e.prototype.contains=function(e){var t=this;return!!this.intervals.find((function(n){return t.math.contains(n,e)}))},e.prototype.isEmpty=function(){return 0===this.intervals.length},e.prototype.isFull=function(){return!!this.intervals.length&&void 0===this.intervals[0].lower&&void 0===this.intervals[0].upper},e.createFullGroup=function(t){return new e([new G(void 0,void 0,!0,!0)],t)},e.createEmptyGroup=function(t){return new e([],t)},e}(),Q=G,z=function(){function e(e,t,n){this.node=e,this.parent=t,this.transaction=n,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,o,a,s;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return this.node.hydrate?[3,2]:[4,this.scanKeys()];case 1:return t=r.sent(),e.push(t.map((function(e){return[e,void 0]}))),[2];case 2:return(n=this.node.collectionSchema.key.path)?[4,this.scanValues()]:[3,4];case 3:return o=r.sent(),e.push(o.map((function(e){return[(0,i.zV)(e,n),e]}))),[2];case 4:return[4,this.scanKeys()];case 5:return a=r.sent(),[4,this.scanValues()];case 6:return s=r.sent(),e.push(a.map((function(e,t){return[e,s[t]]}))),[2]}}))}))},e.prototype.scanKeys=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return e=this.getKeyQueries(),t=this.getIndex(),[4,Promise.all(e.map((function(e){return t.getAllKeys(e)})))];case 1:return[2,n.sent().reduce((function(e,t){return e.push.apply(e,(0,r.__spreadArray)([],(0,r.__read)(t))),e}),[])]}}))}))},e.prototype.scanValues=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return e=this.getKeyQueries(),t=this.getIndex(),[4,Promise.all(e.map((function(e){return t.getAll(e)})))];case 1:return[2,n.sent().reduce((function(e,t){return e.push.apply(e,(0,r.__spreadArray)([],(0,r.__read)(t))),e}),[])]}}))}))},e.prototype.getKeyQueries=function(){var e=new U(this.node.comparer);return this.node.intervals.map((function(t){return Q.getKeyRange(e,t)}))},e.prototype.getIndex=function(){var e=this.node,t=e.collectionSchema,n=e.index;return this.transaction.table(t.name).index(n.name)},e}(),Y=z,X=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a,s,u,c,l,p,h,d,f;return(0,r.__generator)(this,(function(v){if(n=(t=this).context,i=t.node,!(o=n.inputs).length)return[2];if(1===o.length)return e.push(o[0]),[2];a=function(e,t){var n=(0,r.__read)(e,1)[0],o=(0,r.__read)(t,1)[0];return i.comparer.cmp(n,o)},s=new q({cmp:a}),u=this.getSmallestPointers(o).slice();try{for(c=(0,r.__values)(o),l=c.next();!l.done;l=c.next())l.value.sort(a)}catch(y){d={error:y}}finally{try{l&&!l.done&&(f=c.return)&&f.call(c)}finally{if(d)throw d.error}}return p=function(e){return o.every((function(t){return s.has(t,e)}))},h=u.filter(p),e.push(h),[2]}))}))},e.prototype.getSmallestPointers=function(e){return e.reduce((function(e,t){return e.length<t.length?e:t}),this.context.inputs[0])},e}(),J=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,i,o,a,s,u,c;return(0,r.__generator)(this,(function(l){t=this.node,n=t.offset,i=t.limit;try{for(o=(0,r.__values)(this.context.inputs),a=o.next();!a.done;a=o.next())s=a.value,e.push(s.slice(n,!i||isNaN(i)?void 0:n+i))}catch(p){u={error:p}}finally{try{a&&!a.done&&(c=o.return)&&c.call(o)}finally{if(u)throw u.error}}return[2]}))}))},e}(),$=function(){function e(e,t,n){this.node=e,this.parent=t,this.transaction=n,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,o,a,s;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return this.node.hydrate?[3,2]:[4,this.scanKeys()];case 1:return t=r.sent(),e.push(t.map((function(e){return[e,void 0]}))),[2];case 2:return(n=this.node.collectionSchema.key.path)?[4,this.scanValues()]:[3,4];case 3:return o=r.sent(),e.push(o.map((function(e){return[(0,i.zV)(e,n),e]}))),[2];case 4:return[4,this.scanKeys()];case 5:return a=r.sent(),[4,this.scanValues()];case 6:return s=r.sent(),e.push(a.map((function(e,t){return[e,s[t]]}))),[2]}}))}))},e.prototype.scanKeys=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return e=this.getKeyQueries(),t=this.getTable(),[4,Promise.all(e.map((function(e){return t.getAllKeys(e)})))];case 1:return[2,n.sent().reduce((function(e,t){return e.push.apply(e,(0,r.__spreadArray)([],(0,r.__read)(t))),e}),[])]}}))}))},e.prototype.scanValues=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t;return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return e=this.getKeyQueries(),t=this.getTable(),[4,Promise.all(e.map((function(e){return t.getAll(e)})))];case 1:return[2,n.sent().reduce((function(e,t){return e.push.apply(e,(0,r.__spreadArray)([],(0,r.__read)(t))),e}),[])]}}))}))},e.prototype.getKeyQueries=function(){var e=new U(this.node.comparer);return this.node.type===D.SCAN_ALL?[void 0]:this.node.intervals.map((function(t){return Q.getKeyRange(e,t)}))},e.prototype.getTable=function(){var e=this.node.collectionSchema;return this.transaction.table(e.name)},e}(),Z=$,ee=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,o,a,s,u,c,l,p,h=this;return(0,r.__generator)(this,(function(d){t=this.node,n=t.comparer,o=t.path,a=t.order;try{for(s=(0,r.__values)(this.context.inputs),u=s.next();!u.done;u=s.next())(c=u.value).sort((function(e,t){var s=(0,r.__read)(e,2)[1],u=(0,r.__read)(t,2)[1],c=(0,i.zV)(s,o),l=(0,i.zV)(u,o),p=h.getComparerByType(n,a);if((0,i.ot)(c)&&(0,i.ot)(l))return p(c,l);throw new f})),e.push(c)}catch(v){l={error:v}}finally{try{u&&!u.done&&(p=s.return)&&p.call(s)}finally{if(l)throw l.error}}return[2]}))}))},e.prototype.getComparerByType=function(e,t){return t===i.As.ASCENDING?function(t,n){return e.cmp(t,n)}:function(t,n){return-e.cmp(t,n)}},e}(),te=function(){function e(e,t){this.node=e,this.parent=t,this.context=ne(e)}return e.prototype.perform=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return e.push(this.context.inputs.reduce((function(e,t){return e.push.apply(e,(0,r.__spreadArray)([],(0,r.__read)(t))),e}),[])),[2]}))}))},e}();function ne(e){return{total:e.children.length,done:0,inputs:[]}}var re=function(){function e(e,t){this.onRequestSuccess=function(){},this.onRequestFailed=function(){},this.request=e,this.transaction=t,this.jobs=new Map}return e.prototype.exec=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e=this;return(0,r.__generator)(this,(function(t){return this.task||(this.task=new Promise((function(t,n){e.onRequestSuccess=function(n){e.reset(),t(n)},e.onRequestFailed=function(t){return(0,r.__awaiter)(e,void 0,void 0,(function(){return(0,r.__generator)(this,(function(e){return this.reset(),n(t),[2]}))}))},e.traverse(e.request.root,(function(t,n){var r=function(e,t,n){var r;return(r={},r[D.FILL]=function(){return new B(e,t)},r[D.DISTINCT]=function(){return new j(e,t)},r[D.FILTER]=function(){return new V(e,t)},r[D.HYDRATE]=function(){return new W(e,t,n)},r[D.INDEX_SCAN]=function(){return new Y(e,t,n)},r[D.INTERSECT]=function(){return new X(e,t)},r[D.PAGINATE]=function(){return new J(e,t)},r[D.SCAN]=function(){return new Z(e,t,n)},r[D.SCAN_ALL]=function(){return new Z(e,t,n)},r[D.SORT]=function(){return new ee(e,t)},r[D.UNION]=function(){return new te(e,t)},r)[e.type]()}(t,n&&e.jobs.get(n)||null,e.transaction);e.jobs.set(t,r),t.children.length||e.beginJob(r).catch((function(t){e.onRequestFailed(t)}))}))}))),[2,this.task]}))}))},e.prototype.beginJob=function(e){var t;return(0,r.__awaiter)(this,void 0,void 0,(function(){var n,i,o=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:n=(null===(t=e.parent)||void 0===t?void 0:t.context.inputs)||[],r.label=1;case 1:return r.trys.push([1,3,,4]),[4,e.perform(n)];case 2:return r.sent(),this.finishJob(e,n).catch((function(e){o.onRequestFailed(e)})),[3,4];case 3:return i=r.sent(),this.onRequestFailed(i),[3,4];case 4:return[2]}}))}))},e.prototype.finishJob=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){var n,i=this;return(0,r.__generator)(this,(function(r){return e.parent&&((n=e.parent.context).done+=1,n.done===n.total&&this.beginJob(e.parent).catch((function(e){i.onRequestFailed(e)}))),e.node===this.request.root&&this.onRequestSuccess(t),[2]}))}))},e.prototype.reset=function(){this.jobs=new Map,this.task=void 0,this.onRequestSuccess=function(){},this.onRequestFailed=function(){}},e.prototype.traverse=function(e,t,n){var i,o;t(e,n);try{for(var a=(0,r.__values)(e.children),s=a.next();!s.done;s=a.next()){var u=s.value;this.traverse(u,t,e)}}catch(c){i={error:c}}finally{try{s&&!s.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}},e}(),ie=function(){function e(e){this.comparer=e}return e.prototype.rewrite=function(e){return{offset:e.offset,limit:e.limit,order:e.order&&(0,r.__assign)({},e.order),exp:this.rewriteWhereClauses(e.whereClauses)}},e.prototype.rewriteWhereClauses=function(e){var t,n,o,a,s;if(!e.length)return{type:i.Kl.ALL};var u={type:i.Kl.OR,exps:[]};try{for(var c=(0,r.__values)(e),l=c.next();!l.done;l=c.next()){var p=l.value,h={type:i.Kl.AND,exps:[]};try{for(var d=(o=void 0,(0,r.__values)(Object.entries(p))),f=d.next();!f.done;f=d.next()){var v=(0,r.__read)(f.value,2),y=v[0],g=v[1];if(void 0!==g){var m=(0,i.ot)(g)?((s={})[i.qW.Equals]=g,s):g;this.isEmptyPredicate(m)||h.exps.push({type:i.Kl.FILTER,predicate:m,path:y,hints:{intervalGroup:H.fromWherePredicate(m,this.comparer),isKey:!1,indices:[]}})}}}catch(b){o={error:b}}finally{try{f&&!f.done&&(a=d.return)&&a.call(d)}finally{if(o)throw o.error}}u.exps.push(h)}}catch(_){t={error:_}}finally{try{l&&!l.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return u},e.prototype.isEmptyPredicate=function(e){return Object.values(e).every((function(e){return void 0===e}))},e}(),oe=function(){function e(e){this.schema=e,this.indicesMap=new Map,this.warmupIndicesMap()}return e.prototype.bind=function(e){return this.bindQueryHints(e.exp),e},e.prototype.bindQueryHints=function(e){var t,n=this,r=e;r.type!==i.Kl.AND&&r.type!==i.Kl.OR?r.type===i.Kl.FILTER&&(r.hints.isKey=this.schema.key&&(0,i.IA)(this.schema.key.path,r.path),r.hints.indices=null!==(t=this.indicesMap.get(r.path))&&void 0!==t?t:[]):r.exps.forEach((function(e){return n.bindQueryHints(e)}))},e.prototype.warmupIndicesMap=function(){var e,t,n,i,o;try{for(var a=(0,r.__values)(this.schema.indices.entries()),s=a.next();!s.done;s=a.next()){var u=(0,r.__read)(s.value,2),c=u[0],l=u[1];l.priority=null!==(o=l.priority)&&void 0!==o?o:-(c+1);var p=Array.isArray(l.path)?l.path:[l.path];try{for(var h=(n=void 0,(0,r.__values)(p)),d=h.next();!d.done;d=h.next()){var f=d.value,v=this.indicesMap.get(f)||[];v.push(l),this.indicesMap.set(f,v)}}catch(y){n={error:y}}finally{try{d&&!d.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}}}catch(g){e={error:g}}finally{try{s&&!s.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}},e}(),ae=oe,se=function(){function e(e,t){this.collectionSchema=e,this.comparer=t}return e.prototype.plan=function(e,t){return{root:this.getRootNode(e,t),aggregate:t}},e.prototype.getRootNode=function(e,t){if(e.exp.type===i.Kl.NONE)return this.getSkipNode();var n=this.getBaseNode(e.exp);return(t===i.yE.ENTRIES||t===i.yE.VALUES||e.order)&&(n=this.getHydrateNode([n])),e.order&&(n=this.getSortNode(e.order.path,e.order.type,[n])),(e.offset||e.limit!==i.q9)&&(n=this.getPaginateNode(e.offset,e.limit,[n])),n=this.getDistinctNode([n])},e.prototype.getBaseNode=function(e){return e.type===i.Kl.ALL?this.getScanAllNode():e.type===i.Kl.NONE?this.getSkipNode():e.type===i.Kl.FILTER?this.getFilterNode(e):this.getLogicExpNode(e)},e.prototype.getLogicExpNode=function(e){var t,n,o=[];try{for(var a=(0,r.__values)(e.exps),s=a.next();!s.done;s=a.next()){var u=s.value;o.push(u.type===i.Kl.FILTER?this.getFilterNode(u):this.getLogicExpNode(u))}}catch(c){t={error:c}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return e.type===i.Kl.AND?this.getIntersectNode(o):this.getUnionNode(o)},e.prototype.getFilterNode=function(e){if(!e.path||e.hints.isKey)return this.getScanNode(e.hints.intervalGroup.intervals);var t=e.hints.indices.find((function(t){return(0,i.IA)(t.path,e.path)}));return t?this.getIndexScanNode(e.hints.intervalGroup.intervals,t):this.getMemFilterNode(e.hints.intervalGroup.intervals,e.path)},e.prototype.getIntersectNode=function(e){return{type:D.INTERSECT,comparer:this.comparer,children:e}},e.prototype.getDistinctNode=function(e){return void 0===e&&(e=[]),{type:D.DISTINCT,comparer:this.comparer,children:e}},e.prototype.getUnionNode=function(e){return void 0===e&&(e=[]),{type:D.UNION,children:e}},e.prototype.getHydrateNode=function(e){return void 0===e&&(e=[]),{type:D.HYDRATE,collectionSchema:this.collectionSchema,children:e}},e.prototype.getPaginateNode=function(e,t,n){return void 0===n&&(n=[]),{type:D.PAGINATE,offset:e,limit:t,children:n}},e.prototype.getSortNode=function(e,t,n){return void 0===n&&(n=[]),{type:D.SORT,path:e,order:t,comparer:this.comparer,children:n}},e.prototype.getMemFilterNode=function(e,t,n){return{type:D.FILTER,comparer:this.comparer,path:t,intervals:e,regroup:!1,children:[{type:D.HYDRATE,collectionSchema:this.collectionSchema,children:n||[this.getScanAllNode()]}]}},e.prototype.getIndexScanNode=function(e,t){return{type:D.INDEX_SCAN,collectionSchema:this.collectionSchema,index:t,intervals:e,comparer:this.comparer,children:[]}},e.prototype.getScanNode=function(e){return{type:D.SCAN,collectionSchema:this.collectionSchema,intervals:e,comparer:this.comparer,children:[]}},e.prototype.getScanAllNode=function(){return{type:D.SCAN_ALL,collectionSchema:this.collectionSchema,comparer:this.comparer,children:[]}},e.prototype.getSkipNode=function(){return{type:D.FILL,inputs:[[]],children:[]}},e}(),ue=se,ce=function(){function e(){}return e.prototype.eliminate=function(e){var t=e;return t.exp=this.eliminateExp(e.exp),t},e.prototype.eliminateExp=function(e){return e.type===i.Kl.AND?this.eliminateAndExp(e):e.type===i.Kl.OR?this.eliminateOrExp(e):e.type===i.Kl.FILTER?this.eliminateFilterExp(e):e},e.prototype.eliminateAndExp=function(e){var t,n,o={type:i.Kl.AND,exps:[]};try{for(var a=(0,r.__values)(e.exps),s=a.next();!s.done;s=a.next()){var u=s.value,c=this.eliminateExp(u);if(c.type===i.Kl.NONE)return{type:i.Kl.NONE};c.type!==i.Kl.ALL&&o.exps.push(c)}}catch(l){t={error:l}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return o.exps.length?1===o.exps.length?o.exps[0]:o:{type:i.Kl.ALL}},e.prototype.eliminateOrExp=function(e){var t,n,o={type:i.Kl.OR,exps:[]};try{for(var a=(0,r.__values)(e.exps),s=a.next();!s.done;s=a.next()){var u=s.value,c=this.eliminateExp(u);if(c.type===i.Kl.ALL)return{type:i.Kl.ALL};c.type!==i.Kl.NONE&&o.exps.push(c)}}catch(l){t={error:l}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return o.exps.length?1===o.exps.length?e.exps[0]:o:{type:i.Kl.NONE}},e.prototype.eliminateFilterExp=function(e){return e.hints.intervalGroup.isEmpty()?{type:i.Kl.NONE}:e.hints.intervalGroup.isFull()?{type:i.Kl.ALL}:e},e}(),le=function(){var e,t=!1;return function(n,i){if("function"!==typeof n[i])throw new Error("memo() must be decorated on one of function properties of target");Object.defineProperty(n,i,(0,r.__assign)((0,r.__assign)({},Object.getOwnPropertyDescriptor(n,i)),{value:function(){return t||(e=n[i](),t=!0),e}}))}},pe=D.UNION,he=D.INTERSECT,de=D.HYDRATE,fe=D.INDEX_SCAN,ve=D.SCAN,ye=D.SCAN_ALL,ge=D.FILTER;function me(e){return be(e.root),e}function be(e){var t,n,i=e.children;try{for(var o=(0,r.__values)(i.entries()),a=o.next();!a.done;a=o.next()){var s=(0,r.__read)(a.value,2),u=s[0],c=s[1];if(be(c),[he,pe].includes(c.type)&&1===c.children.length){var l=c.children[0];i[u]=l}}}catch(p){t={error:p}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}}function _e(e){return we(e.root),e}function we(e){var t,n,i,o,a=e.children;try{for(var s=(0,r.__values)(a.entries()),u=s.next();!u.done;u=s.next()){var c=(0,r.__read)(u.value,2),l=c[0],p=c[1];if(we(p),p.type===de){var h=!1;try{for(var d=(i=void 0,(0,r.__values)(p.children)),f=d.next();!f.done;f=d.next())(v=f.value).type!==ve&&v.type!==fe&&v.type!==ye||(h=!0,v.hydrate=!0)}catch(y){i={error:y}}finally{try{f&&!f.done&&(o=d.return)&&o.call(d)}finally{if(i)throw i.error}}if(h&&1===p.children.length){var v=p.children[0];a[l]=v}}}}catch(g){t={error:g}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}}function xe(e){return e}function Ee(e){return Ae(e.root),e}function Ae(e){var t,n;Ce(e.children,(function(r){if(Ae(r),r.type!==ge||!r.children.some((function(e){return e.type===ye})))return!0;if(n){var i=r;!function(e,t){for(var n=e;e.nextFilter;)n=e.nextFilter;n.nextFilter=t}(n,i),i.regroup=e.type===pe}else t=r;return n=r,!1})),t&&e.children.push(t)}function Ce(e,t){for(var n=e,r=0,i=n.length-1;r<=i;){var o=n[r];t(o)?r+=1:(n[r]=n[i],n[i]=o,i-=1)}return n.splice(i+1)}function Se(e){return Ie(e.root),e}function Ie(e){var t,n,i=e.children;try{for(var o=(0,r.__values)(i.entries()),a=o.next();!a.done;a=o.next()){var s=(0,r.__read)(a.value,2),u=s[0],c=s[1];if(Ie(c),c.type===he){var l=c.children.find((function(e){var t=e.type;return[ve,fe].includes(t)}));if(l){var p=Ce(c.children,(function(e){return e.type!==ge}));if(p.length){var h={type:de,collectionSchema:l.collectionSchema,children:[]};i[u]=Pe.apply(void 0,(0,r.__spreadArray)((0,r.__spreadArray)([],(0,r.__read)(p)),[h,c]))}}}}}catch(d){t={error:d}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}}function ke(e){return[i.yE.COUNT,i.yE.KEYS].includes(e.aggregate)||Ne((function(e){e.type!==ve&&e.type!==fe||(e.hydrate=!0)}),e.root),e}function Te(e){return Ne((function(e){var t,n,i,o,a;if(e.type===he){var s=Number.MIN_SAFE_INTEGER;try{for(var u=(0,r.__values)(e.children),c=u.next();!c.done;c=u.next()){var l=c.value,p=Number.MIN_SAFE_INTEGER;l.type===ve&&(p=0),l.type===fe&&l.index.priority&&(p=l.index.priority),s=Math.max(s,p)}}catch(g){t={error:g}}finally{try{c&&!c.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}var h=e.children;try{for(var d=(0,r.__values)(h.entries()),f=d.next();!f.done;f=d.next()){var v=(0,r.__read)(f.value,2),y=v[0];(l=v[1]).type===fe&&(p=null!==(a=l.index.priority)&&void 0!==a?a:Number.MIN_SAFE_INTEGER)<s&&(h[y]=De(l))}}catch(m){i={error:m}}finally{try{f&&!f.done&&(o=d.return)&&o.call(d)}finally{if(i)throw i.error}}}}),e.root),e}function De(e){return{path:e.index.path,intervals:e.intervals,comparer:e.comparer,type:D.FILTER,regroup:!1,children:[{type:D.SCAN_ALL,collectionSchema:e.collectionSchema,comparer:e.comparer,hydrate:!0,children:[]}]}}function Ne(e,t,n,i){var o,a;void 0===n&&(n=null),void 0===i&&(i=-1);var s=t.children;try{for(var u=(0,r.__values)(s.entries()),c=u.next();!c.done;c=u.next()){var l=(0,r.__read)(c.value,2),p=l[0];Ne(e,l[1],t,p)}}catch(h){o={error:h}}finally{try{c&&!c.done&&(a=u.return)&&a.call(u)}finally{if(o)throw o.error}}e(t,n,i)}function Pe(){for(var e,t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var o=(0,r.__read)(n),a=o[0],s=o.slice(1),u=a;try{for(var c=(0,r.__values)(s),l=c.next();!l.done;l=c.next()){var p=l.value;u.children=[p],u=p}}catch(h){e={error:h}}finally{try{l&&!l.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}return a}var Oe,Me=function(){function e(){}return e.prototype.optimize=function(e){var t=[Te,_e,Ee,me,Se,xe,me,_e,ke];return this.applyAllRules(t,e)},e.prototype.applyAllRules=function(e,t){return e.reduce((function(e,t){return t(e)}),t)},e}(),Re=function(){function e(e){void 0===e&&(e=new Map),this.query={offset:0,limit:void 0,order:void 0,whereClauses:[]},this.aliasMap=e}return e.fromRawQuery=function(t,n){var i,o;void 0===n&&(n=new Map);var a=new e(n),s=t.offset,u=t.limit,c=t.order,l=t.whereClauses;a.setOffset(s),a.setLimit(u),c&&a.setOrderBy(c.path,c.type);try{for(var p=(0,r.__values)(l),h=p.next();!h.done;h=p.next()){var d=h.value;a.addWhereClause(d)}}catch(f){i={error:f}}finally{try{h&&!h.done&&(o=p.return)&&o.call(p)}finally{if(i)throw i.error}}return a},e.prototype.setOffset=function(e){this.query.offset=e},e.prototype.setLimit=function(e){this.query.limit=e},e.prototype.setRange=function(e,t){void 0===e&&(e=0),this.query.offset=e,this.query.limit=t!==i.q9?Math.max(0,t-e):i.q9},e.prototype.setOrderBy=function(e,t){this.query.order={path:e,type:t||i.As.ASCENDING}},e.prototype.addWhereClause=function(e){var t,n,i;if(this.isValidWhereClause(e)){var o={};try{for(var a=(0,r.__values)(Object.entries(e)),s=a.next();!s.done;s=a.next()){var u=(0,r.__read)(s.value,2),c=u[0],l=u[1];void 0!==l&&(o[null!==(i=this.aliasMap.get(c))&&void 0!==i?i:c]=l)}}catch(p){t={error:p}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}this.query.whereClauses.push(o)}},e.prototype.clone=function(t){return void 0===t&&(t=this.aliasMap),e.fromRawQuery(this.query,t)},e.prototype.build=function(){return this.query},e.prototype.isValidWhereClause=function(e){return!!e&&Object.keys(e).length>=0},e}(),Be=Re;!function(e){e.DISABLED="disabled",e.ALL="all"}(Oe||(Oe={}));var qe,Le=function(){function e(e,t){this.collectionName=e,this.context=t.context}return e.toggleOptimization=function(t){e.optimization=t?Oe.ALL:Oe.DISABLED},e.getOptimizationMode=function(){return e.optimization},e.prototype.exec=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){var n,o,a,s,u,c,l,p;return(0,r.__generator)(this,(function(h){switch(h.label){case 0:return[4,this.context.getTransaction([this.collectionName],i.pF.READ_ONLY)];case 1:return n=h.sent(),[4,this.getModel()];case 2:return o=h.sent(),a=this.getAliasMap(o.class),s=Be.fromRawQuery(e,a).build(),(u=n.table(this.collectionName)).supports("query")&&s.whereClauses.length<=1?t!==i.yE.VALUES?[3,4]:[4,u.query(s,t)]:[3,7];case 3:return[2,h.sent().map((function(e){var t;return null!==(t=R(e,o.class))&&void 0!==t?t:void 0}))];case 4:return t!==i.yE.ENTRIES?[3,6]:[4,u.query(s,t)];case 5:return[2,h.sent().map((function(e){var t,n=(0,r.__read)(e,2);return[n[0],null!==(t=R(n[1],o.class))&&void 0!==t?t:void 0]}))];case 6:return[2,u.query(s,t)];case 7:return[4,this.getQueryPlan(s,t)];case 8:return c=h.sent(),[4,new re(c,n).exec()];case 9:return l=r.__read.apply(void 0,[h.sent(),1]),p=l[0],t===i.yE.COUNT?[2,p.length]:t===i.yE.KEYS?[2,p.map((function(e){return(0,r.__read)(e,1)[0]}))]:t===i.yE.VALUES?[2,p.map((function(e){var t;return null!==(t=R((0,r.__read)(e,2)[1],o.class))&&void 0!==t?t:void 0}))]:[2,p.map((function(e){var t,n=(0,r.__read)(e,2);return[n[0],null!==(t=R(n[1],o.class))&&void 0!==t?t:void 0]}))]}}))}))},e.prototype.conditions=function(e){return this.getRewriter().rewrite(e)},e.prototype.explain=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.getQueryPlan(e,t)];case 1:return[2,n.sent()]}}))}))},e.prototype.getQueryPlan=function(t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o,a,s,u,c,l;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,this.getRewriter()];case 1:return i=r.sent(),[4,this.getEliminator()];case 2:return o=r.sent(),[4,this.getPlanner()];case 3:return a=r.sent(),[4,this.getBinder()];case 4:return s=r.sent(),[4,this.getOptimizer()];case 5:return u=r.sent(),c=i.rewrite(t),c=s.bind(c),c=o.eliminate(c),l=a.plan(c,n),[2,e.optimization===Oe.DISABLED?l:u.optimize(l)]}}))}))},e.prototype.getAliasMap=function(e){var t,n,i=new Map,o=x.getTableInfo(e.prototype);if(!o)return i;try{for(var a=(0,r.__values)(o.properties.values()),s=a.next();!s.done;s=a.next()){var u=s.value;u.alias&&i.set(u.name,u.alias)}}catch(c){t={error:c}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return i},e.prototype.getModel=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(e){return[2,this.context.waitForModelRegistered(this.collectionName)]}))}))},e.prototype.getPlanner=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e;return(0,r.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.getModel()];case 1:return e=t.sent(),[2,new ue(e.schema,this.context.comparer)]}}))}))},e.prototype.getRewriter=function(){return new ie(this.context.comparer)},e.prototype.getEliminator=function(){return new ce},e.prototype.getBinder=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e;return(0,r.__generator)(this,(function(t){switch(t.label){case 0:return[4,this.getModel()];case 1:return e=t.sent(),[2,new ae(e.schema)]}}))}))},e.prototype.getOptimizer=function(){return new Me},e.optimization=Oe.ALL,(0,r.__decorate)([le()],e.prototype,"getModel",null),(0,r.__decorate)([le()],e.prototype,"getPlanner",null),(0,r.__decorate)([le()],e.prototype,"getRewriter",null),(0,r.__decorate)([le()],e.prototype,"getEliminator",null),(0,r.__decorate)([le()],e.prototype,"getBinder",null),(0,r.__decorate)([le()],e.prototype,"getOptimizer",null),e}(),je=Le,Ke=function(){function e(e,t){this.name=e,this.options=t,this.contextGenerator=t.contextGenerator,this.queryBuilder=new Be,this.patch()}return e.toggleOptimization=function(e){return je.toggleOptimization(e)},e.prototype.skip=function(e){return this.queryBuilder.setOffset(e),this},e.prototype.take=function(e){return this.queryBuilder.setLimit(e),this},e.prototype.slice=function(e,t){return this.queryBuilder.setRange(e,t),this},e.prototype.orderBy=function(e,t){return this.queryBuilder.setOrderBy(e,t),this},e.prototype.where=function(e){return this.queryBuilder.addWhereClause(e),this},e.prototype.or=function(e){return this.queryBuilder.addWhereClause(e),this},e.prototype.conditions=function(){var e=this.contextGenerator.spawnContext();return new je(this.name,{context:e}).conditions(this.queryBuilder.build())},e.prototype.clone=function(){var t=new e(this.name,this.options);return t.queryBuilder=this.queryBuilder.clone(),t},e.prototype.explain=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t;return(0,r.__generator)(this,(function(n){return t=this.contextGenerator.spawnContext(),[2,new je(this.name,{context:t}).explain(this.queryBuilder.build(),e)]}))}))},e.prototype.count=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.COUNT)]}))}))}))]}))}))},e.prototype.entries=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.ENTRIES)]}))}))}))]}))}))},e.prototype.keys=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.KEYS)]}))}))}))]}))}))},e.prototype.values=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.VALUES)]}))}))}))]}))}))},e.prototype.first=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){var t,n;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.VALUES)];case 1:return t=r.sent(),[2,null!==(n=t[0])&&void 0!==n?n:null]}}))}))}))]}))}))},e.prototype.last=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t=this;return(0,r.__generator)(this,(function(n){return[2,(e=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(t,void 0,void 0,(function(){var t,n;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,new je(this.name,{context:e}).exec(this.queryBuilder.build(),i.yE.VALUES)];case 1:return t=r.sent(),[2,null!==(n=t[t.length-1])&&void 0!==n?n:null]}}))}))}))]}))}))},e.prototype.update=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n,o=this;return(0,r.__generator)(this,(function(a){switch(a.label){case 0:return[4,this.entries()];case 1:return t=a.sent(),[2,(n=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(o,void 0,void 0,(function(){var o,a,s,u,c,l,p,h,d,f,v,y,g;return(0,r.__generator)(this,(function(m){switch(m.label){case 0:return o=[],[4,n.getTransaction([this.name],i.pF.READ_WRITE)];case 1:a=m.sent(),s=a.table(this.name),m.label=2;case 2:m.trys.push([2,8,9,10]),u=(0,r.__values)(t),c=u.next(),m.label=3;case 3:return c.done?[3,7]:(l=(0,r.__read)(c.value,2),p=l[0],h=l[1],[4,s.openCursor(p)]);case 4:return(d=m.sent())?(f=e(h),[4,d.update(M(f))]):[3,6];case 5:m.sent(),o.push(p),m.label=6;case 6:return c=u.next(),[3,3];case 7:return[3,10];case 8:return v=m.sent(),y={error:v},[3,10];case 9:try{c&&!c.done&&(g=u.return)&&g.call(u)}finally{if(y)throw y.error}return[7];case 10:return[2,o]}}))}))}))]}}))}))},e.prototype.clear=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,t,n=this;return(0,r.__generator)(this,(function(o){switch(o.label){case 0:return[4,this.keys()];case 1:return e=o.sent(),[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){var n,o,a,s,u,c,l,p,h,d;return(0,r.__generator)(this,(function(f){switch(f.label){case 0:return n=[],[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:return o=f.sent(),(a=o.table(this.name)).supports("bulkDelete")?[4,a.bulkDelete(e)]:[3,3];case 2:return f.sent(),[2,e];case 3:f.trys.push([3,9,10,11]),s=(0,r.__values)(e),u=s.next(),f.label=4;case 4:return u.done?[3,8]:(c=u.value,[4,a.openCursor(c)]);case 5:return(l=f.sent())?[4,l.delete()]:[3,7];case 6:f.sent(),n.push(c),f.label=7;case 7:return u=s.next(),[3,4];case 8:return[3,11];case 9:return p=f.sent(),h={error:p},[3,11];case 10:try{u&&!u.done&&(d=s.return)&&d.call(s)}finally{if(h)throw h.error}return[7];case 11:return[2,n]}}))}))}))]}}))}))},e.prototype.patch=function(){var e=this.options.aspects;e.update.patch(this,"update"),e.clear.patch(this,"clear"),e.count.patch(this,"count"),e.entries.patch(this,"entries"),e.keys.patch(this,"keys"),e.values.patch(this,"values"),e.first.patch(this,"first"),e.last.patch(this,"last"),e.skip.patch(this,"skip"),e.take.patch(this,"take"),e.slice.patch(this,"slice"),e.orderBy.patch(this,"orderBy"),e.where.patch(this,"where"),e.or.patch(this,"or")},e}(),Fe=function(){function e(e,t){this.name=e,this.aspects=t.aspects,this.contextGenerator=t.contextGenerator,this.unsliced=new Ke(e,t),this.patch()}return e.prototype.skip=function(e){return this.unsliced.clone().skip(e)},e.prototype.take=function(e){return this.unsliced.clone().take(e)},e.prototype.slice=function(e,t){return this.unsliced.clone().slice(e,t)},e.prototype.orderBy=function(e,t){return this.unsliced.clone().orderBy(e,t)},e.prototype.where=function(e){return this.unsliced.clone().where(e)},e.prototype.or=function(e){return this.unsliced.clone().or(e)},e.prototype.update=function(e){return this.unsliced.update(e)},e.prototype.clear=function(){return this.unsliced.clear()},e.prototype.count=function(){return this.unsliced.count()},e.prototype.entries=function(){return this.unsliced.entries()},e.prototype.keys=function(){return this.unsliced.keys()},e.prototype.values=function(){return this.unsliced.values()},e.prototype.first=function(){return this.unsliced.first()},e.prototype.last=function(){return this.unsliced.last()},e.prototype.get=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){var n,o,a;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_ONLY)];case 1:return n=r.sent(),[4,t.waitForModelRegistered(this.name)];case 2:return o=r.sent(),[4,n.table(this.name).get(e)];case 3:return[2,(a=r.sent())?R(a,o.class):null]}}))}))}))]}))}))},e.prototype.has=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_ONLY)];case 1:return[4,n.sent().table(this.name).openCursor(e)];case 2:return[2,!!n.sent()]}}))}))}))]}))}))},e.prototype.delete=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){var n,o,a;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:return n=r.sent(),[4,(o=n.table(this.name)).openCursor(e)];case 2:return a=r.sent(),[4,o.delete(e)];case 3:return r.sent(),[2,a?e:null]}}))}))}))]}))}))},e.prototype.insert=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:return[4,n.sent().table(this.name).insert(M(e))];case 2:return[2,n.sent()]}}))}))}))]}))}))},e.prototype.upsert=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:return[4,n.sent().table(this.name).upsert(M(e))];case 2:return[2,n.sent()]}}))}))}))]}))}))},e.prototype.bulkInsert=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){var n,o,a,s,u,c,l,p,h,d;return(0,r.__generator)(this,(function(f){switch(f.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:n=f.sent(),o=[],a=n.table(this.name),f.label=2;case 2:f.trys.push([2,7,8,9]),s=(0,r.__values)(e),u=s.next(),f.label=3;case 3:return u.done?[3,6]:(c=u.value,[4,a.insert(M(c))]);case 4:l=f.sent(),o.push(l),f.label=5;case 5:return u=s.next(),[3,3];case 6:return[3,9];case 7:return p=f.sent(),h={error:p},[3,9];case 8:try{u&&!u.done&&(d=s.return)&&d.call(s)}finally{if(h)throw h.error}return[7];case 9:return[2,o]}}))}))}))]}))}))},e.prototype.bulkUpsert=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){var t,n=this;return(0,r.__generator)(this,(function(o){return[2,(t=this.contextGenerator.spawnContext()).perform((function(){return(0,r.__awaiter)(n,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.getTransaction([this.name],i.pF.READ_WRITE)];case 1:return[2,n.sent().table(this.name).bulkUpsert(e.map((function(e){return M(e)})))]}}))}))}))]}))}))},e.prototype.conditions=function(){return this.unsliced.conditions()},e.prototype.patch=function(){this.aspects.get.patch(this,"get"),this.aspects.has.patch(this,"has"),this.aspects.delete.patch(this,"delete"),this.aspects.insert.patch(this,"insert"),this.aspects.upsert.patch(this,"upsert"),this.aspects.bulkInsert.patch(this,"bulkInsert"),this.aspects.bulkUpsert.patch(this,"bulkUpsert")},e}(),Ue=Fe,Ve=function(){function e(e,t){this.collectionMap=new Map,this.storage=e,this.eventBus=t}return e.prototype.getCollection=function(e,t){if(this.collectionMap.has(e))return this.collectionMap.get(e);var n=this.createCollection(e,t);return this.collectionMap.set(e,n),this.eventBus.emit(T.CollectionCreated,{collectionName:e,context:t.spawnContext()}),n},e.prototype.createCollection=function(e,t){var n=this.storage.aspects.collection;return new Ue(e,{contextGenerator:t,aspects:n})},e}(),We=o.sH.withMessageCreator("UnexpectedModifierError",(function(e){return'unexpected error occurred at the "'+e+'" stage of the plugable function, there may be a bug in your modifiers.'})),Ge=o.sH.withMessageCreator("InvalidPatchedFunctionError",(function(e){return'patched target is not a function, patched key is "'+e+'"'}));!function(e){e.before="before",e.around="around",e.return="return",e.throw="throw",e.after="after",e.protect="protect"}(qe||(qe={}));var He=function(){function e(e){this.modifiers={before:[],around:[],return:[],throw:[],after:[],protect:[]},this.createContext=e}return e.prototype.before=function(e){return this.modifiers.before.push(e),this},e.prototype.around=function(e){return this.modifiers.around.push(e),this},e.prototype.throw=function(e){return this.modifiers.throw.push(e),this},e.prototype.return=function(e){return this.modifiers.return.push(e),this},e.prototype.after=function(e){return this.modifiers.after.push(e),this},e.prototype.protect=function(e){return this.modifiers.protect.push(e),this},e.prototype.patch=function(e,t){Object.defineProperty(e,t,{enumerable:!1,value:this.compile(e,t),writable:!0,configurable:!0})},e.prototype.dirty=function(){return Object.values(this.modifiers).some((function(e){return e.length}))},e.prototype.compile=function(e,t){var n=e[t];if("function"!==typeof n)throw new Ge(t);var r=this.invoke.bind(this);return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r(n,this,e)}},e}(),Qe=He,ze=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,r.__extends)(t,e),t.create=function(){return new t((function(){return{}}))},t.withContext=function(e){return new t(e)},t.prototype.invoke=function(e,t,n){var i;if(!this.dirty())return e.call.apply(e,(0,r.__spreadArray)([t],(0,r.__read)(n)));var o=Object.assign(this.createContext(),{args:n,this:t,callee:e,return:void 0,error:void 0});try{this.trigger(qe.before,o,this.modifiers.protect),this.modifiers.around.length?this.trigger(qe.around,o,this.modifiers.protect):o.return=(i=o.callee).call.apply(i,(0,r.__spreadArray)([o.this],(0,r.__read)(o.args))),this.trigger(qe.return,o,this.modifiers.protect)}catch(a){throw this.modifiers.throw.length&&(Object.assign(o,{error:a}),this.trigger(qe.throw,o,this.modifiers.protect)),a}finally{this.trigger(qe.after,o,this.modifiers.protect)}return o.return},t.prototype.trigger=function(e,t,n){var i,a,s,u;try{for(var c=(0,r.__values)(this.modifiers[e]),l=c.next();!l.done;l=c.next()){var p=l.value;try{p.call(t.this,t)}catch(v){if(!n.length){(0,o.ZK)(new We(e,v));continue}try{for(var h=(s=void 0,(0,r.__values)(n)),d=h.next();!d.done;d=h.next()){var f=d.value;Object.assign(t,{error:v}),f.call(t.this,t)}}catch(y){s={error:y}}finally{try{d&&!d.done&&(u=h.return)&&u.call(h)}finally{if(s)throw s.error}}}}}catch(g){i={error:g}}finally{try{l&&!l.done&&(a=c.return)&&a.call(c)}finally{if(i)throw i.error}}},t}(Qe),Ye=ze,Xe=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,r.__extends)(t,e),t.create=function(){return new t((function(){return{}}))},t.withContext=function(e){return new t(e)},t.prototype.invoke=function(e,t,n){var i=this;if(!this.dirty())return e.call.apply(e,(0,r.__spreadArray)([t],(0,r.__read)(n)));var o=Object.assign(this.createContext(),{args:n,this:t,callee:e,return:void 0,error:void 0});return new Promise((function(e,t){(0,r.__awaiter)(i,void 0,void 0,(function(){var e,t,n,i;return(0,r.__generator)(this,(function(a){switch(a.label){case 0:return a.trys.push([0,7,10,12]),[4,this.trigger(qe.before,o,this.modifiers.protect)];case 1:return a.sent(),this.modifiers.around.length?[3,3]:(e=(i=o.callee).call.apply(i,(0,r.__spreadArray)([o.this],(0,r.__read)(o.args))),t=o,[4,e]);case 2:return t.return=a.sent(),[3,5];case 3:return[4,this.trigger(qe.around,o,this.modifiers.protect)];case 4:a.sent(),a.label=5;case 5:return[4,this.trigger(qe.return,o,this.modifiers.protect)];case 6:return a.sent(),[3,12];case 7:return n=a.sent(),Object.assign(o,{error:n}),this.modifiers.throw.length?[4,this.trigger(qe.throw,o,this.modifiers.protect)]:[3,9];case 8:a.sent(),a.label=9;case 9:throw n;case 10:return[4,this.trigger(qe.after,o,this.modifiers.protect)];case 11:return a.sent(),[7];case 12:return[2]}}))})).then((function(){e(o.return)})).catch((function(e){t(e)}))}))},t.prototype.trigger=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,a,s,u,c,l,p,h,d,f,v,y,g;return(0,r.__generator)(this,(function(m){switch(m.label){case 0:m.trys.push([0,15,16,17]),i=(0,r.__values)(this.modifiers[e]),a=i.next(),m.label=1;case 1:if(a.done)return[3,14];s=a.value,m.label=2;case 2:return m.trys.push([2,4,,13]),[4,s.call(t.this,t)];case 3:return m.sent(),[3,13];case 4:if(u=m.sent(),!n.length)return(0,o.ZK)(new We(e,u)),[3,13];m.label=5;case 5:m.trys.push([5,10,11,12]),y=void 0,c=(0,r.__values)(n),l=c.next(),m.label=6;case 6:return l.done?[3,9]:(p=l.value,Object.assign(t,{error:u}),[4,p.call(t.this,t)]);case 7:m.sent(),m.label=8;case 8:return l=c.next(),[3,6];case 9:return[3,12];case 10:return h=m.sent(),y={error:h},[3,12];case 11:try{l&&!l.done&&(g=c.return)&&g.call(c)}finally{if(y)throw y.error}return[7];case 12:return[3,13];case 13:return a=i.next(),[3,1];case 14:return[3,17];case 15:return d=m.sent(),f={error:d},[3,17];case 16:try{a&&!a.done&&(v=i.return)&&v.call(i)}finally{if(f)throw f.error}return[7];case 17:return[2]}}))}))},t}(Qe),Je=Xe;function $e(){return{timings:new Map,counters:new Map,messages:new Map,errors:new Map,flags:new Map,data:new Map}}var Ze,et=function(){function e(e,t){this.storage=e,this.eventBus=t,this.plugins=[]}return e.prototype.add=function(){for(var e,t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];try{for(var o=(0,r.__values)(n),a=o.next();!a.done;a=o.next()){var s=a.value;this.plugins.push(s),s.register(this.storage),this.eventBus.emit(k.RegisterPlugin,s)}}catch(u){e={error:u}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}},e}(),tt=et,nt=o.sH.withMessageCreator("UnexpectedOutsideMigrationActionError",(function(e){return e+" outside ensure(callback) is not allowed, please wrap your migration actions inside a ensure callback"})),rt=function(){function e(e,t){this.name=e,this.context=t}return e.create=function(t){return{index:function(n){return new e(n,t)}}},e.prototype.create=function(e){var t=this.context.scope.collection;if(!t)throw new nt("CreateIndex");return this.context.actions.schema.push({type:i.g6.CreateIndex,name:this.name,attributes:(0,r.__assign)({},e),collection:t}),this},e.prototype.drop=function(){var e=this.context.scope.collection;if(!e)throw new nt("DropIndex");this.context.actions.schema.push({type:i.g6.DropIndex,name:this.name,collection:e})},e.prototype.alter=function(e){var t=this.context.scope.collection;if(!t)throw new nt("AlterIndex");return this.context.actions.schema.push({type:i.g6.DropIndex,name:this.name,collection:t},{type:i.g6.CreateIndex,name:this.name,attributes:(0,r.__assign)({},e),collection:t}),this},e.prototype.rename=function(e){var t=this.context.scope.collection;if(!t)throw new nt("RenameIndex");this.context.actions.schema.push({type:i.g6.DropIndex,name:this.name,collection:t},{type:i.g6.CreateIndex,name:e,attributes:{path:""},collection:t})},e.prototype.ensure=function(){throw new o.zF},e}(),it=function(){function e(e,t){this.name=e,this.context=t}return e.create=function(t){return{collection:function(n){return new e(n,t)}}},e.prototype.create=function(e){return this.context.actions.schema.push({type:i.g6.CreateCollection,name:this.name,attributes:(0,r.__assign)({},e)}),this},e.prototype.drop=function(){this.context.actions.schema.push({type:i.g6.DropCollection,name:this.name})},e.prototype.alter=function(e){return this.context.actions.schema.push({type:i.g6.DropCollection,name:this.name},{type:i.g6.CreateCollection,name:this.name,attributes:(0,r.__assign)({},e)}),this},e.prototype.rename=function(e){this.context.actions.schema.push({type:i.g6.DropCollection,name:this.name},{type:i.g6.CreateCollection,name:e,attributes:{key:{generator:i.uZ.AutoIncrement},properties:[]}})},e.prototype.ensure=function(e){var t=this.context,n=(0,r.__assign)({},rt.create(t));this.context.scope.collection=this.name,e(n),this.context.scope.collection=null},e}(),ot=function(){function e(){this.context={actions:{schema:[],data:[]},scope:{database:null,collection:null}},this.builder=it.create(this.context)}return e.prototype.init=function(e){this.state=e,this.build()},e.prototype.plan=function(){return this.context.actions.schema.length||this.context.actions.data.length?[{schema:{actions:this.context.actions.schema.slice()},data:{actions:this.context.actions.data.slice()}}]:[]},e.prototype.handleDropCollection=function(e){var t,n;try{for(var i=(0,r.__values)(e),o=i.next();!o.done;o=i.next()){var a=o.value;this.builder.collection(a.name).drop()}}catch(s){t={error:s}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},e.prototype.handleCreateCollection=function(e){var t,n,i=function(e){o.builder.collection(e.name).create(e).ensure((function(t){var n,i;try{for(var o=(n=void 0,(0,r.__values)(e.indices)),a=o.next();!a.done;a=o.next()){var s=a.value;t.index(s.name).create(s)}}catch(u){n={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}}))},o=this;try{for(var a=(0,r.__values)(e),s=a.next();!s.done;s=a.next())i(s.value)}catch(u){t={error:u}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},e.prototype.handleIndexChange=function(e){var t,n,i=function(e){o.builder.collection(e.collection).ensure((function(t){var n,i,o,a,s,u;try{for(var c=(n=void 0,(0,r.__values)((null===(s=e.index)||void 0===s?void 0:s.added)||[])),l=c.next();!l.done;l=c.next()){var p=l.value;t.index(p.name).create(p)}}catch(f){n={error:f}}finally{try{l&&!l.done&&(i=c.return)&&i.call(c)}finally{if(n)throw n.error}}try{for(var h=(o=void 0,(0,r.__values)((null===(u=e.index)||void 0===u?void 0:u.deleted)||[])),d=h.next();!d.done;d=h.next())p=d.value,t.index(p.name).drop()}catch(v){o={error:v}}finally{try{d&&!d.done&&(a=h.return)&&a.call(h)}finally{if(o)throw o.error}}}))},o=this;try{for(var a=(0,r.__values)(e),s=a.next();!s.done;s=a.next())i(s.value)}catch(u){t={error:u}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},e.prototype.build=function(){if(!this.state)throw new Error("Migration state is undefined, must init before!");var e=this.state.schema,t=e.expect,n=e.actual,r=i.Ze.databaseDiff(n,t);this.handleCreateCollection(r.added),this.handleDropCollection(r.deleted),this.handleIndexChange(r.different)},e}(),at=i.O3.name;!function(e){e.SYSTEM_TABLE="system_table",e.SCAN_EXISTING_TABLE="scan_exists_table"}(Ze||(Ze={}));var st=function(){function e(){}return e.hasSystemTable=function(e){return e.tableNames.includes(at)},e.getDatabaseSchema=function(t,n,o){return(0,r.__awaiter)(this,void 0,void 0,(function(){var a,s,u,c,l;return(0,r.__generator)(this,(function(p){switch(p.label){case 0:return[4,n.openDB(t,{name:t,collections:[i.O3]})];case 1:a=p.sent(),s=!1,p.label=2;case 2:return p.trys.push([2,,10,11]),a.tableNames.length?[3,4]:(a.close(),s=!0,[4,n.deleteDB(t)]);case 3:return p.sent(),[2,{schema:{name:this.name,version:0,collections:[]},from:"scan_exists_table"}];case 4:return this.hasSystemTable(a)?[3,6]:[4,e.getDatabaseSchemaByScanningTableStructure(o.collections.map((function(e){return e.name})),a)];case 5:return[2,{schema:p.sent(),from:"scan_exists_table"}];case 6:return[4,a.transaction([at],i.pF.READ_ONLY)];case 7:return[4,(u=p.sent()).table(at).getAll()];case 8:return c=p.sent()||[],l={name:this.name,version:a.version,collections:(0,r.__spreadArray)((0,r.__spreadArray)([],(0,r.__read)(c)),[this.getSystemTableSchema()])},[4,u.commit()];case 9:return p.sent(),[2,{schema:l,from:"system_table"}];case 10:return s||a.close(),[7];case 11:return[2]}}))}))},e.getSystemTableSchema=function(){return i.O3},e.updateSchemaChange=function(e,t,n,o){return(0,r.__awaiter)(this,void 0,void 0,(function(){var a,s,u,c,l,p,h,d,f,v,g,m,b,_,w,x,E,A,C,S,I,k,T;return(0,r.__generator)(this,(function(D){switch(D.label){case 0:return a=t.table(at),o?[4,a.bulkUpsert(n.schema.expect.collections.filter((function(e){return e.name!==at})))]:[3,2];case 1:return D.sent(),[2];case 2:D.trys.push([2,27,,29]),s=i.Ze.databaseDiff(n.schema.actual,n.schema.expect),u=s.added.filter((function(e){return e.name!==at})),D.label=3;case 3:D.trys.push([3,8,9,10]),c=(0,r.__values)(u),l=c.next(),D.label=4;case 4:return l.done?[3,7]:((f=l.value).dataVersion=e,[4,a.upsert(f)]);case 5:D.sent(),D.label=6;case 6:return l=c.next(),[3,4];case 7:return[3,10];case 8:return p=D.sent(),A={error:p},[3,10];case 9:try{l&&!l.done&&(C=c.return)&&C.call(c)}finally{if(A)throw A.error}return[7];case 10:D.trys.push([10,15,16,17]),h=(0,r.__values)(s.deleted),d=h.next(),D.label=11;case 11:return d.done?[3,14]:(f=d.value,[4,a.delete(f.name)]);case 12:D.sent(),D.label=13;case 13:return d=h.next(),[3,11];case 14:return[3,17];case 15:return v=D.sent(),S={error:v},[3,17];case 16:try{d&&!d.done&&(I=h.return)&&I.call(h)}finally{if(S)throw S.error}return[7];case 17:g=s.different.filter((function(e){return!!e.index})),m=function(e){var t,n,i;return(0,r.__generator)(this,(function(o){switch(o.label){case 0:return[4,a.get(e.collection)];case 1:return t=o.sent(),n=[],i=t.indices.filter((function(t){return!e.index.deleted.some((function(e){return e.name===t.name}))})),n.push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(e.index.added))),n.push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(i))),t.index=n,[4,a.upsert(t)];case 2:return o.sent(),[2]}}))},D.label=18;case 18:D.trys.push([18,23,24,25]),b=(0,r.__values)(g),_=b.next(),D.label=19;case 19:return _.done?[3,22]:(w=_.value,[5,m(w)]);case 20:D.sent(),D.label=21;case 21:return _=b.next(),[3,19];case 22:return[3,25];case 23:return x=D.sent(),k={error:x},[3,25];case 24:try{_&&!_.done&&(T=b.return)&&T.call(b)}finally{if(k)throw k.error}return[7];case 25:return[4,t.commit()];case 26:if(!D.sent())throw new y;return[3,29];case 27:return E=D.sent(),[4,t.rollback()];case 28:throw D.sent(),E;case 29:return[2]}}))}))},e.updateCollectionDataVersion=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o,a;return(0,r.__generator)(this,(function(s){switch(s.label){case 0:return[4,(i=t.table(at)).get(x.getTableName(n))];case 1:if(o=s.sent(),a=x.getTableInfo(n.prototype),!o)throw new Error("get target table system info error!");if(!a)throw new l(n.name);return o.dataVersion=e,o.properties=(0,r.__spreadArray)([],(0,r.__read)(a.properties.values())).map((function(e){return e.name})),[4,i.upsert(o)];case 2:return s.sent(),[2]}}))}))},e.getTableDataVersion=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return[4,t.table(at).get(e)];case 1:return[2,n.sent().dataVersion]}}))}))},e.getDatabaseSchemaByScanningTableStructure=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){var n,o,a,s,u,c,l,p,h,d,f,v,y,g,m,b;return(0,r.__generator)(this,(function(_){switch(_.label){case 0:n=t.tableNames.filter((function(t){return e.includes(t)})),o=[],_.label=1;case 1:_.trys.push([1,6,7,8]),a=(0,r.__values)(n),s=a.next(),_.label=2;case 2:return s.done?[3,5]:(u=s.value,[4,t.table(u,i.pF.READ_ONLY)]);case 3:c=_.sent(),l={name:u,key:c.autoIncrement?{generator:i.uZ.AutoIncrement}:{path:c.keyPath},indices:[],properties:[]};try{for(m=void 0,p=(0,r.__values)(c.indexNames),h=p.next();!h.done;h=p.next())d=h.value,f=c.index(d),l.indices.push({name:d,path:f.keyPath,unique:f.unique})}catch(w){m={error:w}}finally{try{h&&!h.done&&(b=p.return)&&b.call(p)}finally{if(m)throw m.error}}o.push(l),_.label=4;case 4:return s=a.next(),[3,2];case 5:return[3,8];case 6:return v=_.sent(),y={error:v},[3,8];case 7:try{s&&!s.done&&(g=a.return)&&g.call(a)}finally{if(y)throw y.error}return[7];case 8:return[2,{name:t.name,version:t.version,collections:o}]}}))}))},e}(),ut=function(){function e(e){this.schemaActionHandlerMap=new Map,this.dataActionHandlerMap=new Map,this.schemaActionHandlerMap.set(i.g6.CreateCollection,this.performCreateCollectionAction.bind(this)),this.schemaActionHandlerMap.set(i.g6.DropCollection,this.performDropCollectionAction.bind(this)),this.schemaActionHandlerMap.set(i.g6.CreateIndex,this.performCreateIndexAction.bind(this)),this.schemaActionHandlerMap.set(i.g6.DropIndex,this.performDropIndexAction.bind(this)),this.dataActionHandlerMap.set(i.cg.DropProperty,this.performDropPropertyAction.bind(this)),this.dataActionHandlerMap.set(i.cg.ClearData,this.performClearDataAction.bind(this)),this.dataActionHandlerMap.set(i.cg.ReplaceData,this.performReplaceDataAction.bind(this)),e.executeDataAction.patch(this,"executeDataAction"),e.executeSchemaAction.patch(this,"executeSchemaAction")}return e.prototype.executeSchemaAction=function(e,t,n){var r=this.schemaActionHandlerMap.get(n.type);if(r){if(t.mode!==i.pF.VERSION_CHANGE)throw new c(n.type);return r(e,t,n)}},e.prototype.executeDataAction=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var i;return(0,r.__generator)(this,(function(r){return(i=this.dataActionHandlerMap.get(n.type))?[2,i(e,t,n)]:[2]}))}))},e.prototype.performCreateIndexAction=function(e,t,n){t.table(n.collection).createIndex(n.name,n.attributes.path,{unique:n.attributes.unique})},e.prototype.performDropIndexAction=function(e,t,n){t.table(n.collection).deleteIndex(n.name)},e.prototype.performDropCollectionAction=function(e,t,n){e.deleteTable(n.name)},e.prototype.performCreateCollectionAction=function(e,t,n){var r,o;e.createTable(n.name,{keyPath:null===(r=n.attributes.key)||void 0===r?void 0:r.path,autoIncrement:(null===(o=n.attributes.key)||void 0===o?void 0:o.generator)===i.uZ.AutoIncrement})},e.prototype.performClearDataAction=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,i;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return e=t.table(n.collection),n.filter?[3,2]:[4,e.clear()];case 1:return r.sent(),[2];case 2:return[4,e.openCursor()];case 3:i=r.sent(),r.label=4;case 4:return i?n.filter(i.value())?[4,i.delete()]:[3,6]:[3,8];case 5:r.sent(),r.label=6;case 6:return[4,i.next()];case 7:return i=r.sent(),[3,4];case 8:return[2]}}))}))},e.prototype.performDropPropertyAction=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,i;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.table(n.collection).openCursor()];case 1:e=r.sent(),r.label=2;case 2:return e?((i=e.value())[n.path]=void 0,[4,e.update(i)]):[3,5];case 3:return r.sent(),[4,e.next()];case 4:return e=r.sent(),[3,2];case 5:return[2]}}))}))},e.prototype.performReplaceDataAction=function(e,t,n){var i;return(0,r.__awaiter)(this,void 0,void 0,(function(){var e,o;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,t.table(n.collection).openCursor()];case 1:e=r.sent(),r.label=2;case 2:return e?(o=e.value(),n.filter&&!(null===(i=n.filter)||void 0===i?void 0:i.call(this,o))?[3,4]:[4,e.update(n.replacer(o))]):[3,6];case 3:r.sent(),r.label=4;case 4:return[4,e.next()];case 5:return e=r.sent(),[3,2];case 6:return[2]}}))}))},e}(),ct=function(){function e(e){this.collection=e,this.versionActionsMap=new Map}return e.prototype.getVersionActionsMap=function(){return this.versionActionsMap},e.prototype.version=function(e){var t=this,n={update:function(r){return t.pushAction(e,{type:i.cg.ReplaceData,replacer:r,collection:t.collection}),n},delete:function(r){return t.pushAction(e,{filter:r,type:i.cg.ClearData,collection:t.collection}),n}};return n},e.prototype.pushAction=function(e,t){var n=this.versionActionsMap.get(e)||[];n.push(t),this.versionActionsMap.set(e,n)},e}(),lt=function(){function e(e,t,n){this.expectedSchema=e,this.actualSchema=t,this.modelClass=n}return e.prototype.plan=function(){var e=this.actualSchema.dataVersion||0,t=this.expectedSchema.dataVersion||1;if(e===t)return[];var n=[],i=this.getManualMigrationActions(e,t);n.push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(i)));var o=this.getAutoMigrationActions();return n.push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(o))),[{schema:{actions:[]},data:{actions:n}}]},e.prototype.getManualMigrationActions=function(e,t){var n,r,i=new ct(x.getTableName(this.modelClass));return null===(r=(n=this.modelClass).onDataUpgrade)||void 0===r||r.call(n,e,t,i),this.getRangeDataAction(e,t,i.getVersionActionsMap())},e.prototype.getAutoMigrationActions=function(){var e,t,n=this,o=[],a=this.actualSchema.properties.filter((function(e){return!n.expectedSchema.properties.includes(e)}));try{for(var s=(0,r.__values)(a),u=s.next();!u.done;u=s.next()){var c=u.value;o.push({type:i.cg.DropProperty,collection:x.getTableName(this.modelClass),path:c})}}catch(l){e={error:l}}finally{try{u&&!u.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}return o},e.prototype.getRangeDataAction=function(e,t,n){for(var i=[],o=e;o<=t;o++)i.push.apply(i,(0,r.__spreadArray)([],(0,r.__read)(n.get(o)||[])));return i},e}(),pt=function(){function e(e){this.migrationManager=e,this.upgradedFlag=new Map}return e.prototype.executeDataUpgrade=function(e,t,n,i){return void 0===i&&(i=function(){}),(0,r.__awaiter)(this,void 0,void 0,(function(){var o,a;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return o=x.getTableName(e),this.upgradedFlag.get(o)?[2]:(a=this.getCollectionSchema(o,n),this.isNeedExecuteDataUpgrade(a.expect,a.actual)?[4,this.executeUpgrade(o,t,n,a.expect,a.actual,e)]:(this.upgradedFlag.set(o,!0),[2,i()]));case 1:return r.sent(),this.upgradedFlag.set(o,!0),[2,i()]}}))}))},e.prototype.isNeedExecuteDataUpgrade=function(e,t){return!(!(null===t||void 0===t?void 0:t.dataVersion)||e.dataVersion===t.dataVersion)},e.prototype.executeUpgrade=function(e,t,n,o,a,s){return(0,r.__awaiter)(this,void 0,void 0,(function(){var c,l,p,h,d,f;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return c=new lt(o,a,s),this.migrationManager.use(c),l=this.migrationManager.buildMigration(n),[4,t.transaction([e,st.getSystemTableSchema().name],i.pF.READ_WRITE)];case 1:p=r.sent(),h=!1,r.label=2;case 2:return r.trys.push([2,6,8,11]),d=n.schema.expect.version||1,[4,st.getTableDataVersion(x.getTableName(s),p)];case 3:return r.sent()===d?[2]:[4,this.migrationManager.executeDataMigration(t,l,p)];case 4:return r.sent(),[4,st.updateCollectionDataVersion(d,p,s)];case 5:return r.sent(),[3,11];case 6:return f=r.sent(),h=!0,[4,p.rollback()];case 7:throw r.sent(),new u({oldVersion:a.dataVersion,newVersion:o.dataVersion},f);case 8:return h?[3,10]:[4,p.commit()];case 9:r.sent(),r.label=10;case 10:return[7];case 11:return[2]}}))}))},e.prototype.getCollectionSchema=function(e,t){var n=t.schema,r=n.expect,i=n.actual,o=r.collections.filter((function(t){return t.name===e})),a=i.collections.filter((function(t){return t.name===e}));if(1!==o.length)throw new s(e);return{expect:o[0],actual:a.length?a[0]:void 0}},e}(),ht=function(){function e(e,t,n){var i=this;this.planner=new ot,this.actualDBSchema=null,this.actualDBSchemaFrom=null,this.lazyMigrationProcessor=new pt(this),this.handleCollectionCreated=function(e){var t=e.collectionName,n=e.context;i.safeExecuteDataUpgrade(n,t)},this.handleStartTransaction=function(e){var t,n,o=e.collectionNames,a=e.context;try{for(var s=(0,r.__values)(o),u=s.next();!u.done;u=s.next()){var c=u.value;i.safeExecuteDataUpgrade(a,c)}}catch(l){t={error:l}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}},this.eventBus=e,this.eventBus.on(T.CollectionCreated,this.handleCollectionCreated),this.eventBus.on(T.StartTransaction,this.handleStartTransaction),this.schemaProvider=t,this.actionExecutor=new ut(n.actionExecutor),this.applyAspectPatch(n)}return e.prototype.use=function(e){this.planner=e},e.prototype.prepareAutoUpgradeHandler=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){var n,i,o,a,s,u=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return n=this.schemaProvider.getDatabaseSchema(),[4,st.getDatabaseSchema(e,t,n)];case 1:return i=r.sent(),o=i.schema,a=i.from,this.actualDBSchema=o,this.actualDBSchemaFrom=a,this.log("getDatabaseSchema",this.actualDBSchema),s=this.buildMigration({schema:{expect:n,actual:this.actualDBSchema}}),[2,function(e,t,n,r){u.eventBus.emit(k.SchemaMigrationStart),u.executeSchemaMigration(e,s,r),u.updateMigrationChangeInfo(r).catch((function(e){u.emitError(new g(e))})),u.eventBus.emit(k.SchemaMigrationEnd)}]}}))}))},e.prototype.buildMigration=function(e){var t,n,r,i,o,a,s=e.schema,u=s.actual,c=s.expect;null===(n=null===(t=this.planner)||void 0===t?void 0:t.init)||void 0===n||n.call(t,e);var l=null!==(r=u.version)&&void 0!==r?r:0,p=null!==(i=c.version)&&void 0!==i?i:1;return null!==(a=null===(o=this.planner)||void 0===o?void 0:o.plan(l,p))&&void 0!==a?a:[]},e.prototype.executeSchemaMigration=function(e,t,n){var i,o,a,s;if(t)try{for(var u=(0,r.__values)(t),c=u.next();!c.done;c=u.next()){var l=c.value;try{for(var p=(a=void 0,(0,r.__values)(l.schema.actions)),h=p.next();!h.done;h=p.next()){var d=h.value;this.actionExecutor.executeSchemaAction(e,n,d)}}catch(f){a={error:f}}finally{try{h&&!h.done&&(s=p.return)&&s.call(p)}finally{if(a)throw a.error}}}}catch(v){i={error:v}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(i)throw i.error}}},e.prototype.executeDataMigration=function(e,t,n){return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o,a,s,u,c,l,p,h,d,f,v;return(0,r.__generator)(this,(function(y){switch(y.label){case 0:if(!t)return[2];y.label=1;case 1:y.trys.push([1,12,13,14]),i=(0,r.__values)(t),o=i.next(),y.label=2;case 2:if(o.done)return[3,11];a=o.value,y.label=3;case 3:y.trys.push([3,8,9,10]),f=void 0,s=(0,r.__values)(a.data.actions),u=s.next(),y.label=4;case 4:return u.done?[3,7]:(c=u.value,[4,this.actionExecutor.executeDataAction(e,n,c)]);case 5:y.sent(),y.label=6;case 6:return u=s.next(),[3,4];case 7:return[3,10];case 8:return l=y.sent(),f={error:l},[3,10];case 9:try{u&&!u.done&&(v=s.return)&&v.call(s)}finally{if(f)throw f.error}return[7];case 10:return o=i.next(),[3,2];case 11:return[3,14];case 12:return p=y.sent(),h={error:p},[3,14];case 13:try{o&&!o.done&&(d=i.return)&&d.call(i)}finally{if(h)throw h.error}return[7];case 14:return[2]}}))}))},e.prototype.updateMigrationChangeInfo=function(e){var t,n;return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o;return(0,r.__generator)(this,(function(r){return i=this.schemaProvider.getDatabaseSchema(),o=null!==(t=i.version)&&void 0!==t?t:1,[2,st.updateSchemaChange(o,e,{schema:{expect:i,actual:null!==(n=this.actualDBSchema)&&void 0!==n?n:{name:i.name,collections:[]}}},"scan_exists_table"===this.actualDBSchemaFrom)]}))}))},e.prototype.log=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n]},e.prototype.executeDataUpgradeIfNeed=function(e,t){var n;return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o,a=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return this.log("executeDataUpgradeIfNeed",e.name),i=this.schemaProvider.getDatabaseSchema(),o={name:i.name,collections:[]},[4,this.lazyMigrationProcessor.executeDataUpgrade(e,t,{schema:{expect:i,actual:null!==(n=this.actualDBSchema)&&void 0!==n?n:o}},(function(){a.eventBus.emit(T.ModelLazyMigrationEnd,x.getTableName(e))}))];case 1:return r.sent(),[2]}}))}))},e.prototype.safeExecuteDataUpgrade=function(e,t){var n=this;Promise.all([e.waitForModelRegistered(t),e.waitForDBReady()]).then((function(e){var i=(0,r.__read)(e,2),o=i[0],a=i[1];n.executeDataUpgradeIfNeed(o.class,a).catch((function(e){n.emitError(new m(t,e))}))})).catch((function(){}))},e.prototype.emitError=function(e){this.eventBus.emit(k.Error,e)},e.prototype.applyAspectPatch=function(e){e.buildMigration.patch(this,"buildMigration"),e.executeDataMigration.patch(this,"executeDataMigration"),e.executeSchemaMigration.patch(this,"executeSchemaMigration"),e.prepareAutoUpgradeHandler.patch(this,"prepareAutoUpgradeHandler"),e.log.patch(this,"log"),e.updateMigrationChangeInfo.patch(this,"updateMigrationChangeInfo")},e}(),dt=ht,ft=function(){var e;return{lock:function(t){return e||(e=t()),e.finally((function(){e=void 0}))}}},vt=function(){function e(e,t){var n,i=this;if(this.openingMutex=ft(),this.closingMutex=ft(),this.destroyingMutex=ft(),this.openDatabase=function(){return(0,r.__awaiter)(i,void 0,void 0,(function(){var e=this;return(0,r.__generator)(this,(function(t){return[2,this.openingMutex.lock((function(){return(0,r.__awaiter)(e,void 0,void 0,(function(){var e,t,n,i,o,s,u,c,l,p,h,d=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:if(this.db)return[2];e=this.storage,t=e.name,n=e.version,r.label=1;case 1:return r.trys.push([1,4,,5]),this.eventBus.emit(k.BootstrapStart),i=this.getDatabaseSchema(),o=this,u=(s=this.engine).openDB,c=[t,i,n],h={},[4,this.migrationManager.prepareAutoUpgradeHandler(t,this.engine)];case 2:return[4,u.apply(s,c.concat([(h.upgrade=r.sent(),h.terminated=function(){d.eventBus.emit(k.Fetal,new b(t))},h)]))];case 3:return o.db=r.sent(),this.db.setVersionChangeListener((function(e,t){d.eventBus.emit(k.VersionChange,{oldVersion:e,newVersion:t})})),this.eventBus.emit(k.BootstrapEnd),this.eventBus.emit(k.Ready,this.db),[3,5];case 4:throw l=r.sent(),this.reset(),p=new a(t,l),this.eventBus.emit(k.Error,p),this.eventBus.emit(k.Fetal,p),p;case 5:return[2]}}))}))}))]}))}))},this.handleModelRegistered=function(e){if(!i.schemas.some((function(t){return t.name===e.schema.name}))){var t=e.schema;t.dataVersion=i.storage.version,i.schemas.push(t)}},this.handleFetal=function(){i.reset()},this.storage=e,this.engine=t.engine,this.eventBus=t.eventBus,this.engine.setAspects(e.aspects.engine),this.schemas=[st.getSystemTableSchema()],t.databaseSchema){var o=JSON.parse(t.databaseSchema).collections.map((function(e){return(0,r.__assign)((0,r.__assign)({},e),{dataVersion:i.storage.version})}));(n=this.schemas).push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(o)))}this.migrationManager=new dt(this.eventBus,this,e.aspects.migration),this.eventBus.on(k.RegisterModel,this.handleModelRegistered),this.eventBus.on(k.Fetal,this.handleFetal)}return e.prototype.getDatabaseEngine=function(){return this.engine},e.prototype.getDatabaseSchema=function(){if(!this.storage.name||!this.storage.version)throw new Error("The database name and version are required for generating dbSchema");return{name:this.storage.name,version:this.storage.version,collections:this.schemas}},e.prototype.closeDatabase=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){var e=this;return(0,r.__generator)(this,(function(t){return[2,this.closingMutex.lock((function(){return(0,r.__awaiter)(e,void 0,void 0,(function(){return(0,r.__generator)(this,(function(e){switch(e.label){case 0:return this.db?[4,this.db.close()]:[2];case 1:return e.sent(),this.reset(),this.eventBus.emit(k.Closed),[2]}}))}))}))]}))}))},e.prototype.destroyDatabase=function(){var e=this;return this.destroyingMutex.lock((function(){return(0,r.__awaiter)(e,void 0,void 0,(function(){return(0,r.__generator)(this,(function(e){switch(e.label){case 0:return[4,this.engine.deleteDB(this.storage.name)];case 1:return e.sent(),this.reset(),this.eventBus.emit(k.Destroyed),[2]}}))}))}))},e.prototype.reset=function(){this.db=void 0},e}(),yt=vt,gt=function(e){return setTimeout(e)},mt=function(){function e(e){var t=e.keepActive,n=e.comparer,r=e.channelDB,i=e.channelModel,o=e.channelLazyMigration;this.keepActive=t,this.comparer=n,this.channelDB=r,this.channelModel=i,this.channelLazyMigration=o}return e.fromTransactionManager=function(t,n){return void 0===n&&(n=!1),new e({keepActive:n,comparer:t.comparer,channelDB:t.channelDB,channelModel:t.channelModel,channelLazyMigration:t.channelLazyMigration})},e.prototype.openTransaction=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){var n=this;return(0,r.__generator)(this,(function(i){return this.transactionPromise=(0,r.__awaiter)(n,void 0,void 0,(function(){var n,i,o=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return[4,Promise.all(e.map((function(e){return o.waitForModelRegistered(e)})))];case 1:return r.sent(),[4,Promise.all(e.map((function(e){return o.waitForMigrationReady(e)})))];case 2:return r.sent(),[4,this.waitForDBReady()];case 3:return n=r.sent(),i=this,[4,n.transaction(e,t)];case 4:return i.transaction=r.sent(),[2,this.transaction]}}))})),[2,this.transactionPromise]}))}))},e.prototype.getTransaction=function(e,t){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(n){switch(n.label){case 0:return this.transactionPromise?[3,2]:[4,this.openTransaction(e,t)];case 1:n.sent(),n.label=2;case 2:return[4,this.transactionPromise];case 3:return[2,n.sent()]}}))}))},e.prototype.waitForDBReady=function(){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(e){return[2,this.channelDB.pick()]}))}))},e.prototype.waitForModelRegistered=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,this.channelModel.pick(e)]}))}))},e.prototype.waitForMigrationReady=function(e){return(0,r.__awaiter)(this,void 0,void 0,(function(){return(0,r.__generator)(this,(function(t){return[2,this.channelLazyMigration.pick(e)]}))}))},e.prototype.perform=function(e){return this.keepActive?e():this.autoCommitOrRollback(e)},e.prototype.autoCommitOrRollback=function(e){var t,n;return(0,r.__awaiter)(this,void 0,void 0,(function(){var i,o;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,5]),[4,e()];case 1:return i=r.sent(),[4,null===(t=this.transaction)||void 0===t?void 0:t.commit()];case 2:return r.sent(),[2,i];case 3:return o=r.sent(),[4,null===(n=this.transaction)||void 0===n?void 0:n.rollback()];case 4:throw r.sent(),o;case 5:return[2]}}))}))},e}(),bt=Symbol("channel"),_t=function(e){var t;void 0===e&&(e=function(){return bt});var n=new Map,i=new Map;function o(e,t){var n;null===(n=i.get(e))||void 0===n||n.reject(t),i.delete(e)}function a(e,t){void 0===t&&(t=bt),i.has(t)?function(e,t){var n;null===(n=i.get(e))||void 0===n||n.resolve(t),i.delete(e)}(t,e):n.set(t,Promise.resolve(e))}return{send:function(n){t||a(n,e(n))},pick:function(e){return void 0===e&&(e=bt),t?Promise.reject(t):(n.has(e)||n.set(e,new Promise((function(t,n){i.set(e,{resolve:t,reject:n})}))),n.get(e))},open:function(){t=void 0},close:function(e,a){var s,u;void 0===a&&(a=!1),t=e;try{for(var c=(0,r.__values)(i.keys()),l=c.next();!l.done;l=c.next())o(l.value,e)}catch(p){s={error:p}}finally{try{l&&!l.done&&(u=c.return)&&u.call(c)}finally{if(s)throw s.error}}a&&(n.clear(),i.clear())}}},wt=function(){function e(e,t){var n=this;this.handleFetalError=function(e){n.channelDB.close(e,!0),n.channelModel.close(e),n.channelLazyMigration.close(e)},this.eventBus=e,this.channelDB=_t(),this.channelModel=_t((function(e){return e.schema.name})),this.channelLazyMigration=_t((function(e){return e})),this.comparer=t,this.eventBus.on(k.Fetal,this.handleFetalError),this.eventBus.on(k.Ready,this.channelDB.send),this.eventBus.on(k.RegisterModel,this.channelModel.send),this.eventBus.on(T.ModelLazyMigrationEnd,this.channelLazyMigration.send)}return e.prototype.spawnAutoCommitContext=function(){return mt.fromTransactionManager(this,!1)},e.prototype.spawnKeepAliveContext=function(){return mt.fromTransactionManager(this,!0)},e.prototype.openChannels=function(){this.channelDB.open(),this.channelModel.open(),this.channelLazyMigration.open()},e}(),xt=function(){function e(e){var t,n=this,i=e.name,o=e.engine,a=e.version,s=void 0===a?1:a,u=e.plugins,c=void 0===u?[]:u,l=e.disableAutoOpen,p=void 0!==l&&l,h=e.databaseSchema;this.aspects={collection:{get:Je.withContext($e),has:Je.withContext($e),delete:Je.withContext($e),insert:Je.withContext($e),upsert:Je.withContext($e),bulkInsert:Je.withContext($e),bulkUpsert:Je.withContext($e),update:Je.withContext($e),clear:Je.withContext($e),count:Je.withContext($e),entries:Je.withContext($e),keys:Je.withContext($e),values:Je.withContext($e),first:Je.withContext($e),last:Je.withContext($e),skip:Ye.withContext($e),take:Ye.withContext($e),slice:Ye.withContext($e),orderBy:Ye.withContext($e),where:Ye.withContext($e),or:Ye.withContext($e)},query:{},model:{},migration:{prepareAutoUpgradeHandler:Je.withContext($e),buildMigration:Ye.withContext($e),executeDataMigration:Je.withContext($e),executeSchemaMigration:Ye.withContext($e),updateMigrationChangeInfo:Je.withContext($e),log:Ye.withContext($e),actionExecutor:{executeSchemaAction:Ye.withContext($e),executeDataAction:Je.withContext($e)}},engine:{deleteDB:Je.withContext($e),openDB:Je.withContext($e),database:{createTable:Ye.withContext($e),deleteTable:Ye.withContext($e),close:Ye.withContext($e),table:Je.withContext($e),transaction:Je.withContext($e)},table:{createIndex:Je.withContext($e),deleteIndex:Je.withContext($e),delete:Je.withContext($e),get:Je.withContext($e),getAll:Je.withContext($e),getAllKeys:Je.withContext($e),index:Ye.withContext($e),insert:Je.withContext($e),query:Je.withContext($e),openCursor:Je.withContext($e),upsert:Je.withContext($e),bulkUpsert:Je.withContext($e),clear:Je.withContext($e),bulkDelete:Je.withContext($e)},index:{get:Je.withContext($e),getAll:Je.withContext($e),getAllKeys:Je.withContext($e),openCursor:Je.withContext($e)},cursor:{delete:Je.withContext($e),update:Je.withContext($e),next:Je.withContext($e),value:Ye.withContext($e)},transaction:{commit:Je.withContext($e),rollback:Je.withContext($e),table:Ye.withContext($e)}}},this.eventBus=I(),this.open=function(){return n.transactionManager.openChannels(),n.databaseManager.openDatabase()},this.close=function(){return n.databaseManager.closeDatabase()},this.destroy=function(){return n.databaseManager.destroyDatabase()},this.register=function(e){n.modelManager.register(e)},this.collection=function(e){var t=n.modelManager.getSchemaAndRegisterModelIfNeed(e);return n.collectionManager.getCollection(t.name,{spawnContext:function(){return n.transactionManager.spawnAutoCommitContext()}})},this.transaction=function(e,t,i){return(0,r.__awaiter)(n,void 0,void 0,(function(){var n,o,a,s=this;return(0,r.__generator)(this,(function(r){switch(r.label){case 0:return n=this.transactionManager,o=e.map((function(e){return s.modelManager.getSchemaAndRegisterModelIfNeed(e).name})),a=n.spawnKeepAliveContext(),this.eventBus.emit(T.StartTransaction,{collectionNames:o,context:a}),[4,a.openTransaction(o,t)];case 1:return r.sent(),[2,a.autoCommitOrRollback((function(){return i(s.createStorageTransaction(a))}))]}}))}))},this.name=i,this.version=s,this.events=new N(this.eventBus),this.modelManager=new O(this.eventBus),this.databaseManager=new yt(this,{engine:o,eventBus:this.eventBus,databaseSchema:h}),this.pluginManager=new tt(this,this.eventBus),this.collectionManager=new Ve(this,this.eventBus),this.transactionManager=new wt(this.eventBus,{cmp:this.databaseManager.getDatabaseEngine().cmp}),(t=this.pluginManager).add.apply(t,(0,r.__spreadArray)([],(0,r.__read)(c))),p||gt((function(){return n.open().catch((function(e){throw e}))}))}return e.prototype.createStorageTransaction=function(e){var t=this.modelManager,n=new Ve(this,this.eventBus);return{collection:function(r){var i=t.getSchemaAndRegisterModelIfNeed(r);return n.getCollection(i.name,{spawnContext:function(){return e}})}}},e}(),Et=xt}}]),window.jsExecEndTimeStamp=Date.now(),window.cachedPerformanceEntries||(window.cachedPerformanceEntries=[]),window.cachedPerformanceEntries.push({name:"jsExec: js/vendors-node_modules_tencent_ark-offline-edit_lib_index_js.1abb0df6970e526c199c.js",entryType:"jsExec",startTime:window.jsExecStartTimeStamp,endTime:window.jsExecEndTimeStamp});
//# sourceMappingURL=vendors-node_modules_tencent_ark-offline-edit_lib_index_js.1abb0df6970e526c199c.js.map