self.window=self,window.jsExecStartTimeStamp=Date.now(),(self.webpackChunk_tencent_alloy_builder=self.webpackChunk_tencent_alloy_builder||[]).push([["spread-sheet_src_core_feature_formula_controller_ts-spread-sheet_src_core_worker_worker-threa-ff1554"],{"../spread-sheet/src/core/app/spreadsheet-app-worker.interface.ts":function(e,t,r){"use strict";r.d(t,{m:function(){return o}});var o=(0,r("../node_modules/@tencent/containerized/build/main/index.js").yh)("ISpreadsheetApp")},"../spread-sheet/src/core/feature/copyPaste/utils/hyperlink-convert.ts":function(e,t,r){"use strict";r.d(t,{Ag:function(){return g},Am:function(){return m},O1:function(){return v},U:function(){return S},cX:function(){return y}}),r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.array.includes.js"),r("../node_modules/core-js/modules/es.string.includes.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.split.js"),r("../node_modules/core-js/modules/es.string.replace.js");var o=r("../packages/model/src/cell/index.ts"),n=r("../spread-sheet/src/core/utils/linkedRange.ts"),a=r("../packages/common-utils/src/index.ts"),s=r("./node_modules/axios/index.js"),i=r.n(s),l=r("../node_modules/qs/lib/index.js"),u=r.n(l),d=r("../spread-sheet/src/core/data/configService/spreadConfig.ts"),c=r("../node_modules/i18next/dist/esm/i18next.js"),h=r("../spread-sheet/src/base/util/appConfig.ts"),f=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))},p="#tab=";function m(e,t,r){var a;void 0===r&&(r=!1);var s=t.getSpreadsheetId(!1);if((null===e||void 0===e?void 0:e.getHyperlinkType())&&(null===e||void 0===e?void 0:e.getHyperlink())){var i=e.getHyperlink()||"";return e.getHyperlinkType()===o.HYPERLINK_TYPE.SHEET_LINK?function(e,t,r){return e.includes(p)?g(e.replace(p,""),void 0,t,r):e}(i,r,s):i}var l=null===e||void 0===e?void 0:e.getHyperlinkRuns();if(null===l||void 0===l?void 0:l.length){var u=(0,n.XI)(t,l),d=(0,n.$q)(t,l);if(u&&(null===(a=null===d||void 0===d?void 0:d.range)||void 0===a?void 0:a.sheetId))return g(d.range.sheetId,d.id,r,s)}return null}function g(e,t,r,o){var n=this,s="https://"+h.Z.getConfig("runtime.domainName")+"/sheet",i=(0,a.IZ)("scode"),l=o||d.q.getConfig("padId");return i&&l||r?s+"/"+l+"?"+u().stringify({scode:i,tab:e,type:1,rangeid:t}):new Promise((function(r){return f(n,void 0,void 0,regeneratorRuntime.mark((function o(){var n,a,d,c,h,f,p;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,v(l,i);case 2:n=o.sent,a=n.split("?"),d=a[0],c=a[1],h=u().parse(c),f=h._scode,p=h._docid,i=f,r((s=d)+"/"+(l=p)+"?"+u().stringify({scode:i,tab:e,type:1,rangeid:t}));case 9:case"end":return o.stop()}}),o)})))}))}function v(e,t){var r,o,n,a;return f(this,void 0,void 0,regeneratorRuntime.mark((function s(){var l,d,c;return regeneratorRuntime.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return l=""+location.origin+location.pathname+"?scode="+t+"&type=1",s.prev=1,s.next=4,i().post("/doc/mgr",u().stringify({f:"json",func:4,doc_id:encodeURIComponent(e||""),share_code:t||""}));case 4:if(d=s.sent,0===(null===(o=null===(r=d.data)||void 0===r?void 0:r.head)||void 0===o?void 0:o.ret)){s.next=7;break}return s.abrupt("return",""+location.origin+location.pathname+"?scode="+t);case 7:return c=(null===(a=null===(n=null===d||void 0===d?void 0:d.data)||void 0===n?void 0:n.body)||void 0===a?void 0:a.share_url)||l,s.abrupt("return",c);case 11:return s.prev=11,s.t0=s.catch(1),s.abrupt("return",l);case 14:case"end":return s.stop()}}),s,null,[[1,11]])})))}function S(e){var t,r;return f(this,void 0,void 0,regeneratorRuntime.mark((function o(){var n;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,i().post("/diskauth/get_file_auth",u().stringify({f:"json",func:1,doc_id:encodeURIComponent(e)}));case 3:return n=o.sent,o.abrupt("return",(null===(r=null===(t=null===n||void 0===n?void 0:n.data)||void 0===t?void 0:t.body)||void 0===r?void 0:r.share_auth)||null);case 7:return o.prev=7,o.t0=o.catch(0),console.error(o.t0),o.abrupt("return",null);case 11:case"end":return o.stop()}}),o,null,[[0,7]])})))}function y(e){return e?e.enable_corp_external?c.ZP.t("已获取链接，所有人收到链接可{{value}}",{value:(2===e.external_auth?c.ZP.t("编辑"):c.ZP.t("浏览")).toLowerCase()}):e.enable_corp_internal?c.ZP.t("已获取链接，企业内成员收到链接可{{value}}",{value:(2===e.internal_auth?c.ZP.t("编辑"):c.ZP.t("浏览")).toLowerCase()}):c.ZP.t("已获取链接，仅指定人可访问"):c.ZP.t("链接已经复制")}},"../spread-sheet/src/core/feature/dataValidation/api/DataValidationConfig.ts":function(e,t,r){"use strict";r.d(t,{N:function(){return l}}),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.array.filter.js");var o=r("../packages/model/src/cell/data-validation/data-validation-utils.ts"),n=r("../packages/model/src/cell/data-validation/data-validation-rule-type.ts"),a=r("../spread-sheet/src/core/feature/formula/utils.ts"),s=r("../packages/model/src/range/hexRangeUtils.ts"),i=r("../spread-sheet/src/core/feature/dataValidation/DVInterface.ts");function l(e,t){var r,l=function(e){var t=e.validType,r=e.dataType;switch(t){case i.ob.LIST:return n.Z.LIST;case i.ob.NUMBER:switch(r){case i.h6.FLOAT:return n.Z.CUSTOM_MUST_FLOAT;case i.h6.INT:return n.Z.NUMBER_INT;case i.h6.NONE:return n.Z.NUMBER_FLOAT_AND_INT;case i.h6.TEMPERATURE:return n.Z.CUSTOM_NUMBER_TEMPERATURE;case i.h6.PROGRESS:return n.Z.CUSTOM_PROGRESS}break;case i.ob.TEXT:switch(r){case i.h6.CONTENT:return n.Z.CUSTOM_TEXT_CONTAINS;case i.h6.LENGTH:default:return n.Z.TEXT_LENGTH}case i.ob.DATE:return n.Z.DATE;case i.ob.AVAILABLE:switch(r){case i.h6.ID_CARD:return n.Z.CUSTOM_ID_CARD;case i.h6.PHONE:return n.Z.CUSTOM_NUM_PHONE;case i.h6.TELEPHONE:return n.Z.CUSTOM_NUM_TEL;case i.h6.MAIL:return n.Z.CUSTOM_TEXT_MAIL}break;case i.ob.CHECKBOX:return n.Z.CUSTOM_CHECKBOX;case i.ob.STAR:return n.Z.CUSTOM_STAR;case i.ob.ATTACHMENT:return n.Z.CUSTOM_ATTACHMENT;case i.ob.CONTACT:return n.Z.CUSTOM_CONTACT}return console.warn("数据验证：传入数据不符合规则"),n.Z.CUSTOM}({validType:e.validType,dataType:e.dataType}),u=(null===(r=e.argTokens)||void 0===r?void 0:r.filter((function(e){return Boolean(e.userEnteredValue)})).map((function(r){var i=r.userEnteredValue,u=e.selection;if(u&&l===n.Z.LIST&&(0,a.jr)(i)){var d=(0,s.getRangeInfoFormHexRange)(t,i),c=d.rangeString,h={sheetId:d.sheetId,rowIndex:u.startRowIndex,colIndex:u.startColIndex};return(0,o.G8)("="+c,{ruleType:l,positionInfo:h})}return(0,o.G8)(i)})))||null;return{ruleType:l,inputMessage:e.inputMessage||null,isStrict:e.isStrict||!1,showDropDown:e.showDropDown||!1,operator:e.operator,argTokens:u}}},"../spread-sheet/src/core/feature/dataValidation/api/DataValidationRule.ts":function(e,t,r){"use strict";r.d(t,{Jh:function(){return u},ZU:function(){return p},n3:function(){return m}}),r("../node_modules/core-js/modules/es.array.join.js"),r("../node_modules/core-js/modules/es.object.values.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js");var o=r("../packages/model/src/cell/data-validation/data-validation-utils.ts"),n=r("../packages/model/src/cell/data-validation/data-validation-rule-type.ts"),a=r("../spread-sheet/src/core/utils/formula.ts"),s=r("../spread-sheet/src/core/feature/dataValidation/api/DataValidationUtils.ts"),i=r("../spread-sheet/src/core/feature/dataValidation/type.ts"),l=r("../spread-sheet/src/base/util/phone-number.ts"),u=function(e,t){var r=d(e);if(r)return r;switch(e.ruleType){case n.Z.NUMBER_FLOAT_AND_INT:return h(e,i.sS.NONE);case n.Z.CUSTOM_MUST_FLOAT:return h(e,i.sS.FLOAT);case n.Z.NUMBER_INT:return h(e,i.sS.INT);case n.Z.DATE:return h(e,i.sS.NONE);case n.Z.TEXT_LENGTH:return h(e,i.sS.LENGTH);case n.Z.LIST:return f(e,t);default:return null}},d=function(e){switch(e.ruleType){case n.Z.CUSTOM_TEXT_CONTAINS:return c(e);case n.Z.CUSTOM_ID_CARD:return p();case n.Z.CUSTOM_TEXT_MAIL:case n.Z.CUSTOM_NUM_PHONE:case n.Z.CUSTOM_NUM_TEL:return m(e);case n.Z.CUSTOM_NUMBER_TEMPERATURE:case n.Z.CUSTOM_PROGRESS:return h(e,i.sS.NONE);default:return null}},c=function(e){var t=e.operator,r=e.argTokens;return(0,s.Wj)(t)||!(null===r||void 0===r?void 0:r.length)?null:'=DATA_VALID_TEXT("'+t+'", '+(0,s.Np)(r[0].userEnteredValue)+", $SLOT)"},h=function(e,t,r){var o,n,a=e.operator,i=e.argTokens;if(a&&(0,s.Sv)(a))return null;var l=r||"$SLOT";return'=DATA_VALID_NUMBER("'+(a||"")+'", '+t+", "+(0,s.Np)((0,s.KN)((null===(o=null===i||void 0===i?void 0:i[0])||void 0===o?void 0:o.userEnteredValue)||null))+", "+(0,s.Np)((0,s.KN)((null===(n=null===i||void 0===i?void 0:i[1])||void 0===n?void 0:n.userEnteredValue)||null))+", "+l+")"},f=function(e,t){var r=e.argTokens;if(!r||!r[0]||!(null===r||void 0===r?void 0:r.length))return null;var n=r[0];if((0,o.$U)(n)){var i=(0,o.o5)(n,t);return"DATA_VALID_LIST("+(0,a.moveEqualChar)(i)+", $SLOT)"}var l=n.userEnteredValue;return'DATA_VALID_LIST("'+(0,s.zk)(l).join(",")+'", $SLOT)'},p=function(){return"OR(ISNUMBER(ID($SLOT,0)),ID_FOR_HK($SLOT,0))"},m=function(e){var t=[];return e.ruleType===n.Z.CUSTOM_TEXT_MAIL&&t.push('REGEXMATCH($SLOT,"'+g+'",FALSE)'),e.ruleType===n.Z.CUSTOM_NUM_PHONE&&Object.values(l.Iq).forEach((function(e){t.push('REGEXMATCH($SLOT,"'+e+'",FALSE)')})),e.ruleType===n.Z.CUSTOM_NUM_TEL&&t.push('REGEXMATCH($SLOT,"'+v+'",FALSE)'),"OR("+t.join(",")+")"},g="^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$",v="^(0\\d{2,3}-)?\\d{7,8}(-\\d{1,6})?$"},"../spread-sheet/src/core/feature/dataValidation/api/DataValidationUtils.ts":function(e,t,r){"use strict";r.d(t,{AJ:function(){return N},Dq:function(){return Z},Ex:function(){return T},JU:function(){return B},KN:function(){return O},Np:function(){return x},Sc:function(){return S.Sc},Sv:function(){return j},Wj:function(){return F},ZK:function(){return M},aW:function(){return S.aW},gZ:function(){return L},jY:function(){return C},ko:function(){return R},uU:function(){return V},v1:function(){return P},zk:function(){return w}}),r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.array.join.js"),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.split.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.string.trim.js"),r("../node_modules/core-js/modules/es.array.filter.js"),r("../node_modules/core-js/modules/es.array.from.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.set.js"),r("../node_modules/core-js/modules/esnext.set.add-all.js"),r("../node_modules/core-js/modules/esnext.set.delete-all.js"),r("../node_modules/core-js/modules/esnext.set.difference.js"),r("../node_modules/core-js/modules/esnext.set.every.js"),r("../node_modules/core-js/modules/esnext.set.filter.js"),r("../node_modules/core-js/modules/esnext.set.find.js"),r("../node_modules/core-js/modules/esnext.set.intersection.js"),r("../node_modules/core-js/modules/esnext.set.is-disjoint-from.js"),r("../node_modules/core-js/modules/esnext.set.is-subset-of.js"),r("../node_modules/core-js/modules/esnext.set.is-superset-of.js"),r("../node_modules/core-js/modules/esnext.set.join.js"),r("../node_modules/core-js/modules/esnext.set.map.js"),r("../node_modules/core-js/modules/esnext.set.reduce.js"),r("../node_modules/core-js/modules/esnext.set.some.js"),r("../node_modules/core-js/modules/esnext.set.symmetric-difference.js"),r("../node_modules/core-js/modules/esnext.set.union.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/core-js/modules/es.string.match.js"),r("../node_modules/core-js/modules/es.string.ends-with.js");var o,n=r("../node_modules/i18next/dist/esm/i18next.js"),a=r("../packages/model/src/index.ts"),s=r("../node_modules/@tencent/txdoc_dayjs/dayjs.min.js"),i=r.n(s),l=r("../spread-sheet/src/core/utils/cell.ts"),u=r("../spread-sheet/src/core/utils/formula.ts"),d=r("../spread-sheet/src/core/utils/numberFromat.ts"),c=r("../packages/model/src/range/hexRangeUtils.ts"),h=r("../packages/model/src/cell/data-validation/data-validation-rule-type.ts"),f=r("../packages/model/src/rule/index.ts"),p=r("../packages/model/src/cell/data-validation/data-validation-utils.ts"),m=r("../spread-sheet/src/core/feature/formula/utils.ts"),g=r("../node_modules/@tencent/sheet-formula-sdk/lib/index.js"),v=r("../packages/model/src/cell/metadata/CustomDataType.ts"),S=r("../spread-sheet/src/core/feature/dataValidation/api/DataValidationUIUtils.ts"),y=r("../packages/model/src/cell/format/NumberFormatType.ts"),I=(r("../spread-sheet/src/core/feature/dataValidation/api/DataValidationConfig.ts"),function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))}),R=function(e,t,r){return e?e.split(t).join(r):""},C=function(e){switch(e.ruleType){case h.Z.LIST:case h.Z.NUMBER_INT:case h.Z.NUMBER_FLOAT_AND_INT:case h.Z.CUSTOM_MUST_FLOAT:case h.Z.CUSTOM_NUMBER_TEMPERATURE:case h.Z.TEXT_LENGTH:case h.Z.DATE:return!0}return!1},T=function(e,t,r){return R(e,"$SLOT",g.Pz.toCellId(t,r))},w=function(e){var t;return t=(t=(t=e.split(",")).map((function(e){return e.trim()}))).filter((function(e){return e})),Array.from(new Set(t))};function A(e){var t,r=null===(t=null===e||void 0===e?void 0:e.argTokens)||void 0===t?void 0:t[0];if(!r)return!0;var o=r.type,n=r.formula,a=r.userEnteredValue;if(o===f.ARG_TOKEN_TYPE.VALUE_TOKEN&&null===a)return!0;if(o===f.ARG_TOKEN_TYPE.FORMULA_TOKEN){if(null===n)return!0;if(!0===(null===n||void 0===n?void 0:n.hasReferenceError))return!0}return!1}function D(e){return null!=e&&null!=e.argTokens&&e.ruleType===h.Z.LIST||(console.warn("数据验证：类型不为list或者用户输入为空，不能获取下拉列表信息"),!1)}function b(e,t,n,a){var s,i,l;return I(this,void 0,void 0,regeneratorRuntime.mark((function u(){var d,h,f,m,g,v,S,y,I,R;return regeneratorRuntime.wrap((function(u){for(;;)switch(u.prev=u.next){case 0:if(d=k(t),h=t.argTokens[0],d!==o.RANGE_LIST){u.next=16;break}if(f=(0,p.o5)(h,{rowIndex:n,colIndex:a,options:e.spreadsheet.sheetManager}),m=(0,c.getRangeInfoFormHexRange)(e.spreadsheet,f),g=m.sheetId,v=m.rangeString,S=g||e.spreadsheet.getActiveSheetId(),null===(l=null===(i=null===(s=e.spreadsheet)||void 0===s?void 0:s.sheetManager)||void 0===i?void 0:i.getSheetBySheetId(S))||void 0===l?void 0:l.isLoaded){u.next=10;break}return u.next=10,new Promise((function(t){e.dataCenter.loadSheetData({sheetId:g,ignoreChunk:!0,onFinished:function(){t(!0)},onFail:function(e){var o;t(!1),null===(o=r.g.log)||void 0===o||o.error("获取数据验证引用子表("+g+")失败",e)}})}));case 10:if(y=_(e,v,g),null!==(I=E(e,y))){u.next=14;break}return u.abrupt("return",[]);case 14:return I=I.filter((function(e){return e})),u.abrupt("return",Array.from(new Set(I)));case 16:if(R=h.userEnteredValue,d!==o.ITEM_LIST||null===R){u.next=19;break}return u.abrupt("return",w(R));case 19:return u.abrupt("return",null);case 20:case"end":return u.stop()}}),u)})))}function M(e,t,r){return I(this,void 0,void 0,regeneratorRuntime.mark((function o(){var n,a;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(o.prev=0,D(n=(0,S.Ii)(e.spreadsheet.activeSheet,t,r))&&!A(n)){o.next=5;break}return o.abrupt("return",null);case 5:return o.next=7,b(e,n,t,r);case 7:return a=o.sent,o.abrupt("return",a);case 11:return o.prev=11,o.t0=o.catch(0),console.warn("数据验证获取下拉列表错误",o.t0),o.abrupt("return",null);case 15:case"end":return o.stop()}}),o,null,[[0,11]])})))}function k(e){var t,r;if(e.ruleType!==h.Z.LIST)return"";var n=null===(t=null===e||void 0===e?void 0:e.argTokens)||void 0===t?void 0:t[0].type;if(n===f.ARG_TOKEN_TYPE.FORMULA_TOKEN)return o.RANGE_LIST;var a=null===(r=null===e||void 0===e?void 0:e.argTokens)||void 0===r?void 0:r[0].userEnteredValue;return a&&n===f.ARG_TOKEN_TYPE.VALUE_TOKEN&&0!==a.length?o.ITEM_LIST:""}function E(e,t){if(null==t)return null;var r=t.sheetId,o=e.spreadsheet.sheetManager.getSheetBySheetId(r),n=[];if(o){var a=o.data.getCellDatasAtRange(t);null===a||void 0===a||a.forEach((function(e){return e.forEach((function(e){null!=e&&n.push((0,l.getMergedValue)(e))}))}))}return n}!function(e){e.RANGE_LIST="range-list",e.ITEM_LIST="item-list"}(o||(o={}));var _=function(e,t,r){if(!t)return null;if(!r&&e){r=e.spreadsheet.activeSheetId;var o=(0,u.moveEqualChar)(t).split("!")[0];'"'===o[0]&&'"'===o[o.length-1]&&(o=o.substring(1,o.length-1));var n=e.spreadsheet.sheetManager.getSheetBySheetTitle(o);n&&n.getSheetId()!==r&&(r=n.getSheetId())}return r?(0,c.hex2Range)(t,r):null},j=function(e){return-1===["between","notBetween","equal","notEqual","lessThan","lessThanOrEqual","greaterThan","greaterThanOrEqual"].indexOf(e)},F=function(e){return-1===["contains","notContains","equal"].indexOf(e)};function N(e,t,r){void 0===t&&(t="YYYY-MM-DD"),void 0===r&&(r="date");var o=i()(e).format(t);return"date"==r&&(o+="T00:00:00"),a.Utils.numberFormatUtils.formatParseEngine.datetime2Numeric(o)}var O=function(e){if(e){var t=a.Utils.numberFormatUtils.formatParseEngine.parseValueWithStyle(e);return null==t?e:t.value}return e},x=function(e){var t,r=(0,m.jr)(e);if("string"===typeof e)if('""'===e)t=e;else{if(r)return(0,u.moveEqualChar)(e);t='"'+e+'"'}else{if("number"===typeof e||"boolean"===typeof e)return t=""+e;t='""'}return t},L=function(e,t,r){for(var o=t,n=t.sheetId,a=e.sheetManager.getSheetBySheetId(t.sheetId),s=o.isCol?0:o.startRowIndex,i=o.isCol?a.getRowCount()-1:o.endRowIndex,l=o.isRow?0:o.startColIndex,u=o.isRow?a.getColCount()-1:o.endColIndex,d=s;d<=i;d++)for(var c=l;c<=u;c++)r(d,c,n)},P=function(e){var t=e.view.getSelection();if(!t)return!1;var r=t.activeCell,o=r.rowIndex,n=r.colIndex;return!!(0,S.Sc)(e.spreadsheet.activeSheet,o,n)};function B(e,t,r,o){var s=(void 0===o?{}:o).fractionFirst,i=void 0!==s&&s,l=e.inputOne,c=e.inputTwo,h=e.operate;if(!e.inputTwoShow)return null;if(h!==a.Cell.DATA_VALIDATION_CONDITION_TYPE.BETWEEN&&h!==a.Cell.DATA_VALIDATION_CONDITION_TYPE.NOT_BETWEEN)return null;if(""===l.trim()||""===c.trim())return null;if((0,u.isFormulaString)(l)||(0,u.isFormulaString)(c))return null;var f=(0,d.stringToNumber)(l,{fractionFirst:i}),p=(0,d.stringToNumber)(c,{fractionFirst:i});if(!f||!p)return null;var m=f.numericValue,g=p.numericValue;return"number"!==typeof m||"number"!==typeof g?null:g-m<0?1===t?{inputOneIsError:!0,inputOneErrorTip:n.ZP.t("请输入小于最大值的{{inputType}}",{inputType:r}),inputTwoIsError:!1}:{inputOneIsError:!1,inputTwoIsError:!0,inputTwoErrorTip:n.ZP.t("请输入大于最小值的{{inputType}}",{inputType:r})}:null}var U=function(e){var t=a.Utils.numberFormatUtils.formatParseEngine.parseValue(e,"");return(null===t||void 0===t?void 0:t.type)===y.Z.DATE_TIME||(null===t||void 0===t?void 0:t.type)===y.Z.DATE||(null===t||void 0===t?void 0:t.type)===y.Z.TIME},V=function(e,t){switch(t.ruleType){case h.Z.DATE:return U(e);case h.Z.NUMBER_INT:case h.Z.CUSTOM_MUST_FLOAT:case h.Z.NUMBER_FLOAT_AND_INT:return!U(e)}return!0};function Z(e,t,r){var o;return r&&!r.endsWith("%")||(null===(o=null===t||void 0===t?void 0:t.getMetadata())||void 0===o?void 0:o.customDataType)!==v.ZP.PROGRESS?e:"("+e+" * 100)"}},"../spread-sheet/src/core/feature/formula/controller.ts":function(e,t,r){"use strict";r.d(t,{Z:function(){return At}});var o,n,a=r("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),s=r("../node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js"),i=r("../node_modules/@babel/runtime/helpers/esm/inheritsLoose.js"),l=(r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),r("../node_modules/core-js/modules/es.object.keys.js"),r("../node_modules/core-js/modules/es.array.from.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/es.set.js"),r("../node_modules/core-js/modules/esnext.set.add-all.js"),r("../node_modules/core-js/modules/esnext.set.delete-all.js"),r("../node_modules/core-js/modules/esnext.set.difference.js"),r("../node_modules/core-js/modules/esnext.set.every.js"),r("../node_modules/core-js/modules/esnext.set.filter.js"),r("../node_modules/core-js/modules/esnext.set.find.js"),r("../node_modules/core-js/modules/esnext.set.intersection.js"),r("../node_modules/core-js/modules/esnext.set.is-disjoint-from.js"),r("../node_modules/core-js/modules/esnext.set.is-subset-of.js"),r("../node_modules/core-js/modules/esnext.set.is-superset-of.js"),r("../node_modules/core-js/modules/esnext.set.join.js"),r("../node_modules/core-js/modules/esnext.set.map.js"),r("../node_modules/core-js/modules/esnext.set.reduce.js"),r("../node_modules/core-js/modules/esnext.set.some.js"),r("../node_modules/core-js/modules/esnext.set.symmetric-difference.js"),r("../node_modules/core-js/modules/esnext.set.union.js"),r("../node_modules/core-js/modules/es.array.concat.js"),r("../packages/mutation/src/MutationId.ts")),u=r("../node_modules/@tencent/tdocs-format-render/lib/index.js"),d=r("../spread-sheet/src/core/feature/formula/utils.ts"),c=r("../packages/mutation/src/cell/SetCellPropertiesMutation.ts"),h=r("../packages/mutation/src/cell/SetRangeMutation.ts"),f=r("../packages/model/src/range/GridRange.ts"),p=r("../packages/model/src/cell/CellDataSlot.ts"),m=r("../packages/model/src/cell/CellFormatSlot.ts"),g=r("../packages/mutation/src/dimension/SetDimensionPropertiesMutation.ts"),v=(r("../node_modules/core-js/modules/es.promise.js"),r("../spread-sheet/src/base/report/flowlog.js")),S=function(){function e(){this.statusMap={}}var t=e.prototype;return t.getInitialPromise=function(e){var t=this.statusMap[e];return t&&(0,d.tI)(t.initialized)?t.initialized:Promise.reject()},t.getCurrentStatusMap=function(){for(var e={},t=0,r=Object.keys(this.statusMap);t<r.length;t++){var o=r[t];this.isSheetInitialized(o)?e[o]="initialized":this.isSheetCalculating(o)?e[o]="calculating":this.isSheetWaitingDone(o)?e[o]="waiting":e[o]="loaded"}return e},t.getSheetIds=function(){return Object.keys(this.statusMap)},t.getWaitingPromise=function(e){var t=this.statusMap[e];return t&&(0,d.tI)(t.waiting)?t.waiting:Promise.reject()},t.hasSheetStartedLoadingInFormulaLayer=function(e){return this.isSheetWaitingDone(e)||this.isSheetCalculating(e)||this.isSheetInitialized(e)},t.isSheetLoaded=function(e){return!!this.statusMap[e]},t.isSheetWaitingDone=function(e){var t=this.statusMap[e];return!(!t||!(0,d.tI)(t.waiting)||(0,d.tI)(t.initialized))},t.isSheetCalculating=function(e){var t=this.statusMap[e];return!(!t||t.ready||!(0,d.tI)(t.initialized))},t.isSheetInitialized=function(e){var t=this.statusMap[e];return!(!t||!t.ready)},t.resetSheet=function(e){delete this.statusMap[e]},t.setWaitingStart=function(e){if(!this.statusMap[e]){var t=(0,d.Nl)(),r=t.promise,o=t.reject,n=t.resolve;this.statusMap[e]={waiting:r,waitingReject:o,waitingResolve:n}}},t.setWaitingDone=function(e){var t=this.statusMap[e];if(t&&(0,d.tI)(t.waiting)){if(!(0,d.tI)(t.initialized)){if(!t.waitingResolve)throw new Error(e+" waiting resolve function miss");if(t.waitingResolve(),!t.ready){var r=(0,d.Nl)(),o=r.promise,n=r.reject,a=r.resolve;t.initialized=o,t.initializedReject=n,t.initializedResolve=a}}}else v.Z.info("在主线程中 "+e+"设置 waiting 状态的时机有误")},t.setInitializedDone=function(e){var t=this.statusMap[e];if(!t||!(0,d.tI)(t.initialized))throw new Error(e+" 设置 initialized 的时机有误");if(!t.initializedResolve)throw new Error(e+" resolve function miss");t.initializedResolve(),t.ready=!0},e}(),y=r("../spread-sheet/src/base/event/event.ts"),I=(r("../node_modules/core-js/modules/es.object.assign.js"),r("../node_modules/core-js/modules/es.array.slice.js"),r("../packages/report/src/index.ts")),R=r("../spread-sheet/src/base/index.ts"),C=r("../node_modules/@tencent/docs-user-agent/dist/index.js"),T=r.n(C),w=window,A=w.location.href.indexOf("showLog=1")>=0;!function(e){e.PC="PC",e.ANDROID="Android",e.IOS="IOS"}(n||(n={})),w.formulaReportInfo={},w.allFormulaReportInfo={};var D=90,b=91,M=92,k=93,E=94,_=95,j=96,F=109,N=110,O=111,x=112,L=113,P=103,B=104,U=105,V=106,Z=107,W=108,H=48,G={90:"INIT_KEYFRAME_PARSE",91:"INIT_GRAPH_AND_CALC",92:"INIT_GRAPH",93:"INIT_CALC",94:"INIT_SORT",95:"INIT_PARSE",96:"INIT_RUN",109:"INIT_INHERIT_FORMA",110:"INIT_FORMAT",111:"INIT_SYNCMUTATION",112:"INIT_RESULTTOSPREADSHEET",113:"INIT_SYNCRANGERESULT"},z=((o={})[D]="[打开][函数][worker]keyframe解析构图时间",o[b]="[打开][函数][worker]函数模块总时间",o[M]="[打开][函数][worker]依赖图构建时间",o[k]="[打开][函数][worker]函数计算时间",o[E]="[打开][函数][worker]目标节点排序时间",o[_]="[打开][函数][worker]函数解析时间",o[j]="[打开][函数][worker]函数运行时间",o[P]="[编辑][函数][worker]收到mutation到结束",o[B]="[编辑][函数][worker]单批次计算时间",o[U]="[编辑][函数][worker]单批次图更新时间",o[V]="[编辑][函数][worker]单批次函数解析时间",o[Z]="[编辑][函数][worker]单个函数解析时间",o[W]="[编辑][函数][worker]单个函数运行时间",o[H]="[编辑][函数]关键函数calculateSingleCellFormula",o[F]="[打开][函数][worker]函数格式继承时间",o[N]="[打开][函数][worker]函数结果格式化时间",o[O]="[打开][函数][worker]函数数据序列化和同步给主线程时间",o[x]="[打开][函数][worker]函数结果更新到数据层时间",o[L]="[打开][函数][worker]函数结果通过setRange进行同步的时间",o),Q={mutationSubscribeTime:0,generateFromKeyFrameStart:0,generateFromKeyFrameEnd:0,calculateSingleStart:0,mutationsCount:0},K={},q={};function Y(e){return void 0===K[e]&&(K[e]={asyncFormulaCount:0,formulaCount:0,calculateCount:0,nodeSortDuration:0,parseDuration:0,calculateDuration:0,calculateSingleDuration:0,inheritFormatDuration:0,formatDuration:0,syncMutationDuration:0,resultToSpreadsheetDuration:0,syncRangeResultDuration:0}),K[e]}function X(e,t){void 0===K[e]&&(K[e]={asyncFormulaCount:0,formulaCount:0,calculateCount:0,nodeSortDuration:0,parseDuration:0,calculateDuration:0,calculateSingleDuration:0,inheritFormatDuration:0,formatDuration:0,syncMutationDuration:0,resultToSpreadsheetDuration:0,syncRangeResultDuration:0}),K[e]=Object.assign(Object.assign({},K[e]),t)}function $(e){delete K[e]}function J(e){R.Z.util.timer.wait(0).run((function(){I.ZP.huatuo({appid:20533,flag1:22213,flag2:1,flag3:1,speedTime:e,platform:T().isMobilePhone||T().isAndroidPad?T().isAndroid?n.ANDROID:n.IOS:n.PC},!0),Object.keys(e).forEach((function(t){var r=G[t];r&&(r=r.toLocaleLowerCase(),I.ZP.tdwReport({opername:"excel_performance",module:"formula_worker",action:r,ver5:e[t]}))})),A&&Object.keys(e).forEach((function(t){console.warn("%c"+z[t]+": "+e[t],"color: green; font-size: 14px;")}))}))}function ee(e){Q.mutationSubscribeTime=e||Date.now()}function te(e){var t,r=e.hasFormula,o=e.graphAndCalculateDuration,n=e.buildGraphDuration,a=e.calculateDuration,s=e.sheetId,i=q[s];if(i)if(r){var l,u=Y(i);if(0===u.asyncFormulaCount&&(J(((l={})[b]=o,l[k]=a,l)),w.formulaReportInfo["[函数]函数模块总时间"]=o,w.formulaReportInfo["[函数]函数计算时间"]=a,w.allFormulaReportInfo["[函数]函数模块总时间"]=o+(w.allFormulaReportInfo["[函数]函数模块总时间"]||0),w.allFormulaReportInfo["[函数]函数计算时间"]=a+(w.allFormulaReportInfo["[函数]函数计算时间"]||0)),J(((t={})[M]=n,t[E]=u.nodeSortDuration,t[_]=u.parseDuration,t[j]=u.calculateDuration,t[F]=u.inheritFormatDuration,t[N]=u.formatDuration,t[O]=u.syncMutationDuration,t[x]=u.resultToSpreadsheetDuration,t[L]=u.syncRangeResultDuration,t)),w.formulaReportInfo["[函数]依赖图构建时间"]=n,w.formulaReportInfo["[函数]目标节点排序时间"]=u.nodeSortDuration,w.formulaReportInfo["[函数]函数解析时间"]=u.parseDuration,w.formulaReportInfo["[函数]函数运行时间"]=u.calculateDuration,w.allFormulaReportInfo["[函数]依赖图构建时间"]=(w.allFormulaReportInfo["[函数]依赖图构建时间"]||0)+n,w.allFormulaReportInfo["[函数]目标节点排序时间"]=u.nodeSortDuration+(w.allFormulaReportInfo["[函数]目标节点排序时间"]||0),w.allFormulaReportInfo["[函数]函数解析时间"]=u.parseDuration+(w.allFormulaReportInfo["[函数]函数解析时间"]||0),w.allFormulaReportInfo["[函数]函数运行时间"]=u.calculateDuration+(w.allFormulaReportInfo["[函数]函数运行时间"]||0),0===u.asyncFormulaCount){!function(e){var t=e.buildGraphDuration,r=e.calculateDuration,o=0;t>=4e3?o=33614222:t>=3e3?o=33614223:t>=2e3?o=33614234:t>=1e3&&(o=33614235),0!==o&&I.ZP.monitor(o);var n=0;r>=4e3?n=33614569:r>=3e3?n=33614570:r>=2e3?n=33614572:r>=1e3&&(n=33614574),0!==n&&I.ZP.monitor(n)}({graphAndCalculateDuration:o,buildGraphDuration:n,calculateDuration:a});var d={graphAndCalculateDuration:o,buildGraphDuration:n,calculateDuration:a,formulaCount:u.formulaCount,calculateCount:u.calculateCount,nodeSortDuration:u.nodeSortDuration,parseDuration:u.parseDuration,calculateSingleDuration:u.calculateSingleDuration,inheritFormatDuration:u.inheritFormatDuration,formatDuration:u.formatDuration,syncMutationDuration:u.syncMutationDuration,resultToSpreadsheetDuration:u.resultToSpreadsheetDuration,syncRangeResultDuration:u.syncRangeResultDuration};!function(e){var t=e.graphAndCalculateDuration,r=e.buildGraphDuration,o=e.calculateDuration,n=e.formulaCount,a=e.calculateCount,s=e.nodeSortDuration,i=e.parseDuration,l=e.calculateSingleDuration,u=e.inheritFormatDuration,d=e.formatDuration,c=e.syncMutationDuration,h=e.resultToSpreadsheetDuration,f=e.syncRangeResultDuration;I.ZP.tdwReport({opername:"doc_excel",module:"formula_worker",action:"formula_sheet_open",ver5:JSON.stringify({graphAndCalculateDuration:t,buildGraphDuration:r,calculateDuration:o,formulaCount:n,calculateCount:a,nodeSortDuration:s,parseDuration:i,calculateSingleDuration:l,inheritFormatDuration:u,formatDuration:d,syncMutationDuration:c,resultToSpreadsheetDuration:h,syncRangeResultDuration:f})})}(d),Object.assign(w.formulaReportInfo,d),Object.keys(d).forEach((function(e){Object.prototype.hasOwnProperty.call(d,e)&&(w.allFormulaReportInfo[e]=d[e]+(w.allFormulaReportInfo[e]||0))}))}$(i)}else $(i)}var re=r("../packages/model/src/cell/CellDataDelta.ts"),oe=r("../packages/model/src/cell/CellFormatDelta.ts");function ne(e){var t=ae(e);return new c.Z({gridRange:e.gridRange,cellDataDelta:t})}function ae(e){var t=new re.Z;if(null===e.effectiveValue?t.clearSlot(p.Z.SLOT_EFFIECTIVE_VALUE):"undefined"!==typeof e.effectiveValue&&t.setSlot(p.Z.SLOT_EFFIECTIVE_VALUE,e.effectiveValue),"undefined"!==typeof e.userEnteredNumberFormat){var r=new oe.Z;null===e.userEnteredNumberFormat?r.clearSlot(m.Z.NUMBER_FORMAT):r.setSlot(m.Z.NUMBER_FORMAT,e.userEnteredNumberFormat),t.setSlot(p.Z.SLOT_USER_ENTERED_FORMAT_DELTA,r)}if("undefined"!==typeof e.effectiveFormatNumberFormat){var o=new oe.Z;null===e.effectiveFormatNumberFormat?o.clearSlot(m.Z.NUMBER_FORMAT):o.setSlot(m.Z.NUMBER_FORMAT,e.effectiveFormatNumberFormat),t.setSlot(p.Z.SLOT_EFFIECTIVE_FORMAT_DELTA,o)}return null===e.formula?t.clearSlot(p.Z.SLOT_FORMULA):"undefined"!==typeof e.formula&&t.setSlot(p.Z.SLOT_FORMULA,e.formula),"undefined"!==typeof e.hyperlink&&(e.hyperlink?t.setSlot(p.Z.SLOT_HYPERLINK,e.hyperlink):t.clearSlot(p.Z.SLOT_HYPERLINK)),t}var se=r("../spread-sheet/src/core/feature/formula/utils/parseUtil.ts"),ie=r("../node_modules/@tencent/containerized/build/main/index.js"),le=function(){var e=[],t=!1,r=function r(){if(e.length){1===e.length&&(t=!1),e.shift();var o=e[0];"function"===typeof o&&o(r)}};return{add:function(){e.push.apply(e,arguments)},run:function(){if(e.length&&!t){t=!0;var o=e[0];"function"===typeof o&&o(r)}}}}(),ue=le,de=r("../spread-sheet/src/core/worker/worker-thread/index.ts"),ce=function(e,t,r){var o=this;this.addSomeLoadSheetTasks=function(e){e.forEach(o.addLoadSheetTask)},this.addLoadSheetTask=function(e){return!!o.loadingSheetIdSet.has(e)||!!e&&!!o.externalMethods.getSheetBySheetId(e)&&(ue.add((function(t){R.Z.util.timer.wait(50).run((function(){o.loadSheet(e),t()}))})),ue.run(),o.loadingSheetIdSet.add(e),!0)},this.loadSheet=function(e){o.isInWorker?de.Z.workerThreadWorker.sheetData.loadSheet({sheetId:e,waitForFormulaLayerToBeInitialized:!1}):o.parent.dataCenter.loadSheetData({sheetId:e})},this.externalMethods=e,this.loadingSheetIdSet=new Set,this.isInWorker=t,this.parent=r},he=r("../packages/model/src/dimension/DimensionType.ts"),fe=r("../spread-sheet/src/core/feature/formula/custom-formula-plugin/type.ts"),pe=(r("../node_modules/core-js/modules/es.array.map.js"),r("../node_modules/core-js/modules/es.object.entries.js"),r("../packages/model/src/range/index.ts")),me=r("../packages/mutation/src/index.ts"),ge=r("../packages/model/src/cell/index.ts"),ve=(r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.search.js"),r("../node_modules/core-js/modules/es.array.find.js"),r("../node_modules/core-js/modules/es.array.splice.js"),r("../spread-sheet/src/core/feature/dataValidation/api/DataValidationRule.ts")),Se=r("../spread-sheet/src/core/feature/dataValidation/api/DataValidationUtils.ts"),ye=r("../spread-sheet/src/core/view/level-2/condition-format-center/data/calc-plugin/utils.ts"),Ie=r("../node_modules/@tencent/sheet-formula-sdk/lib/index.js"),Re=r("../packages/model/src/range/hexRangeUtils.ts");function Ce(e,t,r,o){var n=r.getCellDataAtPosition(e,t,{isIgnoreFilterView:!0});if(n){var a=n.getDataValidation();if(a){var s=function(e,t,r){if(null===e)return null;var o=r.rowIndex,n=r.colIndex,a=(0,ve.Jh)(e,r);if(null===a)return null;var s=Ie.Pz.toCellId(o,n),i=(0,Se.Dq)(s,t);return a=(0,Se.ko)(a,"$SLOT",i)}(a,n,{rowIndex:e,colIndex:t,options:o});if(s){var i=(0,se.EG)(s,e,t,r.getSheetId());if(i)return i}}}}function Te(e,t){if(void 0!==e){var o=t.getChartWorkbookRangeById(e);if(null!==o){var n=o.range,a=n.sheetId,s="="+(0,Re.range2AbsoluteHex)(n,r.g.SpreadsheetApp.spreadsheet.activeSheet);return(0,se.EG)(s,0,0,a)}}}function we(e){var t={};return e.forEach((function(e){var r=e.sheetId;t[r]||(t[r]=[]),t[r].push(e)})),t}function Ae(e,t,r){for(;e.length>0;){var o=Math.min(1e3,e.length);r(t(e.slice(0,o))),e.splice(0,o)}}var De=function(e){function t(t){var r;return(r=e.call(this)||this).mergeableType=Ie.nx.GraphMergeableType.AUTO,r.customType=fe.B.DataValidation,r.resultList=[],r.externalMethods=t,r}(0,i.Z)(t,e);var r=t.prototype;return r.generateShouldAddedNodes=function(e){var t=e.ruleRange,r=t.sheetId,o=this.externalMethods.getSheetBySheetId(r),n=Ce(t.startRowIndex,t.startColIndex,o,{getSheetTitleBySheetId:this.externalMethods.getSheetTitleBySheetId});return[{gridRange:(0,d.Ad)(t),formulaModel:n,nodeInfo:void 0}]},r.generateShouldRemovedNodes=function(e){var t=e.ruleRange;return[{id:"",gridRange:(0,d.Ad)(t)}]},r.afterSingleNodeCalculated=function(e){var t=e.formulaInfo,r=e.result,o=t.ast,n=o.row,a=o.col,s=o.sheetId,i=r||!1;this.resultList.push({row:n,col:a,sheetId:s,isDataValid:i,options:{mutationQueueIdRelatedSheetId:s}})},r.afterAllNodesCalculated=function(){var e=this;Ae(this.resultList,(function(t){var r=we(t);return Object.entries(r).map((function(t){var r=t[0];return function(e,t,r){var o=e[0].sheetId,n=t-1,a=0,s=r-1,i=0,l=[];return e.forEach((function(e){if(e.row>=t||e.col>=r||e.col<0||e.col<0)return null;var o;n=Math.min(e.row,n),a=Math.max(e.row,a),s=Math.min(e.col,s),i=Math.max(e.col,i),o=null!==e.isDataValid?new ge.CellDataDelta({setSlots:1<<ge.CELL_DATA_SLOT.SLOT_IS_DATA_VALID,clearSlots:0,delta:{isDataValid:e.isDataValid}}):new ge.CellDataDelta({setSlots:0,clearSlots:1<<ge.CELL_DATA_SLOT.SLOT_IS_DATA_VALID}),l.push({rowIndex:e.row,colIndex:e.col,cellDataDelta:o})})),new me.qi({gridRange:new pe.GridRange(o,n,a,s,i),cellDataDeltaAtPositions:l})}(t[1],e.externalMethods.countRows(r),e.externalMethods.countCols(r))}))}),(function(t){e.externalMethods.syncCellsToDataLayer(t,{toMainThreadDataLayer:!0,toWorkerThreadDataLayer:!0})}))},t}(Ie.nx.BaseCustomNodePlugin),be=(r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.symbol.js"),r("../node_modules/core-js/modules/es.symbol.description.js"),r("../node_modules/core-js/modules/es.symbol.iterator.js"),r("../node_modules/core-js/modules/es.string.split.js"),r("../packages/common-utils/src/index.ts")),Me=r("../packages/model/src/cell/format/index.ts"),ke=r("../packages/model/src/rule/index.ts"),Ee=r("../packages/model/src/rule/DataBarProps.ts"),_e=r("../packages/model/src/cell/data-validation/data-validation-utils.ts");function je(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"===typeof e)return Fe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Fe(e,t):void 0}}(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Fe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function Ne(e){return Array.isArray(e)?e.length>0:!!(0,be.hj)(e)||!!e}var Oe=function(){function e(e){this.externalMethods=e,this.snapshot={}}var t=e.prototype;return t.takeSnapshot=function(e){var t=this.getAllConditionalFormatRuleBySheetId(e);t&&(this.snapshot[e]=t.map((function(e){var t;return{ruleId:e.id,type:null===(t=e.rule.booleanConditionalFormat)||void 0===t?void 0:t.condition.type}})))},t.getRuleFromLatestSnapshot=function(e,t){var r=this.snapshot[e];if(r)return r[t].ruleId},t.getAllConditionalFormatRuleBySheetId=function(e){var t=this.externalMethods.getSheetBySheetId(e);return t?t.conditionalFormatRuleManager.rules:[]},e}(),xe=function(e){function t(t){var r;return(r=e.call(this)||this).mergeableType=Ie.nx.GraphMergeableType.MANUAL,r.customType=fe.B.ConditionalFormat,r.getConditionFormatByIndex=function(e,t){var o=r.getConditionalFormatRuleManager(t),n=null===o||void 0===o?void 0:o.getRuleByRuleIndex(e);return null!==n&&void 0!==n?n:null},r.getConditionFormatById=function(e,t){var o=r.getConditionalFormatRuleManager(t);if(!e)return null;var n=null===o||void 0===o?void 0:o.getRuleByRuleId(e);return null!==n&&void 0!==n?n:null},r.externalMethods=t,r.resultMap={},r.ruleSnapshot=new Oe({getSheetBySheetId:r.externalMethods.getSheetBySheetId}),r}(0,i.Z)(t,e);var o=t.prototype;return o.generateShouldAddedNodes=function(e){var t,o=e.rule,n=e.ruleIndex,a=o.ruleRanges,s=a[0];if(void 0===s)return[];var i=s.sheetId,l=this.getConditionFormatByIndex(n,i);if(!l)return[];var u=l.id,c=(0,ye.Q)(o,s.sheetId,s.startRowIndex,s.startColIndex,{getSheetTitleBySheetId:this.externalMethods.getSheetTitleBySheetId},r.g.SpreadsheetApp.spreadsheet);if(null===o||!u||null===c)return[];var h=[];if((null===(t=o.booleanConditionalFormat)||void 0===t?void 0:t.condition.type)===ke.CONDITION_TYPE.CUSTOM_FORMULA){var f=this.externalMethods.countRows(i),p=this.externalMethods.countCols(i);a.forEach((function(e){h.push({gridRange:(0,d.Ad)(e,{rowCount:f,colCount:p}),formulaModel:c,nodeInfo:{id:u}});var t=(0,Re.range2AbsoluteHex)(e,r.g.SpreadsheetApp.spreadsheet.activeSheet),o=(0,_e.IC)(t,0,0,i);h.push({gridRange:(0,d.Ad)(e),formulaModel:o,nodeInfo:{id:u}})}))}else{var m=s.startRowIndex,g=s.startColIndex,v=s.endRowIndex,S=s.endColIndex;s.isRow?(g=0,S=0,v=m):s.isCol?(m=0,v=0,S=g):(v=m,S=g),h.push({gridRange:new Ie.zD.FormulaGridRange(i,m,v,g,S),formulaModel:c,nodeInfo:{id:u}})}return this.ruleSnapshot.takeSnapshot(s.sheetId),h},o.generateShouldRemovedNodes=function(e){for(var t,r=e.ruleRanges,o=e.ruleIndex,n=[],a=je(r);!(t=a()).done;){var s=t.value,i=this.ruleSnapshot.getRuleFromLatestSnapshot(s.sheetId,o);i&&(this.clearRuleRangeResult(s),n.push({id:i,gridRange:(0,d.Ad)(s)}))}return r.length>0&&this.ruleSnapshot.takeSnapshot(r[0].sheetId),n},o.afterSingleNodeCalculated=function(e){var t=this;if(Array.isArray(e.result)){var r=e.sortedNode,o=e.formulaInfo,n=e.result,a=r.sheetId,s=r.id,i=r.row,l=r.col;if(void 0===s)return;var u=this.externalMethods.countRows(a)-1,d=this.externalMethods.countCols(a)-1;o.formulaModel.getAllCellRangeWithFixedInfo().slice(-n.length).forEach((function(e,r){var o,c=e.isStartRowRelative?i+e.startRowIndex:e.startRowIndex,h=e.isStartColRelative?l+e.startColIndex:e.startColIndex,f=e.isEndRowRelative?i+e.endRowIndex:e.endRowIndex,p=e.isEndColRelative?l+e.endColIndex:e.endColIndex;e.isRowArray&&(p=d),e.isColArray&&(f=u),f=Math.min(f,u);for(var m=(p=Math.min(p,d))-h+1,g=c,v=0;g<=f;g++,v++)for(var S=h,y=0;S<=p;S++,y++){var I=m*v+y,R=null===(o=n[r])||void 0===o?void 0:o[I];Ne(R)||(R=!1),t.saveConditionalFormatResult(g,S,a,s,R)}}))}else{var c=e.sortedNode,h=e.result,f=c.row,p=c.col,m=c.sheetId,g=c.id;if(void 0===g)return;this.saveConditionalFormatResult(f,p,m,g,h)}},o.afterAllNodesCalculated=function(){var e=this,t=[];Object.entries(this.resultMap).forEach((function(o){var n=o[0],a=o[1],s=a.ruleId,i=a.value,l=e.parseResultKey(n),u=l.row,d=l.col,c=l.sheetId;if(null!==e.getConditionalFormatRuleManager(c)){var h=function(e,t,o,n){var a=null,s=null,i=(0,n.getRuleByRuleId)(e,t);if(null===i)return{cellFormat:a,dataBarProps:s};var l=r.g.SpreadsheetApp.spreadsheet,u=i.rule,d=u.booleanConditionalFormat,c=u.gradientConditionalFormat,h=u.dataBarConditionalFormat;if(d&&o)a=d.format;else if(c&&(0,be.hj)(o))a=(0,ye.i)(c,o,l);else if(h&&Array.isArray(o)){var f=h.interpolationPoints,p=h.hideData;s=new Ee.Q({length:o[2],hideData:p,direction:o[0],zeroPoint:o[1],negativeColor:Me.Color.getColorHexCode(f[0].color,l),positiveColor:Me.Color.getColorHexCode(f[1].color,l)})}return{cellFormat:a,dataBarProps:s}}(s,c,i,{getRuleByRuleId:e.getConditionFormatById}),f=h.cellFormat,p=h.dataBarProps,m=e.externalMethods.getDataPositionByFilterViewPosition(u,d,c),g=m.row,v=m.col;t.push({row:g,col:v,sheetId:c,cellFormat:f,dataBarProps:p,options:{mutationQueueIdRelatedSheetId:c}})}})),Ae(t,this.generateUpdateMutationsFromResults.bind(this),(function(t){return e.externalMethods.syncCellsToDataLayer(t,{toMainThreadDataLayer:!0,toWorkerThreadDataLayer:!0})})),this.resultMap={}},o.clearRuleRangeResult=function(e){var t=this,r=e.sheetId,o=this.externalMethods.getSheetBySheetId(r)||void 0,n=this.externalMethods.countCols(r),a=this.externalMethods.countRows(r);e.endRowIndex=Math.min(e.endRowIndex,a-1),e.endColIndex=Math.min(e.endColIndex,n-1),e.each((function(e,o){var n=t.generateResultKey(e,o,r);void 0===t.resultMap[n]&&(t.resultMap[n]={value:!1})}),o)},o.saveConditionalFormatResult=function(e,t,r,o,n){var a=this.getConditionFormatById(o,r);if(null!==a){var s,i=this.generateResultKey(e,t,r),l=this.resultMap[i],u=Ne(null===l||void 0===l?void 0:l.value),d=Ne(n);(void 0===(null===(s=l)||void 0===s?void 0:s.ruleIndex)||!u&&d||u&&d&&a.index<l.ruleIndex)&&(this.resultMap[i]={ruleIndex:a.index,ruleId:o,value:n})}},o.generateUpdateMutationsFromResults=function(e){var t=this,r=we(e);return Object.entries(r).map((function(e){var r=e[0];return function(e,t,r){var o=e[0].sheetId,n=t-1,a=0,s=r-1,i=0,l=[];return e.forEach((function(e){var t=e.row,r=e.col,o=e.cellFormat,u=e.dataBarProps;n=Math.min(t,n),s=Math.min(r,s),a=Math.max(t,a),i=Math.max(r,i);var d=new ge.CellDataDelta;o?d.setSlot(ge.CELL_DATA_SLOT.SLOT_CONDITIONAL_FORMAT_DELTA,o):d.clearSlot(ge.CELL_DATA_SLOT.SLOT_CONDITIONAL_FORMAT_DELTA),u?d.setSlot(ge.CELL_DATA_SLOT.SLOT_DATA_BAR,u):d.clearSlot(ge.CELL_DATA_SLOT.SLOT_DATA_BAR),l.push({rowIndex:t,colIndex:r,cellDataDelta:d})})),new me.qi({gridRange:new pe.GridRange(o,n,a,s,i),cellDataDeltaAtPositions:l})}(e[1],t.externalMethods.countRows(r),t.externalMethods.countCols(r))}))},o.getConditionalFormatRuleManager=function(e){var t=this.externalMethods.getSheetBySheetId(e);return t?t.conditionalFormatRuleManager:null},o.generateResultKey=function(e,t,r){return e+"_"+t+"_"+r},o.parseResultKey=function(e){var t=e.split("_");return{row:+t[0],col:+t[1],sheetId:t[2]}},t}(Ie.nx.BaseCustomNodePlugin),Le=function(e){function t(t){var r;return(r=e.call(this)||this).mergeableType=Ie.nx.GraphMergeableType.MANUAL,r.customType=fe.B.Chart,r.externalMethods=t,r.chartDataRangeSnapshot={},r}(0,i.Z)(t,e);var r=t.prototype;return r.generateShouldAddedNodes=function(e){var t=e.workbookRangeId,r=this.getWorkbookRangeById(t);if(void 0===r)return[];var o=Te(t,{getChartWorkbookRangeById:this.externalMethods.getChartWorkbookRangeById});if(void 0===o)return[];this.chartDataRangeSnapshot[t]=r.range;var n=r.range,a=n.startRowIndex,s=n.startColIndex,i=n.sheetId;return[{gridRange:new Ie.zD.FormulaGridRange(i,a,a,s,s),formulaModel:o,nodeInfo:{id:t}}]},r.generateShouldRemovedNodes=function(e){var t=e.workbookRangeId,r=this.chartDataRangeSnapshot[t];return void 0===r?[]:(delete this.chartDataRangeSnapshot[t],[{id:t,gridRange:(0,d.Ad)(r)}])},r.afterSingleNodeCalculated=function(e){var t=e.sortedNode;void 0!==t.id&&de.Z.workerThreadWorker.charts.triggerDataChange({workbookRangeId:t.id})},r.afterAllNodesCalculated=function(){},r.getWorkbookRangeById=function(e){var t=this.externalMethods.getChartWorkbookRangeById(e);if(null!==t)return t},t}(Ie.nx.BaseCustomNodePlugin);function Pe(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"===typeof e)return Be(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Be(e,t):void 0}}(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Be(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}var Ue=function(){function e(e){var t=this;this.isGraphSegmentNodeNeedCalculate=function(e){return!(t.blockingNodeSet.has(e)||t.loadingSheetSet.has(e.gridRange.sheetId))},this.isSheetNeedCalculate=function(e){return!t.loadingSheetSet.has(e)},this.getLoadedSheetListAndBackUp=function(){if(!t.isAllSheetLoaded)return[];var e=Array.from(t.loadingSheetSet);return t.backUpBlockingNodes=Array.from(t.blockingNodeSet),t.backUpLoadingSheets=e,t.backUpVisitedSheetSet=Array.from(t.visitedSheetSet),t.blockingNodeSet.clear(),t.loadingSheetSet.clear(),t.visitedSheetSet.clear(),e},this.analysesCrossSheetNode=function(e){var r=Date.now(),o=t.externalMethods,n=o.isSheetLoaded,a=o.loadSheet,s=new Set;e.eachDegreeTree(Ie.nx.DegreeTreeType.OUT_DEGREE,(function(r,o,a){0!==Object.keys(r).length&&Object.entries(r).forEach((function(r){var i=r[0],l=r[1];if(!n(i)&&l){var u=i+"-"+o+"-"+a;t.visitedSheetSet.has(u)||(l.all().forEach((function(r){var n=[];e.getRefRangeByDepRange(r.gridRange,o,(function(e){var t=e.inDegreeSegmentNode;n.push(t)})),t.addBlockingGraphSegmentNode(e,o,n)})),t.addBlockingGraphSegmentNode(e,o,Array.from(t.blockingNodeSet)),s.add(i),t.visitedSheetSet.add(u)),t.isAllSheetLoaded=!1}}))}));var i=!0;if(0===s.size)for(var l,u=Pe(t.loadingSheetSet);!(l=u()).done;){var d=l.value;if(!n(d)){i=!1;break}}else console.warn("函数检测到跨表，开始拉取子表",s),i=!1;var c=Date.now();window.h=window.h||0,window.h+=c-r,i?t.isAllSheetLoaded=!0:s.forEach((function(e){-1!==t.externalMethods.getSheetIndexBySheetId(e)&&(a(e),t.loadingSheetSet.add(e))}))},this.addBlockingGraphSegmentNode=function(e,r,o){for(var n=0;n<o.length;n++){var a=o[n];t.blockingNodeSet.add(a),e.getRefRangeByDepRange(a.gridRange,r,(function(e){var r=e.inDegreeSegmentNode;t.blockingNodeSet.has(r)||o.push(r)}))}},this.externalMethods=e,this.blockingNodeSet=new Set,this.loadingSheetSet=new Set,this.visitedSheetSet=new Set,this.backUpBlockingNodes=[],this.backUpLoadingSheets=[],this.backUpVisitedSheetSet=[]}var t=e.prototype;return t.getRecalculateNodes=function(){if(this.isAllSheetLoaded)return Array.from(this.blockingNodeSet)},t.clearOrResumeCrossSheetId=function(){var e=this;if(!this.isAllSheetLoaded)return this.backUpBlockingNodes.forEach((function(t){return e.blockingNodeSet.add(t)})),this.backUpLoadingSheets.forEach((function(t){return e.loadingSheetSet.add(t)})),void this.backUpVisitedSheetSet.forEach((function(t){return e.visitedSheetSet.add(t)}));this.backUpBlockingNodes=[],this.backUpLoadingSheets=[],this.backUpVisitedSheetSet=[]},e}();r("../node_modules/core-js/modules/es.string.replace.js");var Ve,Ze=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),We=r("../packages/model/src/cell/cellDataUtils.ts"),He=r("../spread-sheet/src/core/feature/copyPaste/utils/hyperlink-convert.ts"),Ge=r("../packages/model/src/sheet/SheetType.ts"),ze=r("../packages/model/src/utils/utils.ts"),Qe=function(){function e(e){var t=this;this.countRows=function(e){if(!e||"string"!==typeof e)throw new Error("获取行数量必须要提供 sheetId");var r=t.getSheetBySheetId(e);return r?r.getRowCount():0},this.countCols=function(e){if(!e||"string"!==typeof e)throw new Error("获取列数量必须要提供 sheetId");var r=t.getSheetBySheetId(e);return r?r.getColCount():0},this.getActiveSheetId=function(){return t.spreadsheet.activeSheetId},this.getSheetBySheetId=function(e){var r=e||t.currentSheetId;return t.spreadsheet.sheetManager.getSheetBySheetId(r)},this.getSheetTypeBySheetId=function(e){var r=t.getSheetBySheetId(e);return r?r.getSheetType():Ge.ZP.GRID},this.getSheetIdBySheetName=function(e){var r=t.spreadsheet.sheetManager.getSheetBySheetTitle(e);if(!r)return Ie.ResultErrorType.ref;var o=r.getSheetId(),n=t.getSheetTypeBySheetId(o);return(0,ze.tD)(n)?Ie.ResultErrorType.name:o},this.getSheetIdsAmongTwoSheets=function(e,r){return t.spreadsheet.sheetManager.getSheetIdsAmongTwoSheets(e,r)},this.getSheetIdBySheetIndex=function(e){return t.spreadsheet.sheetManager.getSheetIdBySheetIndex(e)},this.getSheetNameBySheetId=function(e){var r=t.getSheetBySheetId(e);return r?r.getTitle():""},this.getSheetIds=function(){return t.spreadsheet.sheetManager.sheetList.map((function(e){return e.getSheetId()}))},this.getSheetNames=function(){return t.spreadsheet.sheetManager.sheetList.map((function(e){return e.getTitle()}))},this.getCellData=function(e,r,o,n){void 0===n&&(n={isIgnoreFilterView:!1});var a=t.getSheetBySheetId(o),s=n.isIgnoreFilterView;return a?a.getCellDataAtPosition(e,r,{isIgnoreFilterView:s}):null},this.getCellValue=function(e,r,o,n){if(void 0===n&&(n=!1),!o||"string"!==typeof o)throw new Error("获取 cellValue 必须要提供 sheetId");var a=t.getSheetBySheetId(o);if(a){var s=a.getCellDataAtPosition(e,r,{isIgnoreFilterView:n})||null;if(!s)return null;var i=s.getFormattedEffectiveValue();return void 0!==(null===i||void 0===i?void 0:i.value)?i.value:null}return null},this.getCellEditValue=function(e,r,o){if(!o||"string"!==typeof o)throw new Error("获取 cellEditValue 必须要提供 sheetId");var n=t.getSheetBySheetId(o);if(n){var a=n.getCellDataAtPosition(e,r)||null;return a?a.getEditValue():null}return null},this.getCellFormattedValue=function(e,r,o){if(!o||"string"!==typeof o)throw new Error("获取 cellFormattedValue 必须要提供 sheetId");var n=t.getSheetBySheetId(o);if(n){var a=n.getCellDataAtPosition(e,r)||null;return a?a.getFormattedValue():null}return null},this.getRealCellFormat=function(e,r,o,n){if(void 0===n&&(n=!1),!o||"string"!==typeof o)throw new Error("获取 cellFormat 必须要提供 sheetId");var a=t.getSheetBySheetId(o);if(a){var s=a.getCellDataAtPosition(e,r,{isIgnoreFilterView:n})||null;if(!s)return null;var i=(0,We.getExportFormat)(s);return i?i.getNumberFormat():null}return null},this.getFilterViewPositionByDataPosition=function(e,r,o,n){var a=t.spreadsheet.sheetManager.getSheetBySheetId(o);return a?a.transformCoordFromSheetToFilterView(e,r,n):{row:e,col:r}},this.getDataPositionByFilterViewPosition=function(e,r,o,n){var a=t.spreadsheet.sheetManager.getSheetBySheetId(o);return a?a.transformCoordFromFilterViewToSheet(e,r,n):{row:e,col:r}},this.getActiveView=function(e){var r=t.spreadsheet.sheetManager.getSheetBySheetId(e);return r?r.filterViewManager.getActiveFilterView():null},this.isCellHidden=function(e,r,o,n){var a=t.getSheetBySheetId(o);return!!a&&t.isSheetCellHidden(a,e,r,n)},this.traverseCellDataBySheetId=function(e,r){var o=t.getSheetBySheetId(e);o&&o.data.rowData.forEach((function(t,o){t&&t.values.forEach((function(t,n){t&&r({row:o,col:n,sheetId:e,iCellData:t})}))}))},this.getCellHyperlink=function(e,r,o){var n,a=t.getCellData(e,r,o);return n=a,(0,He.Am)(n,t.spreadsheet,!0)},this.getSetRangeMutationsFromCellDataDeltaInfoList=function(e){var t=[],r={};e.forEach((function(e){if(e){var o=e.sheetId,n=e.row,a=e.col,s={rowIndex:n,colIndex:a,cellDataDelta:e.cellDataDelta};if(r[o]){var i=r[o];if(n-500>i.minRow-1){var l=i.minRow,u=i.minCol,d=i.maxRow,c=i.maxCol,p=i.cellDataDeltaAtPositions,m=new h.Z({gridRange:new f.Z(o,l,d,u,c),cellDataDeltaAtPositions:p});return t.push(m),void(r[o]={cellDataDeltaAtPositions:[s],minCol:a,minRow:n,maxRow:n,maxCol:a})}i.cellDataDeltaAtPositions.push(s),i.minRow=Math.min(i.minRow,n),i.maxRow=Math.max(i.maxRow,n),i.minCol=Math.min(i.minCol,a),i.maxCol=Math.max(i.maxCol,a)}else r[o]={cellDataDeltaAtPositions:[s],minCol:a,minRow:n,maxRow:n,maxCol:a}}}));for(var o=0,n=Object.keys(r);o<n.length;o++){var a=n[o],s=r[a],i=s.minRow,l=s.minCol,u=s.maxRow,d=s.maxCol,c=s.cellDataDeltaAtPositions,p=new h.Z({gridRange:new f.Z(a,i,u,l,d),cellDataDeltaAtPositions:c});t.push(p)}return t},this.parent=e,this.spreadsheet=this.parent.spreadsheet}var t=e.prototype;return t.getCellDataDeltaInfoListByFormulaNodes=function(e){var t=this,r=[];return e.map((function(e){var o=t.getCellDataDeltaInfoByFormulaNode(e);o&&r.push(o)})),r},t.getCellDataDeltaInfoByFormulaNode=function(e){var t=e.sheetId;if(this.getSheetBySheetId(t))return{cellDataDelta:ae(e),row:e.row,col:e.col,sheetId:e.sheetId}},t.isSheetCellHidden=function(e,t,r,o){void 0===o&&(o="ALL");var n=e.data,a=n.rowMetadata,s=n.colMetadata,i=null===a||void 0===a?void 0:a[t],l=null===s||void 0===s?void 0:s[r],u=!1;return i&&(u=this.isCellRowOrColInfoHidden(i,o)),l&&(u=this.isCellRowOrColInfoHidden(l,o)||u),u},t.isCellRowOrColInfoHidden=function(e,t){switch(t){case"ALL":return e.hiddenByUser||e.hiddenByFilter;case"USER":return e.hiddenByUser;case"FILTER":return e.hiddenByFilter;default:return!1}},t.getCellDataDeltaByMutations=function(e){var t=e.gridRange,r=e instanceof h.Z?e.cellDataDeltaAtPositions:[];if(e instanceof me.Y0)for(var o=e.cellDataDelta,n=t.startRowIndex;n<=t.endRowIndex;n++)for(var a=t.startColIndex;a<=t.endColIndex;a++)r.push({rowIndex:n,colIndex:a,cellDataDelta:o});return r},(0,Ze.Z)(e,[{key:"currentSheetId",get:function(){return this.spreadsheet.activeSheetId}}]),e}(),Ke=r("../node_modules/lodash/flatten.js"),qe=r.n(Ke),Ye=r("../spread-sheet/src/base/event/eventName.ts"),Xe=r("../packages/model/src/cell/ExtendedValueType.ts"),$e=r("../packages/model/src/cell/ExtendedValue.ts"),Je=function(){function e(){this.cacheMap={}}var t=e.prototype;return t.set=function(e,t){var r=e.row,o=e.col,n=e.sheetId;this.cacheMap[n]||(this.cacheMap[n]=[]),this.cacheMap[n][r]||(this.cacheMap[n][r]=[]);var a=this.cacheMap[n][r][o];a?Object.assign(a,t):this.cacheMap[n][r][o]=t},t.clear=function(){this.cacheMap={}},t.get=function(e){var t,r,o=e.row,n=e.col,a=e.sheetId;return null===(r=null===(t=this.cacheMap[a])||void 0===t?void 0:t[o])||void 0===r?void 0:r[n]},t.getAll=function(){return this.cacheMap},e}(),et=function(e){function t(t,r){var o;return void 0===t&&(t=!1),(o=e.call(this,r)||this).isGridRangeInVisibleArea=function(e){var t=(0,s.Z)(o).visibleArea;if(!t)return!1;var r=o.getActiveSheetId();return e.sheetId===r&&(e.startRowIndex>=t.frozenRowStart&&e.endRowIndex<=t.frozenRowEnd&&e.startColIndex>=t.frozenColStart&&e.endColIndex<=t.frozenColEnd||e.startRowIndex>=t.flowRowStart&&e.endRowIndex<=t.flowRowEnd&&e.startColIndex>=t.flowColStart&&e.endColIndex<=t.flowColEnd)},o.syncCellsToDataLayer=function(e,t){var r=void 0===t?{}:t,n=r.toMainThreadDataLayer,a=r.toWorkerThreadDataLayer,s=e.map((function(e){return e.getAffectedSheetId()}));a&&o.updateCellDataFromFormula(e,{runInWorker:!1,relatedSheetIds:s}),n&&o.updateCellDataFromFormula(e,{runInWorker:!0,needToSetIntializedDone:!0,relatedSheetIds:s})},o.updateCellDataFromFormula=function(e,t){var r=void 0===t?{}:t,n=r.isInVisibleArea,a=r.runInWorker,s=void 0===a||a,i=r.needToSetIntializedDone,l=r.relatedSheetIds;s&&o.isInWorker?o.syncNonPersistentMutationsToMainThread({mutations:e,isInVisibleArea:n,isFromFormula:!0,needToSetIntializedDone:i,relatedSheetIds:l}):s||e.forEach((function(e){y.ZP.spreadsheetEvent.trigger("updateCellDataFromFormula",e)}))},o.syncAllFormulaResultToMainThread=function(e){var t=new Je;o.traverseCellDataBySheetId(e,(function(e){var r,n,a=e.row,s=e.col,i=e.sheetId,l=e.iCellData,u=null===l||void 0===l?void 0:l.getFormula(),d=null===l||void 0===l?void 0:l.getIsDataValid(),c=null===l||void 0===l?void 0:l.getConditionalFormatResult();if(!1===d){var h={row:a,col:s,sheetId:i,cellDataDelta:new re.Z({setSlots:1<<p.Z.SLOT_IS_DATA_VALID,clearSlots:0,delta:{isDataValid:d}})};t.set({row:a,col:s,sheetId:i},h)}if(c){var f={row:a,col:s,sheetId:i,cellDataDelta:new re.Z({setSlots:1<<p.Z.SLOT_CONDITIONAL_FORMAT_DELTA,clearSlots:0,delta:{conditionalFormatResult:c}})};t.set({row:a,col:s,sheetId:i},f)}if(u){var m=null===l||void 0===l?void 0:l.getEffectiveValue(),g=null===(r=null===l||void 0===l?void 0:l.getUserEnteredFormat())||void 0===r?void 0:r.getNumberFormat(),v=null===(n=null===l||void 0===l?void 0:l.getEffectiveFormat())||void 0===n?void 0:n.getNumberFormat(),S=o.getCellDataDeltaInfoByFormulaNode({row:a,col:s,sheetId:i,effectiveValue:m,userEnteredNumberFormat:g,effectiveFormatNumberFormat:v});S&&t.set({row:a,col:s,sheetId:i},S)}}));var r=o.getSetRangeMutationsFromCellDataDeltaInfoList(qe()(t.getAll()[e]));o.syncCellsToDataLayer(r,{toMainThreadDataLayer:!0})},o.syncSingleCalculationResultToDataLayer=function(e,t){var r=e.effectiveFormatNumberFormat,n=e.result,a=e.hyperlink,s=t.row,i=t.col,l=t.sheetId,u=new f.Z(l,s,s,i,i);if(o.isGridRangeInVisibleArea(u)){var c=(null===n||void 0===n?void 0:n.displayText)?Xe.Z.ERROR:d.ps[typeof n],h={effectiveValue:$e.Z.createInstance({type:c,value:n}),gridRange:u,effectiveFormatNumberFormat:r,hyperlink:a};if((0,d.i7)()){var p=ne(h);return p?o.updateCellDataFromFormula([p],{isInVisibleArea:!0}):void 0}}},o.isInWorker=t,o.app=r,t?o.visibleArea={flowColEnd:24,flowColStart:0,flowRowEnd:50,flowRowStart:0,frozenColEnd:0,frozenColStart:0,frozenRowEnd:0,frozenRowStart:0,sheetId:o.getActiveSheetId()}:o.bindVisibleAreaMonitor(),o}(0,i.Z)(t,e);var r=t.prototype;return r.bindVisibleAreaMonitor=function(){var e=this,t=this.app;(0,d.AE)((function(){var e;return null===(e=t.view)||void 0===e?void 0:e.canvas}),(function(){var r=t.view.canvas;t.event.init.listen(Ye.W1.AFTER_FIRST_RENDER,R.Z.util.type.throttle((function(){var t,o=r.areaData,n=o.row,a=n.frozen,s=a.renderFrom,i=a.renderTo,l=n.flow,u=l.renderFrom,d=l.renderTo,c=o.col,h=c.frozen,f=h.renderFrom,p=h.renderTo,m=c.flow,g={frozenRowStart:s,frozenRowEnd:i,flowRowStart:u,flowRowEnd:d,frozenColStart:f,frozenColEnd:p,flowColStart:m.renderFrom,flowColEnd:m.renderTo,sheetId:e.getActiveSheetId()};null===(t=e.app.mainThreadWorker)||void 0===t||t.sheetData.syncVisibleAreaToWorker({visibleArea:g})}),1e3,e,!0))}))},r.syncAllCalculationResultToDataLayer=function(e,t){var r=t.toMainThreadDataLayer,o=t.toWorkerThreadDataLayer,n=this.getFormulaNodesByCurrentBatchValueCache(e),a=this.getCellDataDeltaInfoListByFormulaNodes(n),s=this.getSetRangeMutationsFromCellDataDeltaInfoList(a);this.syncCellsToDataLayer(s,{toMainThreadDataLayer:r,toWorkerThreadDataLayer:o})},r.getFormulaNodesByCurrentBatchValueCache=function(e){var t=[];return Object.keys(e).forEach((function(r){e[r].forEach((function(e,o){e.forEach((function(e,n){var a=e.result,s=e.hyperlink,i=e.effectiveFormatNumberFormat,l=(null===a||void 0===a?void 0:a.displayText)?Xe.Z.ERROR:d.ps[typeof a],u=$e.Z.createInstance({type:l,value:a});t.push({row:o,col:n,sheetId:r,effectiveValue:u,hyperlink:s,effectiveFormatNumberFormat:i})}))}))})),t},r.syncNonPersistentMutationsToMainThread=function(e){e.mutations.forEach((function(t){de.Z.workerThreadWorker.mutationData.syncNonPersistentMutationsToMainThread(Object.assign(Object.assign({},e),{mutations:[t]}))}))},t}(Qe),tt=function(){function e(){this.pluginList=[]}var t=e.prototype;return t.register=function(e){this.pluginList.push(e)},t.beforeBatchCalculate=function(){this.pluginList.forEach((function(e){e.beforeBatchCalculate()}))},t.beforeEveryCalculation=function(e,t){var r=!1;return this.pluginList.forEach((function(o){!1===o.beforeEveryCalculation(e,t)&&(r=!0)})),r},t.afterEveryCalculation=function(e,t,r,o){this.pluginList.forEach((function(n){n.afterEveryCalculation(e,t,r,o)}))},e}(),rt=r("../packages/model/src/workbookRange/index.ts"),ot=r("../packages/model/src/cell/format/NumberFormatType.ts"),nt=r("../spread-sheet/src/core/feature/formula/calculate-plugin/calc-plugin-base.ts"),at={pattern:"General"},st=function(e){function t(t,r){var o;return(o=e.call(this)||this).getInheritFormat=function(e){var t,r=e.formula,n=e.ast;if((0,d.e_)(r))return{effectiveFormatNumberFormat:t=u.NumberFormatFactory.createInstance({pattern:"@"})};var a=o.checkSimpaleTodayAndNowFunctionFormula(r);if(null===a||void 0===a?void 0:a.effectiveFormatNumberFormat)return a;var s=o.getInheritanceFormatByAST(n);return s?(t=s,o.checkmMultiplicationAndDivisionFormula(n)&&o.unInheritSituation(n)&&(t=void 0)):t=u.NumberFormatFactory.createInstance(at),{effectiveFormatNumberFormat:t}},o.getInheritanceFormatByAST=function(e,t){if(void 0===t&&(t=null),t)return t;var r=!1;return Ie.AD.walk(e,(function(e,n){if(t)return{stopAll:!0};var a=n.length>2&&n[n.length-2],s={PMT:!0,IPMT:!0,PPMT:!0,FV:!0,PV:!0,CUMIPMT:!0,CUMPRINC:!0,SYD:!0,SLN:!0,PRICE:!0,PRICEDISC:!0,DB:!0},i=!1;if(Ie.AD.isFunctionNodeButNotBinaryNode(a)&&(i=!0,s[a.funcName.toUpperCase()]&&(r=!0,i=!1)),Ie.AD.isFunctionNodeButNotBinaryNode(e)){if(e.formatType&&"string"===typeof e.formatType)return t=u.NumberFormatFactory.createInstance({pattern:e.formatType}),{stopAll:!0};var l=e.funcName.toUpperCase();if(!{SUM:!0,AVERAGE:!0,MIN:!0,MAX:!0,ROUND:!0,TRUNC:!0}[l]&&!s[l])return{stopSearchingDown:!0,stopParallelTraversal:i}}return Ie.AD.isCellNode(e)?function(e,r,o){var n=o(r.row,r.col,r.sheetId);return n&&!(0,u.isGeneralCell)(n)?(t=n,{stopAll:!0}):{stopSearchingDown:!0,stopParallelTraversal:e}}(i,e,o.getCellFormat):Ie.AD.isCellRangeNode(e)&&!Ie.AD.isCellRangeNodeCrossTableThreeDimension(e)?function(e,r){var o=e.start,n=e.cellRangeType,a=e.sheetIds[0],s={COL:function(){var e=o;return r(0,(0,Ie.VT)(e),a)},ROW:function(){var e=o;return r((0,Ie.Fz)(e),0,a)},NORMAL:function(){var t=e.scope,o=t.row,n=t.col;return r(o,n,a)},USER_RANGE:function(){return null},CELL:function(){return null}}[n]();return s&&!(0,u.isGeneralCell)(s)?(t=s,{stopAll:!0}):{stopSearchingDown:!0,stopParallelTraversal:!0}}(e,o.getCellFormat):{stopParallelTraversal:i}}),{preorder:!0}),r&&!t&&(t=u.NumberFormatFactory.createInstance({pattern:'"¥"#,##0.00_);[Red]\\("¥"#,##0.00\\)'})),t},o.getCellFormat=function(e,t,r){var n,a=o.valueCache.get({row:e,col:t,sheetId:r});return a&&(n=a.effectiveFormatNumberFormat),n||o.externalMethods.getRealCellFormat(e,t,r)},o.checkSimpaleTodayAndNowFunctionFormula=function(e){if(/(today|now|date)\([^)]*\)/i.test(e)&&"="===e.replace(/\s/g,"").replace(/(today|now|date)\([^)]*\)/i,"").replace(/\+|-/g,"").replace(/\d+(\.\d+)?([Ee][+-]?\d+)?/g,"")){var t=e.toLowerCase();return{effectiveFormatNumberFormat:u.NumberFormatFactory.createInstance({pattern:t.indexOf("today")>-1||t.indexOf("date")>-1?"yyyy/m/d":"yyyy/m/d h:mm:ss;@"})}}},o.checkmMultiplicationAndDivisionFormula=function(e){var t,r,o=!1;if(Ie.AD.isFunctionNode(e.body)&&"MATHMATCH"===(null===(t=e.body)||void 0===t?void 0:t.funcName)){var n=null===(r=e.body)||void 0===r?void 0:r.args[2];"*"!==(null===n||void 0===n?void 0:n.value)&&"/"!==n.value||(o=!0)}return o},o.unInheritSituation=function(e){var t,r,n;if(Ie.AD.isFunctionNode(e.body)&&"MATHMATCH"===(null===(t=e.body)||void 0===t?void 0:t.funcName)){var a=null===(r=e.body)||void 0===r?void 0:r.args[0],s=null===(n=e.body)||void 0===n?void 0:n.args[1];if(o.checkNumberFormatTypeAndDotLength(a,ot.Z.NUMBER,0)||o.checkNumberFormatTypeAndDotLength(s,ot.Z.NUMBER,0))return!0;if(o.checkNumberFormatTypeAndDotLength(a,ot.Z.CURRENCY,0)&&o.checkNumberFormatTypeAndDotLength(s,ot.Z.CURRENCY,0))return!0}return!1},o.checkNumberFormatTypeAndDotLength=function(e,t,r){var n;if(Ie.AD.isCellNode(e)&&(n=o.getCellFormat(e.row,e.col,e.sheetId))){var a=(0,u.getCellNumberFormatType)(n),s=(0,u.getCurrentCellDotNum)(null===n||void 0===n?void 0:n.pattern);if(a&&a.group===t&&s===r)return!0}return!1},o.valueCache=t,o.externalMethods=r,o}return(0,i.Z)(t,e),t.prototype.afterEveryCalculation=function(e,t,r,o){var n,a=r.row,s=r.col,i=r.sheetId;Ie.AD.isCellNode(t.ast)&&!o.isCustomFormula&&(n=this.getInheritFormat({formula:t.formula,ast:t.ast}).effectiveFormatNumberFormat,this.valueCache.set({row:a,col:s,sheetId:i},{effectiveFormatNumberFormat:n}))},t}(nt.Z),it=r("../node_modules/i18next/dist/esm/i18next.js"),lt=r("../packages/model/src/cell/ErrorValue.ts"),ut=function(e){function t(t){var r;return(r=e.call(this)||this).valueCache=t,r}(0,i.Z)(t,e);var r=t.prototype;return r.afterEveryCalculation=function(e,t,r){var o=this.getDataLayerResultByFormulaResult(e.result);this.valueCache.set(r,o)},r.getDataLayerResultByFormulaResult=function(e){var t,r=d.ps[typeof e];return(0,Ie.zH)(e)?(t=new lt.Z({displayText:e.displayText,title:it.ZP.t("错误"),type:d.i1[e.type],message:d.OA[e.displayText]}),r=Xe.Z.ERROR):t=e,{result:t,type:r}},t}(nt.Z),dt=(r("../node_modules/core-js/modules/es.number.is-integer.js"),r("../node_modules/core-js/modules/es.number.constructor.js"),r("../packages/model/src/cell/data-validation/data-validation-condition-type.ts")),ct=r("../packages/model/src/utils/numberFormat/FormatParseEngine.ts"),ht=r("../spread-sheet/src/core/feature/dataValidation/type.ts"),ft={acceptRef:!1,min:5};function pt(e,t,r,o,n){var a,s=Ie.AD.isCalcRef(n)?null===(a=n.toArray())||void 0===a?void 0:a[0]:n,i=function(e,t,r,o,n){return null!==r&&function(e,t){var r=!1;switch(e){case ht.sS.INT:r="number"===typeof t&&Number.isInteger(t);break;case ht.sS.FLOAT:r="number"===typeof t&&!Number.isInteger(t);break;default:r="number"===typeof t}return r}(t,r)&&function(e,t,r,o){if(!e)return!0;var n=mt[e];return!!n&&n(t,r,o)}(e,r,o,n)}(e,t,t===ht.sS.LENGTH?s.toString().length:gt(s),gt(r),gt(o));return i}var mt=((Ve={})[dt.Z.BETWEEN]=function(e,t,r){return e>=t&&e<=r},Ve[dt.Z.NOT_BETWEEN]=function(e,t,r){return e<t||e>r},Ve[dt.Z.EQUAL]=function(e,t){return e===t},Ve[dt.Z.NOT_EQUAL]=function(e,t){return e!==t},Ve[dt.Z.LESS]=function(e,t){return e<t},Ve[dt.Z.LESS_EQUAL]=function(e,t){return e<=t},Ve[dt.Z.GREAT]=function(e,t){return e>t},Ve[dt.Z.GREAT_EQUAL]=function(e,t){return e>=t},Ve);function gt(e){var t;if("number"===typeof e)return e;var r=(null===(t=(0,ct.parseValue)(e,null))||void 0===t?void 0:t.numericValue)||e;return null===r||""===r?"":"string"!==typeof(r=r.toString().replace(/℃$/,""))||isNaN(Number(r))?r:parseFloat(r)}r("../node_modules/core-js/modules/es.regexp.constructor.js");var vt={acceptRef:!1,min:3};function St(e,t,r){var o,n=Ie.AD.isCalcRef(r)?null===(o=r.toArray())||void 0===o?void 0:o[0]:r,a=!1;if((null===t||void 0===t?void 0:t.indexOf("#REGEXP"))<0){var s=t.toString();a=null!==n&&function(e,t,r){switch(e){case dt.Z.INCLUDE:return!yt(t)&&-1!==t.indexOf(r);case dt.Z.NOT_INCLUDE:return yt(t)||-1===t.indexOf(r);case dt.Z.EQUAL:return!yt(t)&&t===r}return!1}(e,n.toString(),s)}else{var i=null===t||void 0===t?void 0:t.split("#REGEXP ").map((function(e){if(!(e.length<=0))return new RegExp(e,"g")}));a=null!==n&&function(e,t,r){var o=!1;return!yt(t)&&r&&r.forEach((function(e){(null===e||void 0===e?void 0:e.test(t))&&(o=!0)})),o}(0,n.toString(),i)}return a}function yt(e){return Ie.Pz.hasError(e)||"number"===typeof e&&(isNaN(e)||!isFinite(e))}var It={acceptRef:!1,min:5};function Rt(e){var t=e.getCellFormattedValue;return function(e,r){var o=function(e,t){if(!e)return null;var r=null;if(Ie.AD.isCalcRef(e)){var o=t(e.getRow(0),e.getColumn(0),e.getSheetId(0));o&&(r=o.value)}else r=e;return"string"===typeof r&&r?r=Ie.Pz.parseNumber(r):r}(r,t);if(null===o)return!0;var n=Ie.AD.isCalcRef(e)?function(e,t){for(var r,o,n=e.identities,a=0,s=0,i=[],l=0;l<n.length;l++){var u=n[l],d=u.rowCount,c=u.colCount,h=u.sheetId,f=u.row,p=u.col;a=f+d,s=p+c;for(var m=f;m<a;m++)for(var g=p;g<s;g++){var v=t(m,g,h);o=""===(null===v||void 0===v?void 0:v.value)?""===(null===(r=Ie.Pz.calcContext.getInstance())||void 0===r?void 0:r.custom.cellEditValue(m,g,h))?null:null===v||void 0===v?void 0:v.value:v?v.value:null,i.push(o)}}return i}(e,t):e.split(",");return n.some((function(e){return null!==e&&e.toString()===o.toString()}))}}var Ct=r("../spread-sheet/src/core/view/level-2/condition-format-center/data/custom-formula/index.ts"),Tt=function(e){function t(t){var r;return(r=e.call(this)||this).isNodeDependencyValidInFilterView=function(e,t){var o=t.sheetId,n=t.startRowIndex,a=e.sheetId,s=e.startRowIndex,i=r.externalMethods.getSheetBySheetId(a);if(a!==o||!i)return!0;var l=r.isCrossFilterViewReorderRange(a,t),u=r.isCrossFilterViewReorderRange(a,e);return!l||!u||s===n},r.isCrossFilterViewReorderRange=function(e,t){var o=r.externalMethods.getActiveView(e);if(!o)return!1;var n=o.getBasicFilter();return!(!n||!n.sortSpecs.length)&&n.range.isCross(t)},r.externalMethods=t,r}(0,i.Z)(t,e);var r=t.prototype;return r.beforeEveryCalculation=function(e,t){if(!t.isCustomFormula){var r=this.externalMethods.getFormulaDataByRowCol(e,{customType:Ie.nx.FORMULA_TYPE});return!(r&&!this.isNodeValidInFilterViewWithReorder(r.formulaModel,e))&&void 0}},r.isNodeValidInFilterViewWithReorder=function(e,t){var r=this,o=t.sheetId,n=t.row,a=t.col,s=this.transformNodePositionToViewPosition(n,a,o),i=s.row,l=s.col,u=this.externalMethods.getActiveView(o);if(!u)return!0;var d=u.sheetReference,c=new f.Z(o,i,i,l,l);return null===e||void 0===e?void 0:e.getAllCellRangeWithFixedInfo().every((function(e){var t=Ie.nx.getDepOffsetRangeByRefOffsetRangeAndPart(e,{startRowIndex:i,endRowIndex:i,startColIndex:l,endColIndex:l}),n=Ie.nx.getSheetIdsFromPart(e,o,r.externalMethods.getSheetIdsAmongTwoSheets),a=t.startRow===t.endRow&&t.startCol===t.endCol;return n.every((function(e){if(a){var n=t.startRow,s=t.startCol;if(e!==d.getSheetId())return!0;var i=new f.Z(o,n,n,s,s).clampToSheetSize(d);return r.isNodeDependencyValidInFilterView(c,i)}var l=t.startRow,u=t.startCol,h=t.endRow,p=t.endCol,m=c.sheetId,g=c.startRowIndex,v=r.externalMethods.getSheetBySheetId(m);if(m!==e||!v)return!0;var S=new f.Z(o,l,h,u,p).clampToSheetSize(d),y=r.isCrossFilterViewReorderRange(m,c),I=l===h;return!r.isCrossFilterViewReorderRange(m,S)||!(y&&!I)&&(!y||g===l)}))}))},r.transformNodePositionToViewPosition=function(e,t,r){var o=this.externalMethods.getFilterViewPositionByDataPosition(e,t,r);return{row:o.row,col:o.col,sheetId:r}},t}(nt.Z),wt=function(e){function t(t){var r;return(r=e.call(this)||this).valueCache=t,r}return(0,i.Z)(t,e),t.prototype.afterEveryCalculation=function(e,t,r){var o;Ie.AD.isCellNode(t.ast)&&Ie.AD.isFunctionNode(t.ast.body)&&"HYPERLINK"===t.ast.body.funcName&&(o=e.hyperlink),this.valueCache.set(r,{hyperlink:o})},t}(nt.Z),At=function(e){function t(t,o){var n,a,i,l=(void 0===o?{}:o).isInWorker,p=void 0!==l&&l;return(n=e.call(this,t)||this).graphUpdateTimes=1,n.calcPluginManager=new tt,n.disposables=new ie.SL,n.isLastMutationLocal=!0,n.lastFilterRangeMap={},n.valueCache=new Je,n.getResultBySingleFormula=function(e,t){var o,a=n.formulaController.calculateLogicService.calculateSingleFormula(e,t),s=a.ast;Ie.AD.isCellNode(s)&&s.body&&Ie.AD.isFunctionNode(s.body)&&(0,Ie.de)(s.body)&&(a.result=function(e,t,o){var n,a=(void 0===(n=o)&&(n=""),(n+="").replace(/-/gi,"")),s=[],i={};return e.slice(-t.length).forEach((function(e,o){var n,l=e;if(Ie.AD.isVariableNode(e)&&Ie.AD.isFunctionNode(e.originValueNode)){var u=e.originValueNode.args.find((function(e){return Ie.AD.isCellNode(e)||Ie.AD.isCellRangeNode(e)}));u&&(l=u)}if(Ie.AD.isCellNode(l)){var c=(0,d.k1)(l.row,l.col,l.sheetId);if(i[c])return;i[c]=!0,s.push({customTypeId:a,row:l.row,col:l.col,sheetId:l.sheetId,graphNodeId:c,value:t[o][0]})}else if(Ie.AD.isCellRangeNode(l)){var h=l.scope,f=h.row,p=void 0===f?0:f,m=h.col,g=void 0===m?0:m,v=t[o].length,S=l.scope,y=S.rowCount,I=void 0===y?0:y,R=S.colCount,C=void 0===R?0:R,T=l.startSheetId,w=null===(n=r.g.SpreadsheetApp.spreadsheet)||void 0===n?void 0:n.sheetManager.getSheetBySheetId(T);l.cellRangeType===Ie.AD.CELL_RANGE_TYPE.COL?(w&&(C=Math.min(C,w.getColCount()-g)),I=v/C):l.cellRangeType===Ie.AD.CELL_RANGE_TYPE.ROW?(w&&(I=Math.min(I,w.getRowCount()-p)),C=v/I):w&&(I=Math.min(I,w.getRowCount()-p),C=Math.min(C,w.getColCount()-g));for(var A=0,D=p;D<p+I;D++)for(var b=g;b<g+C;b++){var M=(0,d.k1)(D,b,l.sheetIds[0]);i[M]||(i[M]=!0,s.push({customTypeId:a,row:D,col:b,sheetId:l.sheetIds[0],graphNodeId:M,value:t[o][A]}),A+=1)}}})),s}(s.body.args,a.result,s.cellId));var i=null===(o=(0,d.Gs)(a.result))||void 0===o?void 0:o.result;return{result:null!==i&&void 0!==i?i:a.result,isError:a.isError}},n.keyframeHandler=function(e){var t;if(n.isInWorker){var r=e.sheetId;n.sheetFormulaLayerStatusMap.isSheetLoaded(r)||n.sheetFormulaLayerStatusMap.setWaitingStart(r);var o=n.getSheetBySheetId(r);if(o){var a=null===(t=o.getBasicFilter())||void 0===t?void 0:t.range;a&&(n.lastFilterRangeMap[r]=a);var s=o.data.rowData,i=[],l=[];s.forEach((function(e,t){e&&e.values.forEach((function(e,o){if(e){var n=e.getDataValidation();n&&l.push({dataValidation:n,ruleRange:new f.Z(r,t,t,o,o)});var a=e.getFormula();a&&i.push({row:t,col:o,formulaModel:a,sheetId:r,nodeInfo:void 0})}}))})),l.length>0&&n.formulaController.addCustomNodes(fe.B.DataValidation,l,!1),n.formulaController.commitChangingFormulaNodes(i,!1);var u=[];o.conditionalFormatRuleManager.rules.forEach((function(e){u.push({rule:e.rule,ruleIndex:e.index})})),u.length>0&&n.formulaController.addCustomNodes(fe.B.ConditionalFormat,u,!1)}}},n.startCalculate=function(){n.formulaController.startCalculate(),n.reportCalculateInfo()},n.afterMutationRunHandler=function(e){var t=e.mutation,r=e.sheetId,o=e.sType,a=e.isLocal,s=e.isFromFormula,i=e.isCrossSheetMutation,l=void 0!==i&&i;if(n.isLastMutationLocal=a,"string"===typeof r)n.mutationHandler({mutation:t,sheetId:r,sType:o,isFromFormula:s,isCrossSheetMutation:l});else{var u=r;n.mutationHandler({mutation:t,sheetId:u[0],sType:o,isFromFormula:s,isCrossSheetMutation:l,mutationAffectedSheetIds:u})}},n.mutationHandler=function(e){var t=e.mutation,r=e.sheetId,o=e.isFromFormula,a=e.mutationAffectedSheetIds,s=e.isCrossSheetMutation,i=void 0!==s&&s;if(n.isInWorker&&!o&&(!n.inPlaybackSheetId||n.inPlaybackSheetId===t.getAffectedSheetId())){if(i){if(n.sheetFormulaLayerStatusMap.hasSheetStartedLoadingInFormulaLayer(r))return;n.loadSheetManager.addLoadSheetTask(r)}var l=n.spreadsheet.sheetManager.getSheetBySheetId(r);i||n.sheetFormulaLayerStatusMap.isSheetLoaded(r)||!l||!l.isFetching&&!l.isLoaded||(n.sheetFormulaLayerStatusMap.setWaitingStart(r),n.inPlaybackSheetId=r),n.mutationHandlerBeforeInit(t,r,i),n.mutationHandlerInWorkerBeforeInit(t),n.sheetFormulaLayerStatusMap.isSheetWaitingDone(r)||n.mutationHandlerAfterInit(t,a)}},n.getFormulaDataByRowCol=function(e,t){var r=e.row,o=e.col,a=e.sheetId,s=e.id,i=n.getFormulaModelByRowCol(r,o,a,{customType:t.customType,id:s});if(!i)return null;var l=t.customType!==Ie.nx.FORMULA_TYPE?{row:r,col:o}:n.getFilterViewPositionByDataPosition(r,o,a),u=l.row,d=l.col,c=i.toString(u,d,{getSheetTitleBySheetId:n.spreadsheet.sheetManager.getSheetTitleBySheetId.bind(n.spreadsheet.sheetManager)});return{cellInfo:{row:r,col:o,rowCount:n.countRows(a),colCount:n.countCols(a),id:Ie.Pz.toCellId(r,o),sheetId:a},formulaModel:i,formulaString:c}},n.getFormulaModelByRowCol=function(e,t,o,a){var s=a||{},i=s.customType,l=s.id;if(i!==Ie.nx.FORMULA_TYPE&&void 0!==i){var c=n.getSheetBySheetId(o);if(!c)return null;var h={getSheetTitleBySheetId:n.spreadsheet.sheetManager.getSheetTitleBySheetId.bind(n.spreadsheet.sheetManager),id:l};return i===fe.B.ConditionalFormat?function(e,t,o,n){var a=o.conditionalFormatRuleManager.ruleTree.search({minX:t,maxX:t,minY:e,maxY:e});if(0!==a.length){var s=a.find((function(e){return e.rule.id===n.id}));if(s){var i=s.rule.rule,l=(0,ye.Q)(i,o.getSheetId(),e,t,n,r.g.SpreadsheetApp.spreadsheet);if(l)return l}}}(e,t,c,h)||null:i===fe.B.DataValidation?Ce(e,t,c,h)||null:i===fe.B.Chart&&Te(h.id,{getChartWorkbookRangeById:n.spreadsheet.workbookRangeManager.getChartWorkbookRangeById.bind(n.spreadsheet.workbookRangeManager)})||null}var p=n.getCellData(e,t,o,{isIgnoreFilterView:!0}),m=null===p||void 0===p?void 0:p.getFormula();if(!m){var g=null===p||void 0===p?void 0:p.getEffectiveValue();if(g&&"string"===typeof g.value&&(0,d.jr)(g.value)){var v=null===p||void 0===p?void 0:p.getUserEnteredFormat();if(!v||!(0,u.isTextCell)(v.getNumberFormat())||(0,d.e_)(g.value)){var S=g.value,y=ne({formula:m=(0,se.EG)(S,e,t,o),gridRange:new f.Z(o,e,e,t,t)});n.dataTransferService.updateCellDataFromFormula([y])}}}return m||null},n.mutationForDataValidation=function(e){e&&(e instanceof c.Z?n.setCellPropertiesMutationForDataValidation(e):e instanceof h.Z&&n.setRangeMutationForDataValidation(e))},n.afterCalculateAllNodes=function(e){if(n.crossSheetService.clearOrResumeCrossSheetId(),(null===e||void 0===e?void 0:e.customType)===Ie.nx.FORMULA_TYPE){var t=n.valueCache.getAll();n.dataTransferService.syncAllCalculationResultToDataLayer(t,{toMainThreadDataLayer:!0,toWorkerThreadDataLayer:!0});var r=Object.keys(n.valueCache);de.Z.workerThreadWorker.mutationData.debounceCacheFormulaResult(r),n.valueCache.clear(),console.warn("函数整体计算结束")}},n.afterCalculateSingleNode=function(e){var t=e.result,r=e.formulaInfo,o=e.sortedNode,a=e.customType;(0,Ie.zH)(t.result)&&(t.result.message=d.OA[t.result.displayText]),n.valueCache.set(o,t),n.calcPluginManager.afterEveryCalculation(t,r,o,{isCustomFormula:a!==Ie.nx.FORMULA_TYPE});var s=n.valueCache.get(o);s&&n.dataTransferService.syncSingleCalculationResultToDataLayer(s,o)},n.getCellValueWithCache=function(e,t,r){var o=n.getDataPositionByFilterViewPosition(e,t,r),a=o.row,s=o.col,i=n.valueCache.get({row:a,col:s,sheetId:r});return i&&"undefined"!==typeof i.result?i.result:n.getCellValue(a,s,r,!0)},n.setSheetInitializedForSwitchSheet=function(e){var t=e.sheetId;n.sheetFormulaLayerStatusMap.isSheetLoaded(t)||n.sheetFormulaLayerStatusMap.setWaitingStart(t),n.sheetFormulaLayerStatusMap.isSheetInitialized(t)||(n.sheetFormulaLayerStatusMap.setWaitingDone(t),n.sheetFormulaLayerStatusMap.setInitializedDone(t))},n.mainThreadWorker=t.mainThreadWorker,n.parent=t,n.isInWorker=p,n.spreadsheet=n.parent.spreadsheet,n.sheetFormulaLayerStatusMap=new S,n.dataTransferService=new et(p,n.parent),n.initCalculatePlugin(),n.loadSheetManager=new ce({getSheetBySheetId:n.getSheetBySheetId},n.isInWorker,n.parent),n.crossSheetService=new Ue({isSheetLoaded:n.sheetFormulaLayerStatusMap.isSheetLoaded.bind(n.sheetFormulaLayerStatusMap),loadSheet:n.loadSheetManager.addLoadSheetTask,getSheetIndexBySheetId:n.spreadsheet.sheetManager.getSheetIndexBySheetId.bind(n.spreadsheet.sheetManager)}),n.formulaController=new Ie.hP({getFormulaModelByRowCol:n.getFormulaModelByRowCol,getFormulaDataByRowCol:n.getFormulaDataByRowCol,getSheetIdBySheetIndex:n.getSheetIdBySheetIndex,getSheetIdsAmongTwoSheets:n.getSheetIdsAmongTwoSheets,getCellHyperlink:n.getCellHyperlink,isCellHidden:n.isCellHidden,getCellEditValue:n.getCellEditValue,getCellValue:n.getCellValueWithCache,countRows:n.countRows,countCols:n.countCols,getSheetIdBySheetName:n.getSheetIdBySheetName,getSheetNames:n.getSheetNames,getSheetNameBySheetId:n.getSheetNameBySheetId,getSheetTitleBySheetId:n.spreadsheet.sheetManager.getSheetTitleBySheetId.bind(n.spreadsheet.sheetManager),afterNodesChangedHook:function(){n.crossSheetService.analysesCrossSheetNode(n.formulaController.formulaGraph)},isNodeNeedCalculateHook:function(e){return n.crossSheetService.isGraphSegmentNodeNeedCalculate(e)},beforeBatchCalculate:function(){n.calcPluginManager.beforeBatchCalculate()},beforeCalculateSingleNode:function(e,t){var r=t.customType!==Ie.nx.FORMULA_TYPE;return n.calcPluginManager.beforeEveryCalculation(e,{isCustomFormula:r})},afterCalculateSingleNode:n.afterCalculateSingleNode,afterCalculateAllNodes:n.afterCalculateAllNodes}),p&&(n.formulaController.formulaGraph.addCustomNodePlugin(fe.B.DataValidation,new De({countRows:n.countRows,countCols:n.countCols,getSheetBySheetId:n.getSheetBySheetId,syncCellsToDataLayer:n.dataTransferService.syncCellsToDataLayer,getSheetTitleBySheetId:n.spreadsheet.sheetManager.getSheetTitleBySheetId.bind(n.spreadsheet.sheetManager)})),n.formulaController.formulaGraph.addCustomNodePlugin(fe.B.ConditionalFormat,new xe({countRows:n.countRows,countCols:n.countCols,getSheetBySheetId:n.getSheetBySheetId,syncCellsToDataLayer:n.dataTransferService.syncCellsToDataLayer,getSheetTitleBySheetId:n.spreadsheet.sheetManager.getSheetTitleBySheetId.bind(n.spreadsheet.sheetManager),getDataPositionByFilterViewPosition:n.getDataPositionByFilterViewPosition})),n.formulaController.formulaGraph.addCustomNodePlugin(fe.B.Chart,new Le({getChartWorkbookRangeById:n.spreadsheet.workbookRangeManager.getChartWorkbookRangeById.bind(n.spreadsheet.workbookRangeManager)}))),a=(0,s.Z)(n),i=t,a.registerExternalFunctions("DATA_VALID_NUMBER",pt,ft),a.registerExternalFunctions("DATA_VALID_TEXT",St,vt),a.registerExternalFunctions("DATA_VALID_LIST",Rt({getCellFormattedValue:function(e,t,r){var o=i.spreadsheet.sheetManager.getSheetBySheetId(r);if(o){var n=o.getCellDataAtPosition(e,t);return n?n.getFormattedValue():null}return null}}),It),(0,Ct.v)((0,s.Z)(n)),(0,se.nn)({parse:n.formulaController.calculateLogicService.calculateCenter.formulaParser.parse}),n.subscribe(),n}(0,i.Z)(t,e);var o=t.prototype;return o.subscribe=function(){this.parent.mutationBehavior.emitter.addListener(this.parent.mutationBehavior.EVENT.AFTER_MUTATION_RUN,this.afterMutationRunHandler),y.ZP.default.listen("setSheetInitializedForSwitchSheet",this.setSheetInitializedForSwitchSheet)},o.destroy=function(){var e;null===(e=r.g.log)||void 0===e||e.debug("flow controller destroy()"),this.parent.mutationBehavior.emitter.removeListener(this.parent.mutationBehavior.EVENT.AFTER_MUTATION_RUN,this.afterMutationRunHandler),y.ZP.default.remove("setSheetInitializedForSwitchSheet",this.setSheetInitializedForSwitchSheet),this.formulaController.destroy(),this.disposables.dispose()},o.startReCalculateAfterSheetInitial=function(e){!function(e,t){q[e]=t}(e,this.graphUpdateTimes);var t=this.crossSheetService.getRecalculateNodes(),r=Array.from(new Set([e].concat((0,a.Z)(this.crossSheetService.getLoadedSheetListAndBackUp()))));console.warn("函数子表加载完毕，准备重算",e,r),this.crossSheetService.isSheetNeedCalculate(e)&&this.formulaController.calculateSomeSheetsImmediately(r,t);var o=this.formulaController.getPerformanceInfo(),n=o.buildGraphDuration,s=o.topSortDuration,i=o.calculateDuration,l=n+s+i;this.reportCalculateInfo(),te({hasFormula:!0,graphAndCalculateDuration:l,buildGraphDuration:n,calculateDuration:i,sheetId:e}),this.sheetFormulaLayerStatusMap.isSheetCalculating(e)&&this.sheetFormulaLayerStatusMap.setInitializedDone(e)},o.initEdit=function(e){var t=this;e.forEach((function(e){t.mutationHandler({mutation:e,sheetId:t.getActiveSheetId()})}))},o.registerExternalFunctions=function(e,t,r){this.formulaController.calculateLogicService.calculateCenter.registerCustomFormula(e,t,r)},o.doesCellDataDeltaChangeFormulaLayer=function(e){var t=e.cellDataDelta,r=e.formulaModel,o=t.setSlots&1<<p.Z.SLOT_EFFIECTIVE_VALUE,n=t.setSlots&1<<p.Z.SLOT_FORMULA;if(o&&r&&!n)return!1;if(n)return!0;if(t.clearSlots&1<<p.Z.SLOT_EFFIECTIVE_VALUE)return!0;if(o)return!0;var a=t.delta.userEnteredFormatDelta;if(a){if(a.clearSlots&1<<m.Z.NUMBER_FORMAT)return!0;if(a.setSlots&1<<m.Z.NUMBER_FORMAT)return!0}return!1},o.getIsLastMutationLocal=function(){return this.isLastMutationLocal},o.resetSheet=function(e){var t;this.isInWorker||null===(t=this.mainThreadWorker)||void 0===t||t.sheetData.resetSheetOnWorkerFormula({sheetId:e}),this.sheetFormulaLayerStatusMap.resetSheet(e),this.formulaController.destroy()},o.setCellPropertiesMutationForDataValidation=function(e){var t=e.gridRange,r=e.cellDataDelta;if(!r)return null;if(r.setSlots&1<<p.Z.SLOT_DATA_VALIDATION_RULE){var o=null===r||void 0===r?void 0:r.delta.dataValidation;o&&this.formulaController.addCustomNodes(fe.B.DataValidation,[{dataValidation:o,ruleRange:t}])}r.clearSlots&1<<p.Z.SLOT_DATA_VALIDATION_RULE&&this.formulaController.removeCustomNodes(fe.B.DataValidation,[{ruleRange:t}])},o.setRangeMutationForDataValidation=function(e){var t=e.gridRange,r=e.cellDataDeltaAtPositions;if(!r)return null;var o=[],n=[];r.forEach((function(e){var r=e.cellDataDelta;if(!r)return null;var a=e.colIndex,s=e.rowIndex,i=t.sheetId;if(r.setSlots&1<<p.Z.SLOT_DATA_VALIDATION_RULE){var l=null===r||void 0===r?void 0:r.delta.dataValidation;l&&o.push({dataValidation:l,ruleRange:new f.Z(i,s,s,a,a)})}r.clearSlots&1<<p.Z.SLOT_DATA_VALIDATION_RULE&&n.push({ruleRange:new f.Z(i,s,s,a,a)})})),o.length>0&&this.formulaController.addCustomNodes(fe.B.DataValidation,o),n.length>0&&this.formulaController.removeCustomNodes(fe.B.DataValidation,n)},o.initCalculatePlugin=function(){this.calcPluginManager.register(new ut(this.valueCache)),this.calcPluginManager.register(new st(this.valueCache,{getRealCellFormat:this.getRealCellFormat})),this.calcPluginManager.register(new Tt({getActiveView:this.getActiveView,getDataPositionByFilterViewPosition:this.getDataPositionByFilterViewPosition,getFilterViewPositionByDataPosition:this.getFilterViewPositionByDataPosition,getSheetBySheetId:this.getSheetBySheetId,getSheetIdsAmongTwoSheets:this.getSheetIdsAmongTwoSheets,getFormulaDataByRowCol:this.getFormulaDataByRowCol})),this.calcPluginManager.register(new wt(this.valueCache))},o.mutationHandlerBeforeInit=function(e,t,r){var o=Date.now();switch(e.id){case l.ZP.SET_RANGE_MUTATION:case l.ZP.SET_CELL_PROPERTIES_MUTATION:ee(o),this.calculateFormulasAfterSetCellMutation(e,{isCrossSheetMutation:r}),this.mutationForDataValidation(e);break;case l.ZP.INIT_DATA_MUTATION:this.sheetFormulaLayerStatusMap.setWaitingDone(t),this.inPlaybackSheetId=void 0,this.startReCalculateAfterSheetInitial(t)}},o.mutationHandlerInWorkerBeforeInit=function(e){var t;switch(e.id){case l.ZP.DEFINE_WORKBOOK_RANGE_MUTATION:e.workbookRangeType===rt.WORKBOOK_RANGE_TYPE.CHART&&this.formulaController.addCustomNodes(fe.B.Chart,[{workbookRangeId:e.workbookRangeId}]);break;case l.ZP.DELETE_WORKBOOK_RANGE_MUTATION:e.workbookRangeType===rt.WORKBOOK_RANGE_TYPE.CHART&&this.formulaController.removeCustomNodes(fe.B.Chart,[{workbookRangeId:e.workbookRangeId}]);break;case l.ZP.UPDATE_WORKBOOK_RANGE_MUTATION:e.workbookRangeType===rt.WORKBOOK_RANGE_TYPE.CHART&&(this.formulaController.removeCustomNodes(fe.B.Chart,[{workbookRangeId:e.workbookRangeId}]),this.formulaController.addCustomNodes(fe.B.Chart,[{workbookRangeId:e.workbookRangeId}]));break;case l.ZP.ADD_CONDITIONAL_FORMAT_MUTATION:this.formulaController.addCustomNodes(fe.B.ConditionalFormat,[{ruleIndex:e.ruleIndex,rule:e.rule}]);break;case l.ZP.DELETE_CONDITIONAL_FORMAT_MUTATION:this.formulaController.removeCustomNodes(fe.B.ConditionalFormat,[{ruleRanges:e.oldRuleRanges,ruleIndex:e.ruleIndex}]),null===(t=this.formulaController.formulaGraph.getCustomNodePluginManager().getPlugin(fe.B.ConditionalFormat))||void 0===t||t.clearRuleRangeResult(e.oldRuleRanges);break;case l.ZP.UPDATE_CONDITIONAL_FORMAT_MUTATION:this.formulaController.removeCustomNodes(fe.B.ConditionalFormat,[{ruleRanges:e.oldRuleRanges,ruleIndex:e.ruleIndex}]),this.formulaController.addCustomNodes(fe.B.ConditionalFormat,[{ruleIndex:e.ruleIndex,rule:e.rule}]);case l.ZP.REORDER_RANGE_MUTATION:}},o.mutationHandlerAfterInit=function(e,t){var r,o=Date.now(),n=((r={})[l.ZP.REORDER_RANGE_MUTATION]=this.afterReorderRangeMutation,r[l.ZP.SET_DIMENSION_PROPERTIES_MUTATION]=this.afterSetDimensionPropertiesMutation,r[l.ZP.UPDATE_FILTER_MUTATION]=this.afterUpdateFilterMutation,r[l.ZP.DELETE_FILTER_MUTATION]=this.afterUpdateFilterMutation,r[l.ZP.ACTIVE_FILTER_VIEW_MUTATION]=this.afterUpdateFilterMutation,r[l.ZP.MERGE_CELLS_MUTATION]=function(){ee(o)},r);this.formulaController.commitChangingMutation((0,d.Jn)(e));var a=n[e.id];a&&a.call(this,o,e,{mutationAffectedSheetIds:t})},o.afterReorderRangeMutation=function(e,t){ee(e);for(var r=t.sheetId,o=t.range,n=o.endColIndex,a=o.startColIndex,s=o.startRowIndex,i=o.endRowIndex,l=[],u=s;u<=i;u++)for(var d=a;d<=n;d++){var c=this.getFormulaModelByRowCol(u,d,r)||void 0;l.push({row:u,col:d,formulaModel:c,sheetId:r,nodeInfo:void 0})}this.formulaController.commitChangingFormulaNodes(l)},o.afterSetDimensionPropertiesMutation=function(e,t){var r=this;if(t.operation.some((function(e){return e.slot&g.P8.SLOT_HIDDEN}))){ee(e);var o=t.ranges,n=[];o.forEach((function(e){for(var t=e.dimension,o=e.startIndex,a=e.endIndex,s=e.sheetId,i=he.Z.ROWS===t,l=i?o:0,u=i?a:r.countRows(s),d=i?0:o,c=i?r.countCols(s):a,h=l;h<=u;h++)for(var f=d;f<=c;f++){var p=r.getFormulaModelByRowCol(h,f,s)||void 0;n.push({row:h,col:f,formulaModel:p,sheetId:s,nodeInfo:void 0})}})),this.formulaController.commitChangingFormulaNodes(n)}},o.afterUpdateFilterMutation=function(e,t){var r,o;ee(e);var n=t.sheetId,a=this.getSheetBySheetId(n);if(a){var s=null,i=null===(r=a.getBasicFilter())||void 0===r?void 0:r.range,l=this.lastFilterRangeMap[n];if(i?(s=i,this.lastFilterRangeMap[n]=i):l&&(s=l,this.lastFilterRangeMap[n]=null),s){null===(o=this.formulaController.formulaGraph.getCustomNodePluginManager().getPlugin(fe.B.ConditionalFormat))||void 0===o||o.clearRuleRangeResult(s);for(var u=s,d=u.endColIndex,c=u.startColIndex,h=u.startRowIndex,f=u.endRowIndex,p=u.sheetId,m=[],g=h;g<=f;g++)for(var v=c;v<=d;v++){var S=this.getFormulaModelByRowCol(g,v,p)||void 0;m.push({row:g,col:v,formulaModel:S,sheetId:p,nodeInfo:void 0})}this.formulaController.commitChangingFormulaNodes(m)}}},o.calculateFormulasAfterSetCellMutation=function(e,t){var r=t.isCrossSheetMutation;if(this.isInWorker){var o=this.getChangeNodesByMutation(e,r),n=this.sheetFormulaLayerStatusMap.isSheetInitialized(e.gridRange.sheetId);this.formulaController.commitChangingFormulaNodes(o,n)}},o.getChangeNodesByMutation=function(e,t){var r=this,o=e.gridRange.sheetId,n=[],a=this.getSheetBySheetId(o),s=null===a||void 0===a?void 0:a.filterViewManager.getActiveFilterView();if(s){var i=s.getBasicFilter();if(i&&i.sortSpecs.length){var l=i.range;null===l||void 0===l||l.each((function(e,t){var a=r.getFormulaModelByRowCol(e,t,o);n.push({row:e,col:t,formulaModel:a||void 0,sheetId:o,nodeInfo:void 0})}))}else n=[]}else n=[];return this.getCellDataDeltaByMutations(e).forEach((function(e){var a=e.cellDataDelta,s=e.rowIndex,i=e.colIndex,l=t?a.delta.formula:r.getFormulaModelByRowCol(s,i,o);r.doesCellDataDeltaChangeFormulaLayer({cellDataDelta:a,formulaModel:l})&&(r.inPlaybackSheetId?l&&n.push({row:s,col:i,formulaModel:l||void 0,sheetId:o,nodeInfo:void 0}):n.push({row:s,col:i,formulaModel:l||void 0,sheetId:o,nodeInfo:void 0}))})),n},o.reportCalculateInfo=function(){var e=this.formulaController.getPerformanceInfo();X(this.graphUpdateTimes,{formulaCount:Y(this.graphUpdateTimes).formulaCount+e.formulaCount}),X(this.graphUpdateTimes,{calculateSingleDuration:Y(this.graphUpdateTimes).calculateSingleDuration+e.calculateDuration}),X(this.graphUpdateTimes,{asyncFormulaCount:Y(this.graphUpdateTimes).asyncFormulaCount+e.asyncFormulaCount}),X(this.graphUpdateTimes,{formatDuration:Y(this.graphUpdateTimes).formatDuration+e.formatDuration}),X(this.graphUpdateTimes,{parseDuration:Y(this.graphUpdateTimes).parseDuration+e.parseDuration}),X(this.graphUpdateTimes,{calculateDuration:Y(this.graphUpdateTimes).calculateDuration+e.calculateFormulaDuration}),X(this.graphUpdateTimes,{calculateCount:Y(this.graphUpdateTimes).calculateCount+e.calculateCount}),X(this.graphUpdateTimes,{nodeSortDuration:Y(this.graphUpdateTimes).nodeSortDuration+e.topSortDuration}),this.formulaController.resetPerformanceInfo(),this.graphUpdateTimes+=1},t}(Qe)},"../spread-sheet/src/core/feature/formula/custom-formula-plugin/type.ts":function(e,t,r){"use strict";var o;r.d(t,{B:function(){return o}}),function(e){e.DataValidation="DATA_VALIDATION",e.ConditionalFormat="CONDITIONAL_FORMAT",e.Chart="CHART"}(o||(o={}))},"../spread-sheet/src/core/utils/linkedRange.ts":function(e,t,r){"use strict";r.d(t,{$q:function(){return s},Tu:function(){return l},XI:function(){return i}}),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.split.js");var o=r("../node_modules/i18next/dist/esm/i18next.js"),n=r("../packages/model/src/range/hexRangeUtils.ts"),a=r("../spread-sheet/src/base/util/url.ts"),s=function(e,t){if(null===t||void 0===t?void 0:t[0]){var r=t[0].linkUrl;if(null===r||void 0===r?void 0:r.split("=")){var o=(null===r||void 0===r?void 0:r.split("="))[1],n=e.workbookRangeManager.getLinkedWorkbookRangeById(o);if(n)return n}}return null},i=function(e,t){var r=s(e,t);if(r){var a=function(e,t){var r=t.sheetId,a=e.sheetManager.getSheetBySheetId(r);if(!a)return o.ZP.t("链接无效");var s=""+(0,n.range2RelativeHex)(t,a);return"'"+a.getTitle()+"'!"+s}(e,r.range);return a}return(null===t||void 0===t?void 0:t.length)?o.ZP.t("链接无效"):""},l=function(e,t){var r=(0,a.lS)(t);return r&&e.sheetManager.hasSheetId(r)?{sheetId:r,title:e.sheetManager.getSheetTitleBySheetId(r)}:null}},"../spread-sheet/src/core/worker/common/action-types.ts":function(e,t,r){"use strict";var o,n,a,s,i,l,u,d,c,h,f;r.d(t,{EA:function(){return s},Pt:function(){return a},SG:function(){return l},WG:function(){return o},_K:function(){return n},bP:function(){return i},be:function(){return c},kV:function(){return u},pS:function(){return d},vW:function(){return f},yZ:function(){return h}}),function(e){e.MessageTest="MESSAGETEST",e.HeartBeatTest="HEARTBEATTEST"}(o||(o={})),function(e){e.SyncAllConfig="SYNCALLCONFIG"}(n||(n={})),function(e){e.InitSpreadsheetApp="INITSPREADSHEETAPP",e.InitSpreadsheet="INITSPREADSHEET",e.InitSheet="INITSHEET",e.LoadSheet="LOADSHEET",e.LoadSheetToWorker="LoadSheetToWorker",e.FetchSheetOnMainThread="FETCHSHEETONMAINTHREAD",e.UpdateSpreadsheet="UPDATESPREADSHEET",e.waittingForWorkerSpreadsheetReady="WAITTINGFORWORKERSPREADSHEETREADY",e.syncVisibleAreaToWorker="SYNCVISIBLEAREATOWORKER",e.resetSheetOnWorkerFormula="RESETSHEETONWORKERFORMULA",e.ClearAndReInitSheets="CLEARANDREINITSHEETS",e.ClearAndReInitOneSheet="ClearAndReInitOneSheet",e.TransformSpreadsheetBySheetId="TRANSFORMSPREADSHEETBYSHEETID",e.InformNetworkChange="InformNetworkChange",e.CheckSheetFormulaLayerStatusBetweenThreads="CheckSheetFormulaLayerStatusBetweenThreads"}(a||(a={})),function(e){e.Xsrf="XSRFTOKEN",e.NowUserIndex="NOWUSERINDEX"}(s||(s={})),function(e){e.SyncNonPersistentMutationsToMainThread="SYNCNONPERSISTENTMUTATIONSTOMAINTHREAD",e.CompleteMutationQueue="CompleteMutationQueue",e.SyncNonPersistentMutationsToWorkerThread="SYNCNONPERSISTENTMUTATIONSTOWORKERTHREAD"}(i||(i={})),function(e){e.MonitorReport="MONITORREPORT",e.TdwReport="TDWREPORT",e.HuatuoReport="HUATUOREPORT",e.TdwSingleReport="TDWSINGLEREPORT",e.DebuggerAlert="DEBUGGERALERT",e.RunReport="RunReport",e.FlowLogReport="FlowLogReport",e.SpeedRunReport="SpeedRunReport",e.SpeedHasDonePagePerformanceReport="SpeedHasDonePagePerformanceReport",e.WebLog="WebLog",e.ZzsStatus="ZzsStatus",e.ZzsValue="ZzsValue",e.tipReport="tipReport",e.ResetDefaultTdwData="ResetDefaultTdwData",e.GetSource1="GetSource1",e.KvrOss="KvrOss",e.Idkey="Idkey"}(l||(l={})),function(e){e.CaptureException="CAPTUREEXCEPTION",e.CaptureWorkerPromiseException="CAPTUREWORKERPROMISEEXCEPTION"}(u||(u={})),function(e){e.Commit="COMMIT",e.AcceptCommit="ACCEPT_COMMIT",e.ApplyNewChanges="APPLY_NEW_CHANGES"}(d||(d={})),function(e){e.DATA_CHANGE="DATA_CHANGE"}(c||(c={})),function(e){e.Service="Service"}(h||(h={})),function(e){e.UPDATE_COLUMN_VALIDATION_STATUS="UPDATE_COLUMN_VALIDATION_STATUS"}(f||(f={}))},"../spread-sheet/src/core/worker/common/channel.ts":function(e,t,r){"use strict";r.d(t,{Z:function(){return u}}),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.map.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/esnext.map.delete-all.js"),r("../node_modules/core-js/modules/esnext.map.every.js"),r("../node_modules/core-js/modules/esnext.map.filter.js"),r("../node_modules/core-js/modules/esnext.map.find.js"),r("../node_modules/core-js/modules/esnext.map.find-key.js"),r("../node_modules/core-js/modules/esnext.map.includes.js"),r("../node_modules/core-js/modules/esnext.map.key-of.js"),r("../node_modules/core-js/modules/esnext.map.map-keys.js"),r("../node_modules/core-js/modules/esnext.map.map-values.js"),r("../node_modules/core-js/modules/esnext.map.merge.js"),r("../node_modules/core-js/modules/esnext.map.reduce.js"),r("../node_modules/core-js/modules/esnext.map.some.js"),r("../node_modules/core-js/modules/esnext.map.update.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../node_modules/core-js/modules/es.array-buffer.constructor.js"),r("../node_modules/core-js/modules/es.array-buffer.slice.js");var o,n=r("../spread-sheet/src/base/util/timer.ts");!function(e){e.REQUEST="REQUEST",e.REPLY="REPLY"}(o||(o={}));var a=r("../spread-sheet/src/core/worker/config.ts"),s=r("../spread-sheet/src/core/worker/util.ts"),i=(r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.object.keys.js"),r("../packages/report/src/index.ts")),l=function(){function e(e){var t=this;this.actionLetencyCountMap={},this.isDebugMode=e,n.Z.wait(6e4).run((function(){t.letencyReport()}))}var t=e.prototype;return t.letencyLog=function(e){(0,s.PQ)()-e.time<150||(this.actionLetencyCountMap[e.actionType]=(this.actionLetencyCountMap[e.actionType]||0)+1)},t.timeoutReport=function(e){i.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"channel_time_out",ver5:JSON.stringify(e)})},t.requestDurationReport=function(e,t,r){if(e>t){var o={actionType:r,duration:e,inWorker:void 0};i.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"channel_long_time",ver5:JSON.stringify(o)})}},t.onmesssageDebugLog=function(e){},t.postMessageDebugLog=function(e){},t.letencyReport=function(){var e;if(0!==Object.keys(this.actionLetencyCountMap).length){var t={worker:void 0,letency:this.actionLetencyCountMap};null===(e=r.g.log)||void 0===e||e.info("worker channel letency",t),i.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"channel_letency",ver5:JSON.stringify(t)}),this.actionLetencyCountMap={}}},e}(),u=function(){function e(e,t){this.worker=e,this.controller=t,this.sessionHandlerMap=new Map,this.channelReport=new l(this.controller.isDebugMode),this.worker.addEventListener("message",this.onmessage.bind(this))}var t=e.prototype;return t.request=function(e,t){var r=this.generateSessionId();this.postMessage({messageType:o.REQUEST,actionType:e,payload:t,sessionId:r,time:(0,s.PQ)()}),this.addSessionHandler(r,(function(){}))},t.requestPromise=function(e,t,r){var i=this;void 0===r&&(r=a.Ob);var l=Date.now(),u=this.generateSessionId(),d={messageType:o.REQUEST,actionType:e,payload:t,sessionId:u,time:(0,s.PQ)()},c=0;return c=n.Z.wait(r).run((function(){n.Z.erase(c),i.channelReport.timeoutReport({actionType:e,isInWorker:void 0})})),new Promise((function(t){i.addSessionHandler(u,(function(o){i.deleteSessionHandler(o.sessionId),n.Z.erase(c);var a=Date.now()-l;i.channelReport.requestDurationReport(a,r,e),t(o.payload)})),i.postMessage(d)}))},t.onmessage=function(e){var t,r=this,n=e.data;if(n){var a=n.messageType,s=n.sessionId,i=n.actionType;if(this.channelReport.letencyLog(n),this.channelReport.onmesssageDebugLog(n),a===o.REQUEST)this.controller.actionHandler(n).then((function(e){r.response(s,i,e)}));else if(a===o.REPLY){if(!this.hasSessionHandler(s))throw new Error("没有找到会话 `"+s+"` 的响应器.");null===(t=this.sessionHandlerMap.get(s))||void 0===t||t(n)}}},t.response=function(e,t,r){this.postMessage({messageType:o.REPLY,actionType:t,payload:r,sessionId:e,time:(0,s.PQ)()})},t.postMessage=function(e){var t=e.payload,r=[];(null===t||void 0===t?void 0:t.transferProps)&&t.transferProps.forEach((function(e){Object.prototype.hasOwnProperty.call(t,e)?t[e]instanceof ArrayBuffer?r.push(t[e]):t[e].buffer?t[e].buffer instanceof ArrayBuffer&&r.push(t[e].buffer):console.error("Payload porps "+e+" without buffer"):console.error("Payload without porps "+e)})),this.worker.postMessage(e,r),this.channelReport.postMessageDebugLog(e)},t.addSessionHandler=function(e,t){if(this.hasSessionHandler(e))throw new Error("会话 Id `"+e+"` 已经存在, 这不可能!");this.sessionHandlerMap.set(e,t)},t.deleteSessionHandler=function(e){this.hasSessionHandler(e)&&this.sessionHandlerMap.delete(e)},t.generateSessionId=function(){return"w_"+(0,s.M0)(14)},t.hasSessionHandler=function(e){return this.sessionHandlerMap.has(e)},e}()},"../spread-sheet/src/core/worker/config.ts":function(e,t,r){"use strict";r.d(t,{Ob:function(){return o},R5:function(){return a},UO:function(){return n},lK:function(){return s}});var o=3e4,n=5e3,a=3e4,s=1e4},"../spread-sheet/src/core/worker/util.ts":function(e,t,r){"use strict";function o(){return-1!==navigator.userAgent.indexOf("msie")||-1!==navigator.userAgent.indexOf("rv:11")||!!window.ActiveXObject||"ActiveXObject"in window}function n(){var e=navigator.userAgent.match(/_tdocFlag\/(\d+)/);return!!(null===e||void 0===e?void 0:e[1])&&!!(2&parseInt(e[1],10))}function a(e){return!!e&&("object"===typeof e||"function"===typeof e)&&"function"===typeof e.then}function s(){return"undefined"===typeof performance?Date.now():performance.timeOrigin&&performance.now?performance.timeOrigin+performance.now():Date.now()}function i(e){void 0===e&&(e=21);for(var t="-_",r=36;r;)t+=(r-=1).toString(36);for(r=36;r-10;)t+=(r-=1).toString(36).toUpperCase();for(var o=e,n="";o;)o-=1,n+=t[64*Math.random()|0];return n}r.d(t,{M0:function(){return i},PQ:function(){return s},tI:function(){return a},w1:function(){return o},xc:function(){return n}}),r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.match.js"),r("../node_modules/core-js/modules/es.array.slice.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js")},"../spread-sheet/src/core/worker/worker-thread/index.ts":function(e,t,r){"use strict";r.d(t,{Z:function(){return Nr}}),r("../node_modules/core-js/modules/web.dom-collections.for-each.js"),r("../spread-sheet/src/core/worker/worker-thread/polyfill.ts"),r("../spread-sheet/src/base/i18nInit.ts");var o,n=r("../node_modules/@tencent/containerized/build/main/index.js"),a=(0,n.yh)("IWorkerThreadController"),s=r("../node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js"),i=r("../node_modules/@babel/runtime/helpers/esm/inheritsLoose.js"),l=r("../packages/report/src/index.ts"),u=r("../spread-sheet/src/core/worker/common/base-controller.ts"),d=(r("../spread-sheet/src/core/worker/common/channel.ts"),u.Z,(0,n.yh)("IWorkerThreadCookie")),c=(r("../node_modules/core-js/modules/es.object.get-own-property-descriptor.js"),r("../node_modules/core-js/modules/esnext.reflect.metadata.js"),r("../spread-sheet/src/core/worker/common/action-types.ts")),h=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},f=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},p=function(e,t){return function(r,o){t(r,o,e)}},m=function(){function e(e){this.controller=e}var t=e.prototype;return t.getXsrf=function(){return this.controller.requestPromise(c.EA.Xsrf,"")},t.getNowUserIndex=function(){return this.controller.requestPromise(c.EA.NowUserIndex,"")},e}();m=h([p(0,a),f("design:paramtypes",["function"===typeof(o="undefined"!==typeof a&&a)?o:Object])],m);var g,v=(0,n.yh)("IWorkerThreadCharts"),S=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},y=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},I=function(e,t){return function(r,o){t(r,o,e)}},R=function(){function e(e){this.controller=e}return e.prototype.triggerDataChange=function(e){var t=e.workbookRangeId;return this.controller.requestPromise(c.be.DATA_CHANGE,{workbookRangeId:t})},e}();R=S([I(0,a),y("design:paramtypes",["function"===typeof(g="undefined"!==typeof a&&a)?g:Object])],R);var C,T,w,A,D=(0,n.yh)("IWorkerThreadMessageCenterData"),b=(r("../node_modules/core-js/modules/es.array.filter.js"),r("../node_modules/core-js/modules/es.array.map.js"),r("../packages/mutation/src/MutationId.ts")),M=r("../spread-sheet/src/core/network/message-center/model/userChange-helper.ts"),k=r("../spread-sheet/src/core/network/message-center/model/missChange-helper.ts"),E=(0,n.yh)("IWorkerThreadMutationData"),_=(0,n.yh)("IWorkerThreadSheetData"),j=(0,n.yh)("IFormulaResultCacheCommit"),F=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},N=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},O=function(e,t){return function(r,o){t(r,o,e)}},x=function(){function e(e,t,r,o){var n=this;this.controller=e,this.mutationData=t,this.sheetData=r,this.formulaResultCacheCommit=o,this.handleCommit=function(e){var t=(0,M.bR)(e.userChangeOptions),r=t.mutations,o=t.sheetId,a=t.isWorkbook;if(null!==e.mutationQueueId&&n.mutationData.setMutationQueueId(e.mutationQueueId),n.formulaResultCacheCommit.changeToCommitStatus(e.userChangeOptions.baseVersion),n.sheetData.isSheetDataReady){if(!a&&!n.sheetData.isSheetLoadedInSpreadsheet(o)){var s=n.filterMultiSheetMutations(r);return s.length&&(t.mutations=s,n.sheetData.spreadsheetApp.messageCenterAdapter.sendMessageCenterAdapter.commit(t),n.mutationData.setMuationQueueRunnedIndex(-1)),void n.mutationData.completeMutationQueue({mutationQueueId:e.mutationQueueId})}}else if(!a)return void n.sheetData.userChangeUnAccepted.push(t);n.sheetData.spreadsheetApp.messageCenterAdapter.sendMessageCenterAdapter.commit(t)},this.handleAcceptCommit=function(e){var t=(0,M.bR)(e.userChange);n.sheetData.spreadsheetApp.messageCenterAdapter.sendMessageCenterAdapter.handleAcceptCommit(e.sheetId,e.newVersion,t),n.formulaResultCacheCommit.changeToAcceptStatus(e.newVersion),n.sheetData.userChangeUnAccepted=n.sheetData.userChangeUnAccepted.filter((function(e){return e.sheetId!==t.sheetId||e.taskId!==t.taskId}))},this.handleApplyNewChanges=function(e){var t=(0,k.Ey)(e.changeInfoOptions);void 0!==e.mutationQueueId&&n.mutationData.setMutationQueueId(e.mutationQueueId);var r=t.sheetId;if(!t.isWorkbook&&!n.sheetData.isSheetLoadedInSpreadsheet(r)&&!t.head)return n.sheetData.spreadsheetApp.messageCenterAdapter.receiveMessageCenterAdapter.currentVersion=t.newVersion,void n.mutationData.completeMutationQueue({mutationQueueId:e.mutationQueueId});n.formulaResultCacheCommit.addIgnoreVersion(t.newVersion),n.sheetData.spreadsheetApp.messageCenterAdapter.receiveMessageCenterAdapter.applyNewChanges(t)},this.addActionListener()}var t=e.prototype;return t.addActionListener=function(){this.controller.addActionHandler(c.pS.Commit,this.handleCommit),this.controller.addActionHandler(c.pS.AcceptCommit,this.handleAcceptCommit),this.controller.addActionHandler(c.pS.ApplyNewChanges,this.handleApplyNewChanges)},t.filterMultiSheetMutations=function(e){var t=e.map((function(e){return e.filter((function(e){return!!e.isMultiSheetMutation()||e.id===b.ZP.SET_SHEET_PROPERTIES_MUTATION}))}));return t=t.filter((function(e){return e.length}))},e}();x=F([O(0,a),O(1,E),O(2,_),O(3,j),N("design:paramtypes",["function"===typeof(C="undefined"!==typeof a&&a)?C:Object,"function"===typeof(T="undefined"!==typeof E&&E)?T:Object,"function"===typeof(w="undefined"!==typeof _&&_)?w:Object,"function"===typeof(A="undefined"!==typeof j&&j)?A:Object])],x);var L,P,B,U=r("../node_modules/lodash/debounce.js"),V=r.n(U),Z=r("../spread-sheet/src/core/app/spreadsheet-app-worker.interface.ts"),W=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},H=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},G=function(e,t){return function(r,o){t(r,o,e)}},z=function(){function e(e,t,r){this.controller=e,this.app=t,this.formulaResultCacheCommit=r,this.debounceCacheFormulaResult=V()(this.cacheFormulaResult,3e3),this.muationQueueRunnedIndex=-1,this.addListenActions()}var t=e.prototype;return t.setMutationQueueId=function(e){this.mutationQueueId=e},t.getMutationQueueId=function(){var e=this.mutationQueueId;return"number"===typeof e?e:-1},t.setMuationQueueRunnedIndex=function(e){this.muationQueueRunnedIndex=e},t.completeMutationQueue=function(e){return this.controller.requestPromise(c.bP.CompleteMutationQueue,e)},t.syncNonPersistentMutationsToMainThread=function(e){var t=this,r=e.mutations,o=e.isFromFormula,n=e.needToSetIntializedDone,a=e.isInVisibleArea,s=e.relatedSheetIds,i=e.canCheckUnfinishedCalculationNode,l={serializedMutations:r.map((function(e){return t.app.mutationBehavior.serializeMutation(e)})),isFromFormula:o,latestMutationQueueIdInWorker:this.getMutationQueueId(),needToSetIntializedDone:n,isInVisibleArea:a,relatedSheetIds:s,canCheckUnfinishedCalculationNode:i,muationQueueRunnedIndex:this.muationQueueRunnedIndex};return this.controller.requestPromise(c.bP.SyncNonPersistentMutationsToMainThread,l)},t.syncNonPersistentMutationsToWorkerThread=function(e){var t,r=this;return e.serializedMutations.reduce((function(e,t){var o=r.app.mutationBehavior.deserializeMutation(t);return o&&e.push(o),e}),[]).forEach((function(e){r.app.mutationBehavior.applyMutation(e,{isLocal:!0})})),null===(t=Nr.workerThreadWorker.sheetData.calcController)||void 0===t||t.startCalculate(),!0},t.cacheFormulaResult=function(e){var t=this.app.messageCenter.versionManager.getCurrentVersion();0===t||this.app.spreadsheet.getActiveFilterView()||this.formulaResultCacheCommit.commit(t,e)},t.addListenActions=function(){this.controller.addActionHandler(c.bP.SyncNonPersistentMutationsToWorkerThread,this.syncNonPersistentMutationsToWorkerThread.bind(this))},e}();z=W([G(0,a),G(1,Z.m),G(2,j),H("design:paramtypes",["function"===typeof(L="undefined"!==typeof a&&a)?L:Object,"function"===typeof(P="undefined"!==typeof Z.m&&Z.m)?P:Object,"function"===typeof(B="undefined"!==typeof j&&j)?B:Object])],z);var Q,K=(0,n.yh)("IWorkerThreadRaven"),q=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Y=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},X=function(e,t){return function(r,o){t(r,o,e)}},$=function(){function e(e){this.controller=e,self.Raven=this}var t=e.prototype;return t.captureException=function(e,t){var r={errorString:"object"===typeof e?e.message:"string"!==typeof e?"no-message":e,params:t};this.controller.request(c.kV.CaptureException,r)},t.captureWorkerPromiseException=function(e,t){this.controller.request(c.kV.CaptureWorkerPromiseException,{message:e,stack:t})},e}();$=q([X(0,a),Y("design:paramtypes",["function"===typeof(Q="undefined"!==typeof a&&a)?Q:Object])],$);var J,ee=(0,n.yh)("IWorkerThreadReport"),te=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},re=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},oe=function(e,t){return function(r,o){t(r,o,e)}},ne=function(){function e(t){var r=this;this.controller=t;var o={};["debug","info","warn","error","log","config","report"].forEach((function(e){o[e]=function(){for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];r.controller.request(c.SG.WebLog,{level:e,args:o})}})),this.log=o,self.log=this.log,self.reportProxy=l.ZP,e.loadRealReport(this)}e.loadRealReport=function(e){l.O8.eachLoad({run:e.run.bind(e),speed:{runReport:function(){},hasDonePagePerformanceReport:function(){return!0}},jank:{log:function(){},startMonitor:function(){}},tdwReport:e.tdwReport.bind(e),tdwSingleReport:e.tdwSingleReport.bind(e),monitor:e.monitor.bind(e),huatuo:e.huatuo.bind(e),retcode:function(){},tam:{reportTime:function(){},reportEvent:function(){}},zzsStatus:e.zzsStatus.bind(e),zzsValue:e.zzsValue.bind(e),tipReport:e.tipReport.bind(e),resetDefaultTdwData:e.resetDefaultTdwData.bind(e),getSource1:e.getSource1.bind(e),kvrOss:e.kvrOss.bind(e),idkey:e.idkey.bind(e)})};var t=e.prototype;return t.monitor=function(e){this.controller.request(c.SG.MonitorReport,e)},t.tdwReport=function(e){this.controller.request(c.SG.TdwReport,e)},t.huatuo=function(e){this.controller.request(c.SG.HuatuoReport,e)},t.tdwSingleReport=function(e){this.controller.request(c.SG.TdwSingleReport,e)},t.run=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.controller.request(c.SG.RunReport,{args:t})},t.speedHasDonePagePerformanceReport=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.controller.request(c.SG.SpeedHasDonePagePerformanceReport,{args:t})},t.flowLog=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.controller.request(c.SG.FlowLogReport,{args:t})},t.debuggerAlert=function(e){this.controller.request(c.SG.DebuggerAlert,e)},t.zzsStatus=function(e){this.controller.request(c.SG.ZzsStatus,e)},t.zzsValue=function(e){this.controller.request(c.SG.ZzsValue,e)},t.tipReport=function(e){this.controller.request(c.SG.tipReport,e)},t.resetDefaultTdwData=function(e){this.controller.request(c.SG.ResetDefaultTdwData,e)},t.getSource1=function(e){this.controller.request(c.SG.GetSource1,e)},t.kvrOss=function(e){this.controller.request(c.SG.KvrOss,e)},t.idkey=function(e){this.controller.request(c.SG.Idkey,e)},e}();ne=te([oe(0,a),re("design:paramtypes",["function"===typeof(J="undefined"!==typeof a&&a)?J:Object])],ne);var ae,se=(0,n.yh)("IWorkerThreadWorkerAbilityTest"),ie=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},le=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},ue=function(e,t){return function(r,o){t(r,o,e)}},de=function(){function e(e){this.controller=e,this.addActionListener()}var t=e.prototype;return t.addActionListener=function(){this.controller.addActionHandler(c.WG.MessageTest,this.messageTestHandler.bind(this)),this.controller.addActionHandler(c.WG.HeartBeatTest,this.heartBeatTestHandler.bind(this))},t.messageTestHandler=function(e){return Date.now()-e},t.heartBeatTestHandler=function(e){return e},e}();de=ie([ue(0,a),le("design:paramtypes",["function"===typeof(ae="undefined"!==typeof a&&a)?ae:Object])],de);var ce,he=(0,n.yh)("IWorkerThreadCacConfigSync"),fe=r("../spread-sheet/src/base/util/appConfig.ts"),pe=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},me=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},ge=function(e,t){return function(r,o){t(r,o,e)}},ve=function(){function e(e){this.controller=e,this.cacSyncHandler=function(e){fe.Z.bind(e)},this.addActionListener()}return e.prototype.addActionListener=function(){this.controller.addActionHandler(c._K.SyncAllConfig,this.cacSyncHandler)},e}();ve=pe([ge(0,a),me("design:paramtypes",["function"===typeof(ce="undefined"!==typeof a&&a)?ce:Object])],ve);var Se,ye,Ie,Re,Ce,Te,we,Ae,De,be,Me,ke,Ee=(0,n.yh)("IWorkerThreadWorker"),_e=(0,n.yh)("IDynamic"),je=(0,n.yh)("IWorkerThreadColumnDataValidation"),Fe=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Ne=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Oe=function(e,t){return function(r,o){t(r,o,e)}},xe=function(e,t,r,o,n,a,s,i,l,u,d,c){this.controller=e,this.workerAbilityTest=t,this.report=r,this.raven=o,this.cookie=n,this.charts=a,this.mutationData=s,this.sheetData=i,this.messageCenterData=l,this.dynamic=u,this.columnDataValidation=d,this.cacConfigSync=c};xe=Fe([Oe(0,a),Oe(1,se),Oe(2,ee),Oe(3,K),Oe(4,d),Oe(5,v),Oe(6,E),Oe(7,_),Oe(8,D),Oe(9,_e),Oe(10,je),Oe(11,he),Ne("design:paramtypes",["function"===typeof(Se="undefined"!==typeof a&&a)?Se:Object,"function"===typeof(ye="undefined"!==typeof se&&se)?ye:Object,"function"===typeof(Ie="undefined"!==typeof ee&&ee)?Ie:Object,"function"===typeof(Re="undefined"!==typeof K&&K)?Re:Object,"function"===typeof(Ce="undefined"!==typeof d&&d)?Ce:Object,"function"===typeof(Te="undefined"!==typeof v&&v)?Te:Object,"function"===typeof(we="undefined"!==typeof E&&E)?we:Object,"function"===typeof(Ae="undefined"!==typeof _&&_)?Ae:Object,"function"===typeof(De="undefined"!==typeof D&&D)?De:Object,"function"===typeof(be="undefined"!==typeof _e&&_e)?be:Object,"function"===typeof(Me="undefined"!==typeof je&&je)?Me:Object,"function"===typeof(ke="undefined"!==typeof he&&he)?ke:Object])],xe),r("../node_modules/regenerator-runtime/runtime.js"),r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.array.iterator.js"),r("../node_modules/core-js/modules/es.map.js"),r("../node_modules/core-js/modules/es.string.iterator.js"),r("../node_modules/core-js/modules/esnext.map.delete-all.js"),r("../node_modules/core-js/modules/esnext.map.every.js"),r("../node_modules/core-js/modules/esnext.map.filter.js"),r("../node_modules/core-js/modules/esnext.map.find.js"),r("../node_modules/core-js/modules/esnext.map.find-key.js"),r("../node_modules/core-js/modules/esnext.map.includes.js"),r("../node_modules/core-js/modules/esnext.map.key-of.js"),r("../node_modules/core-js/modules/esnext.map.map-keys.js"),r("../node_modules/core-js/modules/esnext.map.map-values.js"),r("../node_modules/core-js/modules/esnext.map.merge.js"),r("../node_modules/core-js/modules/esnext.map.reduce.js"),r("../node_modules/core-js/modules/esnext.map.some.js"),r("../node_modules/core-js/modules/esnext.map.update.js"),r("../node_modules/core-js/modules/web.dom-collections.iterator.js"),r("../node_modules/core-js/modules/es.object.keys.js"),r("../node_modules/core-js/modules/es.array.join.js");var Le,Pe,Be,Ue,Ve,Ze,We=r("../spread-sheet/src/flow/browser/phase/services/workerService.interface.ts"),He=r("./node_modules/axios/index.js"),Ge=r.n(He),ze=r("../packages/model/src/spreadsheet/Spreadsheet.ts"),Qe=r("../spread-sheet/src/base/event/event.ts"),Ke=r("../spread-sheet/src/base/util/timer.ts"),qe=r("../spread-sheet/src/core/worker/util.ts"),Ye=r("../spread-sheet/src/core/feature/formula/controller.ts"),Xe=r("../packages/model/src/spreadsheet/SpreadsheetType.ts"),$e=r("../packages/model/src/new-embedded/EmbeddedObject.ts"),Je=r("../packages/model/src/spreadsheet/Spreadsheet.interface.ts"),et=r("../spread-sheet/src/core/data/converter/tencentdoc/keyframeToSheetConverter.ts"),tt=r("../spread-sheet/src/core/data/converter/tencentdoc/handleKeyframe/keyframeOne.ts"),rt=r("../spread-sheet/src/base/config/version.ts"),ot=r("../node_modules/@babel/runtime/helpers/esm/toConsumableArray.js"),nt=r("../node_modules/@babel/runtime/helpers/esm/createClass.js"),at=(r("../node_modules/core-js/modules/es.number.constructor.js"),r("../node_modules/core-js/modules/es.array.concat.js"),r("../packages/mutation/src/MutationOperationType.ts")),st=r("../packages/lib/index.ts"),it=r("../node_modules/@tencent/docs-collab/lib/src/task/CollabTask.js"),lt=r.n(it),ut=r("../node_modules/@tencent/docs-collab/lib/src/model/ServerUserChange.js"),dt=r.n(ut),ct=function(){function e(e,t){this._onBeforeApplyCollabMutations=new st.Q5,this.onBeforeApplyCollabMutations=this._onBeforeApplyCollabMutations.event,this.messageCenter=e,this.dependency=t}var t=e.prototype;return t.handleApplyNewChanges=function(e){var t=new(lt())(e.taskId,new(dt())(e),{versionManager:this.messageCenter.versionManager,missChangeDependency:{getMissChangesUrl:this.messageCenter.getFetchMissChangesUrl,globalPadId:Nr.workerThreadWorker.sheetData.spreadsheet.getSpreadsheetId()},acceptCommitDependency:{getMissChangesUrl:this.messageCenter.getFetchMissChangesUrl,acceptCommit:this.dependency.acceptCommit,applyServerUserChanges:this.applyNewChanges.bind(this)}});this.messageCenter.taskQueueManager.pushTask(t)},t.applyNewChanges=function(e){return Nr.workerThreadWorker.sheetData.spreadsheetApp.behavior.apply({type:"collab",sheetId:e.sheetId,requestId:-1,canUndoRedo:!1,opt:e}).then((function(){var e;null===(e=Nr.workerThreadWorker.sheetData.calcController)||void 0===e||e.startCalculate()})).catch((function(){return console.error("worker apply collab error"),!1})),!0},t.onApplyNewChanges=function(e){var t=e.changeInfo,r=e.mutations;try{t.revert||this.applyCollabMutations(r,t),this.messageCenter.versionManager.updateVersion(t.newVersion)}catch(o){console.error("worker alloyCollabMutations error")}},t.applyCollabMutations=function(e,t){var r={newVersion:t.newVersion,requestMutations:Nr.workerThreadWorker.sheetData.spreadsheetApp.mutationBehavior.deSerializeRequests(e)};this._onBeforeApplyCollabMutations.fire(r);var o=[];r.requestMutations.forEach((function(e){o=o.concat(e)})),this.applyInDataAndView(o)},t.applyInDataAndView=function(e){e.forEach((function(e,t){var r=e;Nr.workerThreadWorker.mutationData.setMuationQueueRunnedIndex(t),r.operationType=at.Z.COLLAB,Nr.workerThreadWorker.sheetData.spreadsheetApp.mutationBehavior.applyMutation(r,{isLocal:!1,isCollab:!0})}))},(0,nt.Z)(e,[{key:"currentVersion",get:function(){return this.messageCenter.versionManager.getCurrentVersion()},set:function(e){this.messageCenter.versionManager.updateVersion(e)}}]),e}(),ht=ct,ft=r("../node_modules/@tencent/docs-collab/lib/src/task/AcceptTask.js"),pt=r.n(ft),mt=function(){function e(e,t){this.waitingQueue=[],this.messageCenter=e,this.dependency=t}var t=e.prototype;return t.commit=function(e){e.mutations&&e.mutations.length>0&&(e.mutations.forEach((function(e){e.forEach((function(e,t){Nr.workerThreadWorker.mutationData.setMuationQueueRunnedIndex(t),Nr.workerThreadWorker.sheetData.spreadsheetApp.mutationBehavior.applyMutation(e,{isLocal:!0})}))})),Nr.workerThreadWorker.sheetData.calcController.startCalculate(),this.waitingQueue.push(e))},t.handleAcceptCommit=function(e,t,r,o){void 0===o&&(o=!1);var n=new(pt())({to:t,versionManager:this.messageCenter.versionManager,acceptCommitDependency:{acceptCommit:this.acceptCommit.bind(this),applyServerUserChanges:this.dependency.applyServerUserChanges,getMissChangesUrl:this.messageCenter.getFetchMissChangesUrl},missChangeDependency:{getMissChangesUrl:this.messageCenter.getFetchMissChangesUrl,globalPadId:Nr.workerThreadWorker.sheetData.spreadsheet.getSpreadsheetId()},taskId:r.taskId,otherOptions:{sheetId:e,isNeedKeyframe:o}});this.messageCenter.taskQueueManager.pushTask(n)},t.acceptCommit=function(e,t){this.messageCenter.versionManager.updateVersion(e),this.waitingQueue=this.waitingQueue.filter((function(e){return e.taskId!==t}))},e}(),gt=r("../spread-sheet/src/core/network/message-center/model/PendingControl.ts"),vt=r("../spread-sheet/src/core/network/message-center/base/BaseMessageCenterAdapter.ts"),St=r("../node_modules/@tencent/docs-collab/lib/src/BaseMessageCenter.js"),yt=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))},It=function(e){function t(t){var o,n;return(o=e.call(this,t.baseVersion)||this)._onAcceptCommit=new st.Q5,o.onAcceptCommit=o._onAcceptCommit.event,null===(n=r.g.log)||void 0===n||n.debug("WorkerMessageCenter created"),o.dependency=t,o.taskQueueManager.onTaskError((function(){o.onTaskError()})),o}(0,i.Z)(t,e);var o=t.prototype;return o.dispose=function(){var t;e.prototype.dispose.call(this),this._onAcceptCommit.dispose(),null===(t=r.g.log)||void 0===t||t.info("WorkerMessageCenter dispose")},o.handleAcceptCommit=function(e,t){var o;null===(o=r.g.log)||void 0===o||o.info("WorkerMessageCenter acceptCommit, newVersion="+e),e>this.versionManager.getCurrentVersion()&&this.versionManager.updateVersion(e),this._onAcceptCommit.fire({newVersion:e,taskId:t})},o.handleApplyServerUserChange=function(e){var t,o,n;try{null===(o=(t=this.dependency.collabDependency).applyServerUserChanges)||void 0===o||o.call(t,e.getData());var a=e.getVersion();a>this.versionManager.getCurrentVersion()&&this.versionManager.updateVersion(a)}catch(s){null===(n=r.g.log)||void 0===n||n.error("SendMessageManager handleApplyServerUserChange onApplyServerUserChanges error, error = ",s)}},o.getFetchMissChangesUrl=function(e){return yt(this,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,k.mb)({padId:e.globalPadId,revLower:e.from,revUpper:e.to});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))},o.onTaskError=function(){var e;null===(e=r.g.log)||void 0===e||e.error("WorkerMessageCenter onTaskError"),this.pause()},t}(r.n(St)()),Rt=r("../spread-sheet/src/core/app/SpreadsheetApp.interface.ts"),Ct=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Tt=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},wt=function(e,t){return function(r,o){t(r,o,e)}},At=function(e){function t(t,o){var n,a;return(n=e.call(this)||this).app=t,n.handleStartLoadData=function(e){var t=e.sheetId;n.pendingControl.startLoadSheet(t)&&(n.halfReplaySheets=n.pendingControl.sheet,1===n.pendingControl.loadingCount&&n.messageCenter.taskQueueManager.pause())},n.handleAfterLoadData=function(e){var t=e.sheetId;n.pendingControl.finishLoadSheet(t)&&0===n.pendingControl.loadingCount&&(n.messageCenter.taskQueueManager.resume(),n.applyFormulaModel())},null===(a=r.g.log)||void 0===a||a.info("初始化worker messageCenter"),n.pendingControl=new gt.Z,n.messageCenter=new It({baseVersion:o,collabDependency:{checkIfNeedFollow:function(){return!0},follow:n.followRequestMutations.bind((0,s.Z)(n)),applyServerUserChanges:function(){var e;return(e=n.receiveMessageCenterAdapter).handleApplyNewChanges.apply(e,arguments)}}}),n.sendMessageCenterAdapter=new mt(n.messageCenter,{applyServerUserChanges:function(e){return n.receiveMessageCenterAdapter.applyNewChanges(e)}}),n.receiveMessageCenterAdapter=new ht(n.messageCenter,{acceptCommit:n.sendMessageCenterAdapter.acceptCommit}),n.initEvents(),n}(0,i.Z)(t,e);var o=t.prototype;return o.initEvents=function(){Qe.ZP.default.listen("startLoadData",this.handleStartLoadData),Qe.ZP.default.listen("afterLoadData",this.handleAfterLoadData)},o.followRequestMutations=function(e,t,r){var o=JSON.parse(e),n=JSON.parse(t),a=Nr.workerThreadWorker.sheetData.spreadsheetApp.mutationBehavior.followRequestMutations(o,n,r),s=[];return a.forEach((function(e){var t=[];e.forEach((function(e){var r=Nr.workerThreadWorker.sheetData.spreadsheetApp.mutationBehavior.serializeMutation(e);t.push(r)})),s.push(t)})),JSON.stringify(s)},o.applyFormulaModel=function(){var e=this,t=this.sendMessageCenterAdapter.waitingQueue,r=[];t.forEach((function(e){e.mutations&&e.mutations.length>0&&e.mutations.forEach((function(e){r.push.apply(r,(0,ot.Z)(e))}))})),r.forEach((function(t){Qe.ZP.spreadsheetEvent.trigger("afterMutationRun",{sheetId:e.halfReplaySheets,mutation:t,sType:Xe.Z.NORMAL,isLocal:!0,isFromFormula:!1,isCollab:!1,isReplay:!1})}))},(0,nt.Z)(t,[{key:"currentVersion",get:function(){return this.messageCenter.versionManager.getCurrentVersion()}}]),t}(vt.Z),Dt=At=Ct([wt(0,Rt.m),Tt("design:paramtypes",["function"===typeof(Le="undefined"!==typeof Rt.m&&Rt.m)?Le:Object,Number])],At),bt=r("../node_modules/lodash/isString.js"),Mt=r.n(bt),kt=r("../spread-sheet/src/core/feature/formula/custom-formula-plugin/type.ts"),Et=r("../packages/model/src/workbookRange/index.ts"),_t=r("../packages/model/src/spreadsheet/index.ts"),jt=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Ft=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Nt=function(e,t){return function(r,o){t(r,o,e)}},Ot=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))},xt=function(){function e(e,t,r,o,n){var a=this;this.instantiationService=e,this.spreadsheetApp=t,this.controller=r,this.cookie=o,this.mutationData=n,this.isSheetDataReady=!1,this.userChangeUnAccepted=[],this.isSheetLoadedInSpreadsheet=function(e){if(!a.spreadsheetApp)return!1;if(!a.spreadsheetApp.spreadsheet)return!1;var t=a.spreadsheetApp.spreadsheet.sheetManager.getSheetBySheetId(e);return!!t&&t.isLoaded},this.addListenActions(),this.loadSheetPromiseMap=new Map,self.SpreadsheetApp=this.spreadsheetApp}var t=e.prototype;return t.destroy=function(){var e,t,r;this.isSheetDataReady&&(null===(e=this.calcController)||void 0===e||e.destroy(),this.calcController=void 0,this.spreadsheet=void 0,null===(r=null===(t=this.spreadsheetApp)||void 0===t?void 0:t.messageCenterAdapter)||void 0===r||r.dispose(),this.spreadsheetApp.calcController=void 0,this.spreadsheetApp.spreadsheet=void 0,this.spreadsheetApp.messageCenter=void 0,this.isSheetDataReady=!1)},t.checkSheetFormulaLayerStatusBetweenThreads=function(e){var t=e.currentStatusMap,r=this.calcController.sheetFormulaLayerStatusMap.getCurrentStatusMap(),o=!0;return Object.keys(t).every((function(e){return t[e]===r[e]||(o=!1,!1)})),o},t.loadSheet=function(e){var t=this,r=e.sheetId,o=e.waitForFormulaLayerToBeInitialized;if(!this.isSheetDataReady)return Promise.resolve(!1);var n=this.spreadsheet.sheetManager.getSheetBySheetId(r);if(!n)return Promise.resolve(!1);if(n.isFetching=!0,null===n||void 0===n?void 0:n.isLoaded)return n.isFetching=!1,Ot(t,void 0,void 0,regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.calcController.sheetFormulaLayerStatusMap,n=o?t.getInitialPromise(r):t.getWaitingPromise(r),!(0,qe.tI)(n)){e.next=5;break}return e.next=5,n;case 5:return this.calcController.dataTransferService.syncAllFormulaResultToMainThread(r),e.abrupt("return",!0);case 7:case"end":return e.stop()}}),e,this)})));if(this.loadSheetPromiseMap.has(r))return this.loadSheetPromiseMap.get(r);var a=new Promise((function(e){return Ot(t,void 0,void 0,regeneratorRuntime.mark((function t(){var a,s,i,l,u,d=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=function(t){return Ot(d,void 0,void 0,regeneratorRuntime.mark((function a(){var s,i,l=this;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if("fail"===t){a.next=14;break}if(this.transformSpreadsheet(n,t.initialAttributedText.text,0,t.maxrow-1),n.isLoaded=!0,n.isFetching=!1,s=this.calcController.sheetFormulaLayerStatusMap,i=o?s.getInitialPromise(r):s.getWaitingPromise(r),!(0,qe.tI)(i)){a.next=9;break}return a.next=9,i;case 9:this.loadSheetPromiseMap.delete(r),this.userChangeUnAccepted.forEach((function(e){e.sheetId===n.getSheetId()&&l.spreadsheetApp.messageCenterAdapter.sendMessageCenterAdapter.commit(e)})),e(!0),a.next=17;break;case 14:n.isFetching=!1,this.loadSheetPromiseMap.delete(r),e(!1);case 17:Qe.ZP.default.trigger("afterLoadData",{sheetId:r,oldSheetId:"",isThreeDimensionClick:!1});case 18:case"end":return a.stop()}}),a,this)})))},Qe.ZP.default.trigger("startLoadData",{sheetId:r,oldSheetId:""}),s=this.spreadsheet.getSpreadsheetId(),!(0,qe.w1)()&&!(0,qe.xc)()){t.next=10;break}return t.next=6,this.fetchSheet({sheetId:r,spreadsheetId:s});case 6:i=t.sent,Mt()(i)?(this.loadSheetPromiseMap.delete(r),e(!1)):a(i),t.next=17;break;case 10:return t.next=12,this.cookie.getXsrf();case 12:return l=t.sent,t.next=15,this.cookie.getNowUserIndex();case 15:u=t.sent,this.fetch({sheetId:r,spreadsheetId:s,xsrfStr:l,nowUserIndex:u,callback:a});case 17:case"end":return t.stop()}}),t,this)})))}));return this.loadSheetPromiseMap.set(r,a),a},t.loadSheetToWorker=function(e){var t,o=this;if(!this.isSheetDataReady)return null===(t=r.g.log)||void 0===t||t.error("worker 表格初始化失败"),!1;var n=e.sheetId,a=e.serializeData,s=e.newChartWorkbookRanges,i=e.newEmbeddedObjects,l=e.activeFilterViewId,u=this.spreadsheet.sheetManager.getSheetBySheetId(n);if(!u||(null===u||void 0===u?void 0:u.isLoaded))return Ot(o,void 0,void 0,regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.calcController.sheetFormulaLayerStatusMap.getInitialPromise(n),!(0,qe.tI)(t)){e.next=4;break}return e.next=4,t;case 4:this.calcController.dataTransferService.syncAllFormulaResultToMainThread(n);case 5:case"end":return e.stop()}}),e,this)}))),!1;if(s.forEach((function(e){var t=Et.ChartWorkbookRange.deserialize(e);o.spreadsheet.workbookRangeManager.getWorkbookRangeById(t.id)||o.spreadsheet.workbookRangeManager.addWorkbookRange(t),o.spreadsheetApp.calcController.formulaController.addCustomNodes(kt.B.Chart,[{workbookRangeId:t.id}])})),i.forEach((function(e){var t=$e.Z.deserialize(e);o.spreadsheet.embeddedObjectManager.getEmbeddedObject(t.objectId)||o.spreadsheet.embeddedObjectManager.addEmbeddedObject(t)})),!a)return this.loadSheet({sheetId:n,waitForFormulaLayerToBeInitialized:!0}),!0;var d=JSON.stringify(a);(0,tt.T)(u,d,0,0,rt.Z.KEYFRAME_VER);for(var c=u.getRowCount(),h=u.getColCount(),f=!1,p=0;p<c;p++)for(var m=0;m<h;m++)if(this.spreadsheet.autoUpdateCellData(n,p,m),!f){var g=u.getCellDataAtPosition(p,m);g&&g.getFormula()&&g.getEffectiveValue()&&(f=!0)}return l&&u.filterViewManager.setActiveFilterViewId(l),u.isLoaded=!0,this.calcController.keyframeHandler({sType:Xe.Z.NORMAL,sheetId:n}),this.calcController.sheetFormulaLayerStatusMap.setWaitingStart(n),this.calcController.sheetFormulaLayerStatusMap.setWaitingDone(n),this.calcController.startReCalculateAfterSheetInitial(n),this.backEndFormulaResultCacheReport(f,n),this.spreadsheet.formulaModelManager.keyframeHandler({sheet:u}),!0},t.informNetworkChange=function(e){Qe.ZP.default.trigger(e.type,void 0)},t.syncVisibleAreaToWorker=function(e){var t=e.visibleArea;return!!this.isSheetDataReady&&(this.calcController.dataTransferService.visibleArea=t,!0)},t.updateSpreadsheet=function(e){return!!this.isSheetDataReady&&(this.spreadsheet.sheetManager.setSheets(e.sheetList),!0)},t.fetchSheet=function(e){return this.controller.requestPromise(c.Pt.FetchSheetOnMainThread,e)},t.resetSheetOnWorkerFormula=function(e){var t=e.sheetId;this.calcController.resetSheet(t)},t.transformSpreadsheetBySheetId=function(e){if(!this.isSheetDataReady)return!1;var t=e.sheetId,r=e.text,o=this.spreadsheet.sheetManager.getSheetBySheetId(t);return!!o&&(o.isFetching=!0,this.transformSpreadsheet(o,r,e.startRow,e.endRow),o.isLoaded=!0,o.isFetching=!1,!e.waitForFormulaLayerToBeInitialized||this.calcController.sheetFormulaLayerStatusMap.getInitialPromise(t))},t.fetch=function(e){var t=e.sheetId,o=e.spreadsheetId,n=e.xsrfStr,a=e.nowUserIndex,s=e.callback,i=e.retryTime,l=void 0===i?0:i;return Ot(this,void 0,void 0,regeneratorRuntime.mark((function e(){var i,u,d,c,h,f=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=3,u=2e3,d=["padId="+o,"subId="+t,"startrow=0&endrow=-1&outformat=1&nowb=1",a?"u="+a:"","xsrf="+n,"_r="+Math.random()].filter((function(e){return!!e})).join("&"),c="/dop-api/get/sheet?"+d,e.next=6,Ge()({method:"get",url:c,responseType:"json"}).catch((function(e){var o;return null===(o=r.g.log)||void 0===o||o.error("fetch 子表失败",t,l),e}));case 6:if(h=e.sent,"fail"!==this.checkRespose(h)){e.next=13;break}if(!(l>=i)){e.next=11;break}return s("fail"),e.abrupt("return");case 11:return Ke.Z.wait(u).run((function(){f.fetch({sheetId:t,spreadsheetId:o,xsrfStr:n,nowUserIndex:a,callback:s,retryTime:l+1})})),e.abrupt("return");case 13:s(h.data.data);case 14:case"end":return e.stop()}}),e,this)})))},t.checkRespose=function(e){return"undefined"===typeof e||null===e?"fail":this.checkResposeStatus(e)&&this.checkResponseData(e)?"succ":"fail"},t.checkResposeStatus=function(e){return!(!e.status||200!==e.status)},t.checkResponseData=function(e){return!(!e.data||0!==e.data.retcode)},t.initSpreadsheetApp=function(e){var t,o=new Dt(this.spreadsheetApp,e.baseVersion);(0,n.jz)(o);var a=e.activeSheetId,s=e.header,i=e.spreadsheetId,l=e.title,u=e.clientVars,d=e.workbookRanges;return window.clientVars=u,this.spreadsheet=this.initSpreadsheet({spreadsheetId:i,type:Xe.Z.NORMAL,title:l,sheetList:s,activeSheetId:a,workbookRanges:d?_t.WorkbookRangeManager.deserialize(d):void 0}),this.spreadsheetApp.spreadsheet=this.spreadsheet,this.calcController=new Ye.Z(this.spreadsheetApp,{isInWorker:!0}),this.spreadsheetApp.calcController=this.calcController,this.spreadsheetApp.messageCenterAdapter=o,this.spreadsheetApp.messageCenter=o.messageCenter,this.instantiationService.addService(We.k,{calcController:this.calcController}),this.instantiationService.addService(Je.V,this.spreadsheet),o.messageCenter.resume(),this.mutationData.setMutationQueueId(-1),this.isSheetDataReady=!0,null===(t=r.g.log)||void 0===t||t.log("worker 表格初始化成功"),!0},t.initSpreadsheet=function(e){return new ze.Z(this.spreadsheetApp,e)},t.initSheet=function(e){var t=e.sheetId,r=this.spreadsheet.sheetManager.getSheetBySheetId(t);return!!r&&(r.isFetching=!0,this.transformSpreadsheet(r,e.sheetData,e.startRow,e.endRow),r.isLoaded=!0,r.isFetching=!1,!0)},t.clearAndReInitSheets=function(e){var t=this;return!!this.isSheetDataReady&&(this.spreadsheet.sheetManager.sheetList.forEach((function(e){t.calcController.resetSheet(e.getSheetId())})),this.loadSheetPromiseMap=new Map,this.spreadsheet.workbookRangeManager.clear(),this.spreadsheet.embeddedObjectManager.clear(),this.spreadsheet.sheetManager.setSheets(e.sheetList),!0)},t.clearAndReInitOneSheet=function(e){if(!this.isSheetDataReady)return!1;var t=e.sheetId;return this.loadSheetPromiseMap.delete(t),this.spreadsheet.sheetManager.reInitSheetBySheetId(t),!0},t.transformSpreadsheet=function(e,t,r,o){var n=e.getSheetId();(0,et.Z)(this.spreadsheetApp.spreadsheet,n,t,r,o)},t.backEndFormulaResultCacheReport=function(e,t){var o,n;if(e)return l.ZP.monitor(35406905),void(null===(o=r.g.log)||void 0===o||o.log("子表 "+t+" 击中后台函数结果缓存"));l.ZP.monitor(35406906),null===(n=r.g.log)||void 0===n||n.log("子表 "+t+" 未击中后台函数结果缓存")},t.addListenActions=function(){this.controller.addActionHandler(c.Pt.InitSpreadsheetApp,this.initSpreadsheetApp.bind(this)),this.controller.addActionHandler(c.Pt.InitSheet,this.initSheet.bind(this)),this.controller.addActionHandler(c.Pt.LoadSheet,this.loadSheet.bind(this)),this.controller.addActionHandler(c.Pt.LoadSheetToWorker,this.loadSheetToWorker.bind(this)),this.controller.addActionHandler(c.Pt.UpdateSpreadsheet,this.updateSpreadsheet.bind(this)),this.controller.addActionHandler(c.Pt.syncVisibleAreaToWorker,this.syncVisibleAreaToWorker.bind(this)),this.controller.addActionHandler(c.Pt.resetSheetOnWorkerFormula,this.resetSheetOnWorkerFormula.bind(this)),this.controller.addActionHandler(c.Pt.ClearAndReInitSheets,this.clearAndReInitSheets.bind(this)),this.controller.addActionHandler(c.Pt.ClearAndReInitOneSheet,this.clearAndReInitOneSheet.bind(this)),this.controller.addActionHandler(c.Pt.TransformSpreadsheetBySheetId,this.transformSpreadsheetBySheetId.bind(this)),this.controller.addActionHandler(c.Pt.InformNetworkChange,this.informNetworkChange.bind(this)),this.controller.addActionHandler(c.Pt.CheckSheetFormulaLayerStatusBetweenThreads,this.checkSheetFormulaLayerStatusBetweenThreads.bind(this))},e}();xt=jt([Nt(0,n.TG),Nt(1,Z.m),Nt(2,a),Nt(3,d),Nt(4,E),Ft("design:paramtypes",["function"===typeof(Pe="undefined"!==typeof n.TG&&n.TG)?Pe:Object,"function"===typeof(Be="undefined"!==typeof Z.m&&Z.m)?Be:Object,"function"===typeof(Ue="undefined"!==typeof a&&a)?Ue:Object,"function"===typeof(Ve="undefined"!==typeof d&&d)?Ve:Object,"function"===typeof(Ze="undefined"!==typeof E&&E)?Ze:Object])],xt);var Lt,Pt,Bt=r("../spread-sheet/src/core/app/BaseSpreadsheetApp.ts"),Ut=(r("../spread-sheet/src/base/config/report.ts"),r("../spread-sheet/src/base/event/eventName.ts"),r("../packages/mutation/src/api.ts"),r("../spread-sheet/src/core/app/event-init.ts"),Bt.Z,r("../node_modules/core-js/modules/es.regexp.exec.js"),r("../node_modules/core-js/modules/es.string.replace.js"),r("../node_modules/core-js/modules/es.string.match.js"),r("../node_modules/core-js/modules/es.object.get-prototype-of.js"),r("../node_modules/core-js/modules/es.object.get-own-property-names.js"),r("../node_modules/core-js/modules/es.object.assign.js"),function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))}),Vt=function e(t,r){return void 0===r&&(r=0),Ut(void 0,void 0,void 0,regeneratorRuntime.mark((function o(){var n;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,Ge().get(t).then((function(e){return{error:null,data:e.data}})).catch((function(o){return r>=3?{error:o,data:""}:e(t,r+1)}));case 2:return n=o.sent,o.abrupt("return",n);case 4:case"end":return o.stop()}}),o)})))},Zt=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Wt=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Ht=function(e,t){return function(r,o){t(r,o,e)}},Gt=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))},zt=function(){function e(e,t){this.workerInstantiationService=e,this.controller=t,this.loadedServicesMap={},this.addActionHandler()}var t=e.prototype;return t.addActionHandler=function(){this.controller.addActionHandler(c.yZ.Service,this.service.bind(this))},t.service=function(e){var t,o;return Gt(this,void 0,void 0,regeneratorRuntime.mark((function n(){var a,s,i,u,d,c,h,f,p,m,g,v,S;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a={startLoad:Date.now(),endLoad:-1,endInvoke:-1,ready:-1},s=e.serviceUrl,i=s.replace("?.*$",""),!this.loadedServicesMap[i]){n.next=5;break}return n.abrupt("return",this.loadedServicesMap[i]);case 5:return n.next=7,Vt(s);case 7:if(u=n.sent,d=u.error,c=u.data,!d){n.next=13;break}throw this.loadScriptFailReport(s,d),d;case 13:a.endLoad=Date.now(),f="__workerModule"+Date.now(),n.prev=15,new Function("self['"+f+"']="+c)(),h=self[f],delete self[f],h=(null===h||void 0===h?void 0:h.default)||h,n.next=28;break;case 23:throw n.prev=23,n.t0=n.catch(15),delete self[f],this.invokeScriptFailReport(s,n.t0),n.t0;case 28:if(a.endInvoke=Date.now(),p=this.getServiceNameFromServiceUrl(s)){n.next=33;break}throw this.serviceWithoutNameReport(s),new Error("Service "+s+" without serviceName");case 33:return n.next=35,this.addServiceToDI(h,p);case 35:return m=n.sent,null===(t=r.g.log)||void 0===t||t.info("Worker DI add service success, "+p),0===(g=this.getServiceActionNameList(h,m)).length&&(v="Worker service "+p+" without action",l.ZP.monitor(35445236),console.error(v),null===(o=r.g.log)||void 0===o||o.error(v)),this.addServiceActionToController(m,p,g),S={serviceName:p,serviceActionNameList:g},this.loadedServicesMap[i]=S,a.ready=Date.now(),this.loadServiceSuccessReport(S,a),n.abrupt("return",Promise.resolve(S));case 45:case"end":return n.stop()}}),n,this,[[15,23]])})))},t.addServiceActionToController=function(e,t,r){var o=this;r.forEach((function(r){if(e[r]instanceof Function){var n=t+"."+r;o.controller.addActionHandler(n,(function(t){return e[r].apply(e,(0,ot.Z)(t))}))}else console.error("Service "+t+" action "+r+" no function.")}))},t.addServiceToDI=function(e,t){return Gt(this,void 0,void 0,regeneratorRuntime.mark((function r(){var o,a,s=this;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=(0,n.yh)(t),e instanceof Function?this.workerInstantiationService.addService(o,new n.Mj(e)):this.workerInstantiationService.addService(o,e),r.next=4,new Promise((function(e){s.workerInstantiationService.invokeFunction((function(t){var r=t.get(o);e(r)}))}));case 4:return a=r.sent,r.abrupt("return",a);case 6:case"end":return r.stop()}}),r,this)})))},t.getServiceNameFromServiceUrl=function(e){var t,r=e.match(/(worker-.*?)(-[0-9a-f]+)?\.js$/i);return r?(t=r[1],t=this.normalizeServiceName(t)):(r=e.match(/\.(com|cn)\/.*\/(.*?)\.js$/i))?(t=r[2],t=this.normalizeServiceName(t)):e},t.normalizeServiceName=function(e){return e.replace(/(^\w|[-_/.]\w)/gi,(function(e){return e[e.length-1].toUpperCase()}))},t.getServiceActionNameList=function(e,t){var r=e instanceof Function?Object.getPrototypeOf(t):t;return Object.getOwnPropertyNames(r).filter((function(e){return r[e]instanceof Function})).filter((function(e){return"constructor"!==e}))},t.loadScriptFailReport=function(e,t){var o,n="Worker load script fail, "+e;console.error(n,t),l.ZP.monitor(35445052),l.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"worker_load_script_fail",ver5:e}),null===(o=r.g.log)||void 0===o||o.error(n)},t.invokeScriptFailReport=function(e,t){var o,n="Worker invoke script fail, "+e;console.error(n,t),l.ZP.monitor(35445183),l.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"worker_invoke_script_fail",ver5:e}),null===(o=r.g.log)||void 0===o||o.error(n)},t.serviceWithoutNameReport=function(e){var t,o="Service "+e+" without serviceName";l.ZP.monitor(35445235),l.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"worker_service_without_name",ver5:e}),null===(t=r.g.log)||void 0===t||t.error(o)},t.loadServiceSuccessReport=function(e,t){var o;l.ZP.monitor(35445233);var n=Object.assign(Object.assign({},e),{loadTime:t.endLoad-t.startLoad,invokeTime:t.endInvoke-t.endLoad,readyTime:t.ready-t.endInvoke});l.ZP.tdwReport({opername:"tech_doc",module:"webworker",action:"worker_service_success",ver5:JSON.stringify(n)}),null===(o=r.g.log)||void 0===o||o.info("Worker service is loaded",n)},e}();zt=Zt([Ht(0,n.TG),Ht(1,a),Wt("design:paramtypes",["function"===typeof(Lt="undefined"!==typeof n.TG&&n.TG)?Lt:Object,"function"===typeof(Pt="undefined"!==typeof a&&a)?Pt:Object])],zt);var Qt,Kt=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},qt=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Yt=function(e,t){return function(r,o){t(r,o,e)}},Xt=function(){function e(e){this.controller=e}return e.prototype.triggerValidStatusChange=function(e){return this.controller.requestPromise(c.vW.UPDATE_COLUMN_VALIDATION_STATUS,e)},e}();Xt=Kt([Yt(0,a),qt("design:paramtypes",["function"===typeof(Qt="undefined"!==typeof a&&a)?Qt:Object])],Xt);var $t,Jt,er,tr,rr,or,nr,ar=(0,n.yh)("IWorkerThreadFormulaWasm"),sr=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},ir=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},lr=function(e,t){return function(r,o){t(r,o,e)}},ur=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function s(e){try{l(o.next(e))}catch(t){a(t)}}function i(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}l((o=o.apply(e,t||[])).next())}))},dr=function(){function e(e,t){this.app=e,this.cookie=t,this.maxTaskLength=5,this.commitTimeout=1e4,this.task=[],this.isCommitting=!1}var t=e.prototype;return t.commit=function(e){var t;null===(t=r.g.log)||void 0===t||t.log("提交函数缓存",{version:e.rev,sheets:e.sheets.map((function(e){return e.id}))}),this.addTask(e),this.runTask()},t.addTask=function(e){this.task.length>0&&this.task[this.task.length-1].commitData.rev>e.rev||(this.task.length>=this.maxTaskLength&&this.task.shift(),this.task.push({commitData:e}))},t.runTask=function(){if(!this.isCommitting){var e=this.task.shift();e&&(this.isCommitting=!0,this.commitToServer(e.commitData))}},t.commitToServer=function(e){var t;return ur(this,void 0,void 0,regeneratorRuntime.mark((function o(){var n,a,s=this;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return null===(t=r.g.log)||void 0===t||t.log("开始提交函数缓存到后台"),o.next=3,this.cookie.getXsrf();case 3:n=o.sent,a=this.app.spreadsheet.getSpreadsheetId(),Ge()({method:"post",url:"https://"+fe.Z.getConfig("runtime.domainName")+"/v1/dop-api/commitformula?padId="+a+"&xsrf="+n,data:e,timeout:this.commitTimeout}).then((function(t){var o,n;return 0===(null===(o=t.data)||void 0===o?void 0:o.retcode)?(l.ZP.monitor(35407658),null===(n=r.g.log)||void 0===n||n.log("提交函数缓存到后台成功",{version:e.rev,sheets:e.sheets.map((function(e){return e.id}))}),void s.runNextTask()):Promise.reject("函数结果提交失败")})).catch((function(t){var o,n;l.ZP.monitor(35407659),null===(o=r.g.log)||void 0===o||o.error("提交函数缓存到后台失败",t),null===(n=r.g.log)||void 0===n||n.log("提交函数缓存到后台失败",{version:e.rev,sheets:e.sheets.map((function(e){return e.id}))}),s.runNextTask()}));case 6:case"end":return o.stop()}}),o,this)})))},t.runNextTask=function(){this.isCommitting=!1,this.runTask()},e}(),cr=dr=sr([lr(0,Z.m),lr(1,d),ir("design:paramtypes",["function"===typeof($t="undefined"!==typeof Z.m&&Z.m)?$t:Object,"function"===typeof(Jt="undefined"!==typeof d&&d)?Jt:Object])],dr),hr=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},fr=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},pr=function(e,t){return function(r,o){t(r,o,e)}},mr=function(){function e(e){this.app=e,this.hasReportResultAccuracySheetMap={}}var t=e.prototype;return t.analyzeResultAccuracy=function(e){var t=this;e.sheets.map((function(e){return e.id})).forEach((function(r,o){if(!t.hasReportResultAccuracySheetMap[r]){var n=t.app.spreadsheet.sheetManager.getSheetBySheetId(r);if(n&&!1!==n.isLoaded){var a=e.sheets[o].cells;if(a&&0!==a.length){var s=!1,i=0;if(a.forEach((function(e){var r=e.row,o=e.col,a=e.value,l=n.getCellDataAtPosition(r,o);if(l){var u=l.getEffectiveValue();null!==u&&(s=!0,t.isEffectiveValueEqualToCacheValue(u,a)&&(i+=1))}})),s){var l=i/a.length;t.reportResultAccuracy(l,r,e.rev)}t.hasReportResultAccuracySheetMap[r]=!0}else t.hasReportResultAccuracySheetMap[r]=!0}else t.hasReportResultAccuracySheetMap[r]=!0}}))},t.isEffectiveValueEqualToCacheValue=function(e,t){return e.value===t||"object"===typeof e.value&&"object"===typeof t&&e.value.type===t.type},t.reportResultAccuracy=function(e,t,o){var n;e>=1?l.ZP.monitor(35421526):e>.9?l.ZP.monitor(35421527):e>.7?l.ZP.monitor(35421528):e>.5?l.ZP.monitor(35421529):l.ZP.monitor(35421530);var a={version:o,sheetId:t,accuracy:e};l.ZP.tdwReport({opername:"doc_excel",module:"formula_worker",action:"back_end_result_accuracy",ver5:JSON.stringify(a)}),null===(n=r.g.log)||void 0===n||n.log("使用后台函数缓存准确率",a)},e}(),gr=mr=hr([pr(0,Z.m),fr("design:paramtypes",["function"===typeof(er="undefined"!==typeof Z.m&&Z.m)?er:Object])],mr),vr=(r("../node_modules/core-js/modules/es.array.includes.js"),r("../node_modules/core-js/modules/es.string.includes.js"),r("../node_modules/i18next/dist/esm/i18next.js")),Sr=r("../packages/model/src/cell/ExtendedValueType.ts"),yr=r("../spread-sheet/src/core/feature/formula/utils.ts"),Ir=r("../node_modules/@tencent/sheet-formula-sdk/lib/index.js"),Rr=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},Cr=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Tr=function(e,t){return function(r,o){t(r,o,e)}},wr=Ir.nx.DegreeTreeType,Ar=Ir.zD.iteratorWithLimitGridRange,Dr=function(){function e(e){var t=this;this.app=e,this.preCellsCountMap={},this.traverseCellDataBySheetId=function(e,r){var o=t.app.spreadsheet.sheetManager.getSheetBySheetId(e);if(o){var n=t.app.spreadsheet.formulaModelManager.formulaModelMap.FORMULA.getTreeBySheetIdAndDegreeTreeType(e,wr.IN_DEGREE);null===n||void 0===n||n.all().forEach((function(e){Ar(e.gridRange,(function(e,t){var n=o.getCellDataAtPosition(e,t);n&&r({row:e,col:t,cellData:n})}))}))}}}var t=e.prototype;return t.get=function(e,t){var r=this,o={dataRev:1,rev:e,sheets:[]},n=this.app.spreadsheet.formulaModelManager.formulaModelMap.FORMULA.getTreeMap().inDegreeTreeMap,a=Object.keys(n),s=this.app.calcController.graphUpdateTimes,i=a.reduce((function(e,t){return e[t]=[],e}),{});return a.forEach((function(e){void 0===r.preCellsCountMap[e]&&(r.preCellsCountMap[e]=0)})),a.forEach((function(e){r.traverseCellDataBySheetId(e,(function(t){var o=t.row,n=t.col,a=t.cellData,s=r.getCommitCell({row:o,col:n,cellData:a});s&&i[e].push(s)}))})),a.forEach((function(e){var n=r.getSheetGraphCellsCount(e);if(r.preCellsCountMap[e]!==n)return o.sheets.push({id:e,nochange:!1,cells:i[e]}),void(r.preCellsCountMap[e]=n);r.preGraphUpdateTime!==s&&t.includes(e)?0!==i[e].length&&o.sheets.push({id:e,nochange:!1,cells:i[e]}):o.sheets.push({id:e,nochange:!0})})),this.preGraphUpdateTime=s,o},t.getCommitCell=function(e){var t,r,o=e.row,n=e.col,a=e.cellData;if(!(null===a||void 0===a?void 0:a.getFormula()))return null;var s=(null===a||void 0===a?void 0:a.getEditValue())||"";if(!s||/(STOCK|RAND|NOW|RANDBETWEEN)\(/.test(s))return null;var i=null===a||void 0===a?void 0:a.getEffectiveValue(),l=null===i||void 0===i?void 0:i.value,u=null===i||void 0===i?void 0:i.originValue,d=null===l||void 0===l?void 0:l.displayText,c=null===(t=null===a||void 0===a?void 0:a.getUserEnteredFormat())||void 0===t?void 0:t.getNumberFormat(),h=null===(r=null===a||void 0===a?void 0:a.getEffectiveFormat())||void 0===r?void 0:r.getNumberFormat(),f=u||l,p=yr.ps[typeof f];if(d&&(f={type:l.type,displayText:d,title:vr.ZP.t("错误"),message:yr.OA[d]},p=Sr.Z.ERROR),"string"!==typeof f&&"number"!==typeof f&&"boolean"!==typeof f&&"object"!==typeof f)return null;var m={row:o,col:n,type:p,value:f};if(h){var g=h.serialize();2===g.length&&(m.ef={id:g[0],pattern:g[1]})}if(c){var v=c.serialize();2===v.length&&(m.ef={id:v[0],pattern:v[1]})}return m},t.getSheetGraphCellsCount=function(e){var t=this.app.spreadsheet.formulaModelManager.formulaModelMap.FORMULA.getTreeBySheetIdAndDegreeTreeType(e,wr.IN_DEGREE),r=0;return null===t||void 0===t||t.all().forEach((function(e){var t=e.gridRange,o=t.startRowIndex,n=t.endRowIndex,a=t.startColIndex,s=t.endColIndex;r+=(n-o+1)*(s-a+1)})),r},e}(),br=Dr=Rr([Tr(0,Z.m),Cr("design:paramtypes",["function"===typeof(tr="undefined"!==typeof Z.m&&Z.m)?tr:Object])],Dr),Mr=function(e,t,r,o){var n,a=arguments.length,s=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var i=e.length-1;i>=0;i--)(n=e[i])&&(s=(a<3?n(s):a>3?n(t,r,s):n(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},kr=function(e,t){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(e,t)},Er=function(e,t){return function(r,o){t(r,o,e)}},_r=window.location.href.indexOf("closeFormulaCache=1")>=0;!function(e){e[e.Commit=0]="Commit",e[e.Accept=1]="Accept"}(nr||(nr={}));var jr=function(){function e(e,t){this.app=e,this.cookie=t,this.commitButNotAcceptTotal=0,this.afterNetworkStatus=nr.Accept,this.commitData=null,this.commitQueue=new cr(e,t),this.accuracyReport=new gr(e),this.getCommitData=new br(e)}var t=e.prototype;return t.commit=function(e,t){this.commitData=this.getCommitData.get(e,t),this.accuracyReport.analyzeResultAccuracy(this.commitData),this.checkCanCommitToServer()&&this.commitToServer(this.commitData)},t.addIgnoreVersion=function(e){void 0!==this.ignoreVersion?this.ignoreVersion<e&&(this.ignoreVersion=e):this.ignoreVersion=e},t.changeToCommitStatus=function(e){this.afterNetworkStatus=nr.Commit,this.commitButNotAcceptTotal+=1,this.commitData=null},t.changeToAcceptStatus=function(e){this.afterNetworkStatus=nr.Accept,this.commitButNotAcceptTotal-=1,this.checkCanCommitToServer()&&null!==this.commitData&&(this.commitData.rev=e,this.commitToServer(this.commitData),this.commitData=null)},t.checkCanCommitToServer=function(){return this.afterNetworkStatus===nr.Accept&&0===this.commitButNotAcceptTotal},t.commitToServer=function(e){var t,o;_r||(this.ignoreVersion>=e.rev?null===(t=r.g.log)||void 0===t||t.log("提交函数缓存","无效提交, 该版本为忽略版本"):0!==e.sheets.length?this.commitQueue.commit(e):null===(o=r.g.log)||void 0===o||o.log("提交函数缓存","无效提交, 没有需要提交的子表"))},e}();jr=Mr([Er(0,Z.m),Er(1,d),kr("design:paramtypes",["function"===typeof(rr="undefined"!==typeof Z.m&&Z.m)?rr:Object,"function"===typeof(or="undefined"!==typeof d&&d)?or:Object])],jr);var Fr=new n.o5,Nr=new(function(){function e(){}var t=e.prototype;return t.initWorkerService=function(){var e=new n.yk;Fr.getServiceDescriptors().forEach((function(t){var r=t[0],o=t[1];e.set(r,o)})),this.workerInstantiationService=new n.FS(e)},t.initWorkerThreadWorker=function(){var e=this;this.workerInstantiationService.invokeFunction((function(t){var r=t.get(Ee);e.workerThreadWorker=r}))},t.initWorkerWasm=function(){var e=this;setTimeout((function(){e.workerInstantiationService.invokeFunction((function(e){e.get(ar).initDynamicWasm()}))}),1e4)},e}())},"../spread-sheet/src/core/worker/worker-thread/polyfill.ts":function(e,t,r){r("../node_modules/core-js/modules/es.object.to-string.js"),r("../node_modules/core-js/modules/es.promise.js"),r("../node_modules/core-js/modules/es.function.name.js"),r("../node_modules/core-js/modules/es.array.slice.js"),r("../node_modules/core-js/modules/es.regexp.to-string.js"),self.Promise=Promise}}]),window.jsExecEndTimeStamp=Date.now(),window.cachedPerformanceEntries||(window.cachedPerformanceEntries=[]),window.cachedPerformanceEntries.push({name:"jsExec: js/spread-sheet_src_core_feature_formula_controller_ts-spread-sheet_src_core_worker_worker-threa-ff1554.02ea1556dc3181607bbf.js",entryType:"jsExec",startTime:window.jsExecStartTimeStamp,endTime:window.jsExecEndTimeStamp});
//# sourceMappingURL=spread-sheet_src_core_feature_formula_controller_ts-spread-sheet_src_core_worker_worker-threa-ff1554.02ea1556dc3181607bbf.js.map